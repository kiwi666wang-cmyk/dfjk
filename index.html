<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>DFJK â€” æ¡Œæ©Ÿä¹Ÿæœ‰æ§åˆ¶ä¸­å¿ƒï¼ˆv11, desktop+mobile, hard single-instanceï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet"/>
<style>
/* ===== åŸºç¤ ===== */
html,body{ margin:0; touch-action:manipulation; overscroll-behavior:none; background:#0a1226; }
body{ color:#fff; font-family:sans-serif; text-align:center; transition:background .3s ease; }
body.ex-mode{ background:linear-gradient(to bottom, #ff3300 0%, #990000 50%, #000 100%); }

/* ===== èªè¨€åˆ‡æ› ===== */
#languageSwitcher{
  position:fixed; top:16px; right:16px; z-index:240;
  display:flex; align-items:center; gap:8px;
  background:rgba(12,19,34,.72); backdrop-filter:blur(10px);
  border:1px solid rgba(120,213,255,.3); border-radius:999px;
  padding:6px 12px; font-size:14px; line-height:1;
  box-shadow:0 10px 24px rgba(0,0,0,.35);
}
#languageSwitcher label{ display:flex; align-items:center; gap:6px; cursor:pointer; font-weight:600; }
#languageLabelText{ white-space:nowrap; }
#languageSwitcher select{
  border:none; background:rgba(9,14,26,.9); color:#fff; border-radius:999px;
  padding:6px 10px; font-size:14px; outline:none; appearance:none;
}
#languageSwitcher select:focus{ box-shadow:0 0 0 2px rgba(120,213,255,.45); }
.lang-globe{
  width:18px; height:18px; display:inline-block; flex:0 0 18px;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='9'/%3E%3Cpath d='M12 3a9 9 0 010 18M3 12h18M6.5 7.5a17 17 0 0011 0M6.5 16.5a17 17 0 0111 0'/%3E%3C/svg%3E") center/contain no-repeat;
}

/* ===== èˆå°åŒ…è£¹ï¼šå¯åˆ‡æ›å°ºå¯¸/æ—‹è½‰ ===== */
#stageWrap{
  position:relative; margin:20px auto; width:min(95vw, 840px);
  border-radius:12px; overflow:hidden; z-index:1; will-change:transform;
}
#stageWrap.landscape{
  position:fixed; left:50%; top:50%;
  transform-origin:center center;
  transform:translate(-50%,-50%) rotate(90deg);
  margin:0;
}

/* çœŸæ­£çš„èˆå°å®¹å™¨ */
#stage{ position:relative; width:100%; height:100%; }
canvas{ display:block; width:100%; height:auto; max-width:100%; background:#0c1322; }
#uiCanvas{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; background:transparent; border:none; z-index:6; }

/* æ¼¸å±¤å½é‚Šç•Œ */
#edgeFade{ position:absolute; inset:0; pointer-events:none; border-radius:10px; z-index:5;
  background:
    linear-gradient(to right, rgba(255,255,255,.16), rgba(255,255,255,0) 40%) left/16px 100% no-repeat,
    linear-gradient(to left,  rgba(255,255,255,.16), rgba(255,255,255,0) 40%) right/16px 100% no-repeat,
    linear-gradient(to bottom,rgba(255,255,255,.16), rgba(255,255,255,0) 40%) top/100% 16px no-repeat,
    linear-gradient(to top,   rgba(255,255,255,.16), rgba(255,255,255,0) 40%) bottom/100% 16px no-repeat;
}

/* ===== ç›´å‘ topbarï¼ˆæ©«ç‰ˆç”±æ§åˆ¶ä¸­å¿ƒæ¥ç®¡ï¼‰ ===== */
.topbar{
  position:absolute; top:10px; left:0; right:0; z-index:8;
  display:flex; align-items:center; justify-content:space-between; gap:8px; padding:0 10px;
}
.top-mid{ flex:1 1 auto; display:flex; justify-content:center; }
#ctrlButton{ padding:6px 10px; font-size:14px; border:none; border-radius:8px; background:#78d5ff; cursor:pointer; }

/* è¡€æ¢ï¼ˆç½®ä¸­é¡¯ç¤ºï¼‰ */
#hpBar{ position:relative; height:18px; background:rgba(255,255,255,.18); border-radius:999px; display:none; min-width:160px; }
#hpFill{ position:absolute; inset:0 auto 0 0; width:100%; background:#ff3b3b; border-radius:999px; }
#hpText{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-weight:800; color:#000; font-size:12px; }

/* æ©«ç‰ˆ HP æµ®å‹•ï¼ˆå›ºå®šé å³ä¸Šï¼‰ */
#hpFloat{
  position:absolute; z-index:186; display:none;
  height:18px; min-width:160px; background:rgba(255,255,255,.18);
  border-radius:999px; box-shadow:0 6px 20px rgba(0,0,0,.35);
  right:16px; top:52px; pointer-events:none;
}
#hpFloatFill{ position:absolute; inset:0 auto 0 0; width:100%; background:#ff3b3b; border-radius:999px; }
#hpFloatText{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-weight:800; color:#000; font-size:12px; }

/* èƒŒæ™¯å±¬æ€§ HUDï¼šç§»é™¤ï¼ˆé¿å…èˆ‡æ§åˆ¶ä¸­å¿ƒé‡è¤‡ï¼‰ */
.hud{ display:none; }

/* å€’æ•¸ */
#countdownText{ position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); font-family:'Fredoka One',sans-serif; font-size:72px; color:#fff; text-shadow:2px 2px 8px #000; z-index:9; pointer-events:none; display:none; }
@keyframes popScale{ 0%{transform:translate(-50%,-50%) scale(.85)} 50%{transform:translate(-50%,-50%) scale(1.12)} 100%{transform:translate(-50%,-50%) scale(1)} }

/* å…¶ä»– */
#warnBanner{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:rgba(255,80,80,.95); padding:10px 14px; border-radius:8px; font-size:14px; display:none; z-index:200; }
.row{margin:8px 0} label{margin-right:6px}
select,input[type=range]{ padding:6px 10px; border-radius:6px; border:1px solid #445; background:#12152a; color:#fff; }
#songSelect{ width:90%; max-width:420px; height:280px; }

/* ===== æ§åˆ¶ä¸­å¿ƒï¼ˆä»»ä½•ç‰ˆé¢éƒ½å¯ç”¨ï¼›ç”¨ transform éš±è—/é¡¯ç¤ºï¼‰ ===== */
#landDock{ position:fixed; left:50%; top:0; transform:translate(-50%,-100%); transition:transform .24s ease; width:min(92vw, 560px); z-index:180; pointer-events:none; display:block; }
#landDock.open{ transform:translate(-50%,0); pointer-events:auto; }
#landDock .sheet{ margin:10px auto; background:rgba(20,26,44,.62); backdrop-filter:blur(10px); border:1px solid rgba(120,213,255,.20); border-radius:14px; padding:10px 12px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
#landDock .handleBar{ width:64px; height:6px; border-radius:999px; background:rgba(255,255,255,.65); margin:10px auto 12px; }
#landDock .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px 12px; text-align:left; }
#landDock .kv{ display:flex; justify-content:space-between; gap:10px; font-size:14px; }
#landDock .kv b{ opacity:.85; }
#landDock .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:8px; }
#landDock .actions button{ flex:1 1 180px; margin:0; }

/* æ§åˆ¶ä¸­å¿ƒé–‹é—œæŠŠæ‰‹ï¼ˆå®šä½ç”± JS ä¾èˆå°ä½ç½®å‹•æ…‹è¨­å®šï¼›åƒ…æ‰‹æ©Ÿæ©«ç‰ˆé¡¯ç¤ºï¼‰ */
#dockTopHandle{
  position:absolute; z-index:185; border-radius:999px;
  width:200px; height:28px; background:rgba(255,255,255,.08); backdrop-filter:blur(2px);
  display:none; cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,.25);
  left:50%; top:16px; transform:translate(-50%,0);
}
#dockTopHandle.show{ display:block; }
#dockTopHandle::after{
  content:''; display:block; width:64px; height:6px; border-radius:999px;
  background:rgba(255,255,255,.55); margin:11px auto;
}

/* é®ç½© */
#dockScrim{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.12); z-index:170; }
/* ç¢ºä¿ä¸»é¸å–®å±¤ç´šæ¯”ä»»ä½•æ®˜ç•™è¦†è“‹å±¤é«˜ï¼ˆè‹¥æœ‰ CSS é‚è¼¯å¤±èª¤æ™‚ä»å¯é»ï¼‰ */
#menuScreen,#optionsScreen,#musicScreen,#pauseScreen,#endScreen{ position:relative; z-index:200; }
#dockScrim.show{ display:block; }

/* ç•«é¢åˆ‡æ›é é¢ */
#menuScreen,#musicScreen,#endScreen,#optionsScreen,#pauseScreen{ padding-top:100px; }
button{ margin:10px; padding:10px 20px; font-size:18px; background:#78d5ff; border:none; border-radius:8px; cursor:pointer; }
.blur{ filter:blur(6px); pointer-events:none; user-select:none; }
</style>
</head>
<body>

<div id="languageSwitcher">
  <span class="lang-globe" aria-hidden="true"></span>
  <label for="languageSelect" id="languageLabel"><span id="languageLabelText" data-i18n="languageLabel">èªè¨€</span></label>
  <select id="languageSelect" aria-labelledby="languageLabel"></select>
</div>

<!-- ===== ä¸»é¸å–® ===== -->
<div id="menuScreen">
  <h1 data-i18n="menuTitle">ğŸµ DFJK</h1>
  <div class="row">
    <button id="btnStart" data-i18n="btnStart" onclick="window.__DFJK_API__?.startGame?.()">é–‹å§‹éŠæˆ²</button>
    <button id="btnMusic" data-i18n="btnMusic" onclick="window.__DFJK_API__?.toMusic?.()">éŸ³æ¨‚</button>
    <button id="btnOptions" data-i18n="btnOptions" onclick="window.__DFJK_API__?.toOpt?.()">é¸é …</button>
  </div>
  <div class="row"><span data-i18n="menuSelectedLabel">å·²é¸æ›²ç›®ï¼š</span><span id="menuChosenSong">å°šæœªé¸æ“‡</span></div>
</div>

<!-- ===== éŸ³æ¨‚é¸å–® ===== -->
<div id="musicScreen" style="display:none;">
  <h2 data-i18n="musicTitle">ğŸ¼ é¸æ“‡æœ¬å±€æ›²ç›®</h2>
  <div class="row"><select id="songSelect" size="12"></select></div>
  <div class="row">
    <button id="btnSongConfirm" data-i18n="btnConfirm">ç¢ºå®š</button>
    <button class="btnBackMenu" data-i18n="btnBackMenu">å›ä¸»é¸å–®</button>
  </div>
  <div class="row"><span data-i18n="musicChosenLabel">å·²é¸ï¼š</span><span id="chosenSongLabel">å°šæœªé¸æ“‡</span></div>
</div>

<!-- ===== é¸é … ===== -->
<div id="optionsScreen" style="display:none;">
  <h2 data-i18n="optionsTitle">âš™ï¸ éŠæˆ²é¸é …</h2>
  <div class="row">
    <label for="keyModeSelect" data-i18n="keyModeLabel">éµæ•¸ï¼š</label>
    <select id="keyModeSelect">
      <option value="4" selected data-i18n="keyOption4">4 éµï¼ˆDFJK / å¯ç”¨æ–¹å‘éµï¼‰</option>
      <option value="6" data-i18n="keyOption6">6 éµï¼ˆSDF JKLï¼‰</option>
      <option value="8" data-i18n="keyOption8">8 éµï¼ˆASDF JKL;ï¼‰</option>
    </select>
  </div>
  <div class="row">
    <label for="difficultySelect" data-i18n="difficultyLabel">é›£åº¦ï¼š</label>
    <select id="difficultySelect">
      <option value="ex" data-i18n="difficultyEx">EXï¼ˆæ¥µé™ï¼‰</option>
      <option value="hell" data-i18n="difficultyHell">åœ°ç„</option>
      <option value="hard" data-i18n="difficultyHard">å›°é›£</option>
      <option value="normal" data-i18n="difficultyNormal" selected>æ™®é€š</option>
      <option value="easy" data-i18n="difficultyEasy">ç°¡å–®</option>
      <option value="beginner" data-i18n="difficultyBeginner">åˆå­¸è€…</option>
    </select>
  </div>
  <div class="row">
    <label for="speedMultiplier" data-i18n="speedLabel">é€Ÿåº¦å€ç‡ï¼š</label>
    <select id="speedMultiplier">
      <option value="1" data-i18n="speedOptionStandard">1.0xï¼ˆæ¨™æº–ï¼‰</option><option value="1.1" data-i18n="speedOption11">1.1x</option><option value="1.2" data-i18n="speedOption12">1.2x</option>
      <option value="1.3" data-i18n="speedOption13">1.3x</option><option value="1.6" data-i18n="speedOption16">1.6x</option><option value="2.0" data-i18n="speedOption20">2.0x</option>
      <option value="2.2" data-i18n="speedOption22">2.2x</option><option value="2.4" data-i18n="speedOption24">2.4x</option><option value="2.6" data-i18n="speedOption26">2.6x</option>
      <option value="2.8" data-i18n="speedOption28">2.8x</option><option value="3.0" data-i18n="speedOption30">3.0x</option>
    </select>
  </div>
  <div class="row">
    <label for="noteDirection" data-i18n="noteDirectionLabel">éŸ³ç¬¦æ–¹å‘ï¼š</label>
    <select id="noteDirection">
      <option value="down" data-i18n="noteDirectionDown" selected>ä¸‹è½æ‰“æ“Š</option>
      <option value="up" data-i18n="noteDirectionUp">ä¸Šå‡æ‰“æ“Š</option>
    </select>
  </div>
  <div class="row">
    <label for="judgeMode" data-i18n="judgeModeLabel">åˆ¤å®šæ¨¡å¼ï¼š</label>
    <select id="judgeMode">
      <option value="old" data-i18n="judgeModeOld" selected>Old Inputï¼ˆå« WRONGï¼‰</option>
      <option value="new" data-i18n="judgeModeNew">New Input</option>
    </select>
  </div>
  <div class="row">
    <label for="volumeSlider" data-i18n="volumeLabel">ä¸»éŸ³é‡ï¼ˆBGMï¼‰ï¼š</label>
    <input id="volumeSlider" type="range" min="0" max="100" value="80"/>
    <span id="volumeLabel">80%</span>
  </div>
  <div class="row">
    <label for="sfxSlider" data-i18n="sfxLabel">æ•²æ“Šè²éŸ³é‡ï¼š</label>
    <input id="sfxSlider" type="range" min="0" max="100" value="70"/>
    <span id="sfxLabel">70%</span>
  </div>
  <hr class="row" style="opacity:.2"/>
  <h3 data-i18n="calibrationHeading">ğŸ¯ å‘½ä¸­å»¶é²æ ¡æ­£</h3>
  <div class="row">
    <label for="offsetSlider" data-i18n="offsetLabel">å…¨åŸŸåç§» (ms)ï¼š</label>
    <input id="offsetSlider" type="range" min="-600" max="600" value="0"/>
    <span id="offsetLabel">0 ms</span>
    <button id="offsetCalibBtn" type="button" data-i18n="offsetCalibBtn">å¿«é€Ÿæ ¡æ­£</button>
  </div>
  <hr class="row" style="opacity:.2"/>
  <div class="row">
    <label for="rgbCycleToggle" data-i18n="rgbLabel">RGB å¾ªç’°ç®­é ­è‰²ï¼š</label>
    <input id="rgbCycleToggle" type="checkbox"/>
  </div>
  <div class="row">
    <label for="hpToggle" data-i18n="hpLabel">è¡€æ¢æ¨¡å¼ï¼š</label>
    <input id="hpToggle" type="checkbox"/>
  </div>
  <div class="row">
    <label for="mobileFullHeight" data-i18n="mobileFullLabel">æ‰‹æ©Ÿå…¨é«˜ï¼ˆ>4éµæ¨è–¦ï¼‰ï¼š</label>
    <input id="mobileFullHeight" type="checkbox"/>
  </div>
  <div class="row">
    <label for="mobileLandscape" data-i18n="mobileLandscapeLabel">æ‰‹æ©Ÿæ©«æ¿æ¨¡å¼ï¼ˆÎ²ï¼Œæœªå‹¾é¸å‰‡è‡ªå‹•ä¾è¢å¹•æ–¹å‘ï¼‰ï¼š</label>
    <input id="mobileLandscape" type="checkbox"/>
  </div>
  <div class="row"><button class="btnBackMenu" data-i18n="btnBackMenu">å›ä¸»é¸å–®</button></div>
</div>

<!-- ===== éŠæˆ²ç•«é¢ ===== -->
<div id="gameScreen" style="display:none;position:relative;">
    <div class="topbar">
      <button id="ctrlButton" data-i18n="ctrlButton">âš™ï¸ æ§åˆ¶ä¸­å¿ƒ</button>
      <div class="top-mid">
        <div id="hpBar"><div id="hpFill"></div><div id="hpText">100/100</div></div>
      </div>
      <!-- å³å´ç•™ç™½ï¼Œç¶­æŒç½®ä¸­å°ç¨± -->
      <div style="width:84px"></div>
    </div>
    <div id="stageWrap">
      <div id="stage">
        <canvas id="gameCanvas" width="420" height="640"></canvas>
        <canvas id="uiCanvas"   width="420" height="640"></canvas>
        <div id="edgeFade"></div>
        <div class="hitbar"><div></div><div></div><div></div><div></div></div>
        <div id="countdownText">Ready</div>
      </div>
      <div id="hpFloat"><div id="hpFloatFill"></div><div id="hpFloatText">100/100</div></div>
      <div id="dockTopHandle" title="é»æˆ‘å±•é–‹æ§åˆ¶ä¸­å¿ƒ" data-i18n="dockHandleTitle"></div>
    </div>
  </div>

<!-- ===== æ§åˆ¶ä¸­å¿ƒï¼ˆæ¡Œæ©Ÿèˆ‡æ‰‹æ©Ÿçš†å¯ï¼‰ ===== -->
<div id="dockScrim"></div>
<div id="landDock" aria-label="æ§åˆ¶ä¸­å¿ƒ" data-i18n="ctrlButton" data-i18n-attr="aria-label">
  <div class="sheet">
    <div class="handleBar" id="dockHandle"></div>
    <div class="grid" id="dockGrid">
      <div class="kv"><b data-i18n="dockSong">æ›²ç›®</b><span id="dockSong">-</span></div>
      <div class="kv"><b data-i18n="dockLanes">éµæ•¸</b><span id="dockLanes">4</span></div>
      <div class="kv"><b data-i18n="dockDiff">é›£åº¦</b><span id="dockDiff">-</span></div>
      <div class="kv"><b data-i18n="dockDir">æ–¹å‘</b><span id="dockDir">-</span></div>
      <div class="kv"><b data-i18n="dockJudge">åˆ¤å®š</b><span id="dockJudge">-</span></div>
      <div class="kv"><b data-i18n="dockOffset">åç§»</b><span id="dockOffset">0 ms</span></div>
      <div class="kv"><b data-i18n="dockScore">åˆ†æ•¸</b><span id="dockScore">0</span></div>
      <div class="kv"><b data-i18n="dockCombo">é€£æ“Š</b><span id="dockCombo">0</span></div>
      <div class="kv"><b data-i18n="dockMiss">MISS</b><span id="dockMiss">0</span></div>
      <div class="kv"><b data-i18n="dockHeat">HEAT</b><span id="dockHeatState">ON</span></div>
    </div>
    <div class="actions">
      <button id="dockResume" data-i18n="dockResume">è¿”å›éŠæˆ²ï¼ˆ321ï¼‰</button>
      <button id="dockHeatToggle" data-i18n="dockHeatToggle">HEAT é–‹/é—œ</button>
      <button id="dockToMenu" data-i18n="dockToMenu">è¿”å›ä¸»ç•«é¢</button>
    </div>
  </div>
</div>

<!-- ===== æš«åœï¼ˆä¿ç•™é é¢ï¼Œä½†ä¸å†ç”¨æŒ‰éˆ•é€²å…¥ï¼›ç”±æ§åˆ¶ä¸­å¿ƒå–ä»£ï¼‰ ===== -->
<div id="pauseScreen" style="display:none;">
  <h2 data-i18n="pauseTitle">â¸ï¸ éŠæˆ²æš«åœ</h2>
  <button id="btnResume" data-i18n="btnResume">â–¶ï¸ ç¹¼çºŒ</button>
  <button class="btnBackMenu" data-i18n="btnBackMenu">å›ä¸»é¸å–®</button>
</div>

<!-- ===== çµæŸ ===== -->
<div id="endScreen" style="display:none;">
  <h2 data-i18n="endTitle">ğŸ® éŠæˆ²çµæŸï¼</h2>
  <p><span data-i18n="finalSongLabel">æ›²ç›®ï¼š</span><span id="finalSong">-</span></p>
  <p><span data-i18n="finalDiffLabel">é›£åº¦ï¼š</span><span id="finalDiff">-</span></p>
  <p><span data-i18n="finalDirLabel">æ–¹å‘ï¼š</span><span id="finalDir">-</span></p>
  <p><span data-i18n="finalJudgeLabel">åˆ¤å®šï¼š</span><span id="finalJudge">-</span></p>
  <p><span data-i18n="finalScoreLabel">åˆ†æ•¸ï¼š</span><span id="finalScore">0</span></p>
  <p><span data-i18n="statSickLabel">SICKï¼š</span><span id="statSick">0</span></p>
  <p><span data-i18n="statGoodLabel">GOODï¼š</span><span id="statGood">0</span></p>
  <p><span data-i18n="statBadLabel">BADï¼š</span><span id="statBad">0</span></p>
  <p><span data-i18n="statShitLabel">SHITï¼š</span><span id="statShit">0</span></p>
  <p><span data-i18n="statMissLabel">MISSï¼š</span><span id="statMiss">0</span></p>
  <button id="btnRestart" data-i18n="btnRestart">å†ç©ä¸€æ¬¡</button>
  <button class="btnBackMenu" data-i18n="btnBackMenu">å›ä¸»é¸å–®</button>
</div>

<!-- ===== æ ¡æ­£è¦†è“‹å±¤ ===== -->
<div id="calibOverlay" style="position:fixed; inset:0; display:none; z-index:220; background:rgba(3,7,15,.86); backdrop-filter:blur(2px);">
  <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(520px,92vw); padding:18px 16px; border-radius:12px; background:rgba(10,16,30,.9); box-shadow:0 10px 40px rgba(0,0,0,.4); border:1px solid rgba(120,213,255,.3);">
    <div style="font-size:22px; margin:6px 0 4px;" data-i18n="calibrationTitle">ğŸ¯ å¿«é€Ÿæ ¡æ­£</div>
    <div style="opacity:.85; font-size:14px; margin-bottom:8px;" data-i18n="calibrationHint">è·Ÿè‘—ç¯€æ‹ï¼ˆæ¯æ‹ 1000msï¼‰æŒ‰ DFJK æˆ–é»ç•«é¢ï¼Œè‡³å°‘ 10 æ¬¡å¾Œå¯å®Œæˆã€‚ä¸­ä½æ•¸ + MAD å»æ¥µå€¼ã€‚</div>
    <div id="calibBeatDot" style="width:26px; height:26px; border-radius:50%; margin:12px auto; background:#78d5ff; box-shadow:0 0 30px rgba(120,213,255,.95);"></div>
    <div id="calibBig" style="font:700 44px/1.2 'Fredoka One',sans-serif; margin:8px 0 2px;">å¾…æ©Ÿ</div>
    <div id="calibStat" style="font:14px/1.4 monospace; opacity:.95; margin:2px 0 10px;">0/10ã€€å»ºè­°åç§»ï¼šâ€”</div>
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button id="calibStart"  class="calibBtn" style="flex:1 1 140px; padding:14px 12px; font-size:18px; border-radius:10px; border:none; background:#78d5ff; cursor:pointer;" data-i18n="calibStart">é–‹å§‹</button>
      <button id="calibFinish" class="calibBtn" style="flex:1 1 140px; padding:14px 12px; font-size:18px; border-radius:10px; border:none; background:#ffc857; cursor:pointer;" disabled data-i18n="calibFinish">å®Œæˆ</button>
      <button id="calibCancel" class="calibBtn" style="flex:1 1 140px; padding:14px 12px; font-size:18px; border-radius:10px; border:none; background:#ff6b6b; cursor:pointer;" data-i18n="calibCancel">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<audio id="bgm" preload="auto"></audio>
<div id="warnBanner" data-i18n="warnBanner">âš ï¸ æç¤º</div>

<script>
/* ======================= é˜²äºŒæ¬¡å®£å‘Šï¼šAbortController + å–®ä¾‹ç‹€æ…‹ ======================= */
(() => {
  // å¼·åŒ–å–®ä¾‹å®ˆè¡›ï¼šä»»ä½•å†æ¬¡æ³¨å…¥æœƒå…ˆå‘¼å«èˆŠå¯¦ä¾‹çš„ abort()ï¼Œé¿å…ã€ŒäºŒæ¬¡å®£å‘Šã€
  try { window.__DFJK_V11__?.abort(); } catch {}
  const CTRL = new AbortController();
  window.__DFJK_V11__ = { abort: () => CTRL.abort(), version: 'v11' };
  const SIG = CTRL.signal;
  const addEv = (target, type, handler, opts={}) => {
    if(!target) return; // ç›®æ¨™ä¸å­˜åœ¨å°±ç•¥éï¼Œé¿å…éŒ¯èª¤
    try{ target.addEventListener(type, handler, {...opts, signal: SIG}); }catch{ target.addEventListener(type, handler, opts); }
  };

  const LANG_ORDER = ['en','zh-Hant','zh-Hans','de','ja','ko','fr','ru','th','vi'];
  const I18N = {};
  const DEFAULT_LANG = 'zh-Hant';
  const SPEED_KEYS = ['11','12','13','16','20','22','24','26','28','30'];

  function defineLang(code, data){ I18N[code] = data; }
  function fallbackLang(){ return I18N[DEFAULT_LANG]; }
  function formatStr(str, params={}){
    if(typeof str !== 'string') return '';
    return str.replace(/\{\{(\w+)\}\}/g, (_,k)=> (params && Object.prototype.hasOwnProperty.call(params,k)) ? String(params[k]) : '');
  }
  function getLang(){ return I18N[currentLang] || fallbackLang(); }
  function getString(key){
    const lang = getLang();
    if(lang?.strings && Object.prototype.hasOwnProperty.call(lang.strings,key)) return lang.strings[key];
    const fb = fallbackLang();
    return fb?.strings?.[key] ?? '';
  }
  function getDynamic(key, params){
    const lang = getLang();
    let str = lang?.dynamic && Object.prototype.hasOwnProperty.call(lang.dynamic,key) ? lang.dynamic[key] : undefined;
    if(str === undefined){
      const fb = fallbackLang();
      str = fb?.dynamic?.[key];
    }
    return formatStr(str ?? '', params);
  }

  function formatOffset(value, opts={}){
    const num = Number(value);
    const safe = Number.isFinite(num) ? num : 0;
    const key = opts.signed ? 'offsetSigned' : 'offsetValue';
    const formattedValue = opts.signed
      ? (safe > 0 ? `+${safe}` : safe < 0 ? `${safe}` : '0')
      : String(safe);
    return getDynamic(key, { value: formattedValue });
  }

  defineLang('zh-Hant', {
    nativeName: 'ç¹é«”ä¸­æ–‡',
    languageWord: 'èªè¨€',
    htmlLang: 'zh-Hant',
    fontFamily: "'Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif",
    docTitle: 'DFJK â€” æ§åˆ¶ä¸­å¿ƒç¯€å¥éŠæˆ²',
    strings: {
      docTitle: 'DFJK â€” æ§åˆ¶ä¸­å¿ƒç¯€å¥éŠæˆ²',
      languageLabel: 'èªè¨€',
      menuTitle: 'ğŸµ DFJK',
      btnStart: 'é–‹å§‹éŠæˆ²',
      btnMusic: 'éŸ³æ¨‚',
      btnOptions: 'é¸é …',
      menuSelectedLabel: 'å·²é¸æ›²ç›®ï¼š',
      musicTitle: 'ğŸ¼ é¸æ“‡æœ¬å±€æ›²ç›®',
      btnConfirm: 'ç¢ºå®š',
      btnBackMenu: 'å›ä¸»é¸å–®',
      musicChosenLabel: 'å·²é¸ï¼š',
      optionsTitle: 'âš™ï¸ éŠæˆ²é¸é …',
      keyModeLabel: 'éµæ•¸ï¼š',
      keyOption4: '4 éµï¼ˆDFJK / å¯ç”¨æ–¹å‘éµï¼‰',
      keyOption6: '6 éµï¼ˆSDF JKLï¼‰',
      keyOption8: '8 éµï¼ˆASDF JKL;ï¼‰',
      difficultyLabel: 'é›£åº¦ï¼š',
      difficultyEx: 'EXï¼ˆæ¥µé™ï¼‰',
      difficultyHell: 'åœ°ç„',
      difficultyHard: 'å›°é›£',
      difficultyNormal: 'æ™®é€š',
      difficultyEasy: 'ç°¡å–®',
      difficultyBeginner: 'åˆå­¸è€…',
      speedLabel: 'é€Ÿåº¦å€ç‡ï¼š',
      speedOptionStandard: '1.0xï¼ˆæ¨™æº–ï¼‰',
      noteDirectionLabel: 'éŸ³ç¬¦æ–¹å‘ï¼š',
      noteDirectionDown: 'ä¸‹è½æ‰“æ“Š',
      noteDirectionUp: 'ä¸Šå‡æ‰“æ“Š',
      judgeModeLabel: 'åˆ¤å®šæ¨¡å¼ï¼š',
      judgeModeOld: 'Old Inputï¼ˆå« WRONGï¼‰',
      judgeModeNew: 'New Input',
      volumeLabel: 'ä¸»éŸ³é‡ï¼ˆBGMï¼‰ï¼š',
      sfxLabel: 'æ•²æ“Šè²éŸ³é‡ï¼š',
      calibrationHeading: 'ğŸ¯ å‘½ä¸­å»¶é²æ ¡æ­£',
      offsetLabel: 'å…¨åŸŸåç§» (ms)ï¼š',
      offsetCalibBtn: 'å¿«é€Ÿæ ¡æ­£',
      rgbLabel: 'RGB å¾ªç’°ç®­é ­è‰²ï¼š',
      hpLabel: 'è¡€æ¢æ¨¡å¼ï¼š',
      mobileFullLabel: 'æ‰‹æ©Ÿå…¨é«˜ï¼ˆ>4éµæ¨è–¦ï¼‰ï¼š',
      mobileLandscapeLabel: 'æ‰‹æ©Ÿæ©«æ¿æ¨¡å¼ï¼ˆÎ²ï¼Œæœªå‹¾é¸å‰‡è‡ªå‹•ä¾è¢å¹•æ–¹å‘ï¼‰ï¼š',
      ctrlButton: 'âš™ï¸ æ§åˆ¶ä¸­å¿ƒ',
      dockHandleTitle: 'é»æˆ‘å±•é–‹æ§åˆ¶ä¸­å¿ƒ',
      dockSong: 'æ›²ç›®',
      dockLanes: 'éµæ•¸',
      dockDiff: 'é›£åº¦',
      dockDir: 'æ–¹å‘',
      dockJudge: 'åˆ¤å®š',
      dockOffset: 'åç§»',
      dockScore: 'åˆ†æ•¸',
      dockCombo: 'é€£æ“Š',
      dockMiss: 'MISS',
      dockHeat: 'HEAT',
      dockResume: 'è¿”å›éŠæˆ²ï¼ˆ321ï¼‰',
      dockHeatToggle: 'HEAT é–‹/é—œ',
      dockToMenu: 'è¿”å›ä¸»ç•«é¢',
      pauseTitle: 'â¸ï¸ éŠæˆ²æš«åœ',
      btnResume: 'â–¶ï¸ ç¹¼çºŒ',
      endTitle: 'ğŸ® éŠæˆ²çµæŸï¼',
      finalSongLabel: 'æ›²ç›®ï¼š',
      finalDiffLabel: 'é›£åº¦ï¼š',
      finalDirLabel: 'æ–¹å‘ï¼š',
      finalJudgeLabel: 'åˆ¤å®šï¼š',
      finalScoreLabel: 'åˆ†æ•¸ï¼š',
      statSickLabel: 'SICKï¼š',
      statGoodLabel: 'GOODï¼š',
      statBadLabel: 'BADï¼š',
      statShitLabel: 'SHITï¼š',
      statMissLabel: 'MISSï¼š',
      btnRestart: 'å†ç©ä¸€æ¬¡',
      calibrationTitle: 'ğŸ¯ å¿«é€Ÿæ ¡æ­£',
      calibrationHint: 'è·Ÿè‘—ç¯€æ‹ï¼ˆæ¯æ‹ 1000msï¼‰æŒ‰ DFJK æˆ–é»ç•«é¢ï¼Œè‡³å°‘ 10 æ¬¡å¾Œå¯å®Œæˆã€‚ä¸­ä½æ•¸ + MAD å»æ¥µå€¼ã€‚',
      calibStart: 'é–‹å§‹',
      calibFinish: 'å®Œæˆ',
      calibCancel: 'å–æ¶ˆ',
      warnBanner: 'âš ï¸ æç¤º'
    },
    dynamic: {
      menuSelectedNone: 'å°šæœªé¸æ“‡',
      musicPlaceholder: 'â€” è«‹é¸æ“‡æ›²ç›® â€”',
      alertSelectSong: 'è«‹å…ˆé¸æ“‡éŸ³æ¨‚',
      countdownReady: 'æº–å‚™',
      countdownGo: 'é–‹å§‹ï¼',
      heatOn: 'ç†±åœ–ï¼šON',
      heatOff: 'ç†±åœ–ï¼šOFF',
      heatPosition: 'ç†±åœ–ä½ç½®ï¼š{{position}}',
      heatAuto: 'è‡ªå‹•',
      heatTop: 'ç½®é ‚',
      heatBottom: 'ç½®åº•',
      appliedOffset: 'å·²å¥—ç”¨åç§»ï¼š{{value}} ms',
      offsetValue: '{{value}} ms',
      offsetSigned: '{{value}} ms',
      keyChanged: 'éµæ•¸åˆ‡æ›ç‚º {{value}}',
      mobileOnly: 'æ­¤é¸é …åªåœ¨è¡Œå‹•è£ç½®ç”Ÿæ•ˆ',
      needPauseForCalib: 'è«‹å…ˆé€€å‡ºæˆ–æš«åœéŠæˆ²å†æ ¡æ­£',
      calibrationReady: 'å¾…æ©Ÿ',
      calibrationStats: '{{count}}/{{total}} å»ºè­°åç§»ï¼š{{advice}}',
      calibrationAdviceNone: 'â€”',
      exFailed: 'ä½ è¼¸äº†ï¼EX MISS > 15',
      hpDepleted: 'HP è€—ç›¡',
      heatStatusOn: 'ON',
      heatStatusOff: 'OFF',
      directionUp: 'ä¸Šå‡',
      directionDown: 'ä¸‹è½',
      judgeOld: 'Old',
      judgeNew: 'New',
      heatmapTitle: 'Hit åç§»ç†±åœ– (ms)',
      heatmapStats: 'avg:{{avg}} Ïƒ:{{std}} åç§»:{{offset}}ms'
    }
  });

  defineLang('zh-Hans', {
    nativeName: 'ç®€ä½“ä¸­æ–‡',
    languageWord: 'è¯­è¨€',
    htmlLang: 'zh-Hans',
    fontFamily: "'Noto Sans SC','Microsoft YaHei','PingFang SC','Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif",
    docTitle: 'DFJK â€” æ§åˆ¶ä¸­å¿ƒèŠ‚å¥æ¸¸æˆ',
    strings: {
      docTitle: 'DFJK â€” æ§åˆ¶ä¸­å¿ƒèŠ‚å¥æ¸¸æˆ',
      languageLabel: 'è¯­è¨€',
      menuTitle: 'ğŸµ DFJK',
      btnStart: 'å¼€å§‹æ¸¸æˆ',
      btnMusic: 'éŸ³ä¹',
      btnOptions: 'é€‰é¡¹',
      menuSelectedLabel: 'å·²é€‰æ›²ç›®ï¼š',
      musicTitle: 'ğŸ¼ é€‰æ‹©æœ¬å±€æ›²ç›®',
      btnConfirm: 'ç¡®å®š',
      btnBackMenu: 'å›ä¸»èœå•',
      musicChosenLabel: 'å·²é€‰ï¼š',
      optionsTitle: 'âš™ï¸ æ¸¸æˆé€‰é¡¹',
      keyModeLabel: 'é”®æ•°ï¼š',
      keyOption4: '4 é”®ï¼ˆDFJK / å¯ç”¨æ–¹å‘é”®ï¼‰',
      keyOption6: '6 é”®ï¼ˆSDF JKLï¼‰',
      keyOption8: '8 é”®ï¼ˆASDF JKL;ï¼‰',
      difficultyLabel: 'éš¾åº¦ï¼š',
      difficultyEx: 'EXï¼ˆæé™ï¼‰',
      difficultyHell: 'åœ°ç‹±',
      difficultyHard: 'å›°éš¾',
      difficultyNormal: 'æ™®é€š',
      difficultyEasy: 'ç®€å•',
      difficultyBeginner: 'åˆå­¦è€…',
      speedLabel: 'é€Ÿåº¦å€ç‡ï¼š',
      speedOptionStandard: '1.0xï¼ˆæ ‡å‡†ï¼‰',
      noteDirectionLabel: 'éŸ³ç¬¦æ–¹å‘ï¼š',
      noteDirectionDown: 'ä¸‹è½æ‰“å‡»',
      noteDirectionUp: 'ä¸Šå‡æ‰“å‡»',
      judgeModeLabel: 'åˆ¤å®šæ¨¡å¼ï¼š',
      judgeModeOld: 'Old Inputï¼ˆå« WRONGï¼‰',
      judgeModeNew: 'New Input',
      volumeLabel: 'ä¸»éŸ³é‡ï¼ˆBGMï¼‰ï¼š',
      sfxLabel: 'æ•²å‡»å£°éŸ³é‡ï¼š',
      calibrationHeading: 'ğŸ¯ å‘½ä¸­å»¶è¿Ÿæ ¡æ­£',
      offsetLabel: 'å…¨åŸŸåç§» (ms)ï¼š',
      offsetCalibBtn: 'å¿«é€Ÿæ ¡æ­£',
      rgbLabel: 'RGB å¾ªç¯ç®­å¤´è‰²ï¼š',
      hpLabel: 'è¡€æ¡æ¨¡å¼ï¼š',
      mobileFullLabel: 'æ‰‹æœºå…¨é«˜ï¼ˆ>4é”®æ¨èï¼‰ï¼š',
      mobileLandscapeLabel: 'æ‰‹æœºæ¨ªå±æ¨¡å¼ï¼ˆÎ²ï¼Œæœªå‹¾é€‰åˆ™è‡ªåŠ¨ä¾å±å¹•æ–¹å‘ï¼‰ï¼š',
      ctrlButton: 'âš™ï¸ æ§åˆ¶ä¸­å¿ƒ',
      dockHandleTitle: 'ç‚¹æˆ‘å±•å¼€æ§åˆ¶ä¸­å¿ƒ',
      dockSong: 'æ›²ç›®',
      dockLanes: 'é”®æ•°',
      dockDiff: 'éš¾åº¦',
      dockDir: 'æ–¹å‘',
      dockJudge: 'åˆ¤å®š',
      dockOffset: 'åç§»',
      dockScore: 'åˆ†æ•°',
      dockCombo: 'è¿å‡»',
      dockMiss: 'MISS',
      dockHeat: 'HEAT',
      dockResume: 'è¿”å›æ¸¸æˆï¼ˆ321ï¼‰',
      dockHeatToggle: 'HEAT å¼€/å…³',
      dockToMenu: 'è¿”å›ä¸»ç”»é¢',
      pauseTitle: 'â¸ï¸ æ¸¸æˆæš‚åœ',
      btnResume: 'â–¶ï¸ ç»§ç»­',
      endTitle: 'ğŸ® æ¸¸æˆç»“æŸï¼',
      finalSongLabel: 'æ›²ç›®ï¼š',
      finalDiffLabel: 'éš¾åº¦ï¼š',
      finalDirLabel: 'æ–¹å‘ï¼š',
      finalJudgeLabel: 'åˆ¤å®šï¼š',
      finalScoreLabel: 'åˆ†æ•°ï¼š',
      statSickLabel: 'SICKï¼š',
      statGoodLabel: 'GOODï¼š',
      statBadLabel: 'BADï¼š',
      statShitLabel: 'SHITï¼š',
      statMissLabel: 'MISSï¼š',
      btnRestart: 'å†ç©ä¸€æ¬¡',
      calibrationTitle: 'ğŸ¯ å¿«é€Ÿæ ¡æ­£',
      calibrationHint: 'è·Ÿç€èŠ‚æ‹ï¼ˆæ¯æ‹ 1000msï¼‰æŒ‰ DFJK æˆ–ç‚¹ç”»é¢ï¼Œè‡³å°‘ 10 æ¬¡åå¯å®Œæˆã€‚ä¸­ä½æ•° + MAD å»æå€¼ã€‚',
      calibStart: 'å¼€å§‹',
      calibFinish: 'å®Œæˆ',
      calibCancel: 'å–æ¶ˆ',
      warnBanner: 'âš ï¸ æç¤º'
    },
    dynamic: {
      menuSelectedNone: 'å°šæœªé€‰æ‹©',
      musicPlaceholder: 'â€” è¯·é€‰æ‹©æ›²ç›® â€”',
      alertSelectSong: 'è¯·å…ˆé€‰æ‹©éŸ³ä¹',
      countdownReady: 'å‡†å¤‡',
      countdownGo: 'å¼€å§‹ï¼',
      heatOn: 'çƒ­å›¾ï¼šON',
      heatOff: 'çƒ­å›¾ï¼šOFF',
      heatPosition: 'çƒ­å›¾ä½ç½®ï¼š{{position}}',
      heatAuto: 'è‡ªåŠ¨',
      heatTop: 'ç½®é¡¶',
      heatBottom: 'ç½®åº•',
      appliedOffset: 'å·²å¥—ç”¨åç§»ï¼š{{value}} ms',
      offsetValue: '{{value}} ms',
      offsetSigned: '{{value}} ms',
      keyChanged: 'é”®æ•°åˆ‡æ¢ä¸º {{value}}',
      mobileOnly: 'æ­¤é€‰é¡¹åªåœ¨è¡ŒåŠ¨è£…ç½®ç”Ÿæ•ˆ',
      needPauseForCalib: 'è¯·å…ˆé€€å‡ºæˆ–æš‚åœæ¸¸æˆå†æ ¡æ­£',
      calibrationReady: 'å¾…æœº',
      calibrationStats: '{{count}}/{{total}} å»ºè®®åç§»ï¼š{{advice}}',
      calibrationAdviceNone: 'â€”',
      exFailed: 'ä½ è¾“äº†ï¼EX MISS > 15',
      hpDepleted: 'HP è€—å°½',
      heatStatusOn: 'ON',
      heatStatusOff: 'OFF',
      directionUp: 'ä¸Šå‡',
      directionDown: 'ä¸‹è½',
      judgeOld: 'Old',
      judgeNew: 'New',
      heatmapTitle: 'Hit åç§»çƒ­å›¾ (ms)',
      heatmapStats: 'avg:{{avg}} Ïƒ:{{std}} åç§»:{{offset}}ms'
    }
  });

  defineLang('en', {
    nativeName: 'English',
    zhLabel: 'è‹±æ–‡',
    languageWord: 'Language',
    htmlLang: 'en',
    fontFamily: "'Segoe UI','Helvetica Neue',Arial,'Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif",
    docTitle: 'DFJK â€” Rhythm Control Center',
    strings: {
      docTitle: 'DFJK â€” Rhythm Control Center',
      languageLabel: 'Language',
      menuTitle: 'ğŸµ DFJK',
      btnStart: 'Start Game',
      btnMusic: 'Music',
      btnOptions: 'Options',
      menuSelectedLabel: 'Selected song:',
      musicTitle: 'ğŸ¼ Choose a Track',
      btnConfirm: 'Confirm',
      btnBackMenu: 'Back to Menu',
      musicChosenLabel: 'Picked:',
      optionsTitle: 'âš™ï¸ Game Options',
      keyModeLabel: 'Keys:',
      keyOption4: '4 Keys (DFJK / arrow keys usable)',
      keyOption6: '6 Keys (SDF JKL)',
      keyOption8: '8 Keys (ASDF JKL;)',
      difficultyLabel: 'Difficulty:',
      difficultyEx: 'EX (Extreme)',
      difficultyHell: 'Hell',
      difficultyHard: 'Hard',
      difficultyNormal: 'Normal',
      difficultyEasy: 'Easy',
      difficultyBeginner: 'Beginner',
      speedLabel: 'Scroll Speed:',
      speedOptionStandard: '1.0x (Standard)',
      noteDirectionLabel: 'Note Direction:',
      noteDirectionDown: 'Falling notes',
      noteDirectionUp: 'Rising notes',
      judgeModeLabel: 'Judgement Mode:',
      judgeModeOld: 'Old Input (with WRONG)',
      judgeModeNew: 'New Input',
      volumeLabel: 'Master Volume (BGM):',
      sfxLabel: 'Hit Sound Volume:',
      calibrationHeading: 'ğŸ¯ Timing Calibration',
      offsetLabel: 'Global Offset (ms):',
      offsetCalibBtn: 'Quick Calibrate',
      rgbLabel: 'RGB cycling arrow colors:',
      hpLabel: 'HP mode:',
      mobileFullLabel: 'Mobile full height (>4 keys recommended):',
      mobileLandscapeLabel: 'Mobile landscape mode (beta, auto by orientation when off):',
      ctrlButton: 'âš™ï¸ Control Center',
      dockHandleTitle: 'Tap to open Control Center',
      dockSong: 'Song',
      dockLanes: 'Keys',
      dockDiff: 'Difficulty',
      dockDir: 'Direction',
      dockJudge: 'Judge',
      dockOffset: 'Offset',
      dockScore: 'Score',
      dockCombo: 'Combo',
      dockMiss: 'MISS',
      dockHeat: 'HEAT',
      dockResume: 'Back to Game (321)',
      dockHeatToggle: 'Toggle HEAT',
      dockToMenu: 'Return to Menu',
      pauseTitle: 'â¸ï¸ Game Paused',
      btnResume: 'â–¶ï¸ Resume',
      endTitle: 'ğŸ® Game Over!',
      finalSongLabel: 'Song:',
      finalDiffLabel: 'Difficulty:',
      finalDirLabel: 'Direction:',
      finalJudgeLabel: 'Judgement:',
      finalScoreLabel: 'Score:',
      statSickLabel: 'SICK:',
      statGoodLabel: 'GOOD:',
      statBadLabel: 'BAD:',
      statShitLabel: 'SHIT:',
      statMissLabel: 'MISS:',
      btnRestart: 'Play Again',
      calibrationTitle: 'ğŸ¯ Quick Calibration',
      calibrationHint: 'Follow the beat (1000 ms per beat) and tap DFJK or the screen at least 10 times. Median + MAD removes outliers.',
      calibStart: 'Start',
      calibFinish: 'Finish',
      calibCancel: 'Cancel',
      warnBanner: 'âš ï¸ Notice'
    },
    dynamic: {
      menuSelectedNone: 'Not selected yet',
      musicPlaceholder: 'â€” Choose a track â€”',
      alertSelectSong: 'Please select a song first',
      countdownReady: 'Ready',
      countdownGo: 'Go!',
      heatOn: 'Heatmap: ON',
      heatOff: 'Heatmap: OFF',
      heatPosition: 'Heatmap position: {{position}}',
      heatAuto: 'Auto',
      heatTop: 'Top',
      heatBottom: 'Bottom',
      appliedOffset: 'Offset applied: {{value}} ms',
      offsetValue: '{{value}} ms',
      offsetSigned: '{{value}} ms',
      keyChanged: 'Key mode switched to {{value}}',
      mobileOnly: 'This option only works on mobile devices',
      needPauseForCalib: 'Please leave or pause the game before calibrating',
      calibrationReady: 'Standby',
      calibrationStats: '{{count}}/{{total}} Suggested offset: {{advice}}',
      calibrationAdviceNone: 'â€”',
      exFailed: 'You lost! EX MISS > 15',
      hpDepleted: 'HP depleted',
      heatStatusOn: 'ON',
      heatStatusOff: 'OFF',
      directionUp: 'Upward',
      directionDown: 'Downward',
      judgeOld: 'Old',
      judgeNew: 'New',
      heatmapTitle: 'Hit Offset Heatmap (ms)',
      heatmapStats: 'avg:{{avg}} Ïƒ:{{std}} offset:{{offset}}ms'
    }
  });

  defineLang('de', {
    nativeName: 'Deutsch',
    zhLabel: 'å¾·æ–‡',
    languageWord: 'Sprache',
    htmlLang: 'de',
    fontFamily: "'Fira Sans','Segoe UI','Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif",
    docTitle: 'DFJK â€” Rhythmus-Kontrollzentrum',
    strings: {
      docTitle: 'DFJK â€” Rhythmus-Kontrollzentrum',
      languageLabel: 'Sprache',
      menuTitle: 'ğŸµ DFJK',
      btnStart: 'Spiel starten',
      btnMusic: 'Musik',
      btnOptions: 'Optionen',
      menuSelectedLabel: 'GewÃ¤hlter Titel:',
      musicTitle: 'ğŸ¼ Titel auswÃ¤hlen',
      btnConfirm: 'BestÃ¤tigen',
      btnBackMenu: 'ZurÃ¼ck zum MenÃ¼',
      musicChosenLabel: 'AusgewÃ¤hlt:',
      optionsTitle: 'âš™ï¸ Spieleinstellungen',
      keyModeLabel: 'Tasten:',
      keyOption4: '4 Tasten (DFJK / Pfeiltasten mÃ¶glich)',
      keyOption6: '6 Tasten (SDF JKL)',
      keyOption8: '8 Tasten (ASDF JKL;)',
      difficultyLabel: 'Schwierigkeit:',
      difficultyEx: 'EX (Extrem)',
      difficultyHell: 'HÃ¶lle',
      difficultyHard: 'Schwer',
      difficultyNormal: 'Normal',
      difficultyEasy: 'Leicht',
      difficultyBeginner: 'AnfÃ¤nger',
      speedLabel: 'Scroll-Geschwindigkeit:',
      speedOptionStandard: '1.0x (Standard)',
      noteDirectionLabel: 'Notenrichtung:',
      noteDirectionDown: 'Fallende Noten',
      noteDirectionUp: 'Steigende Noten',
      judgeModeLabel: 'Bewertungsmodus:',
      judgeModeOld: 'Old Input (mit WRONG)',
      judgeModeNew: 'New Input',
      volumeLabel: 'Master-LautstÃ¤rke (BGM):',
      sfxLabel: 'TrefferlautstÃ¤rke:',
      calibrationHeading: 'ğŸ¯ Timing-Kalibrierung',
      offsetLabel: 'Globaler Offset (ms):',
      offsetCalibBtn: 'Schnell kalibrieren',
      rgbLabel: 'RGB-Farbwechsel fÃ¼r Pfeile:',
      hpLabel: 'HP-Modus:',
      mobileFullLabel: 'VollhÃ¶he auf MobilgerÃ¤ten (>4 Tasten empfohlen):',
      mobileLandscapeLabel: 'Mobiles Querformat (Beta, sonst automatisch):',
      ctrlButton: 'âš™ï¸ Kontrollzentrum',
      dockHandleTitle: 'Zum Ã–ffnen des Kontrollzentrums tippen',
      dockSong: 'Titel',
      dockLanes: 'Tasten',
      dockDiff: 'Schwierigkeit',
      dockDir: 'Richtung',
      dockJudge: 'Bewertung',
      dockOffset: 'Offset',
      dockScore: 'Punkte',
      dockCombo: 'Combo',
      dockMiss: 'MISS',
      dockHeat: 'HEAT',
      dockResume: 'ZurÃ¼ck zum Spiel (321)',
      dockHeatToggle: 'HEAT umschalten',
      dockToMenu: 'Zum HauptmenÃ¼',
      pauseTitle: 'â¸ï¸ Spiel pausiert',
      btnResume: 'â–¶ï¸ Fortsetzen',
      endTitle: 'ğŸ® Spiel vorbei!',
      finalSongLabel: 'Titel:',
      finalDiffLabel: 'Schwierigkeit:',
      finalDirLabel: 'Richtung:',
      finalJudgeLabel: 'Bewertung:',
      finalScoreLabel: 'Punkte:',
      statSickLabel: 'SICK:',
      statGoodLabel: 'GOOD:',
      statBadLabel: 'BAD:',
      statShitLabel: 'SHIT:',
      statMissLabel: 'MISS:',
      btnRestart: 'Erneut spielen',
      calibrationTitle: 'ğŸ¯ Schnellkalibrierung',
      calibrationHint: 'Folge dem Beat (1000 ms pro Schlag) und tippe mindestens 10-mal DFJK oder den Bildschirm. Median + MAD entfernt AusreiÃŸer.',
      calibStart: 'Start',
      calibFinish: 'Fertig',
      calibCancel: 'Abbrechen',
      warnBanner: 'âš ï¸ Hinweis'
    },
    dynamic: {
      menuSelectedNone: 'Noch nichts gewÃ¤hlt',
      musicPlaceholder: 'â€” Titel auswÃ¤hlen â€”',
      alertSelectSong: 'Bitte zuerst einen Titel wÃ¤hlen',
      countdownReady: 'Bereit',
      countdownGo: 'Los!',
      heatOn: 'Heatmap: AN',
      heatOff: 'Heatmap: AUS',
      heatPosition: 'Heatmap-Position: {{position}}',
      heatAuto: 'Auto',
      heatTop: 'Oben',
      heatBottom: 'Unten',
      appliedOffset: 'Offset gesetzt: {{value}} ms',
      offsetValue: '{{value}} ms',
      offsetSigned: '{{value}} ms',
      keyChanged: 'Tastenanzahl auf {{value}} geÃ¤ndert',
      mobileOnly: 'Diese Option funktioniert nur auf MobilgerÃ¤ten',
      needPauseForCalib: 'Bitte Spiel verlassen oder pausieren, bevor kalibriert wird',
      calibrationReady: 'Bereit',
      calibrationStats: '{{count}}/{{total}} Empfohlener Offset: {{advice}}',
      calibrationAdviceNone: 'â€”',
      exFailed: 'Du hast verloren! EX MISS > 15',
      hpDepleted: 'HP aufgebraucht',
      heatStatusOn: 'AN',
      heatStatusOff: 'AUS',
      directionUp: 'AufwÃ¤rts',
      directionDown: 'AbwÃ¤rts',
      judgeOld: 'Old',
      judgeNew: 'New',
      heatmapTitle: 'Hit-Offset-Heatmap (ms)',
      heatmapStats: 'avg:{{avg}} Ïƒ:{{std}} Offset:{{offset}}ms'
    }
  });

  defineLang('ja', {
    nativeName: 'æ—¥æœ¬èª',
    zhLabel: 'æ—¥æ–‡',
    languageWord: 'è¨€èª',
    htmlLang: 'ja',
    fontFamily: "'Noto Sans JP','Hiragino Kaku Gothic ProN','Yu Gothic','Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif",
    docTitle: 'DFJK â€” ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼',
    strings: {
      docTitle: 'DFJK â€” ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼',
      languageLabel: 'è¨€èª',
      menuTitle: 'ğŸµ DFJK',
      btnStart: 'ã‚²ãƒ¼ãƒ é–‹å§‹',
      btnMusic: 'æ¥½æ›²',
      btnOptions: 'è¨­å®š',
      menuSelectedLabel: 'é¸æŠä¸­ã®æ›²ï¼š',
      musicTitle: 'ğŸ¼ æ¥½æ›²ã‚’é¸æŠ',
      btnConfirm: 'æ±ºå®š',
      btnBackMenu: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹',
      musicChosenLabel: 'é¸æŠï¼š',
      optionsTitle: 'âš™ï¸ ã‚²ãƒ¼ãƒ è¨­å®š',
      keyModeLabel: 'ã‚­ãƒ¼æ•°ï¼š',
      keyOption4: '4ã‚­ãƒ¼ï¼ˆDFJK / çŸ¢å°ã‚­ãƒ¼å¯¾å¿œï¼‰',
      keyOption6: '6ã‚­ãƒ¼ï¼ˆSDF JKLï¼‰',
      keyOption8: '8ã‚­ãƒ¼ï¼ˆASDF JKL;ï¼‰',
      difficultyLabel: 'é›£æ˜“åº¦ï¼š',
      difficultyEx: 'EXï¼ˆã‚¨ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼‰',
      difficultyHell: 'ãƒ˜ãƒ«',
      difficultyHard: 'ãƒãƒ¼ãƒ‰',
      difficultyNormal: 'ãƒãƒ¼ãƒãƒ«',
      difficultyEasy: 'ã‚¤ãƒ¼ã‚¸ãƒ¼',
      difficultyBeginner: 'ãƒ“ã‚®ãƒŠãƒ¼',
      speedLabel: 'ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ï¼š',
      speedOptionStandard: '1.0xï¼ˆæ¨™æº–ï¼‰',
      noteDirectionLabel: 'ãƒãƒ¼ãƒ„æ–¹å‘ï¼š',
      noteDirectionDown: 'ä¸‹ã‹ã‚‰è½ä¸‹',
      noteDirectionUp: 'ä¸Šã¸ä¸Šæ˜‡',
      judgeModeLabel: 'åˆ¤å®šãƒ¢ãƒ¼ãƒ‰ï¼š',
      judgeModeOld: 'Old Inputï¼ˆWRONGå«ã‚€ï¼‰',
      judgeModeNew: 'New Input',
      volumeLabel: 'ãƒã‚¹ã‚¿ãƒ¼ãƒœãƒªãƒ¥ãƒ¼ãƒ  (BGM)ï¼š',
      sfxLabel: 'ãƒ’ãƒƒãƒˆéŸ³é‡ï¼š',
      calibrationHeading: 'ğŸ¯ ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´',
      offsetLabel: 'å…¨ä½“ã‚ªãƒ•ã‚»ãƒƒãƒˆ (ms)ï¼š',
      offsetCalibBtn: 'ã‚¯ã‚¤ãƒƒã‚¯èª¿æ•´',
      rgbLabel: 'RGB çŸ¢å°ã‚«ãƒ©ãƒ¼ï¼š',
      hpLabel: 'HP ãƒ¢ãƒ¼ãƒ‰ï¼š',
      mobileFullLabel: 'ãƒ¢ãƒã‚¤ãƒ«å…¨ç”»é¢ï¼ˆ4ã‚­ãƒ¼ä»¥ä¸Šæ¨å¥¨ï¼‰ï¼š',
      mobileLandscapeLabel: 'ãƒ¢ãƒã‚¤ãƒ«æ¨ªå‘ããƒ¢ãƒ¼ãƒ‰ï¼ˆÎ²ãƒ»æœªé¸æŠæ™‚ã¯è‡ªå‹•ï¼‰ï¼š',
      ctrlButton: 'âš™ï¸ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼',
      dockHandleTitle: 'ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼ã‚’é–‹ã',
      dockSong: 'æ›²',
      dockLanes: 'ã‚­ãƒ¼æ•°',
      dockDiff: 'é›£æ˜“åº¦',
      dockDir: 'æ–¹å‘',
      dockJudge: 'åˆ¤å®š',
      dockOffset: 'ã‚ªãƒ•ã‚»ãƒƒãƒˆ',
      dockScore: 'ã‚¹ã‚³ã‚¢',
      dockCombo: 'ã‚³ãƒ³ãƒœ',
      dockMiss: 'MISS',
      dockHeat: 'HEAT',
      dockResume: 'ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹ (321)',
      dockHeatToggle: 'HEAT åˆ‡æ›¿',
      dockToMenu: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹',
      pauseTitle: 'â¸ï¸ ä¸€æ™‚åœæ­¢',
      btnResume: 'â–¶ï¸ å†é–‹',
      endTitle: 'ğŸ® ã‚²ãƒ¼ãƒ çµ‚äº†ï¼',
      finalSongLabel: 'æ›²ï¼š',
      finalDiffLabel: 'é›£æ˜“åº¦ï¼š',
      finalDirLabel: 'æ–¹å‘ï¼š',
      finalJudgeLabel: 'åˆ¤å®šï¼š',
      finalScoreLabel: 'ã‚¹ã‚³ã‚¢ï¼š',
      statSickLabel: 'SICKï¼š',
      statGoodLabel: 'GOODï¼š',
      statBadLabel: 'BADï¼š',
      statShitLabel: 'SHITï¼š',
      statMissLabel: 'MISSï¼š',
      btnRestart: 'ã‚‚ã†ä¸€åº¦éŠã¶',
      calibrationTitle: 'ğŸ¯ ã‚¯ã‚¤ãƒƒã‚¯èª¿æ•´',
      calibrationHint: 'ãƒ“ãƒ¼ãƒˆï¼ˆ1æ‹1000msï¼‰ã«åˆã‚ã›ã¦ DFJK ã‹ç”»é¢ã‚’æœ€ä½10å›ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚ä¸­å¤®å€¤+MADã§å¤–ã‚Œå€¤ã‚’é™¤å»ã—ã¾ã™ã€‚',
      calibStart: 'é–‹å§‹',
      calibFinish: 'å®Œäº†',
      calibCancel: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      warnBanner: 'âš ï¸ ãŠçŸ¥ã‚‰ã›'
    },
    dynamic: {
      menuSelectedNone: 'æœªé¸æŠ',
      musicPlaceholder: 'â€” æ›²ã‚’é¸æŠ â€”',
      alertSelectSong: 'å…ˆã«æ¥½æ›²ã‚’é¸æŠã—ã¦ãã ã•ã„',
      countdownReady: 'ãƒ¬ãƒ‡ã‚£',
      countdownGo: 'ã‚´ãƒ¼ï¼',
      heatOn: 'ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼šON',
      heatOff: 'ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼šOFF',
      heatPosition: 'ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ä½ç½®ï¼š{{position}}',
      heatAuto: 'è‡ªå‹•',
      heatTop: 'ä¸Š',
      heatBottom: 'ä¸‹',
      appliedOffset: 'ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’é©ç”¨ï¼š{{value}} ms',
      offsetValue: '{{value}} ms',
      offsetSigned: '{{value}} ms',
      keyChanged: 'ã‚­ãƒ¼æ•°ã‚’ {{value}} ã«å¤‰æ›´',
      mobileOnly: 'ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãƒ¢ãƒã‚¤ãƒ«ã®ã¿æœ‰åŠ¹ã§ã™',
      needPauseForCalib: 'èª¿æ•´å‰ã«ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã¾ãŸã¯ä¸€æ™‚åœæ­¢ã—ã¦ãã ã•ã„',
      calibrationReady: 'å¾…æ©Ÿä¸­',
      calibrationStats: '{{count}}/{{total}} æ¨å¥¨ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼š{{advice}}',
      calibrationAdviceNone: 'â€”',
      exFailed: 'å¤±æ•—ï¼EX MISS > 15',
      hpDepleted: 'HP ãŒã‚¼ãƒ­ã«ãªã‚Šã¾ã—ãŸ',
      heatStatusOn: 'ON',
      heatStatusOff: 'OFF',
      directionUp: 'ä¸Šæ˜‡',
      directionDown: 'ä¸‹é™',
      judgeOld: 'Old',
      judgeNew: 'New',
      heatmapTitle: 'Hit ã‚ªãƒ•ã‚»ãƒƒãƒˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— (ms)',
      heatmapStats: 'avg:{{avg}} Ïƒ:{{std}} ã‚ªãƒ•ã‚»ãƒƒãƒˆ:{{offset}}ms'
    }
  });

  defineLang('ko', {
    nativeName: 'í•œêµ­ì–´',
    zhLabel: 'éŸ“æ–‡',
    languageWord: 'ì–¸ì–´',
    htmlLang: 'ko',
    fontFamily: "'Noto Sans KR','Malgun Gothic','Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif",
    docTitle: 'DFJK â€” ì»¨íŠ¸ë¡¤ ì„¼í„°',
    strings: {
      docTitle: 'DFJK â€” ì»¨íŠ¸ë¡¤ ì„¼í„°',
      languageLabel: 'ì–¸ì–´',
      menuTitle: 'ğŸµ DFJK',
      btnStart: 'ê²Œì„ ì‹œì‘',
      btnMusic: 'ìŒì•…',
      btnOptions: 'ì˜µì…˜',
      menuSelectedLabel: 'ì„ íƒí•œ ê³¡:',
      musicTitle: 'ğŸ¼ ê³¡ ì„ íƒ',
      btnConfirm: 'í™•ì¸',
      btnBackMenu: 'ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°',
      musicChosenLabel: 'ì„ íƒ:',
      optionsTitle: 'âš™ï¸ ê²Œì„ ì„¤ì •',
      keyModeLabel: 'í‚¤ ìˆ˜:',
      keyOption4: '4í‚¤ (DFJK / ë°©í–¥í‚¤ ì‚¬ìš© ê°€ëŠ¥)',
      keyOption6: '6í‚¤ (SDF JKL)',
      keyOption8: '8í‚¤ (ASDF JKL;)',
      difficultyLabel: 'ë‚œì´ë„:',
      difficultyEx: 'EX (ìµìŠ¤íŠ¸ë¦¼)',
      difficultyHell: 'í—¬',
      difficultyHard: 'í•˜ë“œ',
      difficultyNormal: 'ë…¸ë©€',
      difficultyEasy: 'ì´ì§€',
      difficultyBeginner: 'ë¹„ê¸°ë„ˆ',
      speedLabel: 'ìŠ¤í¬ë¡¤ ì†ë„:',
      speedOptionStandard: '1.0x (í‘œì¤€)',
      noteDirectionLabel: 'ë…¸íŠ¸ ë°©í–¥:',
      noteDirectionDown: 'ìœ„ì—ì„œ ë‚´ë ¤ì˜´',
      noteDirectionUp: 'ì•„ë˜ì—ì„œ ì˜¬ë¼ê°',
      judgeModeLabel: 'íŒì • ëª¨ë“œ:',
      judgeModeOld: 'Old Input (WRONG í¬í•¨)',
      judgeModeNew: 'New Input',
      volumeLabel: 'ë§ˆìŠ¤í„° ë³¼ë¥¨ (BGM):',
      sfxLabel: 'íƒ€ê²©ìŒ ë³¼ë¥¨:',
      calibrationHeading: 'ğŸ¯ íƒ€ì´ë° ë³´ì •',
      offsetLabel: 'ì „ì—­ ì˜¤í”„ì…‹ (ms):',
      offsetCalibBtn: 'ë¹ ë¥¸ ë³´ì •',
      rgbLabel: 'RGB í™”ì‚´í‘œ ìƒ‰ìƒ ìˆœí™˜:',
      hpLabel: 'HP ëª¨ë“œ:',
      mobileFullLabel: 'ëª¨ë°”ì¼ ì „ì²´ ë†’ì´ (4í‚¤ ì´ìƒ ê¶Œì¥):',
      mobileLandscapeLabel: 'ëª¨ë°”ì¼ ê°€ë¡œ ëª¨ë“œ (ë² íƒ€, ë¯¸ì„ íƒ ì‹œ ìë™):',
      ctrlButton: 'âš™ï¸ ì»¨íŠ¸ë¡¤ ì„¼í„°',
      dockHandleTitle: 'íƒ­í•˜ì—¬ ì»¨íŠ¸ë¡¤ ì„¼í„° ì—´ê¸°',
      dockSong: 'ê³¡',
      dockLanes: 'í‚¤ ìˆ˜',
      dockDiff: 'ë‚œì´ë„',
      dockDir: 'ë°©í–¥',
      dockJudge: 'íŒì •',
      dockOffset: 'ì˜¤í”„ì…‹',
      dockScore: 'ì ìˆ˜',
      dockCombo: 'ì½¤ë³´',
      dockMiss: 'MISS',
      dockHeat: 'HEAT',
      dockResume: 'ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸° (321)',
      dockHeatToggle: 'HEAT ì „í™˜',
      dockToMenu: 'ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°',
      pauseTitle: 'â¸ï¸ ì¼ì‹œ ì •ì§€',
      btnResume: 'â–¶ï¸ ì¬ê°œ',
      endTitle: 'ğŸ® ê²Œì„ ì¢…ë£Œ!',
      finalSongLabel: 'ê³¡:',
      finalDiffLabel: 'ë‚œì´ë„:',
      finalDirLabel: 'ë°©í–¥:',
      finalJudgeLabel: 'íŒì •:',
      finalScoreLabel: 'ì ìˆ˜:',
      statSickLabel: 'SICK:',
      statGoodLabel: 'GOOD:',
      statBadLabel: 'BAD:',
      statShitLabel: 'SHIT:',
      statMissLabel: 'MISS:',
      btnRestart: 'ë‹¤ì‹œ í”Œë ˆì´',
      calibrationTitle: 'ğŸ¯ ë¹ ë¥¸ ë³´ì •',
      calibrationHint: 'ë°•ì(í•œ ë°• 1000ms)ì— ë§ì¶° DFJK ë˜ëŠ” í™”ë©´ì„ ìµœì†Œ 10íšŒ ì´ìƒ ëˆ„ë¥´ì„¸ìš”. ì¤‘ì•™ê°’ + MADë¡œ ì´ìƒì¹˜ë¥¼ ì œê±°í•©ë‹ˆë‹¤.',
      calibStart: 'ì‹œì‘',
      calibFinish: 'ì™„ë£Œ',
      calibCancel: 'ì·¨ì†Œ',
      warnBanner: 'âš ï¸ ì•Œë¦¼'
    },
    dynamic: {
      menuSelectedNone: 'ì„ íƒë˜ì§€ ì•ŠìŒ',
      musicPlaceholder: 'â€” ê³¡ì„ ì„ íƒ â€”',
      alertSelectSong: 'ë¨¼ì € ê³¡ì„ ì„ íƒí•˜ì„¸ìš”',
      countdownReady: 'ì¤€ë¹„',
      countdownGo: 'ì‹œì‘!',
      heatOn: 'íˆíŠ¸ë§µ: ON',
      heatOff: 'íˆíŠ¸ë§µ: OFF',
      heatPosition: 'íˆíŠ¸ë§µ ìœ„ì¹˜: {{position}}',
      heatAuto: 'ìë™',
      heatTop: 'ìœ„',
      heatBottom: 'ì•„ë˜',
      appliedOffset: 'ì˜¤í”„ì…‹ ì ìš©: {{value}} ms',
      offsetValue: '{{value}} ms',
      offsetSigned: '{{value}} ms',
      keyChanged: 'í‚¤ ìˆ˜ê°€ {{value}}ë¡œ ë³€ê²½ë¨',
      mobileOnly: 'ì´ ì˜µì…˜ì€ ëª¨ë°”ì¼ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤',
      needPauseForCalib: 'ë³´ì •í•˜ê¸° ì „ì— ê²Œì„ì„ ì¢…ë£Œí•˜ê±°ë‚˜ ì¼ì‹œ ì •ì§€í•˜ì„¸ìš”',
      calibrationReady: 'ëŒ€ê¸° ì¤‘',
      calibrationStats: '{{count}}/{{total}} ê¶Œì¥ ì˜¤í”„ì…‹: {{advice}}',
      calibrationAdviceNone: 'â€”',
      exFailed: 'íŒ¨ë°°! EX MISS > 15',
      hpDepleted: 'HPê°€ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤',
      heatStatusOn: 'ON',
      heatStatusOff: 'OFF',
      directionUp: 'ìƒí–¥',
      directionDown: 'í•˜í–¥',
      judgeOld: 'Old',
      judgeNew: 'New',
      heatmapTitle: 'Hit ì˜¤í”„ì…‹ íˆíŠ¸ë§µ (ms)',
      heatmapStats: 'avg:{{avg}} Ïƒ:{{std}} ì˜¤í”„ì…‹:{{offset}}ms'
    }
  });

  defineLang('fr', {
    nativeName: 'FranÃ§ais',
    zhLabel: 'æ³•æ–‡',
    languageWord: 'Langue',
    htmlLang: 'fr',
    fontFamily: "'Fira Sans','Segoe UI','Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif",
    docTitle: 'DFJK â€” Centre de contrÃ´le rythmique',
    strings: {
      docTitle: 'DFJK â€” Centre de contrÃ´le rythmique',
      languageLabel: 'Langue',
      menuTitle: 'ğŸµ DFJK',
      btnStart: 'Commencer',
      btnMusic: 'Musique',
      btnOptions: 'Options',
      menuSelectedLabel: 'Morceau choisi :',
      musicTitle: 'ğŸ¼ Choisir un morceau',
      btnConfirm: 'Valider',
      btnBackMenu: 'Retour au menu',
      musicChosenLabel: 'SÃ©lection :',
      optionsTitle: 'âš™ï¸ Options du jeu',
      keyModeLabel: 'Touches :',
      keyOption4: '4 touches (DFJK / flÃ¨ches possibles)',
      keyOption6: '6 touches (SDF JKL)',
      keyOption8: '8 touches (ASDF JKL;)',
      difficultyLabel: 'DifficultÃ© :',
      difficultyEx: 'EX (ExtrÃªme)',
      difficultyHell: 'Enfer',
      difficultyHard: 'Difficile',
      difficultyNormal: 'Normal',
      difficultyEasy: 'Facile',
      difficultyBeginner: 'DÃ©butant',
      speedLabel: 'Vitesse de dÃ©filement :',
      speedOptionStandard: '1.0x (Standard)',
      noteDirectionLabel: 'Direction des notes :',
      noteDirectionDown: 'Notes descendantes',
      noteDirectionUp: 'Notes montantes',
      judgeModeLabel: 'Mode de jugement :',
      judgeModeOld: 'Old Input (avec WRONG)',
      judgeModeNew: 'New Input',
      volumeLabel: 'Volume principal (BGM) :',
      sfxLabel: 'Volume des impacts :',
      calibrationHeading: 'ğŸ¯ Calibration du timing',
      offsetLabel: 'DÃ©calage global (ms) :',
      offsetCalibBtn: 'Calibration rapide',
      rgbLabel: 'Couleurs RGB cycliques :',
      hpLabel: 'Mode HP :',
      mobileFullLabel: 'Hauteur totale mobile (>4 touches conseillÃ©) :',
      mobileLandscapeLabel: 'Mode paysage mobile (bÃªta, auto sinon) :',
      ctrlButton: 'âš™ï¸ Centre de contrÃ´le',
      dockHandleTitle: 'Touchez pour ouvrir le centre de contrÃ´le',
      dockSong: 'Morceau',
      dockLanes: 'Touches',
      dockDiff: 'DifficultÃ©',
      dockDir: 'Direction',
      dockJudge: 'Jugement',
      dockOffset: 'DÃ©calage',
      dockScore: 'Score',
      dockCombo: 'Combo',
      dockMiss: 'MISS',
      dockHeat: 'HEAT',
      dockResume: 'Retour au jeu (321)',
      dockHeatToggle: 'Basculer HEAT',
      dockToMenu: 'Retour menu principal',
      pauseTitle: 'â¸ï¸ Jeu en pause',
      btnResume: 'â–¶ï¸ Reprendre',
      endTitle: 'ğŸ® Fin de partie !',
      finalSongLabel: 'Morceau :',
      finalDiffLabel: 'DifficultÃ© :',
      finalDirLabel: 'Direction :',
      finalJudgeLabel: 'Jugement :',
      finalScoreLabel: 'Score :',
      statSickLabel: 'SICK :',
      statGoodLabel: 'GOOD :',
      statBadLabel: 'BAD :',
      statShitLabel: 'SHIT :',
      statMissLabel: 'MISS :',
      btnRestart: 'Rejouer',
      calibrationTitle: 'ğŸ¯ Calibration rapide',
      calibrationHint: 'Suivez le rythme (1000 ms par battement) et appuyez sur DFJK ou lâ€™Ã©cran au moins 10 fois. MÃ©diane + MAD supprime les valeurs aberrantes.',
      calibStart: 'DÃ©marrer',
      calibFinish: 'Terminer',
      calibCancel: 'Annuler',
      warnBanner: 'âš ï¸ Alerte'
    },
    dynamic: {
      menuSelectedNone: 'Aucune sÃ©lection',
      musicPlaceholder: 'â€” Choisir un morceau â€”',
      alertSelectSong: 'Veuillez dâ€™abord choisir un morceau',
      countdownReady: 'PrÃªt',
      countdownGo: 'Go !',
      heatOn: 'Heatmap : ON',
      heatOff: 'Heatmap : OFF',
      heatPosition: 'Position de la heatmap : {{position}}',
      heatAuto: 'Auto',
      heatTop: 'Haut',
      heatBottom: 'Bas',
      appliedOffset: 'DÃ©calage appliquÃ© : {{value}} ms',
      offsetValue: '{{value}} ms',
      offsetSigned: '{{value}} ms',
      keyChanged: 'Nombre de touches changÃ© en {{value}}',
      mobileOnly: 'Cette option fonctionne uniquement sur mobile',
      needPauseForCalib: 'Veuillez quitter ou mettre en pause avant de calibrer',
      calibrationReady: 'PrÃªt',
      calibrationStats: '{{count}}/{{total}} DÃ©calage conseillÃ© : {{advice}}',
      calibrationAdviceNone: 'â€”',
      exFailed: 'DÃ©faite ! EX MISS > 15',
      hpDepleted: 'HP Ã©puisÃ©s',
      heatStatusOn: 'ON',
      heatStatusOff: 'OFF',
      directionUp: 'Montant',
      directionDown: 'Descendant',
      judgeOld: 'Old',
      judgeNew: 'New',
      heatmapTitle: 'Heatmap des dÃ©calages (ms)',
      heatmapStats: 'moy:{{avg}} Ïƒ:{{std}} dÃ©calage:{{offset}}ms'
    }
  });

  defineLang('ru', {
    nativeName: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹',
    zhLabel: 'ä¿„æ–‡',
    languageWord: 'Ğ¯Ğ·Ñ‹Ğº',
    htmlLang: 'ru',
    fontFamily: "'PT Sans','Segoe UI','Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif",
    docTitle: 'DFJK â€” Ğ¦ĞµĞ½Ñ‚Ñ€ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ€Ğ¸Ñ‚Ğ¼Ğ¾Ğ¼',
    strings: {
      docTitle: 'DFJK â€” Ğ¦ĞµĞ½Ñ‚Ñ€ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ€Ğ¸Ñ‚Ğ¼Ğ¾Ğ¼',
      languageLabel: 'Ğ¯Ğ·Ñ‹Ğº',
      menuTitle: 'ğŸµ DFJK',
      btnStart: 'ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ',
      btnMusic: 'ĞœÑƒĞ·Ñ‹ĞºĞ°',
      btnOptions: 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸',
      menuSelectedLabel: 'Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚Ñ€ĞµĞº:',
      musicTitle: 'ğŸ¼ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ñ€ĞµĞº',
      btnConfirm: 'ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ',
      btnBackMenu: 'Ğ’ Ğ¼ĞµĞ½Ñ',
      musicChosenLabel: 'Ğ’Ñ‹Ğ±Ğ¾Ñ€:',
      optionsTitle: 'âš™ï¸ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¸Ğ³Ñ€Ñ‹',
      keyModeLabel: 'ĞšĞ»Ğ°Ğ²Ğ¸ÑˆĞ¸:',
      keyOption4: '4 ĞºĞ»Ğ°Ğ²Ğ¸ÑˆĞ¸ (DFJK / ÑÑ‚Ñ€ĞµĞ»ĞºĞ¸)',
      keyOption6: '6 ĞºĞ»Ğ°Ğ²Ğ¸Ñˆ (SDF JKL)',
      keyOption8: '8 ĞºĞ»Ğ°Ğ²Ğ¸Ñˆ (ASDF JKL;)',
      difficultyLabel: 'Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ:',
      difficultyEx: 'EX (Ğ­ĞºÑÑ‚Ñ€Ğ¸Ğ¼)',
      difficultyHell: 'ĞĞ´',
      difficultyHard: 'Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾',
      difficultyNormal: 'ĞĞ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾',
      difficultyEasy: 'Ğ›ĞµĞ³ĞºĞ¾',
      difficultyBeginner: 'ĞĞ¾Ğ²Ğ¸Ñ‡Ğ¾Ğº',
      speedLabel: 'Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºĞ¸:',
      speedOptionStandard: '1.0x (Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚)',
      noteDirectionLabel: 'ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ñ‚:',
      noteDirectionDown: 'ĞŸĞ°Ğ´Ğ°ÑÑ‚ Ğ²Ğ½Ğ¸Ğ·',
      noteDirectionUp: 'ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ÑÑ‚ÑÑ Ğ²Ğ²ĞµÑ€Ñ…',
      judgeModeLabel: 'Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¾Ñ†ĞµĞ½ĞºĞ¸:',
      judgeModeOld: 'Old Input (Ñ WRONG)',
      judgeModeNew: 'New Input',
      volumeLabel: 'ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ³Ñ€Ğ¾Ğ¼ĞºĞ¾ÑÑ‚ÑŒ (BGM):',
      sfxLabel: 'Ğ“Ñ€Ğ¾Ğ¼ĞºĞ¾ÑÑ‚ÑŒ ÑƒĞ´Ğ°Ñ€Ğ¾Ğ²:',
      calibrationHeading: 'ğŸ¯ ĞšĞ°Ğ»Ğ¸Ğ±Ñ€Ğ¾Ğ²ĞºĞ° Ñ‚Ğ°Ğ¹Ğ¼Ğ¸Ğ½Ğ³Ğ°',
      offsetLabel: 'Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ´Ğ²Ğ¸Ğ³ (Ğ¼Ñ):',
      offsetCalibBtn: 'Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ ĞºĞ°Ğ»Ğ¸Ğ±Ñ€Ğ¾Ğ²ĞºĞ°',
      rgbLabel: 'RGB ÑĞ¼ĞµĞ½Ğ° Ñ†Ğ²ĞµÑ‚Ğ° ÑÑ‚Ñ€ĞµĞ»Ğ¾Ğº:',
      hpLabel: 'Ğ ĞµĞ¶Ğ¸Ğ¼ HP:',
      mobileFullLabel: 'ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ²Ñ‹ÑĞ¾Ñ‚Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… (>4 ĞºĞ»Ğ°Ğ²Ğ¸Ñˆ):',
      mobileLandscapeLabel: 'Ğ“Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ (Ğ±ĞµÑ‚Ğ°, Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ°Ğ²Ñ‚Ğ¾):',
      ctrlButton: 'âš™ï¸ Ğ¦ĞµĞ½Ñ‚Ñ€ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ',
      dockHandleTitle: 'ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ†ĞµĞ½Ñ‚Ñ€',
      dockSong: 'Ğ¢Ñ€ĞµĞº',
      dockLanes: 'ĞšĞ»Ğ°Ğ²Ğ¸ÑˆĞ¸',
      dockDiff: 'Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ',
      dockDir: 'ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ',
      dockJudge: 'ĞÑ†ĞµĞ½ĞºĞ°',
      dockOffset: 'Ğ¡Ğ´Ğ²Ğ¸Ğ³',
      dockScore: 'ĞÑ‡ĞºĞ¸',
      dockCombo: 'ĞšĞ¾Ğ¼Ğ±Ğ¾',
      dockMiss: 'MISS',
      dockHeat: 'HEAT',
      dockResume: 'ĞĞ°Ğ·Ğ°Ğ´ Ğ² Ğ¸Ğ³Ñ€Ñƒ (321)',
      dockHeatToggle: 'ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ HEAT',
      dockToMenu: 'Ğ’ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ',
      pauseTitle: 'â¸ï¸ ĞŸĞ°ÑƒĞ·Ğ°',
      btnResume: 'â–¶ï¸ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ',
      endTitle: 'ğŸ® Ğ˜Ğ³Ñ€Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡ĞµĞ½Ğ°!',
      finalSongLabel: 'Ğ¢Ñ€ĞµĞº:',
      finalDiffLabel: 'Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ:',
      finalDirLabel: 'ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:',
      finalJudgeLabel: 'ĞÑ†ĞµĞ½ĞºĞ°:',
      finalScoreLabel: 'ĞÑ‡ĞºĞ¸:',
      statSickLabel: 'SICK:',
      statGoodLabel: 'GOOD:',
      statBadLabel: 'BAD:',
      statShitLabel: 'SHIT:',
      statMissLabel: 'MISS:',
      btnRestart: 'Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°',
      calibrationTitle: 'ğŸ¯ Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ ĞºĞ°Ğ»Ğ¸Ğ±Ñ€Ğ¾Ğ²ĞºĞ°',
      calibrationHint: 'Ğ¡Ğ»ĞµĞ´ÑƒĞ¹Ñ‚Ğµ Ñ€Ğ¸Ñ‚Ğ¼Ñƒ (1000 Ğ¼Ñ Ğ½Ğ° Ğ´Ğ¾Ğ»Ñ) Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ DFJK Ğ¸Ğ»Ğ¸ ÑĞºÑ€Ğ°Ğ½ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 10 Ñ€Ğ°Ğ·. ĞœĞµĞ´Ğ¸Ğ°Ğ½Ğ° + MAD ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑÑ‹.',
      calibStart: 'Ğ¡Ñ‚Ğ°Ñ€Ñ‚',
      calibFinish: 'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾',
      calibCancel: 'ĞÑ‚Ğ¼ĞµĞ½Ğ°',
      warnBanner: 'âš ï¸ Ğ’Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ'
    },
    dynamic: {
      menuSelectedNone: 'ĞŸĞ¾ĞºĞ° Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾',
      musicPlaceholder: 'â€” Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ñ€ĞµĞº â€”',
      alertSelectSong: 'Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ñ€ĞµĞº',
      countdownReady: 'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾',
      countdownGo: 'Ğ’Ğ¿ĞµÑ€Ñ‘Ğ´!',
      heatOn: 'Heatmap: Ğ’ĞšĞ›',
      heatOff: 'Heatmap: Ğ’Ğ«ĞšĞ›',
      heatPosition: 'ĞŸĞ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ heatmap: {{position}}',
      heatAuto: 'ĞĞ²Ñ‚Ğ¾',
      heatTop: 'Ğ¡Ğ²ĞµÑ€Ñ…Ñƒ',
      heatBottom: 'Ğ¡Ğ½Ğ¸Ğ·Ñƒ',
      appliedOffset: 'Ğ¡Ğ´Ğ²Ğ¸Ğ³ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ñ‘Ğ½: {{value}} Ğ¼Ñ',
      offsetValue: '{{value}} Ğ¼Ñ',
      offsetSigned: '{{value}} Ğ¼Ñ',
      keyChanged: 'Ğ§Ğ¸ÑĞ»Ğ¾ ĞºĞ»Ğ°Ğ²Ğ¸Ñˆ: {{value}}',
      mobileOnly: 'ĞĞ¿Ñ†Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°Ñ…',
      needPauseForCalib: 'Ğ’Ñ‹Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¸Ğ³Ñ€Ñƒ Ğ½Ğ° Ğ¿Ğ°ÑƒĞ·Ñƒ Ğ¿ĞµÑ€ĞµĞ´ ĞºĞ°Ğ»Ğ¸Ğ±Ñ€Ğ¾Ğ²ĞºĞ¾Ğ¹',
      calibrationReady: 'ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ',
      calibrationStats: '{{count}}/{{total}} Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹ ÑĞ´Ğ²Ğ¸Ğ³: {{advice}}',
      calibrationAdviceNone: 'â€”',
      exFailed: 'ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ! EX MISS > 15',
      hpDepleted: 'HP Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½',
      heatStatusOn: 'Ğ’ĞšĞ›',
      heatStatusOff: 'Ğ’Ğ«ĞšĞ›',
      directionUp: 'Ğ’Ğ²ĞµÑ€Ñ…',
      directionDown: 'Ğ’Ğ½Ğ¸Ğ·',
      judgeOld: 'Old',
      judgeNew: 'New',
      heatmapTitle: 'Ğ¢ĞµĞ¿Ğ»Ğ¾Ğ²Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğ¹ (Ğ¼Ñ)',
      heatmapStats: 'avg:{{avg}} Ïƒ:{{std}} ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ:{{offset}}Ğ¼Ñ'
    }
  });

  defineLang('th', {
    nativeName: 'à¹„à¸—à¸¢',
    zhLabel: 'æ³°æ–‡',
    languageWord: 'à¸ à¸²à¸©à¸²',
    htmlLang: 'th',
    fontFamily: "'Noto Sans Thai','Sarabun','Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif",
    docTitle: 'DFJK â€” à¸¨à¸¹à¸™à¸¢à¹Œà¸„à¸§à¸šà¸„à¸¸à¸¡à¸ˆà¸±à¸‡à¸«à¸§à¸°',
    strings: {
      docTitle: 'DFJK â€” à¸¨à¸¹à¸™à¸¢à¹Œà¸„à¸§à¸šà¸„à¸¸à¸¡à¸ˆà¸±à¸‡à¸«à¸§à¸°',
      languageLabel: 'à¸ à¸²à¸©à¸²',
      menuTitle: 'ğŸµ DFJK',
      btnStart: 'à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡',
      btnMusic: 'à¹€à¸à¸¥à¸‡',
      btnOptions: 'à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸',
      menuSelectedLabel: 'à¹€à¸à¸¥à¸‡à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸:',
      musicTitle: 'ğŸ¼ à¹€à¸¥à¸·à¸­à¸à¹€à¸à¸¥à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸£à¸­à¸šà¸™à¸µà¹‰',
      btnConfirm: 'à¸¢à¸·à¸™à¸¢à¸±à¸™',
      btnBackMenu: 'à¸à¸¥à¸±à¸šà¹€à¸¡à¸™à¸¹à¸«à¸¥à¸±à¸',
      musicChosenLabel: 'à¹€à¸¥à¸·à¸­à¸à¹à¸¥à¹‰à¸§:',
      optionsTitle: 'âš™ï¸ à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸à¸¡',
      keyModeLabel: 'à¸ˆà¸³à¸™à¸§à¸™à¸›à¸¸à¹ˆà¸¡:',
      keyOption4: '4 à¸›à¸¸à¹ˆà¸¡ (DFJK / à¹ƒà¸Šà¹‰à¸›à¸¸à¹ˆà¸¡à¸¥à¸¹à¸à¸¨à¸£à¹„à¸”à¹‰)',
      keyOption6: '6 à¸›à¸¸à¹ˆà¸¡ (SDF JKL)',
      keyOption8: '8 à¸›à¸¸à¹ˆà¸¡ (ASDF JKL;)',
      difficultyLabel: 'à¸„à¸§à¸²à¸¡à¸¢à¸²à¸:',
      difficultyEx: 'EX (à¹‚à¸«à¸”à¸ªà¸¸à¸”)',
      difficultyHell: 'à¸™à¸£à¸',
      difficultyHard: 'à¸¢à¸²à¸',
      difficultyNormal: 'à¸›à¸à¸•à¸´',
      difficultyEasy: 'à¸‡à¹ˆà¸²à¸¢',
      difficultyBeginner: 'à¸œà¸¹à¹‰à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™',
      speedLabel: 'à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§à¹€à¸¥à¸·à¹ˆà¸­à¸™:',
      speedOptionStandard: '1.0x (à¸¡à¸²à¸•à¸£à¸à¸²à¸™)',
      noteDirectionLabel: 'à¸—à¸´à¸¨à¸—à¸²à¸‡à¹‚à¸™à¹‰à¸•:',
      noteDirectionDown: 'à¸•à¸à¸ˆà¸²à¸à¸”à¹‰à¸²à¸™à¸šà¸™',
      noteDirectionUp: 'à¸à¸¸à¹ˆà¸‡à¸ˆà¸²à¸à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡',
      judgeModeLabel: 'à¹‚à¸«à¸¡à¸”à¸•à¸±à¸”à¸ªà¸´à¸™:',
      judgeModeOld: 'Old Input (à¸¡à¸µ WRONG)',
      judgeModeNew: 'New Input',
      volumeLabel: 'à¹€à¸ªà¸µà¸¢à¸‡à¸«à¸¥à¸±à¸ (BGM):',
      sfxLabel: 'à¹€à¸ªà¸µà¸¢à¸‡à¸à¸”à¸›à¸¸à¹ˆà¸¡:',
      calibrationHeading: 'ğŸ¯ à¸›à¸£à¸±à¸šà¹€à¸§à¸¥à¸²à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸ˆà¸±à¸‡à¸«à¸§à¸°',
      offsetLabel: 'à¸„à¹ˆà¸² Offset à¸£à¸§à¸¡ (à¸¡à¸´à¸¥à¸¥à¸´à¸§à¸´à¸™à¸²à¸—à¸µ):',
      offsetCalibBtn: 'à¸›à¸£à¸±à¸šà¹€à¸£à¹‡à¸§',
      rgbLabel: 'à¸¥à¸¹à¸à¸¨à¸£à¹„à¸¥à¹ˆà¸ªà¸µ RGB:',
      hpLabel: 'à¹‚à¸«à¸¡à¸” HP:',
      mobileFullLabel: 'à¸ªà¸¹à¸‡à¹€à¸•à¹‡à¸¡à¸ˆà¸­à¸šà¸™à¸¡à¸·à¸­à¸–à¸·à¸­ (>4 à¸›à¸¸à¹ˆà¸¡à¹à¸™à¸°à¸™à¸³):',
      mobileLandscapeLabel: 'à¹‚à¸«à¸¡à¸”à¹à¸™à¸§à¸™à¸­à¸™à¸¡à¸·à¸­à¸–à¸·à¸­ (à¹€à¸šà¸•à¹‰à¸² à¸›à¸¥à¹ˆà¸­à¸¢à¸§à¹ˆà¸²à¸‡à¹ƒà¸«à¹‰à¸«à¸¡à¸¸à¸™à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´):',
      ctrlButton: 'âš™ï¸ à¸¨à¸¹à¸™à¸¢à¹Œà¸„à¸§à¸šà¸„à¸¸à¸¡',
      dockHandleTitle: 'à¹à¸•à¸°à¹€à¸à¸·à¹ˆà¸­à¹€à¸›à¸´à¸”à¸¨à¸¹à¸™à¸¢à¹Œà¸„à¸§à¸šà¸„à¸¸à¸¡',
      dockSong: 'à¹€à¸à¸¥à¸‡',
      dockLanes: 'à¸›à¸¸à¹ˆà¸¡',
      dockDiff: 'à¸„à¸§à¸²à¸¡à¸¢à¸²à¸',
      dockDir: 'à¸—à¸´à¸¨à¸—à¸²à¸‡',
      dockJudge: 'à¸•à¸±à¸”à¸ªà¸´à¸™',
      dockOffset: 'à¸­à¸­à¸Ÿà¹€à¸‹à¹‡à¸•',
      dockScore: 'à¸„à¸°à¹à¸™à¸™',
      dockCombo: 'à¸„à¸­à¸¡à¹‚à¸š',
      dockMiss: 'MISS',
      dockHeat: 'HEAT',
      dockResume: 'à¸à¸¥à¸±à¸šà¸ªà¸¹à¹ˆà¹€à¸à¸¡ (321)',
      dockHeatToggle: 'à¸ªà¸¥à¸±à¸š HEAT',
      dockToMenu: 'à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¹€à¸¡à¸™à¸¹',
      pauseTitle: 'â¸ï¸ à¸«à¸¢à¸¸à¸”à¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§',
      btnResume: 'â–¶ï¸ à¹€à¸¥à¹ˆà¸™à¸•à¹ˆà¸­',
      endTitle: 'ğŸ® à¸ˆà¸šà¹€à¸à¸¡!',
      finalSongLabel: 'à¹€à¸à¸¥à¸‡:',
      finalDiffLabel: 'à¸„à¸§à¸²à¸¡à¸¢à¸²à¸:',
      finalDirLabel: 'à¸—à¸´à¸¨à¸—à¸²à¸‡:',
      finalJudgeLabel: 'à¸•à¸±à¸”à¸ªà¸´à¸™:',
      finalScoreLabel: 'à¸„à¸°à¹à¸™à¸™:',
      statSickLabel: 'SICK:',
      statGoodLabel: 'GOOD:',
      statBadLabel: 'BAD:',
      statShitLabel: 'SHIT:',
      statMissLabel: 'MISS:',
      btnRestart: 'à¹€à¸¥à¹ˆà¸™à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡',
      calibrationTitle: 'ğŸ¯ à¸›à¸£à¸±à¸šà¸ˆà¸¹à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸§à¸”à¹€à¸£à¹‡à¸§',
      calibrationHint: 'à¸à¸”à¸•à¸²à¸¡à¸ˆà¸±à¸‡à¸«à¸§à¸° (à¸—à¸¸à¸ 1000 à¸¡à¸´à¸¥à¸¥à¸´à¸§à¸´à¸™à¸²à¸—à¸µà¸•à¹ˆà¸­à¸ˆà¸±à¸‡à¸«à¸§à¸°) à¸”à¹‰à¸§à¸¢ DFJK à¸«à¸£à¸·à¸­à¹à¸•à¸°à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 10 à¸„à¸£à¸±à¹‰à¸‡ à¸„à¹ˆà¸²à¸¡à¸±à¸˜à¸¢à¸à¸²à¸™ + MAD à¸ˆà¸°à¸•à¸±à¸”à¸„à¹ˆà¸²à¸œà¸´à¸”à¸›à¸à¸•à¸´à¸­à¸­à¸',
      calibStart: 'à¹€à¸£à¸´à¹ˆà¸¡',
      calibFinish: 'à¹€à¸ªà¸£à¹‡à¸ˆ',
      calibCancel: 'à¸¢à¸à¹€à¸¥à¸´à¸',
      warnBanner: 'âš ï¸ à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™'
    },
    dynamic: {
      menuSelectedNone: 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸·à¸­à¸',
      musicPlaceholder: 'â€” à¹€à¸¥à¸·à¸­à¸à¹€à¸à¸¥à¸‡ â€”',
      alertSelectSong: 'à¹‚à¸›à¸£à¸”à¹€à¸¥à¸·à¸­à¸à¹€à¸à¸¥à¸‡à¸à¹ˆà¸­à¸™',
      countdownReady: 'à¸à¸£à¹‰à¸­à¸¡',
      countdownGo: 'à¸¥à¸¸à¸¢!',
      heatOn: 'Heatmap: à¹€à¸›à¸´à¸”',
      heatOff: 'Heatmap: à¸›à¸´à¸”',
      heatPosition: 'à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ Heatmap: {{position}}',
      heatAuto: 'à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´',
      heatTop: 'à¸”à¹‰à¸²à¸™à¸šà¸™',
      heatBottom: 'à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡',
      appliedOffset: 'à¸•à¸±à¹‰à¸‡à¸­à¸­à¸Ÿà¹€à¸‹à¹‡à¸•à¹à¸¥à¹‰à¸§: {{value}} à¸¡à¸ª.',
      offsetValue: '{{value}} à¸¡à¸ª.',
      offsetSigned: '{{value}} à¸¡à¸ª.',
      keyChanged: 'à¸ªà¸¥à¸±à¸šà¸ˆà¸³à¸™à¸§à¸™à¸›à¸¸à¹ˆà¸¡à¹€à¸›à¹‡à¸™ {{value}}',
      mobileOnly: 'à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸™à¸µà¹‰à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¹€à¸‰à¸à¸²à¸°à¸šà¸™à¸¡à¸·à¸­à¸–à¸·à¸­',
      needPauseForCalib: 'à¸à¸£à¸¸à¸“à¸²à¸­à¸­à¸à¸«à¸£à¸·à¸­à¸à¸±à¸à¹€à¸à¸¡à¸à¹ˆà¸­à¸™à¸›à¸£à¸±à¸šà¹€à¸—à¸µà¸¢à¸š',
      calibrationReady: 'à¸à¸£à¹‰à¸­à¸¡à¸›à¸£à¸±à¸š',
      calibrationStats: '{{count}}/{{total}} à¸­à¸­à¸Ÿà¹€à¸‹à¹‡à¸•à¹à¸™à¸°à¸™à¸³: {{advice}}',
      calibrationAdviceNone: 'â€”',
      exFailed: 'à¹à¸à¹‰! EX MISS > 15',
      hpDepleted: 'HP à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§',
      heatStatusOn: 'à¹€à¸›à¸´à¸”',
      heatStatusOff: 'à¸›à¸´à¸”',
      directionUp: 'à¸‚à¸¶à¹‰à¸™',
      directionDown: 'à¸¥à¸‡',
      judgeOld: 'Old',
      judgeNew: 'New',
      heatmapTitle: 'Heatmap à¸„à¹ˆà¸²à¸„à¸¥à¸²à¸”à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™ (ms)',
      heatmapStats: 'avg:{{avg}} Ïƒ:{{std}} à¸­à¸­à¸Ÿà¹€à¸‹à¹‡à¸•:{{offset}}ms'
    }
  });

  defineLang('vi', {
    nativeName: 'Tiáº¿ng Viá»‡t',
    zhLabel: 'è¶Šå—æ–‡',
    languageWord: 'NgÃ´n ngá»¯',
    htmlLang: 'vi',
    fontFamily: "'Noto Sans','Segoe UI','Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif",
    docTitle: 'DFJK â€” Trung tÃ¢m Ä‘iá»u khiá»ƒn nhá»‹p Ä‘iá»‡u',
    strings: {
      docTitle: 'DFJK â€” Trung tÃ¢m Ä‘iá»u khiá»ƒn nhá»‹p Ä‘iá»‡u',
      languageLabel: 'NgÃ´n ngá»¯',
      menuTitle: 'ğŸµ DFJK',
      btnStart: 'Báº¯t Ä‘áº§u chÆ¡i',
      btnMusic: 'BÃ i hÃ¡t',
      btnOptions: 'TÃ¹y chá»n',
      menuSelectedLabel: 'BÃ i Ä‘Ã£ chá»n:',
      musicTitle: 'ğŸ¼ Chá»n bÃ i cho vÃ¡n nÃ y',
      btnConfirm: 'XÃ¡c nháº­n',
      btnBackMenu: 'Vá» menu chÃ­nh',
      musicChosenLabel: 'ÄÃ£ chá»n:',
      optionsTitle: 'âš™ï¸ CÃ i Ä‘áº·t trÃ² chÆ¡i',
      keyModeLabel: 'Sá»‘ phÃ­m:',
      keyOption4: '4 phÃ­m (DFJK / dÃ¹ng phÃ­m mÅ©i tÃªn)',
      keyOption6: '6 phÃ­m (SDF JKL)',
      keyOption8: '8 phÃ­m (ASDF JKL;)',
      difficultyLabel: 'Äá»™ khÃ³:',
      difficultyEx: 'EX (Cá»±c khÃ³)',
      difficultyHell: 'Äá»‹a ngá»¥c',
      difficultyHard: 'KhÃ³',
      difficultyNormal: 'ThÆ°á»ng',
      difficultyEasy: 'Dá»…',
      difficultyBeginner: 'Má»›i chÆ¡i',
      speedLabel: 'Tá»‘c Ä‘á»™ cuá»™n:',
      speedOptionStandard: '1.0x (Chuáº©n)',
      noteDirectionLabel: 'HÆ°á»›ng ná»‘t:',
      noteDirectionDown: 'RÆ¡i tá»« trÃªn xuá»‘ng',
      noteDirectionUp: 'Äi tá»« dÆ°á»›i lÃªn',
      judgeModeLabel: 'Cháº¿ Ä‘á»™ cháº¥m Ä‘iá»ƒm:',
      judgeModeOld: 'Old Input (kÃ¨m WRONG)',
      judgeModeNew: 'New Input',
      volumeLabel: 'Ã‚m lÆ°á»£ng chÃ­nh (BGM):',
      sfxLabel: 'Ã‚m thanh nháº¥n phÃ­m:',
      calibrationHeading: 'ğŸ¯ CÄƒn chá»‰nh thá»i gian',
      offsetLabel: 'Äá»™ lá»‡ch tá»•ng (ms):',
      offsetCalibBtn: 'CÄƒn nhanh',
      rgbLabel: 'MÃ u mÅ©i tÃªn RGB tuáº§n hoÃ n:',
      hpLabel: 'Cháº¿ Ä‘á»™ HP:',
      mobileFullLabel: 'Chiá»u cao Ä‘áº§y Ä‘á»§ trÃªn di Ä‘á»™ng (>4 phÃ­m khuyÃªn dÃ¹ng):',
      mobileLandscapeLabel: 'Cháº¿ Ä‘á»™ ngang di Ä‘á»™ng (beta, bá» chá»n Ä‘á»ƒ tá»± xoay):',
      ctrlButton: 'âš™ï¸ Trung tÃ¢m Ä‘iá»u khiá»ƒn',
      dockHandleTitle: 'Nháº¥n Ä‘á»ƒ má»Ÿ trung tÃ¢m Ä‘iá»u khiá»ƒn',
      dockSong: 'BÃ i hÃ¡t',
      dockLanes: 'PhÃ­m',
      dockDiff: 'Äá»™ khÃ³',
      dockDir: 'HÆ°á»›ng',
      dockJudge: 'Cháº¥m Ä‘iá»ƒm',
      dockOffset: 'Äá»™ lá»‡ch',
      dockScore: 'Äiá»ƒm',
      dockCombo: 'Combo',
      dockMiss: 'MISS',
      dockHeat: 'HEAT',
      dockResume: 'Quay láº¡i game (321)',
      dockHeatToggle: 'Báº­t/táº¯t HEAT',
      dockToMenu: 'Quay vá» menu',
      pauseTitle: 'â¸ï¸ Táº¡m dá»«ng',
      btnResume: 'â–¶ï¸ Tiáº¿p tá»¥c',
      endTitle: 'ğŸ® Káº¿t thÃºc trÃ² chÆ¡i!',
      finalSongLabel: 'BÃ i hÃ¡t:',
      finalDiffLabel: 'Äá»™ khÃ³:',
      finalDirLabel: 'HÆ°á»›ng:',
      finalJudgeLabel: 'Cháº¥m Ä‘iá»ƒm:',
      finalScoreLabel: 'Äiá»ƒm:',
      statSickLabel: 'SICK:',
      statGoodLabel: 'GOOD:',
      statBadLabel: 'BAD:',
      statShitLabel: 'SHIT:',
      statMissLabel: 'MISS:',
      btnRestart: 'ChÆ¡i láº¡i',
      calibrationTitle: 'ğŸ¯ CÄƒn chá»‰nh nhanh',
      calibrationHint: 'HÃ£y gÃµ theo nhá»‹p (1000 ms má»—i phÃ¡ch) báº±ng DFJK hoáº·c cháº¡m mÃ n hÃ¬nh Ã­t nháº¥t 10 láº§n. Trung vá»‹ + MAD Ä‘á»ƒ loáº¡i bá» ngoáº¡i lá»‡.',
      calibStart: 'Báº¯t Ä‘áº§u',
      calibFinish: 'HoÃ n táº¥t',
      calibCancel: 'Há»§y',
      warnBanner: 'âš ï¸ ThÃ´ng bÃ¡o'
    },
    dynamic: {
      menuSelectedNone: 'ChÆ°a chá»n',
      musicPlaceholder: 'â€” Chá»n bÃ i â€”',
      alertSelectSong: 'Vui lÃ²ng chá»n bÃ i hÃ¡t trÆ°á»›c',
      countdownReady: 'Sáºµn sÃ ng',
      countdownGo: 'Báº¯t Ä‘áº§u!',
      heatOn: 'Heatmap: Báº¬T',
      heatOff: 'Heatmap: Táº®T',
      heatPosition: 'Vá»‹ trÃ­ Heatmap: {{position}}',
      heatAuto: 'Tá»± Ä‘á»™ng',
      heatTop: 'TrÃªn',
      heatBottom: 'DÆ°á»›i',
      appliedOffset: 'ÄÃ£ Ã¡p dá»¥ng Ä‘á»™ lá»‡ch: {{value}} ms',
      offsetValue: '{{value}} ms',
      offsetSigned: '{{value}} ms',
      keyChanged: 'Äá»•i sá»‘ phÃ­m thÃ nh {{value}}',
      mobileOnly: 'TÃ¹y chá»n nÃ y chá»‰ dÃ¹ng trÃªn thiáº¿t bá»‹ di Ä‘á»™ng',
      needPauseForCalib: 'HÃ£y thoÃ¡t hoáº·c táº¡m dá»«ng game trÆ°á»›c khi cÄƒn chá»‰nh',
      calibrationReady: 'Sáºµn sÃ ng cÄƒn chá»‰nh',
      calibrationStats: '{{count}}/{{total}} Äá»™ lá»‡ch gá»£i Ã½: {{advice}}',
      calibrationAdviceNone: 'â€”',
      exFailed: 'Thua cuá»™c! EX MISS > 15',
      hpDepleted: 'HP Ä‘Ã£ cáº¡n',
      heatStatusOn: 'Báº¬T',
      heatStatusOff: 'Táº®T',
      directionUp: 'HÆ°á»›ng lÃªn',
      directionDown: 'HÆ°á»›ng xuá»‘ng',
      judgeOld: 'Old',
      judgeNew: 'New',
      heatmapTitle: 'Heatmap Ä‘á»™ lá»‡ch (ms)',
      heatmapStats: 'avg:{{avg}} Ïƒ:{{std}} Ä‘á»™ lá»‡ch:{{offset}}ms'
    }
  });

  for(const code of Object.keys(I18N)){
    const data = I18N[code];
    if(!data.strings) data.strings = {};
    SPEED_KEYS.forEach(sk => {
      const key = `speedOption${sk}`;
      if(!Object.prototype.hasOwnProperty.call(data.strings, key)){
        data.strings[key] = `${(Number(sk)/10).toFixed(1)}x`;
      }
    });
  }

  let currentLang = DEFAULT_LANG;

  function detectInitialLanguage(){
    try{
      const stored = localStorage.getItem('dfjk.language');
      if(stored && I18N[stored]) return stored;
    }catch{}
    const prefs = [];
    if(Array.isArray(navigator.languages)) prefs.push(...navigator.languages);
    if(navigator.language) prefs.push(navigator.language);
    const map = [
      ['zh-hant','zh-Hant'],['zh-tw','zh-Hant'],['zh-hk','zh-Hant'],
      ['zh-cn','zh-Hans'],['zh-sg','zh-Hans'],['zh','zh-Hans'],
      ['en','en'],['de','de'],['ja','ja'],['ko','ko'],['fr','fr'],
      ['ru','ru'],['th','th'],['vi','vi']
    ];
    for(const pref of prefs){
      if(!pref) continue; const lower = pref.toLowerCase();
      for(const [pattern, target] of map){ if(lower.startsWith(pattern) && I18N[target]) return target; }
    }
    return DEFAULT_LANG;
  }

  currentLang = detectInitialLanguage();

  function applyStaticStrings(){
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.dataset.i18n;
      if(!key) return;
      const attr = el.dataset.i18nAttr;
      const text = getString(key);
      if(attr){ el.setAttribute(attr, text); return; }
      if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = text;
      else el.textContent = text;
    });
  }

  function updateSongLabels(){
    const menuLabel = $("#menuChosenSong");
    const chosenLabel = $("#chosenSongLabel");
    const fallback = getDynamic('menuSelectedNone');
    if(menuLabel){ menuLabel.textContent = selectedSongFile ? menuLabel.textContent : fallback; }
    if(chosenLabel){ chosenLabel.textContent = selectedSongFile ? chosenLabel.textContent : fallback; }
  }

  function updateLanguageDependentUI(){
    const langData = getLang();
    document.documentElement.lang = langData.htmlLang || 'en';
    document.body.style.fontFamily = langData.fontFamily || "sans-serif";
    document.title = langData.docTitle || 'DFJK';
    const label = $("#languageLabelText");
    if(label) label.textContent = langData.languageWord || getString('languageLabel');
    const countdown = $("#countdownText");
    if(countdown && countdown.dataset.locked !== '1') countdown.textContent = getDynamic('countdownReady');
    const calibBig = $("#calibBig");
    if(calibBig && calibBig.dataset.locked !== '1') calibBig.textContent = getDynamic('calibrationReady');
    const calibStat = $("#calibStat");
    if(calibStat && calibStat.dataset.locked !== '1') calibStat.textContent = getDynamic('calibrationStats', {count:0,total:10,advice:getDynamic('calibrationAdviceNone')});
    const songSel = $("#songSelect");
    if(songSel){ const opt = songSel.querySelector('option[value=""]'); if(opt) opt.textContent = getDynamic('musicPlaceholder'); }
    updateSongLabels();
    updateDockHUD();
    hudOffset(OFFSET);
  }

  function setLanguage(code, opts={}){
    if(!I18N[code]) code = DEFAULT_LANG;
    currentLang = code;
    if(!opts.skipStorage){ try{ localStorage.setItem('dfjk.language', code); }catch{} }
    applyStaticStrings();
    if(!opts.skipSelect){ const sel=$("#languageSelect"); if(sel) sel.value = code; }
    updateLanguageDependentUI();
    ui();
  }

  function setupLanguageSelect(){
    const sel = $("#languageSelect");
    if(!sel) return;
    sel.innerHTML = '';
    LANG_ORDER.forEach(code => {
      const data = I18N[code];
      if(!data) return;
      const option = document.createElement('option');
      option.value = code;
      const assist = data.zhLabel;
      const baseName = data.nativeName || code;
      option.textContent = assist ? `${baseName}ï¼ˆ${assist}ï¼‰` : baseName;
      sel.appendChild(option);
    });
    sel.value = currentLang;
    addEv(sel, 'change', () => setLanguage(sel.value));
  }
  
  /* å…±äº«ç‹€æ…‹å…ˆå®£å‘Šï¼Œç¢ºä¿ abort æ™‚ä¸€å®šå­˜åœ¨ */
  let loopId = null;
  let cRAF = null;
  let timers = [];

  const onAbort = () => {
    try { cancelAnimationFrame(loopId); }catch{}
    try { cancelAnimationFrame(cRAF); }catch{}
    try { timers.forEach(id => clearTimeout(id)); }catch{}
    timers.length = 0;
    stopAudio();
    cancelCalibAudio();
  };
  SIG.addEventListener('abort', onAbort, { once:true });

  /* ===== å°å·¥å…· ===== */
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const banner = (m)=>{ const b=$("#warnBanner"); b.textContent=m; b.style.display="block"; setTimeout(()=>b.style.display="none",1600); };

  /* ===== å°ºå¯¸å¸¸æ•¸ï¼å‹•æ…‹ç‹€æ…‹ ===== */
  const H = 640;
  const baseLaneW = 105;
  let LANES = [4,6,8].includes(+localStorage.getItem("dfjk.lanes")) ? +localStorage.getItem("dfjk.lanes") : 4;
  let W = baseLaneW * LANES;

  const c  = $("#gameCanvas");
  const ctx= c.getContext("2d",{ alpha:false, desynchronized:true });
  const uc = $("#uiCanvas");
  const uix= uc.getContext("2d",{ alpha:true });

  /* è¡Œå‹•è£ç½®é–‹é—œ */
  const IS_MOBILE = matchMedia("(pointer: coarse)").matches;
  let MOBILE_FULL = localStorage.getItem('dfjk.mobileFull') === '1';
  let LANDSCAPE_FORCE   = localStorage.getItem('dfjk.landscape')   === '1'; // å‹¾é¸æ™‚å¼·åˆ¶æ©«ç‰ˆ

  /* DPR */
  function fitDPR(){
    const d = Math.min(devicePixelRatio||1, 2);
    c.width  = W * d; c.height = H * d;
    uc.width = W * d; uc.height= H * d;
    ctx.setTransform(d,0,0,d,0,0);
    uix.setTransform(d,0,0,d,0,0);
  }

  const isLandscapeNow = () => IS_MOBILE && (LANDSCAPE_FORCE || (window.innerWidth > window.innerHeight + 20));

  /* ä½ˆå±€ */
  let rectH = c.getBoundingClientRect().height, rectW = c.getBoundingClientRect().width;
  let scaleY = rectH / H;
  let judgeCss = 0;
  let judgeY = 0;
  const HITKEY = 90;
  const NOTE_SZ = 46;
  let uiScale = 1;

  function layout(){
    const r = c.getBoundingClientRect();
    rectH = r.height; rectW = r.width;
    scaleY = rectH / H;
    const LANDSCAPE = isLandscapeNow();
    if (IS_MOBILE && LANDSCAPE){
      const BOTTOM_PAD_CSS = Math.max(72, Math.round(0.16 * rectH)); // æ©«ç‰ˆé½Šåº•
      judgeCss = (dir==='up') ? BOTTOM_PAD_CSS : (rectH - BOTTOM_PAD_CSS);
    } else {
      judgeCss = (dir==='up') ? (HITKEY*uiScale/2) : (rectH - HITKEY*uiScale/2);
    }
    judgeY = judgeCss / scaleY;
  }
  function desktopScale(){
    const coarse = matchMedia("(pointer: coarse)").matches;
    const wide   = matchMedia("(min-width:1024px)").matches;
    const wider  = matchMedia("(min-width:1440px)").matches;
    let u = 1;
    if(!coarse && (wide || wider)) u = wider ? 1.8 : 1.5;
    uiScale = u;
  }
  function laneX(i){ const lw = W/LANES; return i*lw + lw/2; }

  /* ===== é¡è‰² / RGB ===== */
  const BASE_COL = ['#b266ff','#66ccff','#66ff66','#ff6666','#ffc857','#ff9bd3','#78d5ff','#ffd966'];
  let RGB = localStorage.getItem("dfjk.rgbCycle")==="1";
  function h2x(h,s,l){ s/=100; l/=100; const k=n=>(n+h/30)%12; const a=s*Math.min(l,1-l); const f=n=>l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1))); const to=x=>("0"+Math.round(x*255).toString(16)).slice(-2); return `#${to(f(0))}${to(f(8))}${to(f(4))}`; }
  function light(hex,a){ const p=parseInt(hex.slice(1),16); let r=(p>>16)&255,g=(p>>8)&255,b=p&255; r=Math.min(255,Math.round(r+(255-r)*a)); g=Math.min(255,Math.round(g+(255-g)*a)); b=Math.min(255,Math.round(b+(255-b)*a)); return `rgb(${r},${g},${b})`; }
  function laneCol(i,t){ if(RGB){ const hue=((t*60)+i*(360/LANES))%360; return h2x(hue,85,55); } return BASE_COL[i % BASE_COL.length]; }

  /* ===== ç®­é ­ç¹ªè£½ ===== */
  function d2a(d){ if(d==="up")return -Math.PI/2; if(d==="down")return Math.PI/2; if(d==="left")return Math.PI; return 0; }
  function arrowPath(xc,s){ const L=s*2.05,Hh=s*0.92,cut=Hh*0.30,tip=L*0.50,tail=-L*0.22; xc.beginPath(); xc.moveTo(tail,-Hh*0.55); xc.lineTo(0,-Hh*0.55); xc.lineTo(tip,0); xc.lineTo(0,Hh*0.55); xc.lineTo(tail,Hh*0.55); xc.lineTo(tail+cut,0); xc.closePath(); }

  let LANE_DIRS = [];
  function recomputeLaneDirs(){
    LANE_DIRS = [];
    for(let i=0;i<LANES;i++){
      if(i===0){ LANE_DIRS.push('left'); continue; }
      if(i===LANES-1){ LANE_DIRS.push('right'); continue; }
      LANE_DIRS.push(i%2===0 ? 'up' : 'down');
    }
  }
  recomputeLaneDirs();

  function drawArrow(o){
    const {x,y,size,dir,base,isRec,pulse=0,t=0,scale=1,rot=0} = o;
    const ang = d2a(dir);
    ctx.save(); ctx.translate(x,y); ctx.rotate(ang+rot); ctx.scale(scale,scale);
    arrowPath(ctx,size);
    ctx.fillStyle = isRec? "#050607" : light(base,.12); ctx.fill();
    ctx.lineWidth = isRec? 2 : 2.2; ctx.strokeStyle="rgba(255,255,255,.95)"; ctx.stroke();
    const k=6; ctx.save(); ctx.clip();
    for(let i=0;i<k;i++){ const u=i/(k-1)-.5, yy=u*size*.95; ctx.globalAlpha = isRec ? (0.12+0.22*pulse) : 0.20; ctx.strokeStyle = "#ffffff"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(-size,yy); ctx.lineTo(size*1.1,yy); ctx.stroke(); }
    const sw=(Math.sin(t*2.2)+1)/2, w=size*0.65, sx=-size+(size*2.2)*sw; const g=ctx.createLinearGradient(sx-w,0,sx+w,0);
    g.addColorStop(0,'rgba(255,255,255,0)'); g.addColorStop(.5,'rgba(255,255,255,.28)'); g.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=g; ctx.fillRect(-size*1.2,-size*1.2,size*2.4,size*2.4); ctx.restore(); ctx.restore();
  }
  function drawTrail(o){ const {x,y,size,dir,base,t} = o; const step=3,gap=10,a=d2a(dir);
    for(let i=1;i<=step;i++){ const off=i*gap, ax=x-Math.cos(a)*off, ay=y-Math.sin(a)*off; ctx.save(); ctx.globalAlpha=.16*(1-i/(step+1)); drawArrow({x:ax,y:ay,size,dir,base,isRec:false,t}); ctx.restore(); } }

  /* ===== èƒŒæ™¯ ===== */
  function bg(t){ ctx.save(); ctx.fillStyle="#0c1322"; ctx.fillRect(0,0,W,H);
    const Ls=[{step:26,s:28,a:.18,c:'rgba(120,213,255,0.35)'},{step:18,s:50,a:.14,c:'rgba(255,0,160,0.28)'},{step:34,s:18,a:.12,c:'rgba(255,255,0,0.22)'}];
    for(const L of Ls){ ctx.globalAlpha=L.a; ctx.strokeStyle=L.c; ctx.lineWidth=1; const ox=(t*L.s)%L.step, oy=(t*L.s*0.7)%L.step;
      for(let x=-ox;x<=W;x+=L.step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
      for(let y=-oy;y<=H;y+=L.step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(0+y,H+y); ctx.stroke(); } }
    ctx.restore(); }

  /* ===== éŸ³è¨Š / SFX ===== */
  let OFFSET = +(localStorage.getItem("dfjk.offsetMs")||0);
  const bgm=$("#bgm"); let AC=null, Gm=null, Gsfx=null; let Gcal=null;
  let VOL_M=(+(localStorage.getItem("dfjk.volume")||80))/100;
  let VOL_S=(+(localStorage.getItem("dfjk.sfxVol")||70))/100;
  async function ensureAC(){ if(!AC){ const Ctx=window.AudioContext||window.webkitAudioContext; AC=new Ctx({latencyHint:"interactive"}); }
    if(!Gm){ Gm=AC.createGain(); Gm.connect(AC.destination); }
    if(!Gsfx){ Gsfx=AC.createGain(); Gsfx.gain.value=VOL_S; Gsfx.connect(Gm); } }
  function applyVol(){ if(Gm)Gm.gain.value=VOL_M; if(bgm)bgm.volume=VOL_M; if(Gsfx)Gsfx.gain.value=VOL_S; }
  function cancelCalibAudio(){ try{ if(AC && Gcal){ Gcal.gain.cancelScheduledValues(AC.currentTime); Gcal.gain.setValueAtTime(0, AC.currentTime); try{ Gcal.disconnect(); }catch{} Gcal = null; } }catch{} for(const id of timers) try{ clearTimeout(id); }catch{} timers.length = 0; }
  async function tapSfx(){ try{ await ensureAC(); const t0=AC.currentTime+0.001, dur=0.10; const mix=AC.createGain(); mix.connect(Gsfx||Gm);
    const o1=AC.createOscillator(); o1.type='triangle'; o1.frequency.setValueAtTime(2700,t0); o1.frequency.exponentialRampToValueAtTime(1900,t0+dur);
    const g1=AC.createGain(); g1.gain.setValueAtTime(0.0001,t0); g1.gain.exponentialRampToValueAtTime(0.55,t0+0.004); g1.gain.exponentialRampToValueAtTime(0.0001,t0+dur); o1.connect(g1); g1.connect(mix);
    const o2=AC.createOscillator(); o2.type='square'; o2.frequency.setValueAtTime(5400,t0); o2.frequency.exponentialRampToValueAtTime(2800,t0+0.08);
    const g2=AC.createGain(); g2.gain.setValueAtTime(0.17,t0); g2.gain.exponentialRampToValueAtTime(0.0001,t0+0.08); o2.connect(g2); g2.connect(mix);
    const nb=AC.createBuffer(1,256,AC.sampleRate); const data=nb.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1; const n=AC.createBufferSource(); n.buffer=nb;
    const bp=AC.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=9800; bp.Q.value=6; const hp=AC.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=2000; hp.Q.value=0.7; const ng=AC.createGain(); ng.gain.setValueAtTime(0.16,t0); ng.gain.exponentialRampToValueAtTime(0.0001,t0+0.06);
    n.connect(bp); bp.connect(hp); hp.connect(ng); ng.connect(mix); o1.start(t0); o1.stop(t0+dur+0.03); o2.start(t0); o2.stop(t0+0.09); n.start(t0); n.stop(t0+0.06);
  }catch{} }

  /* ===== åˆ¤å®š / åˆ†æ•¸ ===== */
  const WIN = { sick:85, good:135, bad:155, shit:175 };
  const SC  = { sick:350, good:200, bad:100, shit:-50, miss:-300, ghost:-150 };
  let baseSpd = 550, spd=baseSpd;

  const dts=[]; const DT_MAX=240;
  function recDt(d){ dts.push(d); if(dts.length>DT_MAX)dts.shift(); }
  function dtStats(){ if(!dts.length) return {avg:0,std:0}; const n=dts.length; const avg=dts.reduce((a,c)=>a+c,0)/n; const va=dts.reduce((a,c)=>a+(c-avg)*(c-avg),0)/n; return {avg,std:Math.sqrt(va)}; }

  let comboFlash=""; let comboT0=0;
  function comboFlashNow(){ comboFlash=`COMBO x${combo}!!`; comboT0=performance.now()/1000; }

 function endWith(msg){
    running=false; stopLoop(); stopAudio();
    const diffOpt=$("#difficultySelect")?.querySelector(`option[value="${diff}"]`);
    $("#finalSong").textContent=currentSong;
    $("#finalDiff").textContent=diffOpt ? diffOpt.textContent : diff.toUpperCase();
    $("#finalDir").textContent=(dir==='up'?getDynamic('directionUp'):getDynamic('directionDown'));
    $("#finalJudge").textContent=(jmode==='old'?getDynamic('judgeOld'):getDynamic('judgeNew'));
    $("#finalScore").textContent=score; $("#statSick").textContent=stats.sick; $("#statGood").textContent=stats.good;
    $("#statBad").textContent=stats.bad; $("#statShit").textContent=stats.shit; $("#statMiss").textContent=missCount;
    phase='menu';
    showOnly('endScreen');
    if(msg) banner(msg);
  }
  function exCheck(){ if(diff==='ex' && missCount>15){ endWith(getDynamic('exFailed')); } }

  function yAt(thit,tnow){ return (dir==='down') ? (judgeY - (thit-tnow)*spd) : (judgeY + (thit-tnow)*spd); }

  /* ===== è¡€æ¢ ===== */
  const HP_MAX=100; let HP_ON=(localStorage.getItem("dfjk.hpOn")==="1"); let HP=HP_MAX;
  function hpShow(b){
    const LANDSCAPE = isLandscapeNow();
    if(LANDSCAPE){
      const f = $("#hpFloat");
      f.style.display = b ? "block" : "none";
      $("#hpBar").style.display = "none";
      positionHpFloat();
    }else{
      $("#hpBar").style.display=b?"block":"none";
      $("#hpFloat").style.display="none";
    }
  }
  function hpUpdate(){
    const fill=$("#hpFill"), txt=$("#hpText");
    const w=Math.max(0,Math.min(100, HP/HP_MAX*100));
    fill.style.width=w.toFixed(1)+"%"; txt.textContent=`${HP}/${HP_MAX}`;
    const f=$("#hpFloat"), ff=$("#hpFloatFill"), ft=$("#hpFloatText");
    ff.style.width=w.toFixed(1)+"%"; ft.textContent=`${HP}/${HP_MAX}`;
    positionHpFloat();
  }
  function hpSet(v){ HP=Math.max(0,Math.min(HP_MAX,Math.round(v))); hpUpdate(); if(HP<=0 && running){ endWith(getDynamic('hpDepleted')); } }
  function hpAdd(d){ if(!HP_ON) return; hpSet(HP+d); }
  function hpDelta(j){ if(j==="SICK") return +15; if(j==="GOOD") return +12; if(j==="BAD") return +6; let missV=0, shitV=0;
    if(diff==='beginner'||diff==='easy'){ missV=-5;  shitV=-3; }
    else if(diff==='normal'){ missV=-8;  shitV=-6; }
    else if(diff==='hard'){   missV=-10; shitV=-8; }
    else if(diff==='ex'){     missV=-25; shitV=-20; }
    else { /* hell */         missV=-28; shitV=-22; }
    if(j==="MISS") return missV; if(j==="SHIT") return shitV; return 0;
  }

  /* ===== HUDï¼ˆåªæ›´æ–°æ§åˆ¶ä¸­å¿ƒï¼‰ ===== */
  function hud(){ updateDockHUD(); }

  const hits=[], parts=[];
  function addHit(l){ const t=performance.now()/1000, j=judgeY, x=laneX(l);
    hits.push({lane:l,t0:t,life:.40}); const N=26, col=laneCol(l,t);
    for(let i=0;i<N;i++){ const a=Math.random()*Math.PI*2, sp=80+Math.random()*220;
      const vx=Math.cos(a)*sp, vy=Math.sin(a)*sp, life=.28+Math.random()*.22, th=.8+Math.random()*1.6;
      parts.push({x,y:j,vx,vy,life,t0:t,col,th}); } }
  function impact(l){ recPulse[l]=1.2; recHitT[l]=performance.now()/1000; }

  function fxUpdate(dt){
    const now=performance.now()/1000;
    for(let i=hits.length-1;i>=0;i--) if((now-hits[i].t0)>hits[i].life) hits.splice(i,1);
    for(let i=parts.length-1;i>=0;i--){
      const p=parts[i], age=now-p.t0; if(age>p.life){ parts.splice(i,1); continue; }
      p.x+=p.vx*dt; p.y+=p.vy*dt; p.vx*=(1-1.6*dt); p.vy*=(1-1.6*dt);
    }
  }
  function fxDraw(){
    const t=performance.now()/1000, j=judgeY;
    ctx.save();
    for(const fx of hits){
      const age=t-fx.t0, p=Math.min(1,age/fx.life), x=laneX(fx.lane), r=28+90*p;
      ctx.globalCompositeOperation='lighter';
      const g=ctx.createRadialGradient(x,j,r*.2, x,j,r);
      g.addColorStop(0,'rgba(255,255,255,.35)'); g.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,j,r,0,Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation='source-over'; ctx.globalAlpha=1-p;
    }
    ctx.restore();

    ctx.save(); ctx.globalCompositeOperation='lighter';
    for(const p of parts){
      const now=performance.now()/1000, age=now-p.t0, q=Math.max(0,1-age/p.life);
      ctx.strokeStyle=p.col; ctx.globalAlpha=Math.pow(q,1.6); ctx.lineWidth=p.th;
      ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(p.x - p.vx*0.025, p.y - p.vy*0.025); ctx.stroke();
    }
    ctx.restore();
  }

  function upd(songT,dt){
    for(const n of chart) n.y = yAt(n.t, songT);
    for(const n of chart){
      if(n.hit) continue;
      const late=(songT-n.t)*1000, over=WIN.shit+160;
      if(late>over){
        n.hit=true; remain--;
        lastJudge='MISS'; combo=0; missCount++; stats.miss++; score=Math.max(0,score+SC.miss); hpAdd(hpDelta('MISS'));
        hud(); exCheck();
      }
    }
    for(let i=0;i<LANES;i++) recPulse[i]=Math.max(0, recPulse[i]-dt*3.2);
    fxUpdate(dt);
  }

  function draw(opt={}){
    const sk=!!opt.skip, t=performance.now()/1000, j=judgeY;
    ctx.clearRect(0,0,W,H); bg(t);
    for(let i=0;i<LANES;i++){
      const x=laneX(i), col=laneCol(i,t), since=Math.max(0,t-recHitT[i]), wave=Math.max(0,1-since/0.22);
      const p=Math.max(recPulse[i],wave), sc=1+0.42*p+0.08*Math.sin((1-p)*Math.PI), rot=(Math.sin(since*60)*0.05)*p;
      drawArrow({x,y:j,size:NOTE_SZ,dir:LANE_DIRS[i],base:col,isRec:true,pulse:p,t,scale:sc,rot});
    }
    if(!sk){
      const top=-160, bot=H+160;
      for(let i=0;i<chart.length;i++){
        const n=chart[i]; if(n.hit) continue; if(n.y<top||n.y>bot) continue;
        const x=laneX(n.lane), col=laneCol(n.lane, t+i*0.02);
        drawTrail({x,y:n.y,size:NOTE_SZ,dir:LANE_DIRS[n.lane],base:col,t:t+i*0.02});
        drawArrow({x,y:n.y,size:NOTE_SZ,dir:LANE_DIRS[n.lane],base:col,isRec:false,t:t+i*0.02});
      }
    }
    fxDraw();
    if(lastJudge!=='-'){ ctx.fillStyle='#fff'; ctx.font='bold 32px sans-serif'; ctx.textAlign='center';
      const off=(dir==='up') ? 120 : -40; ctx.fillText(lastJudge, W/2, j+off); }
    if(comboFlash){
      const life=.9, age=(performance.now()/1000 - comboT0);
      if(age<life){ const s=1+0.18*Math.sin(age*9);
        ctx.save(); ctx.translate(W/2,H*0.22); ctx.scale(s,s);
        ctx.fillStyle='rgba(255,255,255,.95)'; ctx.font='bold 36px sans-serif'; ctx.textAlign='center'; ctx.fillText(comboFlash,0,0);
        ctx.restore();
      }else comboFlash='';
    }
  }
  function drawPreview(t){
    ctx.clearRect(0,0,W,H); bg(performance.now()/1000);
    const j=judgeY;
    for(let i=0;i<LANES;i++){
      const x=laneX(i), col=laneCol(i, performance.now()/1000);
      drawArrow({x,y:j,size:NOTE_SZ,dir:LANE_DIRS[i],base:col,isRec:true,pulse:0,t:0,scale:1,rot:0});
    }
    const top=-160, bot=H+160;
    for(let i=0;i<chart.length;i++){
      const n=chart[i]; if(n.hit) continue;
      const y=yAt(n.t,t); if(y<top||y>bot) continue;
      const x=laneX(n.lane), col=laneCol(n.lane, performance.now()/1000+i*0.02);
      drawTrail({x,y,size:NOTE_SZ,dir:LANE_DIRS[n.lane],base:col,t:0});
      drawArrow({x,y,size:NOTE_SZ,dir:LANE_DIRS[n.lane],base:col,isRec:false,t:0});
    }
  }

  /* ===== ç†±åœ–ï¼ˆUI Canvasï¼‰ ===== */
  let showHeat = true;
  let heatMode = 0;
  function ui(){
    uix.clearRect(0,0,W,H); if(!showHeat) return;
    const bins=36, mn=-300, mx=300, step=(mx-mn)/bins, hist=new Array(bins).fill(0);
    for(const v of dts){ const i=Math.floor((v-mn)/step); if(i>=0&&i<bins) hist[i]++; }
    const LANDSCAPE = isLandscapeNow();
    const marginX = Math.max(12, W * (IS_MOBILE ? 0.04 : 0.035));
    const marginY = Math.max(18, H * (IS_MOBILE ? 0.045 : 0.035));
    const padX = 8;
    const padTop = 12;
    const padBottom = 32;
    let w = Math.min(260, Math.max(180, W - marginX * 2));
    if(IS_MOBILE) w = Math.min(w, Math.round(W * 0.62));
    let h = Math.round(Math.max(72, Math.min(110, H * 0.16)));
    const bw=w/bins;

    let x0 = marginX;
    let y0 = marginY;
    const leftBound = marginX;
    let rightBound = W - w - marginX;
    const topBound = marginY + padTop;
    let bottomBound = H - h - (marginY + padBottom);
    if(rightBound < leftBound) rightBound = leftBound;
    if(bottomBound < topBound) bottomBound = topBound;

    if(IS_MOBILE){
      const autoY = (dir==='up') ? bottomBound : topBound;
      if(heatMode===1) y0 = topBound;
      else if(heatMode===2) y0 = bottomBound;
      else y0 = autoY;

      if(LANDSCAPE){
        x0 = (dir==='up') ? rightBound : leftBound;
      } else {
        x0 = leftBound;
      }
    } else {
      if(!LANDSCAPE){
        const cr = c.getBoundingClientRect();
        const tb = document.querySelector('.topbar');
        const tr = tb ? tb.getBoundingClientRect() : null;
        if(cr && tr){
          const hCss = h / H * cr.height;
          const marginCss = marginY / H * cr.height;
          const yCandidate = Math.max(marginCss, (tr.bottom - cr.top) + 8);
          const yCss = Math.min(cr.height - hCss - marginCss, yCandidate);
          x0 = leftBound;
          y0 = (yCss / cr.height) * H;
        }
      } else {
        const autoY = (dir==='up') ? bottomBound : topBound;
        if(heatMode===1) y0 = topBound;
        else if(heatMode===2) y0 = bottomBound;
        else y0 = autoY;
        x0 = leftBound;
      }
    }

    x0 = Math.max(leftBound, Math.min(rightBound, x0));
    y0 = Math.max(topBound, Math.min(bottomBound, y0));
    x0 = Math.round(x0);
    y0 = Math.round(y0);

    uix.save(); uix.globalAlpha=.98; uix.fillStyle='rgba(0,0,0,.58)';
    uix.fillRect(x0-padX, y0-padTop, w + padX*2, h + padTop + padBottom);
    uix.fillStyle='#fff'; uix.font='12px sans-serif'; uix.fillText(getDynamic('heatmapTitle'), x0, y0-(padTop-2));
    const maxc=Math.max(1,...hist);
    for(let i=0;i<bins;i++){ const v=hist[i], bh=(v/maxc)*h, xx=Math.floor(x0+i*bw); uix.fillStyle='#78d5ff'; uix.fillRect(xx, y0+(h-bh), Math.ceil(bw-1), bh); }
    const {avg,std}=dtStats();
    uix.fillStyle='#fff'; uix.font='12px sans-serif'; uix.fillText(getDynamic('heatmapStats',{avg:avg.toFixed(1),std:std.toFixed(1),offset:OFFSET}), x0, y0+h+20);
    uix.strokeStyle='#ffd966'; uix.beginPath(); const mid=x0 + (-mn)/step * bw; uix.moveTo(mid,y0); uix.lineTo(mid,y0+h); uix.stroke();
    uix.restore();
  }

  /* ===== éŸ³æ¨‚æ™‚é˜èˆ‡æµç¨‹ ç­‰ ===== */
  let phase = "menu";
  function canUseDock(){ return phase==='countdown' || phase==='playing' || phase==='paused'; }
  let running=false, paused=false;
  let selectedSongFile = null, currentSong = "-";
  let score=0, combo=0, missCount=0, lastJudge="-";
  let stats = {sick:0,good:0,bad:0,shit:0,miss:0};
  let wrongCount=0;
  let chart=[], remain=0;
  let recPulse = new Array(LANES).fill(0);
  let recHitT  = new Array(LANES).fill(0);
  let diff="normal", dir="down", jmode="old";

  /* éŸ³æ¨‚æ™‚é˜ */
  let durSec=120, ended=false;
  function stopAudio(){ try{ bgm.pause(); }catch{} ended=false; cancelCalibAudio(); }
  let softBase=0, softStart=0;
  function startAt(sec){ try{ const to=Math.max(0,Math.min((durSec||120)-.001,sec||0)); bgm.currentTime=to; }catch{} bgm.play().catch(()=>{}); ended=false; bgm.onended=()=>{ ended=true; }; softBase=bgm.currentTime||0; softStart=performance.now()/1000; }
  function hardClock(){ const t=(bgm && !isNaN(bgm.currentTime)) ? bgm.currentTime : (performance.now()/1000 - softStart) + softBase; return Math.max(0,Math.min(durSec,t)); }
  function judgeClock(){ return hardClock() + (OFFSET/1000); }

  /* ç•«é¢åˆ‡æ› */
  function showOnly(id){
    const pages=['menuScreen','musicScreen','optionsScreen','gameScreen','pauseScreen','endScreen'];
      pages.forEach(x=>{ const el = document.getElementById(x); if(!el) return; el.style.display = (x===id?'block':'none'); });
    // ç„¡è«–å¦‚ä½•ç§»é™¤éŠæˆ²æ¨¡ç³Š
    document.getElementById('gameScreen')?.classList.remove('blur');
    const langSwitcher = document.getElementById('languageSwitcher');
    if(langSwitcher){
      const showLang = (id === 'menuScreen');
      langSwitcher.style.display = showLang ? 'flex' : 'none';
      langSwitcher.setAttribute('aria-hidden', showLang ? 'false' : 'true');
    }
    const notGame = (id !== 'gameScreen');
    if(notGame){
      // é—œä»»ä½•å¯èƒ½é®ä½é»æ“Šçš„è¦†è“‹å±¤
      try{ closeDock(true); }catch{}
      const scrim = document.getElementById('dockScrim'); if(scrim) scrim.classList.remove('show');
      const dock = document.getElementById('landDock'); if(dock) dock.classList.remove('open');
      // ç›´æ©«ç‰ˆ HP æ¼‚æµ®æ¢éƒ½é—œ
      try{ hpShow(false); }catch{}
    }
    if(id!=='gameScreen'){ $("#gameScreen")?.classList.remove('blur'); }
    bindDock();
  }
  function toMenu(){ cancelCountdown(); stopLoop(); stopAudio(); cancelCalibAudio(); phase='menu'; running=false; paused=false; document.body.classList.remove('ex-mode'); showOnly('menuScreen'); $("#menuChosenSong").textContent = selectedSongFile ? selectedSongFile.replace(/\.mp3$/i,'') : getDynamic('menuSelectedNone'); closeDock(true); }
  function toOpt(){
    // ç¢ºä¿ä»»ä½•é®ç½©/æ§åˆ¶ä¸­å¿ƒéƒ½é—œé–‰ï¼Œé¿å…æ“‹ä½é»æ“Š
    try{ closeDock(true); }catch{}
    cancelCountdown();
    stopLoop();
    stopAudio();
    document.body.classList.remove('ex-mode');
    phase='menu'; // åœ¨é¸å–®èªå¢ƒä¸‹ç€è¦½é¸é …
    showOnly('optionsScreen');
  }
  function toMusic(){ showOnly('musicScreen'); }

  /* æ›²åº« */
  const S=[
  "Charlie Puth - Light Switch [Official Music Video] - Charlie Puth.mp3","Creepy Nuts â€Mirageâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Opening Theme Song - Creepy Nuts.mp3","Creepy Nuts â€Nemureâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Ending Theme Song - Creepy Nuts (1).mp3","Creepy Nutsï½¢Bling-Bang-Bang-Bornï½£ Ã— TV Animeï½¢ãƒãƒƒã‚·ãƒ¥ãƒ«-MASHLE-ï½£ Collab Music Video #BBBBãƒ€ãƒ³ã‚¹ - Creepy Nuts.mp3","KANA-BOON - Silhouette - KANABOONVEVO.mp3","Wiz Khalifa - See You Again ft. Charlie Puth [Official Video] Furious 7 Soundtrack - Wiz Khalifa Music (youtube).mp3","Maroon 5 - Memories (Official Video) - Maroon5VEVO (youtube).mp3","Chainsaw Man â€“ The Movie Reze Arc - Theme Song FULL IRIS OUT by Kenshi Yonezu (Lyrics) - Jamong (youtube).mp3","ãƒ’ã‚°ãƒã‚¢ã‚¤ _ ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ã€Official Videoã€‘ Ai Higuchi â€Itterasshai(See you later)â€ - ãƒ’ã‚°ãƒã‚¢ã‚¤ (youtube).mp3","Chainsaw Man â€“ The Movie Reze Arc - Ending FULL JANE DOE by Kenshi Yonezu, Hikaru Utada (Lyrics) - Jamong (youtube).mp3","PokÃ©mon partners of different generations dancing POKÃ‰DANCE Animation Music Video - PokÃ©mon Asia ENG (youtube).mp3","Lost Sky, Sara Skinner - Dreams pt. II (feat. Sara Skinner) [NCS Release].mp3","OneRepublic - Nobody (from Kaiju No. 8) [Official Music Video] - OneRepublicVEVO.mp3","YOASOBIã€ŒWatch me!ã€Official Music Video - Ayase _ YOASOBI.mp3","yung kai - blue (official music video) - yung kai.mp3","ã€AKASAKIã€‘Bunny Girl _ ãƒãƒ‹ãƒ¼ã‚¬ãƒ¼ãƒ«ï¼ˆLyric Videoï¼‰ - AKASAKI (19).mp3","ã€MVã€‘éš™_ã‚†ãƒ¼ã‚Šã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã€‘ - ã€ãƒ¦ã‚¤ã‚«ã€.mp3","ã€imaseã€‘NIGHT DANCERï¼ˆMVï¼‰ - imase.mp3","ãªã¨ã‚Š - Overdose - ãªã¨ã‚Š _ natori.mp3","å¥½ãã ã‹ã‚‰ã€‚_ ã€ãƒ¦ã‚¤ã‚«ã€ã€MVã€‘ - ã€ãƒ¦ã‚¤ã‚«ã€.mp3","å»»å»»å¥‡è­š - Eve MV - Eve.mp3","é’ã®ã™ã¿ã‹ _ ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ - Where Our Blue Is _ Tatsuya Kitani - ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ _ Tatsuya Kitani.mp3","Toge Toge Sadistic - Enormita (youtube).mp3","My dream girls - NACHERRY (youtube).mp3","PEACEKEEPER - STEREO DIVE FOUNDATION (youtube).mp3","YOASOBI - Idolã€Œã‚¢ã‚¤ãƒ‰ãƒ«ã€Lyrics Video [Kan_Rom_Eng] Oshi no Ko (æ¨ã—ã®å­) OP - mimanimi (youtube).mp3","YOASOBI â€“ 'æ€ªç‰© (Monster)' Lyrics - Kei Takahashi (youtube).mp3","YOASOBI - Racing Into The Night Lyrics (JPN_ROM_ENG) - rin rin (youtube).mp3","ã€Hanserã€‘å®¤å†…ç³»çš„TrackMaker _ ã‚¤ãƒ³ãƒ‰ã‚¢ç³»ãªã‚‰ãƒˆãƒ©ãƒƒã‚¯ãƒ¡ã‚¤ã‚«ãƒ¼ ã€ä¸­æ–‡ç¿»å”± _ coverã€‘ - OtakuLAB (youtube).mp3","Aimer - Brave Shine - AimerOfficialVEVO (youtube).mp3","ROSA WALTON x HALLIE COGGINS - I REALLY WANT TO STAY AT YOUR HOUSE (LYRIC) AMV CYBERPUNK EDGERUNNERS - Eternity Music (youtube).mp3"
  ];
  function fillSongs(){ const sel=$("#songSelect"); if(sel.dataset.filled) return; sel.innerHTML=""; const ph=document.createElement("option"); ph.value=""; ph.textContent=getDynamic('musicPlaceholder'); ph.disabled=true; ph.selected=!selectedSongFile; sel.appendChild(ph); S.forEach(f=>{ const o=document.createElement("option"); o.value=f; o.textContent=f.replace(/\.mp3$/i,""); if(selectedSongFile===f) o.selected=true; sel.appendChild(o); }); addEv(sel,"change",()=>{ $("#chosenSongLabel").textContent = sel.value ? sel.options[sel.selectedIndex].textContent : getDynamic('menuSelectedNone'); }); sel.dataset.filled="1"; }
  function confirmSong(){ const sel=$("#songSelect"); if(!sel.value){ alert(getDynamic('alertSelectSong')); return; } selectedSongFile=sel.value; const label=sel.options[sel.selectedIndex].textContent; $("#chosenSongLabel").textContent = label; $("#menuChosenSong").textContent  = label; toMenu(); }

  /* è­œé¢ç”¢ç”Ÿ */
  const LEAD=1.6;
  function genChart(dur){
    chart=[];
    let dbl=.35, tmin=.24, tmax=.52;
    if(diff==='beginner'){ dbl=.15; tmin=.34; tmax=.64; }
    else if(diff==='easy'){ dbl=.20; tmin=.28; tmax=.54; }
    else if(diff==='hard'){ dbl=.55; tmin=.18; tmax=.40; }

    if(!(diff==='ex'||diff==='hell')){
      let t=LEAD;
      while(t<dur){
        const used=new Set(); const arr=[];
        const cnt=Math.random()<dbl?2:1;
        while(arr.length<cnt){
          const ln=Math.floor(Math.random()*LANES);
          if(!used.has(ln)){ used.add(ln); arr.push({t,lane:ln,hit:false,y:-50}); }
        }
        chart.push(...arr);
        t += Math.random()*(tmax-tmin)+tmin;
      }
    }else{
      const beat=0.5; let t=LEAD, cur=0;
      const n = ()=>{ cur=(cur+1)%LANES; return cur; };
      const opp= (i)=> (i + Math.floor(LANES/2)) % LANES;
      const nxt= (i)=> (i + 1) % LANES;
      const rnd= ()=> Math.floor(Math.random()*LANES);
      const push=(tt,ln)=>chart.push({t:tt,lane:ln,hit:false,y:-50});
      while(t<dur){
        if(diff==='ex'){
          push(t, n());
          if(Math.random()<.60) push(t, opp(cur));
          if(Math.random()<.35) push(t+beat/2, nxt(cur));
          if(Math.random()<.18){ push(t+beat/3, rnd()); push(t+2*beat/3, rnd()); }
          t += Math.random()<.5 ? beat/2 : beat;
        }else{ // hell
          push(t, n());
          if(Math.random()<.85) push(t, opp(cur));
          push(t+beat/2, nxt(cur));
          if(Math.random()<.4){ push(t+beat/4, rnd()); push(t+3*beat/4, rnd()); }
          t += beat/2;
        }
      }
    }
    remain=chart.length;
  }

  /* åç§» HUD èˆ‡è¨­å®š */
  function hudOffset(v){
    const text = formatOffset(v);
    const offsetLabel = $("#offsetLabel");
    if(offsetLabel) offsetLabel.textContent = text;
    const dockOffset = $("#dockOffset");
    if(dockOffset) dockOffset.textContent = text;
  }
  function setOffset(v){ v=Math.max(-600,Math.min(600,(v|0))); OFFSET=v; localStorage.setItem("dfjk.offsetMs",String(v)); hudOffset(v); }

  /* æ§åˆ¶ä¸­å¿ƒ */
  let dockOpenState=false, pausedByDock=false, dockEventsBound=false;
  function updateDockHUD(){
    $("#dockSong").textContent = currentSong;
    $("#dockLanes").textContent= String(LANES);
    const diffOpt=$("#difficultySelect")?.querySelector(`option[value="${diff}"]`);
    $("#dockDiff").textContent = diffOpt ? diffOpt.textContent : diff.toUpperCase();
    $("#dockDir").textContent  = (dir==='up'?getDynamic('directionUp'):getDynamic('directionDown'));
    $("#dockJudge").textContent= (jmode==='old'?getDynamic('judgeOld'):getDynamic('judgeNew'));
    $("#dockScore").textContent= String(score);
    $("#dockCombo").textContent= String(combo);
    $("#dockMiss").textContent = String(missCount);
    $("#dockHeatState").textContent = getDynamic(showHeat?'heatStatusOn':'heatStatusOff');
  }
  function toggleHeat(showMessage){
    showHeat = !showHeat;
    ui();
    updateDockHUD();
    if(showMessage) banner(getDynamic(showHeat?'heatOn':'heatOff'));
  }
  function openDock(){
    if(dockOpenState || !canUseDock()) return;
    dockOpenState=true;
    $("#landDock").classList.add('open');
    $("#dockScrim").classList.add('show');
    if(phase==='playing'||phase==='countdown'){
      pausedByDock=true;
      pauseForDock();
    } else {
      pausedByDock=false;
    }
    updateDockHUD();
  }
  function closeDock(silent){
    if(!dockOpenState) return;
    dockOpenState=false;
    $("#landDock").classList.remove('open');
    $("#dockScrim").classList.remove('show');
    if(!silent && pausedByDock){
      pausedByDock=false;
      resumeFromDock();
    }
  }
 function bindDock(){
    const handle = $("#dockHandle");
    const topHandle = $("#dockTopHandle");
    const allowed = canUseDock();
    positionDockHandle();
    if(!allowed){
      closeDock(true);
      $("#landDock")?.setAttribute('aria-hidden','true');
    } else {
      $("#landDock")?.setAttribute('aria-hidden','false');
    }
    const ctrlBtn = $("#ctrlButton");
    if(ctrlBtn){
      ctrlBtn.disabled = !allowed;
      ctrlBtn.setAttribute('aria-disabled', (!allowed).toString());
    }
    if(!dockEventsBound){
      const toggle = ()=>{ if(!canUseDock()) return; dockOpenState?closeDock():openDock(); };
      ["click","pointerdown","touchstart"].forEach(ev=>{
        addEv(topHandle, ev, toggle, {passive:true});
        addEv(handle, ev, toggle, {passive:true});
      });
      addEv($("#dockScrim"),'click', ()=> closeDock() );
      addEv($("#dockResume"),'click', ()=> closeDock() );
      addEv($("#dockHeatToggle"),'click', ()=>{ if(!canUseDock()) return; toggleHeat(true); });
      addEv($("#dockToMenu"),'click', ()=>{ closeDock(true); toMenu(); });
      dockEventsBound=true;
    }
  }

  function setLanes(n){ n = [4,6,8].includes(+n) ? +n : 4; if(n===LANES) return; LANES = n; localStorage.setItem("dfjk.lanes", String(LANES)); W = baseLaneW * LANES; fitDPR(); desktopScale(); applyStageLayout(); recPulse = new Array(LANES).fill(0); recHitT  = new Array(LANES).fill(0); recomputeLaneDirs(); draw({skip:true}); ui(); hud(); }

  /* ç‰ˆé¢å¥—ç”¨ï¼ˆç›´ç‰ˆ 6/8 éµä¸è¶…æ¡†ï¼Œä¸”ä¸å£“ç¸®ç•«é¢/å­—é«”/ç®­é ­ï¼‰ */
  function applyStageLayout(){
    const wrap = $("#stageWrap");
    const topbar = $("#gameScreen .topbar");
    const dockHandleEl = $("#dockTopHandle");
    const vw = Math.min(window.innerWidth, document.documentElement.clientWidth||window.innerWidth);
    const vh = window.innerHeight || document.documentElement.clientHeight || 640;
    const LANDSCAPE = isLandscapeNow();
    
    // ä¾ç›®å‰ lanes å¯¦éš›ç•«å¸ƒå¯¬é«˜æ¯”
    const aspect = W / H;

    if (!IS_MOBILE){
      wrap.classList.remove('landscape');
      const desiredW = Math.round(baseLaneW*LANES*uiScale);
      const targetW  = Math.min(desiredW, Math.floor(vw*0.98));
      const targetH  = Math.round(targetW * (H / W));  // ç¢ºä¿å®¹å™¨é«˜åº¦èˆ‡ canvas æ¯”ä¾‹ä¸€è‡´
      wrap.style.width  = targetW + 'px';
      wrap.style.height = targetH + 'px';
      wrap.style.margin = '20px auto';
      if(topbar) topbar.style.display='flex';
      if(dockHandleEl){ dockHandleEl.classList.remove('show'); dockHandleEl.style.display='none'; }
      $("#landDock").classList.remove('open'); $("#dockScrim").classList.remove('show');
      $("#hpFloat").style.display='none';
    } else if (LANDSCAPE){
      wrap.classList.add('landscape');
      const scale = Math.min(vw / H, vh / W);
      const w = Math.max(320, Math.floor(scale * W));
      const h = Math.max(480, Math.floor(scale * H));
      wrap.style.width  = w + 'px';
      wrap.style.height = h + 'px';
      wrap.style.margin = '0';
      if(topbar) topbar.style.display='none';
      // æ§åˆ¶ä¸­å¿ƒåœ¨æ‰‹æ©Ÿæ©«ç‰ˆç”¨æŠŠæ‰‹
      positionDockHandle();
      hpShow(HP_ON);
    } else {
      // Portrait mobile (åŒ…å« 6/8 éµ)ï¼šç”¨å¯è¦–å¯¬å„ªå…ˆï¼Œç²¾æº–ç®—é«˜ï¼Œä¿è­‰ä¸è¶…æ¡†ä¸”ä¸å¤±çœŸ
      wrap.classList.remove('landscape');
      const maxW = Math.floor(vw * 0.98);
      let targetW = Math.min(maxW, Math.round(baseLaneW*LANES)); // å°è¢å¹•è‡ªå‹•ç¸®å°
      let targetH = Math.round(targetW * (H / W));
      let marginTop = 20;

      if (MOBILE_FULL && LANES>4){
        const topPad = (()=>{
          if(!topbar) return 24;
          const tr = topbar.getBoundingClientRect();
          return Math.max(24, Math.round(tr.height + 24));
        })();
        const availableH = Math.max(360, Math.floor(vh - topPad - 20));
        let h1 = Math.min(Math.floor(vh * 0.96), availableH);
        let w1 = Math.round(h1 * aspect);
        if (w1 > maxW){ w1 = maxW; h1 = Math.round(w1 / aspect); }
        targetW = w1; targetH = h1;
        marginTop = Math.max(8, topPad);
      }

      wrap.style.width  = targetW + 'px';
      wrap.style.height = targetH + 'px';
      wrap.style.margin = `${marginTop}px auto 20px`;
      if(topbar) topbar.style.display='flex';
      if(dockHandleEl){ dockHandleEl.classList.remove('show'); dockHandleEl.style.display='none'; }
      $("#landDock").classList.remove('open'); $("#dockScrim").classList.remove('show');
      $("#hpFloat").style.display='none';
    }
    layout(); draw({skip:true}); ui();
    positionHpFloat();
  }

  /* å°‡æ§åˆ¶ä¸­å¿ƒæŠŠæ‰‹å®šä½åœ¨ã€Œæ—‹è½‰å¾Œèˆå°ã€çš„ç›¸å°é ‚éƒ¨ä¸­å¤®ï¼ˆé•·é‚Šä¸­å¤®ï¼‰ */
  function positionDockHandle(){
    const LANDSCAPE = isLandscapeNow();
    const handle = $("#dockTopHandle");
    if(!handle) return;
    if(!(IS_MOBILE && LANDSCAPE && canUseDock())){
      handle.style.display='none';
      handle.classList.remove('show');
      return;
    }
    handle.style.display='block';
    handle.classList.add('show');
    positionHpFloat();
  }

  /* å°‡æµ®å‹• HP æ¢å®šä½åˆ°æ—‹è½‰èˆå°çš„ç›¸å°å³ä¸Š */
  function positionHpFloat(){
    const LANDSCAPE = isLandscapeNow();
    const f = $("#hpFloat");
    if(!(IS_MOBILE && LANDSCAPE && f.style.display==='block')) return;
    const wrap = $("#stageWrap");
    if(!wrap) return;
    const baseW = wrap.offsetWidth || W;
    const width = Math.max(180, Math.min(280, Math.floor(baseW * 0.55)));
    const margin = Math.max(14, Math.round(baseW * 0.04));
    f.style.width = width + 'px';
    f.style.right = margin + 'px';
    f.style.left = 'auto';
    const handle = $("#dockTopHandle");
    const handleGap = (handle && handle.classList.contains('show')) ? ((handle.offsetHeight||0) + 18) : 0;
    const top = Math.max(margin + handleGap, 16);
    f.style.top = top + 'px';
  }

  /* è¼¸å…¥è™•ç† */
  const VIB = IS_MOBILE && ("vibrate" in navigator);
  function laneKeyFromChar(k){
    k=k.toLowerCase();
    if(LANES===4){
      if(k==='d')return 0; if(k==='f')return 1; if(k==='j')return 2; if(k==='k')return 3;
      if(k==='arrowleft')return 0; if(k==='arrowdown')return 1; if(k==='arrowup')return 2; if(k==='arrowright')return 3;
      return null;
    }
    if(LANES===6){ if(k==='s')return 0; if(k==='d')return 1; if(k==='f')return 2; if(k==='j')return 3; if(k==='k')return 4; if(k==='l')return 5; return null; }
    if(k==='a')return 0; if(k==='s')return 1; if(k==='d')return 2; if(k==='f')return 3; if(k==='j')return 4; if(k==='k')return 5; if(k==='l')return 6; if(k===';')return 7; return null;
  }
  function lanePtrFromClient(clientX, clientY){
    const r = c.getBoundingClientRect();
    const LANDSCAPE = isLandscapeNow();
    let xCss, denom;
    if (!LANDSCAPE){ xCss = clientX - r.left; denom = r.width; }
    else { xCss = clientY - r.top; denom = r.height; }
    const x = xCss / denom * W;
    let best=0, bd=1e9; for(let i=0;i<LANES;i++){ const d=Math.abs(x-laneX(i)); if(d<bd){ bd=d; best=i; } } return best;
  }
  function onPress(l){
    if(!running) return;
    tapSfx();
    const t=judgeClock(); let bi=-1, ba=1e9;
    for(let i=0;i<chart.length;i++){
      const n=chart[i]; if(n.hit||n.lane!==l) continue;
      const dt=(t-n.t)*1000, ad=Math.abs(dt);
      if(ad<=WIN.shit && ad<ba){ ba=ad; bi=i; }
    }
    if(bi>=0){
      const n=chart[bi]; n.hit=true; remain--;
      const dt=(t-n.t)*1000; let r="";
      if(Math.abs(dt)<=WIN.sick){ r='SICK!'; score=Math.max(0,score+SC.sick); stats.sick++; combo++; }
      else if(Math.abs(dt)<=WIN.good){ r='GOOD'; score=Math.max(0,score+SC.good); stats.good++; combo++; }
      else if(Math.abs(dt)<=WIN.bad){ r='BAD'; score=Math.max(0,score+SC.bad); stats.bad++; combo++; }
      else { r='SHIT'; score=Math.max(0,score+SC.shit); stats.shit++; combo=Math.max(0,combo-1); }
      lastJudge=r; recDt(dt); hud(); const key=r.replace('!',''); if(['SICK','GOOD','BAD','SHIT'].includes(key)) hpAdd(hpDelta(key)); if(combo>0 && combo%10===0) comboFlashNow(); addHit(l); impact(l); if(VIB){ try{ navigator.vibrate(10);}catch{} }
    }else{ if(jmode==='old'){ lastJudge='WRONG'; wrongCount++; hpAdd(-2); } else lastJudge='-'; hud(); recPulse[l]=Math.max(recPulse[l],1.0); addHit(l); impact(l); }
  }
  addEv(window,"keydown", e=>{
    if(e.repeat) return; const k=e.key.toLowerCase();
    if(k==='h'){ toggleHeat(true); e.preventDefault(); return; }
    if(k==='r'){ heatMode=(heatMode+1)%3; const pos=heatMode===0?getDynamic('heatAuto'):(heatMode===1?getDynamic('heatTop'):getDynamic('heatBottom')); banner(getDynamic('heatPosition',{position:pos})); ui(); e.preventDefault(); return; }
    const l=laneKeyFromChar(k);
    if(l!==null){ if(running&&!paused){ onPress(l); } e.preventDefault(); return; }
    if(k==='escape' || k==='enter'){
      if(dockOpenState){ closeDock(); e.preventDefault(); return; }
      if(!canUseDock()) return;
      if(phase==='countdown') cancelCountdown();
      openDock();
      e.preventDefault();
      return;
    }
  });
  addEv(c,"pointerdown", e=>{ if(!running||paused) return; e.preventDefault(); const l=lanePtrFromClient(e.clientX, e.clientY); onPress(l); }, {passive:false});
  addEv(c,"touchstart", e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); }, {passive:false});
  addEv(c,"touchmove",  e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); }, {passive:false});
  addEv(window,"dblclick",     e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); }, {passive:false});
  addEv(window,"gesturestart", e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); }, {passive:false});

  /* å€’æ•¸ */
  let counting=false;
  function countdown(startCb,opt={}){
    const show=!!opt.show, pv=(typeof opt.t==='number')?opt.t:0;
    cancelCountdown(); counting=true; const el=$("#countdownText"); el.style.display='block'; el.dataset.locked='1';
    const ready=getDynamic('countdownReady'), go=getDynamic('countdownGo');
    const lab=[ready,'3','2','1',go], dur=[600,800,800,800,600], t0=performance.now();
    function step(now){
      if(!counting) return; const e=now-t0; let acc=0, idx=lab.length-1;
      for(let i=0;i<lab.length;i++){ acc+=dur[i]; if(e<acc){ idx=i; break; } }
      el.textContent=(idx<lab.length?lab[idx]:go); el.style.animation='none'; void el.offsetWidth; el.style.animation='popScale .55s ease-out';
      if(show){ drawPreview(pv); } else { draw({skip:true}); } ui();
      const total=dur.reduce((a,b)=>a+b,0);
      if(e>=total){ el.style.display='none'; counting=false; delete el.dataset.locked; startCb(); return; }
      cRAF=requestAnimationFrame(step);
    }
    cRAF=requestAnimationFrame(step);
  }
  function cancelCountdown(){ if(!counting && !cRAF) return; counting=false; try{ cancelAnimationFrame(cRAF);}catch{} cRAF=null; const el=$("#countdownText"); el.style.animation='none'; el.style.display='none'; if(el) delete el.dataset.locked; }

  /* éŠæˆ²æµç¨‹ */
  function startGame(){
    if(!selectedSongFile){ toMusic(); alert(getDynamic('alertSelectSong')); return; }
    diff=$("#difficultySelect").value; dir=$("#noteDirection").value; jmode=$("#judgeMode").value;
    document.body.classList.toggle('ex-mode', diff==='ex');
    let mul=parseFloat($("#speedMultiplier").value);
    if(diff==='beginner') mul=0.8; else if(diff==='easy') mul=0.9;
    score=0; combo=0; lastJudge='-'; missCount=0; stats={sick:0,good:0,bad:0,shit:0,miss:0}; wrongCount=0;
    chart=[]; remain=0; dts.length=0; recPulse=new Array(LANES).fill(0); recHitT=new Array(LANES).fill(0);
    comboFlash=""; hits.length=0; parts.length=0; spd=baseSpd*mul; currentSong=selectedSongFile.replace(/\.mp3$/i,''); hud();
    HP=HP_MAX; hpShow(HP_ON); hpUpdate();
    phase='countdown';
    showOnly('gameScreen');
    fitDPR(); desktopScale(); applyStageLayout();
    draw({skip:true}); ui();
    const url='music/'+encodeURIComponent(selectedSongFile);
    stopAudio(); bgm.src=url; try{ bgm.load(); }catch{}
    durSec = isFinite(bgm.duration) ? bgm.duration : 120;
    genChart(durSec||120);
    countdown(()=>{ phase='playing'; running=true; startAt(0); loopId=requestAnimationFrame(loop); }, {show:false});
  }
  let pausedAt=0;
  // === Dockå°ˆç”¨çš„ã€Œè»Ÿæš«åœã€ï¼šä¿ç•™éŠæˆ²ç•«é¢èˆ‡éŸ³ç¬¦åœ¨èƒŒå¾Œ ===
  function pauseForDock(){
    if(phase==='countdown') cancelCountdown();
    if(!running && phase!=='countdown') return;
    paused=true; phase='paused';
    $("#gameScreen").classList.remove('blur'); // ä¸è¦æ¨¡ç³Šï¼Œä¹Ÿä¸è¦åˆ‡åˆ°æš«åœé 
    showOnly('gameScreen');                      // ä¿æŒéŠæˆ²ç•«é¢åœ¨èƒŒå¾Œ
    pausedAt=hardClock();
    stopLoop();
    stopAudio();
    // ä¸æ¸…ç•«å¸ƒï¼Œä¿ç•™å‰©é¤˜éŸ³ç¬¦åœ¨ç•¶å‰å½±æ ¼
  }
  function resumeFromDock(){
    if(!paused) return;
    paused=false; phase='countdown';
    showOnly('gameScreen');
    const t=pausedAt;
    countdown(()=>{ phase='playing'; running=true; startAt(t); loopId=requestAnimationFrame(loop); }, {show:true,t});
  }
  function pauseGame(fromC){
    if(phase==='countdown' && fromC!==true) cancelCountdown();
    if(!running && phase!=='countdown') return;
    paused=true; phase='paused'; $("#gameScreen").classList.add('blur'); showOnly('pauseScreen');
    pausedAt=hardClock(); stopLoop(); stopAudio();
  }
  function resumeGame(){
    if(!paused) return; paused=false; phase='countdown';
    showOnly('gameScreen'); $("#gameScreen").classList.remove('blur');
    const t=pausedAt;
    countdown(()=>{ phase='playing'; running=true; startAt(t); loopId=requestAnimationFrame(loop); }, {show:true,t});
  }
  function loop(){
    if(paused) return;
    const t=hardClock();
    upd(t,1/60); draw(); ui();
    if(ended || remain<=0){ endWith(); return; }
    loopId=requestAnimationFrame(loop);
  }
  function stopLoop(){ try{ cancelAnimationFrame(loopId);}catch{} loopId=null; }

  /* æ ¡æ­£ */
  const pnl=$("#calibOverlay"), cbStart=$("#calibStart"), cbDone=$("#calibFinish"), cbCancel=$("#calibCancel"), cbBig=$("#calibBig"), cbDot=$("#calibBeatDot"), cbStat=$("#calibStat");
  let cal=false, beatInt=1.0, beats=16, taps=[], tapH=null, syncP0=0, syncC0=0, t0C=0;
  async function openCalib(){ if(phase==='playing' || phase==='countdown'){ banner(getDynamic('needPauseForCalib')); return; } pnl.style.display='block'; cbBig.dataset.locked='1'; cbStat.dataset.locked='1'; cbBig.textContent=getDynamic('calibrationReady'); cbStat.textContent=getDynamic('calibrationStats',{count:0,total:10,advice:getDynamic('calibrationAdviceNone')}); taps=[]; cbDone.disabled=true; await ensureAC().catch(()=>{}); }
  function closeCalib(){ pnl.style.display='none'; cancelCalibAudio(); cal=false; if(tapH){ window.removeEventListener('keydown',tapH); pnl.removeEventListener('pointerdown',tapH); tapH=null; } delete cbBig.dataset.locked; delete cbStat.dataset.locked; cbBig.textContent=getDynamic('calibrationReady'); cbStat.textContent=getDynamic('calibrationStats',{count:0,total:10,advice:getDynamic('calibrationAdviceNone')}); }
  function robust(arr){ if(!arr.length) return 0; const s=[...arr].sort((a,b)=>a-b), m=s[Math.floor(s.length/2)]; const dev=s.map(v=>Math.abs(v-m)).sort((a,b)=>a-b), MAD=dev[Math.floor(dev.length/2)]||1; const keep=arr.filter(v=>Math.abs(v-m)<=Math.max(3*MAD,120)); const t=keep.sort((a,b)=>a-b), lo=Math.floor(t.length*0.2), hi=Math.ceil(t.length*0.8), core=t.slice(lo,hi); const mean=core.reduce((a,c)=>a+c,0)/Math.max(1,core.length); return Math.max(-600,Math.min(600,Math.round(mean))); }
  function startCalib(){ try{ timers.forEach(id=>clearTimeout(id)); }catch{} timers=[]; taps=[]; cbDone.disabled=true; cal=true; try{ AC.resume(); }catch{} if(!Gcal){ Gcal = AC.createGain(); Gcal.gain.value = 1; Gcal.connect(Gsfx||Gm); } syncP0=performance.now()/1000; syncC0=AC.currentTime; const lead=.70; t0C=AC.currentTime+lead;
    for(let i=0;i<beats;i++){ const t=t0C+i*beatInt; const o=AC.createOscillator(), g=AC.createGain(); o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.45,t+0.005); g.gain.exponentialRampToValueAtTime(0.0001,t+0.08); o.connect(g); g.connect(Gcal); o.start(t); o.stop(t+0.09);
      const d=(t-AC.currentTime)*1000; const id=setTimeout(()=>{ cbDot.style.transform='scale(1.28)'; cbDot.style.boxShadow='0 0 30px rgba(120,213,255,1)'; setTimeout(()=>{ cbDot.style.transform='scale(1)'; cbDot.style.boxShadow='0 0 30px rgba(120,213,255,.9)'; },120); }, d); timers.push(id); }
    tapH=(e)=>{ if(e.type==='keydown'){ const k=e.key.toLowerCase(); if(!['d','f','j','k','s','a','l',';'].includes(k)) return; e.preventDefault(); }
      const tp=performance.now()/1000, tC=syncC0 + (tp - syncP0); if(tC < t0C - 0.15) return; const k=Math.round((tC - t0C)/beatInt), tB=t0C + k*beatInt, dMs=(tC - tB)*1000; if(Math.abs(dMs)<=600) taps.push(dMs);
      const need=10, nowN=Math.min(taps.length,need); let adv=getDynamic('calibrationAdviceNone'); if(nowN>=4){ const rec=robust(taps); adv=formatOffset(rec,{signed:true}); } cbBig.textContent = `${nowN}/${need}`; cbStat.textContent = getDynamic('calibrationStats',{count:nowN,total:need,advice:adv}); if(nowN>=need) cbDone.disabled=false; };
    addEv(window,'keydown', tapH); addEv(pnl,'pointerdown', tapH, {passive:true}); }
  function finishCalib(){ if(!taps.length){ closeCalib(); return; } const rec=robust(taps); setOffset(rec); banner(getDynamic('appliedOffset',{value:rec})); closeCalib(); }

  /* ç¶å®š */
  function bind(){
    addEv($("#btnStart"),"click", startGame);
    addEv($("#btnMusic"),"click", toMusic);
    addEv($("#btnOptions"),"click", toOpt);
    addEv($("#btnSongConfirm"),"click", confirmSong);
    $$(".btnBackMenu").forEach(b=> addEv(b,"click", toMenu) );

    // è£œå¼·ï¼šä»»ä½•æƒ…æ³ä¸‹é»åˆ° #btnOptions éƒ½æœƒé€²å…¥é¸é …ï¼ˆé¿å…ç’°å¢ƒæ€ªç•°å°è‡´åŸç¶å®šå¤±æ•ˆï¼‰
    addEv(document,'click', (e)=>{ const t=e.target; const hit = t && (t.id==='btnOptions' || (t.closest && t.closest('#btnOptions'))); if(hit){ e.preventDefault(); toOpt(); } }, {capture:true});
    addEv(document,'pointerup', (e)=>{ const t=e.target; const hit = t && (t.id==='btnOptions' || (t.closest && t.closest('#btnOptions'))); if(hit){ e.preventDefault(); toOpt(); } }, {capture:true});
    addEv(document,'touchend', (e)=>{ const t=e.target; const hit = t && (t.id==='btnOptions' || (t.closest && t.closest('#btnOptions'))); if(hit){ e.preventDefault(); toOpt(); } }, {capture:true});

    // ç›´å‘/æ¡Œæ©Ÿï¼šæ§åˆ¶ä¸­å¿ƒå…¥å£æŒ‰éˆ•ï¼ˆå–ä»£ HEAT èˆ‡ æš«åœéµï¼‰
    const ctrlBtn = $("#ctrlButton");
    addEv(ctrlBtn, "click", ()=>{
      if(!canUseDock()) return;
      if(phase==='countdown') cancelCountdown();
      openDock();
    });
    
    // æš«åœé ä»ä¿ç•™å¿«æ·éµï¼ˆå¾æ§åˆ¶ä¸­å¿ƒ resume æ™‚æœƒç”¨åˆ°ï¼‰
    addEv($("#btnResume"),"click", resumeGame);
    addEv($("#btnRestart"),"click", startGame);

    /* éŸ³é‡ */
    const mS=$("#volumeSlider"), mL=$("#volumeLabel"), sS=$("#sfxSlider"), sL=$("#sfxLabel");
    const mv=+(localStorage.getItem("dfjk.volume")||80), sv=+(localStorage.getItem("dfjk.sfxVol")||70);
    mS.value=String(mv); sS.value=String(sv); VOL_M=mv/100; VOL_S=sv/100; applyVol();
    mL.textContent=`${mv}%`; sL.textContent=`${sv}%`;
    addEv(mS,"input", ()=>{ const v=+mS.value; VOL_M=v/100; mL.textContent=`${v}%`; localStorage.setItem("dfjk.volume",String(v)); applyVol(); });
    addEv(sS,"input", ()=>{ const v=+sS.value; VOL_S=v/100; sL.textContent=`${v}%`; localStorage.setItem("dfjk.sfxVol",String(v)); applyVol(); });

    /* åç§» slider + å¿«é€Ÿæ ¡æ­£ */
    const oS=$("#offsetSlider"), svOff=+(localStorage.getItem("dfjk.offsetMs")||0);
    oS.value=String(svOff); setOffset(svOff);
    addEv(oS,"input", ()=> setOffset(+oS.value) );
    addEv($("#offsetCalibBtn"),"click", openCalib);
    addEv($("#calibStart"),"click", ()=>{ if(!cal) startCalib(); });
    addEv($("#calibFinish"),"click", finishCalib);
    addEv($("#calibCancel"),"click", closeCalib);

    /* RGB åˆ‡æ› */
    const rgb=$("#rgbCycleToggle"); rgb.checked=RGB;
    addEv(rgb,"change", ()=>{ RGB=rgb.checked; localStorage.setItem("dfjk.rgbCycle", RGB?'1':'0'); });

    /* è¡€æ¢æ¨¡å¼ */
    const hpC=$("#hpToggle"); hpC.checked=HP_ON;
    addEv(hpC,"change", ()=>{ HP_ON=hpC.checked; localStorage.setItem("dfjk.hpOn", HP_ON?'1':'0'); hpShow(HP_ON); });

    /* éµæ•¸é¸æ“‡ */
    const keySel=$("#keyModeSelect");
    keySel.value = String(LANES);
    addEv(keySel,"change", ()=>{ const n=+keySel.value; setLanes(n); banner(getDynamic('keyChanged',{value:n})); });

    /* æ‰‹æ©Ÿå…¨é«˜èˆ‡æ©«æ¿ï¼ˆæ©«æ¿æœªå‹¾é¸æ™‚è‡ªå‹•ä¾è¢å¹•æ–¹å‘ï¼‰ */
    const full=$("#mobileFullHeight"), land=$("#mobileLandscape");
    full.checked=MOBILE_FULL; land.checked=LANDSCAPE_FORCE;
    addEv(full,'change',()=>{ if(!IS_MOBILE){ banner('æ­¤é¸é …åªåœ¨è¡Œå‹•è£ç½®ç”Ÿæ•ˆ'); full.checked=MOBILE_FULL; return; } MOBILE_FULL=full.checked; localStorage.setItem('dfjk.mobileFull', MOBILE_FULL?'1':'0'); applyStageLayout(); });
    addEv(land,'change',()=>{ if(!IS_MOBILE){ banner('æ­¤é¸é …åªåœ¨è¡Œå‹•è£ç½®ç”Ÿæ•ˆ'); land.checked=LANDSCAPE_FORCE; return; } LANDSCAPE_FORCE=land.checked; localStorage.setItem('dfjk.landscape', LANDSCAPE_FORCE?'1':'0'); applyStageLayout(); bindDock(); });

    bindDock();

    /* é¸é …ä¿åº•é»æ“Šï¼ˆèˆŠç’°å¢ƒç›¸å®¹ï¼‰ */
    addEv(document,'click', (e)=>{
      const t = e.target;
      const hit = t && (t.id === 'btnOptions' || (t.closest && t.closest('#btnOptions')));
      if(!hit) return;
      e.preventDefault();
      try { toOpt?.(); return; } catch(_) {}
      try { showOnly?.('optionsScreen'); return; } catch(_) {}
      ['menuScreen','musicScreen','optionsScreen','gameScreen','pauseScreen','endScreen']
        .forEach(id => { const el = document.getElementById(id); if(el) el.style.display = (id==='optionsScreen')?'block':'none'; });
    }, {capture:true});
  }

  function init(){
    // å°å¤–æš´éœ²ä¿åº• APIï¼Œè®“ HTML æŒ‰éˆ•å¯ç›´æ¥å‘¼å«
    window.__DFJK_API__ = { toOpt, toMenu, toMusic, startGame, openDock, closeDock };
    setupLanguageSelect();
    setLanguage(currentLang, {skipStorage:true});
    recomputeLaneDirs();
    fitDPR(); desktopScale(); applyStageLayout();
    fillSongs(); bind(); hpShow(HP_ON); hpUpdate(); hud();
    showOnly("menuScreen");
    addEv(window,"resize", ()=>{ fitDPR(); desktopScale(); applyStageLayout(); bindDock(); if(phase==='countdown'){ draw({skip:true}); ui(); } });
    addEv(window,"orientationchange", ()=>{ setTimeout(()=>{ fitDPR(); desktopScale(); applyStageLayout(); bindDock(); }, 50); });
  }
  if (document.readyState === "loading") addEv(document, "DOMContentLoaded", init); else init();
})(); // end IIFE
</script>
</body>
</html>







