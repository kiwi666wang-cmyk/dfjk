<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>DFJK â€” è¡€æ¢ï¼‹RGBï¼‹æ ¡æ­£ï¼ˆéµæ•¸å¯é¸ï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet"/>
<style>
/* ===== åŸºç¤ ===== */
html,body{ margin:0; touch-action:manipulation; overscroll-behavior:none; }
body{
  color:#fff; font-family:sans-serif; text-align:center;
  background:radial-gradient(1200px 780px at 50% 0%, #101b33 0%, #0a1226 55%, #07111f 100%);
  transition:background .3s ease;
}
body.ex-mode{ background:linear-gradient(to bottom, #ff3300 0%, #990000 50%, #000 100%); }

/* ===== èˆå° ===== */
#stage{
  position:relative;
  width:95%;
  max-width:420px; /* æœƒè¢« JS ä¾éµæ•¸è¦†å¯« */
  margin:20px auto;
  --u:1;
  z-index:1;
}
canvas{ display:block; width:100%; height:auto; background:#0c1322; }
#uiCanvas{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; background:transparent; border:none; z-index:6; }

/* æ¼¸å±¤å½é‚Šç•Œ */
#edgeFade{
  position:absolute; inset:0; pointer-events:none; border-radius:10px; z-index:5;
  background:
    linear-gradient(to right, rgba(255,255,255,.16), rgba(255,255,255,0) 40%) left/16px 100% no-repeat,
    linear-gradient(to left,  rgba(255,255,255,.16), rgba(255,255,255,0) 40%) right/16px 100% no-repeat,
    linear-gradient(to bottom,rgba(255,255,255,.16), rgba(255,255,255,0) 40%) top/100% 16px no-repeat,
    linear-gradient(to top,   rgba(255,255,255,.16), rgba(255,255,255,0) 40%) bottom/100% 16px no-repeat;
}

/* ===== ä¸Šæ–¹åˆ—ï¼šHEAT / HP / æš«åœ ===== */
.topbar{
  position:absolute; top:10px; left:0; right:0; z-index:8;
  display:flex; align-items:center; gap:8px; padding:0 10px;
}
#toggleHeatBtn{
  padding:6px 10px; font-size:12px; background:#1c293e;
  border:1px solid rgba(255,255,255,.35); border-radius:8px; color:#fff; opacity:.95; cursor:pointer;
}
#pauseButton{ padding:6px 10px; font-size:14px; border:none; border-radius:8px; background:#78d5ff; cursor:pointer; }

/* è¡€æ¢ */
#hpBar{ position:relative; flex:1; height:18px; margin:0 2px; background:rgba(255,255,255,.18); border-radius:999px; display:none; }
#hpFill{ position:absolute; inset:0 auto 0 0; width:100%; background:#ff3b3b; border-radius:999px; }
#hpText{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-weight:800; color:#000; font-size:12px; }

/* å…¶ä»– UI */
.hitbar{ position:absolute; left:0; width:100%; display:flex; justify-content:space-between; align-items:center; height:calc(90px * var(--u)); z-index:2; opacity:0; pointer-events:none; }
.hud{ font-size:18px; margin-top:10px; line-height:1.6; }
.songline{ font-size:14px; opacity:.9; }
button{ margin:10px; padding:10px 20px; font-size:18px; background:#78d5ff; border:none; border-radius:8px; cursor:pointer; }
#menuScreen,#musicScreen,#endScreen,#optionsScreen,#pauseScreen{ padding-top:120px; }
.blur{ filter:blur(6px); pointer-events:none; user-select:none; }

/* å€’æ•¸ */
#countdownText{
  position:absolute; top:40%; left:50%; transform:translate(-50%,-50%);
  font-family:'Fredoka One',sans-serif; font-size:72px; color:#fff; text-shadow:2px 2px 8px #000; z-index:9; pointer-events:none; display:none;
}
@keyframes popScale{ 0%{transform:translate(-50%,-50%) scale(.85)} 50%{transform:translate(-50%,-50%) scale(1.12)} 100%{transform:translate(-50%,-50%) scale(1)} }

/* å…¶ä»– */
#warnBanner{
  position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
  background:rgba(255,80,80,.95); padding:10px 14px; border-radius:8px; font-size:14px; display:none; z-index:20;
}
.row{margin:8px 0} label{margin-right:6px}
select,input[type=range]{ padding:6px 10px; border-radius:6px; border:1px solid #445; background:#12152a; color:#fff; }
#songSelect{ width:90%; max-width:420px; height:280px; }
</style>
</head>
<body>

<!-- ===== ä¸»é¸å–® ===== -->
<div id="menuScreen">
  <h1>ğŸµ DFJK</h1>
  <div class="row">
    <button id="btnStart">é–‹å§‹éŠæˆ²</button>
    <button id="btnMusic">éŸ³æ¨‚</button>
    <button id="btnOptions">é¸é …</button>
  </div>
  <div class="row">å·²é¸æ›²ç›®ï¼š<span id="menuChosenSong">å°šæœªé¸æ“‡</span></div>
</div>

<!-- ===== éŸ³æ¨‚é¸å–® ===== -->
<div id="musicScreen" style="display:none;">
  <h2>ğŸ¼ é¸æ“‡æœ¬å±€æ›²ç›®</h2>
  <div class="row"><select id="songSelect" size="12"></select></div>
  <div class="row">
    <button id="btnSongConfirm">ç¢ºå®š</button>
    <button class="btnBackMenu">å›ä¸»é¸å–®</button>
  </div>
  <div class="row">å·²é¸ï¼š<span id="chosenSongLabel">å°šæœªé¸æ“‡</span></div>
</div>

<!-- ===== é¸é … ===== -->
<div id="optionsScreen" style="display:none;">
  <h2>âš™ï¸ éŠæˆ²é¸é …</h2>

  <div class="row">
    <label for="keyModeSelect">éµæ•¸ï¼š</label>
    <select id="keyModeSelect">
      <option value="4" selected>4 éµï¼ˆDFJK / å¯ç”¨æ–¹å‘éµï¼‰</option>
      <option value="6">6 éµï¼ˆSDF JKLï¼‰</option>
      <option value="8">8 éµï¼ˆASDF JKL;ï¼‰</option>
    </select>
  </div>

  <div class="row">
    <label for="difficultySelect">é›£åº¦ï¼š</label>
    <select id="difficultySelect">
      <option value="ex">EXï¼ˆæ¥µé™ï¼‰</option>
      <option value="hell">åœ°ç„</option>
      <option value="hard">å›°é›£</option>
      <option value="normal" selected>æ™®é€š</option>
      <option value="easy">ç°¡å–®</option>
      <option value="beginner">åˆå­¸è€…</option>
    </select>
  </div>

  <div class="row">
    <label for="speedMultiplier">é€Ÿåº¦å€ç‡ï¼š</label>
    <select id="speedMultiplier">
      <option value="1">1.0xï¼ˆæ¨™æº–ï¼‰</option><option value="1.1">1.1x</option><option value="1.2">1.2x</option>
      <option value="1.3">1.3x</option><option value="1.6">1.6x</option><option value="2.0">2.0x</option>
      <option value="2.2">2.2x</option><option value="2.4">2.4x</option><option value="2.6">2.6x</option>
      <option value="2.8">2.8x</option><option value="3.0">3.0x</option>
    </select>
  </div>

  <div class="row">
    <label for="noteDirection">éŸ³ç¬¦æ–¹å‘ï¼š</label>
    <select id="noteDirection">
      <option value="down" selected>ä¸‹è½æ‰“æ“Š</option>
      <option value="up">ä¸Šå‡æ‰“æ“Š</option>
    </select>
  </div>

  <div class="row">
    <label for="judgeMode">åˆ¤å®šæ¨¡å¼ï¼š</label>
    <select id="judgeMode">
      <option value="old" selected>Old Inputï¼ˆå« WRONGï¼‰</option>
      <option value="new">New Input</option>
    </select>
  </div>

  <div class="row">
    <label for="volumeSlider">ä¸»éŸ³é‡ï¼ˆBGMï¼‰ï¼š</label>
    <input id="volumeSlider" type="range" min="0" max="100" value="80"/>
    <span id="volumeLabel">80%</span>
  </div>

  <div class="row">
    <label for="sfxSlider">æ•²æ“Šè²éŸ³é‡ï¼š</label>
    <input id="sfxSlider" type="range" min="0" max="100" value="70"/>
    <span id="sfxLabel">70%</span>
  </div>

  <hr class="row" style="opacity:.2"/>

  <h3>ğŸ¯ å‘½ä¸­å»¶é²æ ¡æ­£</h3>
  <div class="row">
    <label for="offsetSlider">å…¨åŸŸåç§» (ms)ï¼š</label>
    <input id="offsetSlider" type="range" min="-600" max="600" value="0"/>
    <span id="offsetLabel">0 ms</span>
    <button id="offsetCalibBtn" type="button">å¿«é€Ÿæ ¡æ­£</button>
  </div>

  <hr class="row" style="opacity:.2"/>

  <div class="row">
    <label for="rgbCycleToggle">RGB å¾ªç’°ç®­é ­è‰²ï¼š</label>
    <input id="rgbCycleToggle" type="checkbox"/>
  </div>

  <div class="row">
    <label for="hpToggle">è¡€æ¢æ¨¡å¼ï¼š</label>
    <input id="hpToggle" type="checkbox"/>
  </div>

  <div class="row"><button class="btnBackMenu">å›ä¸»é¸å–®</button></div>
</div>

<!-- ===== éŠæˆ²ç•«é¢ ===== -->
<div id="gameScreen" style="display:none;position:relative;">
  <div class="topbar">
    <button id="toggleHeatBtn">HEAT</button>
    <div id="hpBar"><div id="hpFill"></div><div id="hpText">100/100</div></div>
    <button id="pauseButton">â¸ï¸</button>
  </div>

  <div id="stage">
    <canvas id="gameCanvas" width="420" height="640"></canvas>
    <canvas id="uiCanvas"   width="420" height="640"></canvas>
    <div id="edgeFade"></div>
    <div class="hitbar"><div></div><div></div><div></div><div></div></div>
    <div id="countdownText">Ready</div>
  </div>

  <div class="hud">
    åˆ†æ•¸ï¼š<span id="score">0</span>ã€€
    é€£æ“Šï¼š<span id="combo">0</span>ã€€
    åˆ¤å®šï¼š<span id="judgement">-</span>ã€€
    MISSï¼š<span id="missCount">0</span>
    <div class="songline">
      æ›²ç›®ï¼š<span id="songTitle">-</span> ï½œ éµæ•¸ï¼š<span id="laneLabel">4</span> ï½œ 
      é›£åº¦ï¼š<span id="diffLabel">-</span> ï½œ æ–¹å‘ï¼š<span id="dirLabel">-</span> ï½œ 
      åˆ¤å®šï¼š<span id="judgeLabel">-</span> ï½œ åç§»ï¼š<span id="offsetActive">0 ms</span>
    </div>
  </div>
</div>

<!-- ===== æš«åœ ===== -->
<div id="pauseScreen" style="display:none;">
  <h2>â¸ï¸ éŠæˆ²æš«åœ</h2>
  <button id="btnResume">â–¶ï¸ ç¹¼çºŒ</button>
  <button class="btnBackMenu">å›ä¸»é¸å–®</button>
</div>

<!-- ===== çµæŸ ===== -->
<div id="endScreen" style="display:none;">
  <h2>ğŸ® éŠæˆ²çµæŸï¼</h2>
  <p>æ›²ç›®ï¼š<span id="finalSong">-</span></p>
  <p>é›£åº¦ï¼š<span id="finalDiff">-</span></p>
  <p>æ–¹å‘ï¼š<span id="finalDir">-</span></p>
  <p>åˆ¤å®šï¼š<span id="finalJudge">-</span></p>
  <p>åˆ†æ•¸ï¼š<span id="finalScore">0</span></p>
  <p>SICKï¼š<span id="statSick">0</span></p>
  <p>GOODï¼š<span id="statGood">0</span></p>
  <p>BADï¼š<span id="statBad">0</span></p>
  <p>SHITï¼š<span id="statShit">0</span></p>
  <p>MISSï¼š<span id="statMiss">0</span></p>
  <button id="btnRestart">å†ç©ä¸€æ¬¡</button>
  <button class="btnBackMenu">å›ä¸»é¸å–®</button>
</div>

<!-- ===== æ ¡æ­£è¦†è“‹å±¤ ===== -->
<div id="calibOverlay" style="position:fixed; inset:0; display:none; z-index:50; background:rgba(3,7,15,.86); backdrop-filter:blur(2px);">
  <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(520px,92vw); padding:18px 16px; border-radius:12px; background:rgba(10,16,30,.9); box-shadow:0 10px 40px rgba(0,0,0,.4); border:1px solid rgba(120,213,255,.3);">
    <div style="font-size:22px; margin:6px 0 4px;">ğŸ¯ å¿«é€Ÿæ ¡æ­£</div>
    <div style="opacity:.85; font-size:14px; margin-bottom:8px;">è·Ÿè‘—ç¯€æ‹ï¼ˆæ¯æ‹ 1000msï¼‰æŒ‰ DFJK æˆ–é»ç•«é¢ï¼Œè‡³å°‘ 10 æ¬¡å¾Œå¯å®Œæˆã€‚ä¸­ä½æ•¸ + MAD å»æ¥µå€¼ã€‚</div>
    <div id="calibBeatDot" style="width:26px; height:26px; border-radius:50%; margin:12px auto; background:#78d5ff; box-shadow:0 0 30px rgba(120,213,255,.95);"></div>
    <div id="calibBig" style="font:700 44px/1.2 'Fredoka One',sans-serif; margin:8px 0 2px;">å¾…æ©Ÿ</div>
    <div id="calibStat" style="font:14px/1.4 monospace; opacity:.95; margin:2px 0 10px;">0/10ã€€å»ºè­°åç§»ï¼šâ€”</div>
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button id="calibStart"  class="calibBtn" style="flex:1 1 140px; padding:14px 12px; font-size:18px; border-radius:10px; border:none; background:#78d5ff; cursor:pointer;">é–‹å§‹</button>
      <button id="calibFinish" class="calibBtn" style="flex:1 1 140px; padding:14px 12px; font-size:18px; border-radius:10px; border:none; background:#ffc857; cursor:pointer;" disabled>å®Œæˆ</button>
      <button id="calibCancel" class="calibBtn" style="flex:1 1 140px; padding:14px 12px; font-size:18px; border-radius:10px; border:none; background:#ff6b6b; cursor:pointer;">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<audio id="bgm" preload="auto"></audio>
<div id="warnBanner">âš ï¸ æç¤º</div>

<script>
/* ===== ç°¡æ˜“å·¥å…· ===== */
const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const banner = (m)=>{ const b=$("#warnBanner"); b.textContent=m; b.style.display="block"; setTimeout(()=>b.style.display="none",1600); };

/* ===== ç•«å¸ƒ / DPR & éµæ•¸å‹•æ…‹å¯¬åº¦ ===== */
const H = 640;
const baseLaneW = 105;              // æ¯éµåŸºæº–å¯¬åº¦ï¼ˆç¶­æŒ 4 éµæ™‚ 420ï¼‰
let LANES = [4,6,8].includes(+localStorage.getItem("dfjk.lanes")) ? +localStorage.getItem("dfjk.lanes") : 4;
let W = baseLaneW * LANES;

const c  = $("#gameCanvas");
const ctx= c.getContext("2d",{ alpha:false, desynchronized:true });
const uc = $("#uiCanvas");
const uix= uc.getContext("2d",{ alpha:true });

function fitDPR(){
  const d = Math.min(devicePixelRatio||1, 2);
  c.width  = W * d; c.height = H * d;
  uc.width = W * d; uc.height= H * d;
  ctx.setTransform(d,0,0,d,0,0);
  uix.setTransform(d,0,0,d,0,0);
}

/* ===== ç‹€æ…‹ ===== */
const IS_MOBILE = matchMedia("(pointer: coarse)").matches;
const VIB = IS_MOBILE && ("vibrate" in navigator);
const HITKEY = 90;
const NOTE_SZ = 46;

let uiScale = 1;
let phase = "menu";
let running=false, paused=false, loopId=null;

let selectedSongFile = null, currentSong = "-";

let score=0, combo=0, missCount=0, lastJudge="-";
let stats = {sick:0,good:0,bad:0,shit:0,miss:0};
let wrongCount=0;

let chart=[], remain=0;

let recPulse = new Array(LANES).fill(0);
let recHitT  = new Array(LANES).fill(0);

let diff="normal", dir="down", jmode="old";

/* ç†±åœ– */
let showHeat = true;
let heatMode = 0;

/* ä½ˆå±€ */
let rectH = c.getBoundingClientRect().height;
let scaleY = rectH / H;
let judgeCss = (HITKEY * uiScale / 2);
let judgeY = judgeCss / scaleY;

function layout(){
  const r = c.getBoundingClientRect();
  rectH = r.height;
  scaleY = rectH / H;
  judgeCss = (dir==='up') ? (HITKEY*uiScale/2) : (rectH - HITKEY*uiScale/2);
  judgeY = judgeCss / scaleY;
}

function desktopScale(){
  const coarse = matchMedia("(pointer: coarse)").matches;
  const wide   = matchMedia("(min-width:1024px)").matches;
  const wider  = matchMedia("(min-width:1440px)").matches;
  let u = 1;
  if(!coarse && (wide || wider)) u = wider ? 1.8 : 1.5;
  uiScale = u;
  const st = $("#stage");
  st.style.setProperty("--u", String(u));
  st.style.maxWidth = `${Math.round(baseLaneW*LANES*u)}px`;
  layout();
}

function laneX(i){ const lw = W/LANES; return i*lw + lw/2; }

/* ===== é¡è‰² / RGB ===== */
const BASE_COL = ['#b266ff','#66ccff','#66ff66','#ff6666','#ffc857','#ff9bd3','#78d5ff','#ffd966'];
let RGB = localStorage.getItem("dfjk.rgbCycle")==="1";

function h2x(h,s,l){
  s/=100; l/=100;
  const k=n=>(n+h/30)%12; const a=s*Math.min(l,1-l);
  const f=n=>l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
  const to=x=>("0"+Math.round(x*255).toString(16)).slice(-2);
  return `#${to(f(0))}${to(f(8))}${to(f(4))}`;
}
function light(hex,a){
  const p=parseInt(hex.slice(1),16);
  let r=(p>>16)&255,g=(p>>8)&255,b=p&255;
  r=Math.min(255,Math.round(r+(255-r)*a));
  g=Math.min(255,Math.round(g+(255-g)*a));
  b=Math.min(255,Math.round(b+(255-b)*a));
  return `rgb(${r},${g},${b})`;
}
function laneCol(i,t){
  if(RGB){ const hue=((t*60)+i*(360/LANES))%360; return h2x(hue,85,55); }
  return BASE_COL[i % BASE_COL.length];
}

/* ===== ç®­é ­ç¹ªè£½ï¼ˆcyber é¢¨ï¼‰ ===== */
function d2a(d){ if(d==="up")return -Math.PI/2; if(d==="down")return Math.PI/2; if(d==="left")return Math.PI; return 0; }
function arrowPath(xc,s){
  const L=s*2.05,Hh=s*0.92,cut=Hh*0.30,tip=L*0.50,tail=-L*0.22;
  xc.beginPath();
  xc.moveTo(tail,-Hh*0.55); xc.lineTo(0,-Hh*0.55); xc.lineTo(tip,0);
  xc.lineTo(0,Hh*0.55); xc.lineTo(tail,Hh*0.55); xc.lineTo(tail+cut,0); xc.closePath();
}

/* ä¾éµæ•¸ç”¢ç”Ÿ lane æ–¹å‘ï¼ˆå…©ç«¯å·¦å³ï¼Œä¸­é–“ä¸Šä¸‹äº¤éŒ¯ï¼‰ */
let LANE_DIRS = [];
function recomputeLaneDirs(){
  LANE_DIRS = [];
  for(let i=0;i<LANES;i++){
    if(i===0){ LANE_DIRS.push('left'); continue; }
    if(i===LANES-1){ LANE_DIRS.push('right'); continue; }
    LANE_DIRS.push(i%2===0 ? 'up' : 'down');
  }
}
recomputeLaneDirs();

function drawArrow(o){
  const {x,y,size,dir,base,isRec,pulse=0,t=0,scale=1,rot=0} = o;
  const ang = d2a(dir);
  ctx.save(); ctx.translate(x,y); ctx.rotate(ang+rot); ctx.scale(scale,scale);
  arrowPath(ctx,size);
  ctx.fillStyle = isRec? "#050607" : light(base,.12); ctx.fill();
  ctx.lineWidth = isRec? 2 : 2.2; ctx.strokeStyle="rgba(255,255,255,.95)"; ctx.stroke();

  const k=6; ctx.save(); ctx.clip();
  for(let i=0;i<k;i++){
    const u=i/(k-1)-.5, yy=u*size*.95;
    ctx.globalAlpha = isRec ? (0.12+0.22*pulse) : 0.20;
    ctx.strokeStyle = "#ffffff"; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(-size,yy); ctx.lineTo(size*1.1,yy); ctx.stroke();
  }
  const sw=(Math.sin(t*2.2)+1)/2, w=size*0.65, sx=-size+(size*2.2)*sw;
  const g=ctx.createLinearGradient(sx-w,0,sx+w,0);
  g.addColorStop(0,'rgba(255,255,255,0)'); g.addColorStop(.5,'rgba(255,255,255,.28)'); g.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle=g; ctx.fillRect(-size*1.2,-size*1.2,size*2.4,size*2.4);
  ctx.restore(); ctx.restore();
}
function drawTrail(o){
  const {x,y,size,dir,base,t} = o;
  const step=3,gap=10,a=d2a(dir);
  for(let i=1;i<=step;i++){
    const off=i*gap, ax=x-Math.cos(a)*off, ay=y-Math.sin(a)*off;
    ctx.save(); ctx.globalAlpha=.16*(1-i/(step+1));
    drawArrow({x:ax,y:ay,size,dir,base,isRec:false,t}); ctx.restore();
  }
}

/* ===== èƒŒæ™¯ç‰¹æ•ˆ ===== */
function bg(t){
  ctx.save(); ctx.fillStyle="#0c1322"; ctx.fillRect(0,0,W,H);
  const Ls=[ {step:26,s:28,a:.18,c:'rgba(120,213,255,0.35)'},{step:18,s:50,a:.14,c:'rgba(255,0,160,0.28)'},{step:34,s:18,a:.12,c:'rgba(255,255,0,0.22)'} ];
  for(const L of Ls){
    ctx.globalAlpha=L.a; ctx.strokeStyle=L.c; ctx.lineWidth=1;
    const ox=(t*L.s)%L.step, oy=(t*L.s*0.7)%L.step;
    for(let x=-ox;x<=W;x+=L.step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
    for(let y=-oy;y<=H;y+=L.step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(0+y,H+y); ctx.stroke(); }
  }
  ctx.restore();
}

/* ===== éŸ³è¨Š / SFX ===== */
let OFFSET = +(localStorage.getItem("dfjk.offsetMs")||0);
const bgm=$("#bgm"); let AC=null, Gm=null, Gsfx=null;
let VOL_M=(+(localStorage.getItem("dfjk.volume")||80))/100;
let VOL_S=(+(localStorage.getItem("dfjk.sfxVol")||70))/100;

async function ensureAC(){ if(!AC){ const Ctx=window.AudioContext||window.webkitAudioContext; AC=new Ctx({latencyHint:"interactive"}); }
  if(!Gm){ Gm=AC.createGain(); Gm.connect(AC.destination); }
  if(!Gsfx){ Gsfx=AC.createGain(); Gsfx.gain.value=VOL_S; Gsfx.connect(Gm); } }
function applyVol(){ if(Gm)Gm.gain.value=VOL_M; if(bgm)bgm.volume=VOL_M; if(Gsfx)Gsfx.gain.value=VOL_S; }

/* å°é»æ“ŠéŸ³æ•ˆ */
async function tapSfx(){ try{
  await ensureAC(); const t0=AC.currentTime+0.001, dur=0.10;
  const mix=AC.createGain(); mix.connect(Gsfx||Gm);
  const o1=AC.createOscillator(); o1.type='triangle'; o1.frequency.setValueAtTime(2700,t0); o1.frequency.exponentialRampToValueAtTime(1900,t0+dur);
  const g1=AC.createGain(); g1.gain.setValueAtTime(0.0001,t0); g1.gain.exponentialRampToValueAtTime(0.55,t0+0.004); g1.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
  o1.connect(g1); g1.connect(mix);
  const o2=AC.createOscillator(); o2.type='square'; o2.frequency.setValueAtTime(5400,t0); o2.frequency.exponentialRampToValueAtTime(2800,t0+0.08);
  const g2=AC.createGain(); g2.gain.setValueAtTime(0.17,t0); g2.gain.exponentialRampToValueAtTime(0.0001,t0+0.08);
  o2.connect(g2); g2.connect(mix);
  const nb=AC.createBuffer(1,256,AC.sampleRate); const data=nb.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
  const n=AC.createBufferSource(); n.buffer=nb;
  const bp=AC.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=9800; bp.Q.value=6;
  const hp=AC.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=2000; hp.Q.value=0.7;
  const ng=AC.createGain(); ng.gain.setValueAtTime(0.16,t0); ng.gain.exponentialRampToValueAtTime(0.0001,t0+0.06);
  n.connect(bp); bp.connect(hp); hp.connect(ng); ng.connect(mix);
  o1.start(t0); o1.stop(t0+dur+0.03); o2.start(t0); o2.stop(t0+0.09); n.start(t0); n.stop(t0+0.06);
}catch{} }

/* ===== åˆ¤å®š / åˆ†æ•¸ ===== */
const WIN = { sick:85, good:135, bad:155, shit:175 };
const SC  = { sick:350, good:200, bad:100, shit:-50, miss:-300, ghost:-150 };
let baseSpd = 550, spd=baseSpd;

/* åç§»çµ±è¨ˆ for ç†±åœ– */
const dts=[]; const DT_MAX=240;
function recDt(d){ dts.push(d); if(dts.length>DT_MAX)dts.shift(); }
function dtStats(){ if(!dts.length) return {avg:0,std:0}; const n=dts.length; const avg=dts.reduce((a,c)=>a+c,0)/n; const va=dts.reduce((a,c)=>a+(c-avg)*(c-avg),0)/n; return {avg,std:Math.sqrt(va)}; }

/* é€£æ“Šæç¤º */
let comboFlash=""; let comboT0=0;
function comboFlashNow(){ comboFlash=`COMBO x${combo}!!`; comboT0=performance.now()/1000; }

/* Game Over / EX MISS é™åˆ¶ */
function endWith(msg){
  running=false; stopLoop(); stopAudio();
  $("#finalSong").textContent=currentSong;
  $("#finalDiff").textContent=diff.toUpperCase();
  $("#finalDir").textContent=(dir==='up'?'ä¸Šå‡':'ä¸‹è½');
  $("#finalJudge").textContent=(jmode==='old'?'Old':'New');
  $("#finalScore").textContent=score;
  $("#statSick").textContent=stats.sick; $("#statGood").textContent=stats.good;
  $("#statBad").textContent=stats.bad;   $("#statShit").textContent=stats.shit;
  $("#statMiss").textContent=missCount;
  showOnly('endScreen'); phase='menu'; if(msg) banner(msg);
}
function exCheck(){ if(diff==='ex' && missCount>15){ endWith("ä½ è¼¸äº†ï¼EX MISS > 15"); } }

/* å¹¾ä½• */
function yAt(thit,tnow){ const j=judgeY; return (dir==='down') ? j - (thit-tnow)*spd : j + (thit-tnow)*spd; }

/* ===== è¡€æ¢ ===== */
const HP_MAX=100; let HP_ON=(localStorage.getItem("dfjk.hpOn")==="1"); let HP=HP_MAX;
function hpShow(b){ $("#hpBar").style.display=b?"block":"none"; }
function hpUpdate(){ const fill=$("#hpFill"), txt=$("#hpText"); const w=Math.max(0,Math.min(100, HP/HP_MAX*100)); fill.style.width=w.toFixed(1)+"%"; txt.textContent=`${HP}/${HP_MAX}`; }
function hpSet(v){ HP=Math.max(0,Math.min(HP_MAX,Math.round(v))); hpUpdate(); if(HP<=0 && running){ endWith("HP è€—ç›¡"); } }
function hpAdd(d){ if(!HP_ON) return; hpSet(HP+d); }
function hpDelta(j){
  if(j==="SICK") return +15; if(j==="GOOD") return +12; if(j==="BAD") return +6;
  let missV=0, shitV=0;
  if(diff==='beginner'||diff==='easy'){ missV=-5;  shitV=-3; }
  else if(diff==='normal'){ missV=-8;  shitV=-6; }
  else if(diff==='hard'){   missV=-10; shitV=-8; }
  else if(diff==='ex'){     missV=-25; shitV=-20; }
  else { /* hell */         missV=-28; shitV=-22; }
  if(j==="MISS") return missV; if(j==="SHIT") return shitV; return 0;
}

/* ===== HUD / ç‰¹æ•ˆ ===== */
function hud(){
  $("#score").textContent=score;
  $("#combo").textContent=combo;
  $("#judgement").textContent=lastJudge;
  $("#missCount").textContent=missCount;
  $("#songTitle").textContent=currentSong;
  $("#laneLabel").textContent=String(LANES);
  $("#diffLabel").textContent=diff.toUpperCase();
  $("#dirLabel").textContent=(dir==='up'?'ä¸Šå‡':'ä¸‹è½');
  $("#judgeLabel").textContent=(jmode==='old'?'Old':'New');
  $("#offsetActive").textContent=`${OFFSET} ms`;
}

/* å‘½ä¸­ç‰¹æ•ˆ */
const hits=[], parts=[];
function addHit(l){
  const t=performance.now()/1000, j=judgeY, x=laneX(l);
  hits.push({lane:l,t0:t,life:.40});
  const N=26, col=laneCol(l,t);
  for(let i=0;i<N;i++){
    const a=Math.random()*Math.PI*2, sp=80+Math.random()*220;
    const vx=Math.cos(a)*sp, vy=Math.sin(a)*sp, life=.28+Math.random()*.22, th=.8+Math.random()*1.6;
    parts.push({x,y:j,vx,vy,life,t0:t,col,th});
  }
}
function impact(l){ recPulse[l]=1.2; recHitT[l]=performance.now()/1000; }
function fxUpdate(dt){
  const now=performance.now()/1000;
  for(let i=hits.length-1;i>=0;i--) if((now-hits[i].t0)>hits[i].life) hits.splice(i,1);
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i], age=now-p.t0; if(age>p.life){ parts.splice(i,1); continue; }
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.vx*=(1-1.6*dt); p.vy*=(1-1.6*dt);
  }
}
function fxDraw(){
  const t=performance.now()/1000, j=judgeY;
  ctx.save();
  for(const fx of hits){
    const age=t-fx.t0, p=Math.min(1,age/fx.life), x=laneX(fx.lane), r=28+90*p;
    ctx.globalCompositeOperation='lighter';
    const g=ctx.createRadialGradient(x,j,r*.2, x,j,r);
    g.addColorStop(0,'rgba(255,255,255,.35)'); g.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,j,r,0,Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation='source-over'; ctx.globalAlpha=1-p;
  }
  ctx.restore();

  ctx.save(); ctx.globalCompositeOperation='lighter';
  for(const p of parts){
    const now=performance.now()/1000, age=now-p.t0, q=Math.max(0,1-age/p.life);
    ctx.strokeStyle=p.col; ctx.globalAlpha=Math.pow(q,1.6); ctx.lineWidth=p.th;
    ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(p.x - p.vx*0.025, p.y - p.vy*0.025); ctx.stroke();
  }
  ctx.restore();
}

/* ===== æ›´æ–° / ç¹ªåœ– ===== */
function upd(songT,dt){
  for(const n of chart) n.y = yAt(n.t, songT);
  for(const n of chart){
    if(n.hit) continue;
    const late=(songT-n.t)*1000, over=WIN.shit+160;
    if(late>over){
      n.hit=true; remain--; lastJudge='MISS'; combo=0; missCount++; stats.miss++; score=Math.max(0,score+SC.miss); hpAdd(hpDelta('MISS')); hud(); exCheck();
    }
  }
  for(let i=0;i<LANES;i++) recPulse[i]=Math.max(0, recPulse[i]-dt*3.2);
  fxUpdate(dt);
}
function draw(opt={}){
  const sk=!!opt.skip, t=performance.now()/1000, j=judgeY;
  ctx.clearRect(0,0,W,H); bg(t);

  for(let i=0;i<LANES;i++){
    const x=laneX(i), col=laneCol(i,t), since=Math.max(0,t-recHitT[i]), wave=Math.max(0,1-since/0.22);
    const p=Math.max(recPulse[i],wave), sc=1+0.42*p+0.08*Math.sin((1-p)*Math.PI), rot=(Math.sin(since*60)*0.05)*p;
    drawArrow({x,y:j,size:NOTE_SZ,dir:LANE_DIRS[i],base:col,isRec:true,pulse:p,t,scale:sc,rot});
  }

  if(!sk){
    const top=-160, bot=H+160;
    for(let i=0;i<chart.length;i++){
      const n=chart[i]; if(n.hit) continue; if(n.y<top||n.y>bot) continue;
      const x=laneX(n.lane), col=laneCol(n.lane, t+i*0.02);
      drawTrail({x,y:n.y,size:NOTE_SZ,dir:LANE_DIRS[n.lane],base:col,t:t+i*0.02});
      drawArrow({x,y:n.y,size:NOTE_SZ,dir:LANE_DIRS[n.lane],base:col,isRec:false,t:t+i*0.02});
    }
  }

  fxDraw();

  if(lastJudge!=='-'){
    ctx.fillStyle='#fff'; ctx.font='bold 32px sans-serif'; ctx.textAlign='center';
    const off=(dir==='up') ? 120 : -40; ctx.fillText(lastJudge, W/2, j+off);
  }

  if(comboFlash){
    const life=.9, age=(performance.now()/1000 - comboT0);
    if(age<life){
      const s=1+0.18*Math.sin(age*9);
      ctx.save(); ctx.translate(W/2,H*0.22); ctx.scale(s,s);
      ctx.fillStyle='rgba(255,255,255,.95)'; ctx.font='bold 36px sans-serif'; ctx.textAlign='center'; ctx.fillText(comboFlash,0,0);
      ctx.restore();
    }else comboFlash='';
  }
}
function drawPreview(t){
  ctx.clearRect(0,0,W,H); bg(performance.now()/1000);
  const j=judgeY;
  for(let i=0;i<LANES;i++){
    const x=laneX(i), col=laneCol(i, performance.now()/1000);
    drawArrow({x,y:j,size:NOTE_SZ,dir:LANE_DIRS[i],base:col,isRec:true,pulse:0,t:0,scale:1,rot:0});
  }
  const top=-160, bot=H+160;
  for(let i=0;i<chart.length;i++){
    const n=chart[i]; if(n.hit) continue;
    const y=yAt(n.t,t); if(y<top||y>bot) continue;
    const x=laneX(n.lane), col=laneCol(n.lane, performance.now()/1000+i*0.02);
    drawTrail({x,y,size:NOTE_SZ,dir:LANE_DIRS[n.lane],base:col,t:0});
    drawArrow({x,y,size:NOTE_SZ,dir:LANE_DIRS[n.lane],base:col,isRec:false,t:0});
  }
}

/* ===== ç†±åœ–ï¼ˆUI Canvasï¼‰ ===== */
function ui(){
  uix.clearRect(0,0,W,H); if(!showHeat) return;
  const bins=36, mn=-300, mx=300, step=(mx-mn)/bins, hist=new Array(bins).fill(0);
  for(const v of dts){ const i=Math.floor((v-mn)/step); if(i>=0&&i<bins) hist[i]++; }
  const w=230, h=74, bw=w/bins;
  let yAuto=(dir==='up') ? (H-h-24) : (24 + (IS_MOBILE?6:0));
  let yPos = (heatMode===1)?24 : (heatMode===2 ? (H-h-24) : yAuto);
  const x0=14,y0=yPos;
  uix.save(); uix.globalAlpha=.98; uix.fillStyle='rgba(0,0,0,.58)'; uix.fillRect(x0-8,y0-10,w+16,h+46);
  uix.fillStyle='#fff'; uix.font='12px sans-serif'; uix.fillText('Hit åç§»ç†±åœ– (ms)', x0, y0-12);
  const maxc=Math.max(1,...hist);
  for(let i=0;i<bins;i++){
    const v=hist[i], bh=(v/maxc)*h, xx=Math.floor(x0+i*bw);
    uix.fillStyle='#78d5ff'; uix.fillRect(xx, y0+(h-bh), Math.ceil(bw-1), bh);
  }
  const {avg,std}=dtStats();
  uix.fillStyle='#fff'; uix.fillText(`avg:${avg.toFixed(1)} Ïƒ:${std.toFixed(1)} åç§»:${OFFSET}ms`, x0, y0+h+16);
  uix.strokeStyle='#ffd966'; uix.beginPath(); const mid=x0 + (-mn)/step * bw; uix.moveTo(mid,y0); uix.lineTo(mid,y0+h); uix.stroke();
  uix.restore();
}

/* ===== éµä½æ˜ å°„ï¼ˆä¾éµæ•¸ï¼‰ ===== */
function laneKeyFromChar(k){
  k=k.toLowerCase();
  if(LANES===4){
    if(k==='d')return 0; if(k==='f')return 1; if(k==='j')return 2; if(k==='k')return 3;
    // 4 éµå…è¨±æ–¹å‘éµ
    if(k==='arrowleft')return 0; if(k==='arrowdown')return 1; if(k==='arrowup')return 2; if(k==='arrowright')return 3;
    return null;
  }
  if(LANES===6){
    if(k==='s')return 0; if(k==='d')return 1; if(k==='f')return 2; if(k==='j')return 3; if(k==='k')return 4; if(k==='l')return 5;
    return null; // åœç”¨æ–¹å‘éµ
  }
  // 8 éµï¼šA S D F J K L ;
  if(k==='a')return 0; if(k==='s')return 1; if(k==='d')return 2; if(k==='f')return 3;
  if(k==='j')return 4; if(k==='k')return 5; if(k==='l')return 6; if(k===';')return 7;
  return null;
}
function lanePtr(xCss){ const r=c.getBoundingClientRect(); const x=xCss/r.width*W; let b=0,bd=1e9;
  for(let i=0;i<LANES;i++){ const d=Math.abs(x-laneX(i)); if(d<bd){ bd=d; b=i; } } return b; }

/* ===== è¼¸å…¥è™•ç† ===== */
function onPress(l){
  if(!running) return;
  tapSfx();
  const t=judgeClock(); let bi=-1, ba=1e9;
  for(let i=0;i<chart.length;i++){
    const n=chart[i]; if(n.hit||n.lane!==l) continue;
    const dt=(t-n.t)*1000, ad=Math.abs(dt);
    if(ad<=WIN.shit && ad<ba){ ba=ad; bi=i; }
  }
  if(bi>=0){
    const n=chart[bi]; n.hit=true; remain--;
    const dt=(t-n.t)*1000;
    let r="";
    if(Math.abs(dt)<=WIN.sick){ r='SICK!'; score=Math.max(0,score+SC.sick); stats.sick++; combo++; }
    else if(Math.abs(dt)<=WIN.good){ r='GOOD'; score=Math.max(0,score+SC.good); stats.good++; combo++; }
    else if(Math.abs(dt)<=WIN.bad){ r='BAD'; score=Math.max(0,score+SC.bad); stats.bad++; combo++; }
    else { r='SHIT'; score=Math.max(0,score+SC.shit); stats.shit++; combo=Math.max(0,combo-1); }
    lastJudge=r; recDt(dt); hud();
    const key=r.replace('!',''); if(['SICK','GOOD','BAD','SHIT'].includes(key)) hpAdd(hpDelta(key));
    if(combo>0 && combo%10===0) comboFlashNow();
    addHit(l); impact(l); if(VIB){ try{ navigator.vibrate(10);}catch{} }
  }else{
    if(jmode==='old'){ lastJudge='WRONG'; wrongCount++; hpAdd(-2); } else lastJudge='-';
    hud(); recPulse[l]=Math.max(recPulse[l],1.0); addHit(l); impact(l);
  }
}
window.addEventListener("keydown", e=>{
  if(e.repeat) return; const k=e.key.toLowerCase();
  if(k==='h'){ showHeat=!showHeat; banner(showHeat?'ç†±åœ–ï¼šON':'ç†±åœ–ï¼šOFF'); ui(); e.preventDefault(); return; }
  if(k==='r'){ heatMode=(heatMode+1)%3; banner(`ç†±åœ–ä½ç½®ï¼š${heatMode===0?'è‡ªå‹•':(heatMode===1?'ç½®é ‚':'ç½®åº•')}`); ui(); e.preventDefault(); return; }
  const l=laneKeyFromChar(k);
  if(l!==null){ if(running&&!paused){ onPress(l); } e.preventDefault(); return; }
  if(k==='escape'){ if(phase==='playing') pauseGame(); else if(phase==='paused') resumeGame();
    else if(phase==='countdown'){ cancelCountdown(); pauseGame(true); } e.preventDefault(); }
});
c.addEventListener("pointerdown", e=>{ if(!running||paused) return; e.preventDefault(); const r=c.getBoundingClientRect(); const l=lanePtr(e.clientX-r.left); onPress(l); }, {passive:false});
c.addEventListener("touchstart", e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); }, {passive:false});
c.addEventListener("touchmove",  e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); }, {passive:false});
window.addEventListener("dblclick",     e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); }, {passive:false});
window.addEventListener("gesturestart", e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); }, {passive:false});

/* ===== å€’æ•¸ ===== */
let counting=false, cRAF=null;
function countdown(startCb,opt={}){ const show=!!opt.show, pv=(typeof opt.t==='number')?opt.t:0;
  cancelCountdown(); counting=true; const el=$("#countdownText"); el.style.display='block';
  const lab=['Ready','3','2','1','Go!'], dur=[600,800,800,800,600], t0=performance.now();
  function step(now){
    if(!counting) return; const e=now-t0; let acc=0, idx=lab.length-1;
    for(let i=0;i<lab.length;i++){ acc+=dur[i]; if(e<acc){ idx=i; break; } }
    el.textContent=(idx<lab.length?lab[idx]:'Go!'); el.style.animation='none'; void el.offsetWidth; el.style.animation='popScale .55s ease-out';
    if(show){ drawPreview(pv); } else { draw({skip:true}); } ui();
    const total=dur.reduce((a,b)=>a+b,0);
    if(e>=total){ el.style.display='none'; counting=false; startCb(); return; }
    cRAF=requestAnimationFrame(step);
  }
  cRAF=requestAnimationFrame(step);
}
function cancelCountdown(){ if(!counting && !cRAF) return; counting=false; try{ cancelAnimationFrame(cRAF);}catch{} cRAF=null; const el=$("#countdownText"); el.style.animation='none'; el.style.display='none'; }

/* ===== éŸ³æ¨‚æ™‚é˜ ===== */
let durSec=120, ended=false;
function stopAudio(){ try{ bgm.pause(); }catch{} ended=false; }
let softBase=0, softStart=0;
function startAt(sec){ try{ const to=Math.max(0,Math.min((durSec||120)-.001,sec||0)); bgm.currentTime=to; }catch{} bgm.play().catch(()=>{}); ended=false; bgm.onended=()=>{ ended=true; };
  softBase=bgm.currentTime||0; softStart=performance.now()/1000; }
function hardClock(){ const t=(bgm && !isNaN(bgm.currentTime)) ? bgm.currentTime : (performance.now()/1000 - softStart) + softBase; return Math.max(0,Math.min(durSec,t)); }
function judgeClock(){ return hardClock() + (OFFSET/1000); }

/* ===== ç•«é¢åˆ‡æ› ===== */
function showOnly(id){
  ['menuScreen','musicScreen','optionsScreen','gameScreen','pauseScreen','endScreen'].forEach(x=>{
    const el=$("#"+x); if(!el) return; el.style.display=(x===id?'block':'none');
  });
  if(id!=='gameScreen'){ $("#gameScreen")?.classList.remove('blur'); }
}
function toMenu(){ cancelCountdown(); stopLoop(); stopAudio(); phase='menu'; running=false; paused=false; document.body.classList.remove('ex-mode'); showOnly('menuScreen');
  $("#menuChosenSong").textContent = selectedSongFile ? selectedSongFile.replace(/\.mp3$/i,'') : 'å°šæœªé¸æ“‡'; }
function toOpt(){ showOnly('optionsScreen'); }
function toMusic(){ showOnly('musicScreen'); }

/* ===== æ›²åº« ===== */
const S=[ /* ä½ çš„æª”ååˆ—è¡¨åŸå°ä¸å‹• */ 
"Charlie Puth - Light Switch [Official Music Video] - Charlie Puth.mp3",
"Creepy Nuts â€Mirageâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Opening Theme Song - Creepy Nuts.mp3",
"Creepy Nuts â€Nemureâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Ending Theme Song - Creepy Nuts (1).mp3",
"Creepy Nutsï½¢Bling-Bang-Bang-Bornï½£ Ã— TV Animeï½¢ãƒãƒƒã‚·ãƒ¥ãƒ«-MASHLE-ï½£ Collab Music Video #BBBBãƒ€ãƒ³ã‚¹ - Creepy Nuts.mp3",
"KANA-BOON - Silhouette - KANABOONVEVO.mp3",
"Wiz Khalifa - See You Again ft. Charlie Puth [Official Video] Furious 7 Soundtrack - Wiz Khalifa Music (youtube).mp3",
"Maroon 5 - Memories (Official Video) - Maroon5VEVO (youtube).mp3",
"Chainsaw Man â€“ The Movie Reze Arc - Theme Song FULL IRIS OUT by Kenshi Yonezu (Lyrics) - Jamong (youtube).mp3",
"ãƒ’ã‚°ãƒã‚¢ã‚¤ _ ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ã€Official Videoã€‘ Ai Higuchi â€Itterasshai(See you later)â€ - ãƒ’ã‚°ãƒã‚¢ã‚¤ (youtube).mp3",
"Chainsaw Man â€“ The Movie Reze Arc - Ending FULL JANE DOE by Kenshi Yonezu, Hikaru Utada (Lyrics) - Jamong (youtube).mp3",
"PokÃ©mon partners of different generations dancing POKÃ‰DANCE Animation Music Video - PokÃ©mon Asia ENG (youtube).mp3",
"Lost Sky, Sara Skinner - Dreams pt. II (feat. Sara Skinner) [NCS Release].mp3",
"OneRepublic - Nobody (from Kaiju No. 8) [Official Music Video] - OneRepublicVEVO.mp3",
"YOASOBIã€ŒWatch me!ã€Official Music Video - Ayase _ YOASOBI.mp3",
"yung kai - blue (official music video) - yung kai.mp3",
"ã€AKASAKIã€‘Bunny Girl _ ãƒãƒ‹ãƒ¼ã‚¬ãƒ¼ãƒ«ï¼ˆLyric Videoï¼‰ - AKASAKI (19).mp3",
"ã€MVã€‘éš™_ã‚†ãƒ¼ã‚Šã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã€‘ - ã€ãƒ¦ã‚¤ã‚«ã€.mp3",
"ã€imaseã€‘NIGHT DANCERï¼ˆMVï¼‰ - imase.mp3",
"ãªã¨ã‚Š - Overdose - ãªã¨ã‚Š _ natori.mp3",
"å¥½ãã ã‹ã‚‰ã€‚_ ã€ãƒ¦ã‚¤ã‚«ã€ã€MVã€‘ - ã€ãƒ¦ã‚¤ã‚«ã€.mp3",
"å»»å»»å¥‡è­š - Eve MV - Eve.mp3",
"é’ã®ã™ã¿ã‹ _ ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ - Where Our Blue Is _ Tatsuya Kitani - ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ _ Tatsuya Kitani.mp3",
"Toge Toge Sadistic - Enormita (youtube).mp3",
"My dream girls - NACHERRY (youtube).mp3",
"PEACEKEEPER - STEREO DIVE FOUNDATION (youtube).mp3",
"YOASOBI - Idolã€Œã‚¢ã‚¤ãƒ‰ãƒ«ã€Lyrics Video [Kan_Rom_Eng] Oshi no Ko (æ¨ã—ã®å­) OP - mimanimi (youtube).mp3",
"YOASOBI â€“ 'æ€ªç‰© (Monster)' Lyrics - Kei Takahashi (youtube).mp3",
"YOASOBI - Racing Into The Night Lyrics (JPN_ROM_ENG) - rin rin (youtube).mp3",
"ã€Hanserã€‘å®¤å†…ç³»çš„TrackMaker _ ã‚¤ãƒ³ãƒˆã‚™ã‚¢ç³»ãªã‚‰ãƒˆãƒ©ãƒƒã‚¯ãƒ¡ã‚¤ã‚«ãƒ¼ ã€ä¸­æ–‡ç¿»å”± _ coverã€‘ - OtakuLAB (youtube).mp3",
"Aimer - Brave Shine - AimerOfficialVEVO (youtube).mp3",
"ROSA WALTON x HALLIE COGGINS - I REALLY WANT TO STAY AT YOUR HOUSE (LYRIC) AMV CYBERPUNK EDGERUNNERS - Eternity Music (youtube).mp3"
];
function fillSongs(){
  const sel=$("#songSelect"); if(sel.dataset.filled) return; sel.innerHTML="";
  const ph=document.createElement("option"); ph.value=""; ph.textContent="â€” è«‹é¸æ“‡æ›²ç›® â€”"; ph.disabled=true; ph.selected=!selectedSongFile; sel.appendChild(ph);
  S.forEach(f=>{ const o=document.createElement("option"); o.value=f; o.textContent=f.replace(/\.mp3$/i,""); if(selectedSongFile===f) o.selected=true; sel.appendChild(o); });
  sel.addEventListener("change",()=>{ $("#chosenSongLabel").textContent = sel.value ? sel.options[sel.selectedIndex].textContent : "å°šæœªé¸æ“‡"; });
  sel.dataset.filled="1";
}
function confirmSong(){
  const sel=$("#songSelect"); if(!sel.value){ alert("è«‹å…ˆé¸æ“‡éŸ³æ¨‚"); return; }
  selectedSongFile=sel.value;
  $("#chosenSongLabel").textContent = sel.options[sel.selectedIndex].textContent;
  $("#menuChosenSong").textContent  = sel.options[sel.selectedIndex].textContent;
  toMenu();
}

/* ===== è­œé¢ç”¢ç”Ÿï¼ˆéµæ•¸é€šç”¨ï¼‰ ===== */
const LEAD=1.6;
function genChart(dur){
  chart=[];
  let dbl=.35, tmin=.24, tmax=.52;
  if(diff==='beginner'){ dbl=.15; tmin=.34; tmax=.64; }
  else if(diff==='easy'){ dbl=.20; tmin=.28; tmax=.54; }
  else if(diff==='hard'){ dbl=.55; tmin=.18; tmax=.40; }

  if(!(diff==='ex'||diff==='hell')){
    let t=LEAD;
    while(t<dur){
      const used=new Set(); const arr=[];
      const cnt=Math.random()<dbl?2:1;
      while(arr.length<cnt){
        const ln=Math.floor(Math.random()*LANES);
        if(!used.has(ln)){ used.add(ln); arr.push({t,lane:ln,hit:false,y:-50}); }
      }
      chart.push(...arr);
      t += Math.random()*(tmax-tmin)+tmin;
    }
  }else{
    const beat=0.5; let t=LEAD, cur=0;
    const n = ()=>{ cur=(cur+1)%LANES; return cur; };
    const opp= (i)=> (i + Math.floor(LANES/2)) % LANES;
    const nxt= (i)=> (i + 1) % LANES;
    const rnd= ()=> Math.floor(Math.random()*LANES);
    const push=(tt,ln)=>chart.push({t:tt,lane:ln,hit:false,y:-50});
    while(t<dur){
      if(diff==='ex'){
        push(t, n());
        if(Math.random()<.60) push(t, opp(cur));
        if(Math.random()<.35) push(t+beat/2, nxt(cur));
        if(Math.random()<.18){ push(t+beat/3, rnd()); push(t+2*beat/3, rnd()); }
        t += Math.random()<.5 ? beat/2 : beat;
      }else{ // hell
        push(t, n());
        if(Math.random()<.85) push(t, opp(cur));
        push(t+beat/2, nxt(cur));
        if(Math.random()<.4){ push(t+beat/4, rnd()); push(t+3*beat/4, rnd()); }
        t += beat/2;
      }
    }
  }
  remain=chart.length;
}

/* ===== HUD èˆ‡æµç¨‹ ===== */
function hudOffset(v){ $("#offsetLabel").textContent=`${v} ms`; $("#offsetActive").textContent=`${v} ms`; }
function setOffset(v){ v=Math.max(-600,Math.min(600,(v|0))); OFFSET=v; localStorage.setItem("dfjk.offsetMs",String(v)); hudOffset(v); }

/* è®Šæ›´éµæ•¸ï¼ˆæ ¸å¿ƒï¼‰ */
function setLanes(n){
  n = [4,6,8].includes(+n) ? +n : 4;
  if(n===LANES) return;
  LANES = n;
  localStorage.setItem("dfjk.lanes", String(LANES));
  // èª¿æ•´ç•«å¸ƒå¯¬åº¦èˆ‡ UI
  W = baseLaneW * LANES;
  fitDPR(); desktopScale(); layout();
  // é‡å»ºæç¤ºç‹€æ…‹é™£åˆ—
  recPulse = new Array(LANES).fill(0);
  recHitT  = new Array(LANES).fill(0);
  recomputeLaneDirs();
  draw({skip:true}); ui(); hud();
}

/* é–‹å§‹éŠæˆ² */
function startGame(){
  if(!selectedSongFile){ toMusic(); alert("è«‹å…ˆé¸æ“‡éŸ³æ¨‚"); return; }
  diff=$("#difficultySelect").value; dir=$("#noteDirection").value; jmode=$("#judgeMode").value;
  document.body.classList.toggle('ex-mode', diff==='ex');

  let mul=parseFloat($("#speedMultiplier").value);
  if(diff==='beginner') mul=0.8; else if(diff==='easy') mul=0.9;

  score=0; combo=0; lastJudge='-'; missCount=0;
  stats={sick:0,good:0,bad:0,shit:0,miss:0}; wrongCount=0;
  chart=[]; remain=0; dts.length=0;
  recPulse=new Array(LANES).fill(0); recHitT=new Array(LANES).fill(0);
  comboFlash=""; hits.length=0; parts.length=0;

  spd=baseSpd*mul;
  currentSong=selectedSongFile.replace(/\.mp3$/i,'');
  hud();

  HP=HP_MAX; hpShow(HP_ON); hpUpdate();

  showOnly('gameScreen'); phase='countdown';
  fitDPR(); desktopScale(); layout();
  draw({skip:true}); ui();

  const url='music/'+encodeURIComponent(selectedSongFile);
  stopAudio(); bgm.src=url; try{ bgm.load(); }catch{}
  durSec = isFinite(bgm.duration) ? bgm.duration : 120;
  genChart(durSec||120);

  countdown(()=>{ phase='playing'; running=true; startAt(0); loopId=requestAnimationFrame(loop); }, {show:false});
}

let pausedAt=0;
function pauseGame(fromC){
  if(phase==='countdown' && fromC!==true) cancelCountdown();
  if(!running && phase!=='countdown') return;
  paused=true; phase='paused'; $("#gameScreen").classList.add('blur'); showOnly('pauseScreen');
  pausedAt=hardClock(); stopLoop(); stopAudio();
}
function resumeGame(){
  if(!paused) return; paused=false; phase='countdown';
  showOnly('gameScreen'); $("#gameScreen").classList.remove('blur');
  const t=pausedAt;
  countdown(()=>{ phase='playing'; running=true; startAt(t); loopId=requestAnimationFrame(loop); }, {show:true,t});
}
function loop(){
  if(paused) return;
  const t=hardClock();
  upd(t,1/60); draw(); ui();
  if(ended || remain<=0){ endWith(); return; }
  loopId=requestAnimationFrame(loop);
}
function stopLoop(){ try{ cancelAnimationFrame(loopId);}catch{} loopId=null; }

/* ===== æ ¡æ­£ ===== */
const pnl=$("#calibOverlay"), cbStart=$("#calibStart"), cbDone=$("#calibFinish"), cbCancel=$("#calibCancel"), cbBig=$("#calibBig"), cbDot=$("#calibBeatDot"), cbStat=$("#calibStat");
let cal=false, beatInt=1.0, beats=16, taps=[], timers=[], tapH=null, syncP0=0, syncC0=0, t0C=0;

async function openCalib(){
  if(phase==='playing' || phase==='countdown'){ banner("è«‹å…ˆé€€å‡ºæˆ–æš«åœéŠæˆ²å†æ ¡æ­£"); return; }
  pnl.style.display='block'; cbBig.textContent='å¾…æ©Ÿ'; cbStat.textContent='0/10 å»ºè­°åç§»ï¼šâ€”'; taps=[]; cbDone.disabled=true; await ensureAC().catch(()=>{});
}
function closeCalib(){ pnl.style.display='none'; timers.forEach(id=>clearTimeout(id)); timers=[]; cal=false;
  if(tapH){ window.removeEventListener('keydown',tapH); pnl.removeEventListener('pointerdown',tapH); tapH=null; } }
function robust(arr){
  if(!arr.length) return 0;
  const s=[...arr].sort((a,b)=>a-b), m=s[Math.floor(s.length/2)];
  const dev=s.map(v=>Math.abs(v-m)).sort((a,b)=>a-b), MAD=dev[Math.floor(dev.length/2)]||1;
  const keep=arr.filter(v=>Math.abs(v-m)<=Math.max(3*MAD,120));
  const t=keep.sort((a,b)=>a-b), lo=Math.floor(t.length*0.2), hi=Math.ceil(t.length*0.8), core=t.slice(lo,hi);
  const mean=core.reduce((a,c)=>a+c,0)/Math.max(1,core.length);
  return Math.max(-600,Math.min(600,Math.round(mean)));
}
function startCalib(){
  timers.forEach(id=>clearTimeout(id)); timers=[]; taps=[]; cbDone.disabled=true; cal=true;
  try{ AC.resume(); }catch{}
  syncP0=performance.now()/1000; syncC0=AC.currentTime;
  const lead=.70; t0C=AC.currentTime+lead;
  for(let i=0;i<beats;i++){
    const t=t0C+i*beatInt;
    const o=AC.createOscillator(), g=AC.createGain();
    o.type='sine'; o.frequency.value=880;
    g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.45,t+0.005); g.gain.exponentialRampToValueAtTime(0.0001,t+0.08);
    o.connect(g); g.connect(Gsfx||Gm); o.start(t); o.stop(t+0.09);
    const d=(t-AC.currentTime)*1000;
    const id=setTimeout(()=>{ cbDot.style.transform='scale(1.28)'; cbDot.style.boxShadow='0 0 30px rgba(120,213,255,1)'; setTimeout(()=>{ cbDot.style.transform='scale(1)'; cbDot.style.boxShadow='0 0 30px rgba(120,213,255,.9)'; },120); }, d);
    timers.push(id);
  }
  tapH=(e)=>{
    if(e.type==='keydown'){
      const k=e.key.toLowerCase();
      if(!['d','f','j','k','s','a','l',';'].includes(k)) return;
      e.preventDefault();
    }
    const tp=performance.now()/1000, tC=syncC0 + (tp - syncP0);
    if(tC < t0C - 0.15) return;
    const k=Math.round((tC - t0C)/beatInt), tB=t0C + k*beatInt, dMs=(tC - tB)*1000;
    if(Math.abs(dMs)<=600) taps.push(dMs);
    const need=10, nowN=Math.min(taps.length,need);
    let adv='â€”'; if(nowN>=4){ const rec=robust(taps); adv=(rec>0?'+':'')+rec+' ms'; }
    cbBig.textContent = nowN + '/' + need; cbStat.textContent = `${nowN}/${need} å»ºè­°åç§»ï¼š${adv}`;
    if(nowN>=need) cbDone.disabled=false;
  };
  window.addEventListener('keydown',tapH); pnl.addEventListener('pointerdown',tapH);
}
function finishCalib(){ if(!taps.length){ closeCalib(); return; } const rec=robust(taps); setOffset(rec); banner(`å·²å¥—ç”¨åç§»ï¼š${rec} ms`); closeCalib(); }

/* ===== ç¶å®š / åˆå§‹åŒ– ===== */
function bind(){
  $("#btnStart").addEventListener("click", startGame);
  $("#btnMusic").addEventListener("click", toMusic);
  $("#btnOptions").addEventListener("click", toOpt);
  $("#btnSongConfirm").addEventListener("click", confirmSong);
  $$(".btnBackMenu").forEach(b=> b.addEventListener("click", toMenu));
  $("#pauseButton").addEventListener("click", ()=>{ if(phase==='countdown') cancelCountdown(); pauseGame(); });
  $("#btnResume").addEventListener("click", resumeGame);
  $("#btnRestart").addEventListener("click", startGame);

  /* éŸ³é‡ */
  const mS=$("#volumeSlider"), mL=$("#volumeLabel"), sS=$("#sfxSlider"), sL=$("#sfxLabel");
  const mv=+(localStorage.getItem("dfjk.volume")||80), sv=+(localStorage.getItem("dfjk.sfxVol")||70);
  mS.value=String(mv); sS.value=String(sv); VOL_M=mv/100; VOL_S=sv/100; applyVol(); mL.textContent=`${mv}%`; sL.textContent=`${sv}%`;
  mS.addEventListener("input", ()=>{ const v=+mS.value; VOL_M=v/100; mL.textContent=`${v}%`; localStorage.setItem("dfjk.volume",String(v)); applyVol(); });
  sS.addEventListener("input", ()=>{ const v=+sS.value; VOL_S=v/100; sL.textContent=`${v}%`; localStorage.setItem("dfjk.sfxVol",String(v)); applyVol(); });

  /* åç§» slider + å¿«é€Ÿæ ¡æ­£ */
  const oS=$("#offsetSlider"), svOff=+(localStorage.getItem("dfjk.offsetMs")||0);
  oS.value=String(svOff); setOffset(svOff); oS.addEventListener("input", ()=> setOffset(+oS.value) );
  $("#offsetCalibBtn").addEventListener("click", openCalib);
  $("#calibStart").addEventListener("click", ()=>{ if(!cal) startCalib(); });
  $("#calibFinish").addEventListener("click", finishCalib);
  $("#calibCancel").addEventListener("click", closeCalib);

  /* RGB åˆ‡æ› */
  const rgb=$("#rgbCycleToggle"); rgb.checked=RGB;
  rgb.addEventListener("change", ()=>{ RGB=rgb.checked; localStorage.setItem("dfjk.rgbCycle", RGB?'1':'0'); });

  /* è¡€æ¢æ¨¡å¼ */
  const hpC=$("#hpToggle"); hpC.checked=HP_ON;
  hpC.addEventListener("change", ()=>{ HP_ON=hpC.checked; localStorage.setItem("dfjk.hpOn", HP_ON?'1':'0'); hpShow(HP_ON); hpUpdate(); });

  /* ç†±åœ–æŒ‰éˆ• */
  $("#toggleHeatBtn").addEventListener("click", ()=>{ showHeat=!showHeat; banner(showHeat?'ç†±åœ–ï¼šON':'ç†±åœ–ï¼šOFF'); ui(); });

  /* éµæ•¸é¸æ“‡ */
  const keySel=$("#keyModeSelect");
  keySel.value = String(LANES);
  keySel.addEventListener("change", ()=>{
    const n=+keySel.value;
    setLanes(n);
    // é‡æ–°ç”¢ç”Ÿå¿«å–ç”¨çš„é è¦½ç®­é ­ç­‰
    draw({skip:true}); ui(); hud();
  });
}

function init(){
  recomputeLaneDirs();
  fitDPR(); desktopScale(); layout();
  fillSongs(); bind(); hpShow(HP_ON); hpUpdate(); hud();
  showOnly("menuScreen");
}

/* é‡æ–°è¨ˆç®—ä½ˆå±€ */
window.addEventListener("resize", ()=>{ fitDPR(); desktopScale(); layout(); if(phase==='countdown'){ draw({skip:true}); ui(); } });

/* DOM å°±ç·’ */
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
