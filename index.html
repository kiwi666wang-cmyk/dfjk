<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DFJK é«˜ç²¾åº¦ Cyberpunk ç‰ˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  html,body{touch-action:manipulation}
  body{
    margin:0;color:#fff;font-family:sans-serif;text-align:center;transition:background .5s ease;
    background: radial-gradient(1300px 900px at 50% 0%, #111a30 0%, #0b1426 55%, #07101d 100%);
    overflow-x:hidden;
  }
  /* è¼•é‡ glitch/æƒæ */
  body::before,body::after{content:"";position:fixed;inset:0;pointer-events:none;z-index:0}
  body::before{
    background:
      repeating-linear-gradient(to bottom, rgba(255,255,255,.07) 0 1px, rgba(0,0,0,0) 3px),
      linear-gradient(120deg, rgba(0,255,255,.18), rgba(255,0,160,.15) 60%, rgba(255,255,0,.10));
    mix-blend-mode:screen;animation:scanY 5.6s linear infinite;opacity:.28;
  }
  body::after{
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="2" stitchTiles="stitch"/></filter><rect width="140" height="140" filter="url(%23n)" opacity="0.09"/></svg>');
    background-size:240px 240px;animation:noiseShift 7.5s steps(28) infinite;opacity:.22;mix-blend-mode:overlay;
  }
  @keyframes scanY{from{background-position:0 0,0 0}to{background-position:0 360px,0 0}}
  @keyframes noiseShift{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(0,-70px,0)}}

  #stage{position:relative;width:95%;max-width:420px;margin:20px auto;--u:1;z-index:1}
  canvas{display:block;background:#0f1727;width:100%;height:auto;touch-action:manipulation}
  canvas.ui{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;background:transparent;border:none;z-index:5}
  /* å½é‚Šç•Œï¼šæ¼¸å±¤æ·¡å‡ºï¼Œå–ä»£ç¡¬é‚Šæ¡† */
  #edgeFade{position:absolute;inset:0;pointer-events:none;opacity:1;border-radius:10px;
    background:
      linear-gradient(to right, rgba(255,255,255,.16), rgba(255,255,255,0) 40%) left/16px 100% no-repeat,
      linear-gradient(to left,  rgba(255,255,255,.16), rgba(255,255,255,0) 40%) right/16px 100% no-repeat,
      linear-gradient(to bottom,rgba(255,255,255,.16), rgba(255,255,255,0) 40%) top/100% 16px no-repeat,
      linear-gradient(to top,   rgba(255,255,255,.16), rgba(255,255,255,0) 40%) bottom/100% 16px no-repeat;
  }

  .hitbar{position:absolute;left:0;width:100%;display:flex;justify-content:space-between;align-items:center;height:calc(90px * var(--u));z-index:2;opacity:0;pointer-events:none}
  .hud{font-size:18px;margin-top:10px;line-height:1.6}
  .songline{font-size:14px;opacity:.9}
  button{margin:10px;padding:10px 20px;font-size:18px;background:#78d5ff;border:none;border-radius:8px;cursor:pointer}
  #menuScreen,#musicScreen,#endScreen,#optionsScreen,#pauseScreen{padding-top:120px}
  .blur{filter:blur(6px);pointer-events:none;user-select:none}
  #pauseButton{position:absolute;top:10px;right:10px;z-index:3}

  /* å€’æ•¸ */
  #countdownText{
    position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);
    font-family:'Fredoka One',sans-serif;font-size:72px;color:#fff;text-shadow:2px 2px 8px #000;z-index:9;pointer-events:none;display:none}
  @keyframes popScale{0%{transform:translate(-50%,-50%) scale(.85)}50%{transform:translate(-50%,-50%) scale(1.12)}100%{transform:translate(-50%,-50%) scale(1)}}

  /* æç¤º/åµéŒ¯ */
  #warnBanner{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:rgba(255,80,80,.95);padding:10px 14px;border-radius:8px;font-size:14px;display:none;z-index:20}
  #debug{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.55);padding:6px 10px;border-radius:6px;font:12px/1.4 monospace;z-index:25}
</style>
</head>
<body>
  <!-- ä¸»é¸å–® -->
  <div id="menuScreen">
    <h1>ğŸµ DFJK é«˜ç²¾åº¦ Cyberpunk ç‰ˆ</h1>
    <div class="row">
      <button onclick="window.startGame && window.startGame()">é–‹å§‹éŠæˆ²</button>
      <button onclick="window.showMusic && window.showMusic()">éŸ³æ¨‚</button>
      <button onclick="window.showOptions && window.showOptions()">é¸é …</button>
    </div>
    <div class="row">å·²é¸æ›²ç›®ï¼š<span id="menuChosenSong">å°šæœªé¸æ“‡</span></div>
  </div>

  <!-- éŸ³æ¨‚é¸å–® -->
  <div id="musicScreen" style="display:none;">
    <h2>ğŸ¼ é¸æ“‡æœ¬å±€æ›²ç›®</h2>
    <div class="row">
      <select id="songSelect" size="12"></select>
      <div class="hint">å¿…é ˆé¸æ“‡æ›²ç›®æ‰å¯é–‹å§‹ã€‚</div>
    </div>
    <div class="row">
      <button onclick="window.confirmSong && window.confirmSong()">ç¢ºå®š</button>
      <button onclick="window.goToMenu && window.goToMenu()">å›ä¸»é¸å–®</button>
    </div>
    <div class="row">å·²é¸ï¼š<span id="chosenSongLabel">å°šæœªé¸æ“‡</span></div>
  </div>

  <!-- é¸é … -->
  <div id="optionsScreen" style="display:none;">
    <h2>âš™ï¸ éŠæˆ²é¸é …</h2>
    <div class="row">
      <label for="difficultySelect">é›£åº¦ï¼š</label>
      <select id="difficultySelect">
        <option value="ex">EXï¼ˆæ¥µé™ï¼‰</option>
        <option value="hell">åœ°ç„</option>
        <option value="hard">å›°é›£</option>
        <option value="normal" selected>æ™®é€š</option>
        <option value="easy">ç°¡å–®</option>
        <option value="beginner">åˆå­¸è€…</option>
      </select>
    </div>
    <div class="row">
      <label for="speedMultiplier">é€Ÿåº¦å€ç‡ï¼š</label>
      <select id="speedMultiplier">
        <option value="1">1.0xï¼ˆæ¨™æº–ï¼‰</option>
        <option value="1.1">1.1x</option>
        <option value="1.2">1.2x</option>
        <option value="1.3">1.3x</option>
        <option value="1.6">1.6x</option>
        <option value="2.0">2.0x</option>
      </select>
    </div>
    <div class="row">
      <label for="noteDirection">éŸ³ç¬¦æ–¹å‘ï¼š</label>
      <select id="noteDirection">
        <option value="down" selected>ä¸‹è½æ‰“æ“Šï¼ˆæ‰“æ“Šç·šåœ¨åº•ï¼‰</option>
        <option value="up">ä¸Šå‡æ‰“æ“Šï¼ˆæ‰“æ“Šç·šåœ¨é ‚ï¼‰</option>
      </select>
    </div>
    <div class="row">
      <label for="judgeMode">åˆ¤å®šæ¨¡å¼ï¼š</label>
      <select id="judgeMode">
        <option value="old" selected>Old Inputï¼ˆå« Ghost æ‡²ç½°ï¼‰</option>
        <option value="new">New Inputï¼ˆç§»é™¤ WRONGï¼‰</option>
      </select>
    </div>
    <div class="row">
      <label for="volumeSlider">éŸ³é‡ï¼š</label>
      <input id="volumeSlider" type="range" min="0" max="100" value="80" />
      <span id="volumeLabel">80%</span>
    </div>
    <div class="row"><hr style="opacity:.2"></div>
    <h3>ğŸ¯ å‘½ä¸­å»¶é²æ ¡æ­£</h3>
    <div class="row">
      <label for="offsetSlider">å…¨åŸŸåç§» (ms)ï¼š</label>
      <input id="offsetSlider" type="range" min="-600" max="600" value="0" />
      <span id="offsetLabel">0 ms</span>
      <button id="offsetCalibBtn" type="button">å¿«é€Ÿæ ¡æ­£</button>
    </div>
    <div class="row"><button onclick="window.goToMenu && window.goToMenu()">å›ä¸»é¸å–®</button></div>
  </div>

  <!-- éŠæˆ²ç•«é¢ -->
  <div id="gameScreen" style="display:none; position:relative;">
    <button id="pauseButton" onclick="window.pauseGame && window.pauseGame()">â¸ï¸</button>
    <div id="stage">
      <canvas id="gameCanvas" width="420" height="640"></canvas>
      <canvas id="uiCanvas" class="ui" width="420" height="640"></canvas>
      <div id="edgeFade" aria-hidden="true"></div>
      <div class="hitbar"><div class="hitkey"></div><div class="hitkey"></div><div class="hitkey"></div><div class="hitkey"></div></div>
      <div id="countdownText">Ready</div>
    </div>
    <div class="hud">
      åˆ†æ•¸ï¼š<span id="score">0</span>ã€€é€£æ“Šï¼š<span id="combo">0</span>ã€€åˆ¤å®šï¼š<span id="judgement">-</span>ã€€MISSï¼š<span id="missCount">0</span>
      <div class="songline">
        æ›²ç›®ï¼š<span id="songTitle">-</span> ï½œ é›£åº¦ï¼š<span id="diffLabel">-</span> ï½œ æ–¹å‘ï¼š<span id="dirLabel">-</span> ï½œ åˆ¤å®šï¼š<span id="judgeLabel">-</span> ï½œ åç§»ï¼š<span id="offsetActive">0 ms</span>
      </div>
    </div>
  </div>

  <!-- æš«åœ -->
  <div id="pauseScreen" style="display:none;">
    <h2>â¸ï¸ éŠæˆ²æš«åœ</h2>
    <button onclick="window.resumeGame && window.resumeGame()">â–¶ï¸ ç¹¼çºŒ</button>
    <button onclick="window.goToMenu && window.goToMenu()">å›ä¸»é¸å–®</button>
  </div>

  <!-- çµç®— -->
  <div id="endScreen" style="display:none;">
    <h2>ğŸ® éŠæˆ²çµæŸï¼</h2>
    <p>æ›²ç›®ï¼š<span id="finalSong">-</span></p>
    <p>é›£åº¦ï¼š<span id="finalDiff">-</span></p>
    <p>æ–¹å‘ï¼š<span id="finalDir">-</span></p>
    <p>åˆ¤å®šï¼š<span id="finalJudge">-</span></p>
    <p>åˆ†æ•¸ï¼š<span id="finalScore">0</span></p>
    <p>SICKï¼š<span id="statSick">0</span></p>
    <p>GOODï¼š<span id="statGood">0</span></p>
    <p>BADï¼š<span id="statBad">0</span></p>
    <p>SHITï¼š<span id="statShit">0</span></p>
    <p>MISSï¼š<span id="statMiss">0</span></p>
    <button onclick="window.startGame && window.startGame()">å†ç©ä¸€æ¬¡</button>
    <button onclick="window.goToMenu && window.goToMenu()">å›ä¸»é¸å–®</button>
  </div>

  <!-- SFX ï¼† BGMï¼šBGM åƒ…åš HTML5 å¾Œå‚™æ’­æ”¾ -->
  <audio id="hitSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_6e3e3b6f3f.mp3?filename=click-124467.mp3" preload="auto"></audio>
  <audio id="bgm" preload="auto" crossorigin="anonymous"></audio>

  <div id="warnBanner">âš ï¸ æç¤º</div>
  <div id="debug">mode: - | err: -</div>

<script>
/* ========= å¯èª¿åƒæ•¸ ========= */
const MUSIC_DIR = 'music/';               // mp3 ç›®éŒ„
const CENTER_TUCK_PX = 12;                // ä¸­é–“å…© Lane å‘å…§å¾®æ”¶
const GLITCH_AMPLIFY = 1.45;              // æ•…éšœç‰¹æ•ˆå¼·åº¦
const TAIL_FACTOR    = 0.48;              // ç®­å°¾é•·åº¦ï¼ˆè¶Šå¤§è¶Šé•·ï¼‰  // â†‘ æ¯”å‰ç‰ˆæ›´é•·
const COUNTDOWN_MS   = 4100;              // å€’æ•¸ç¸½æ™‚é•·ï¼ˆæ›´æœ‰ç¯€å¥æ„Ÿï¼‰

/* ========= è®Šæ•¸ ========= */
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
const uiCanvas=document.getElementById('uiCanvas');
const uictx=uiCanvas.getContext('2d',{alpha:true});
const debugEl=document.getElementById('debug');

let W=420,H=640;
function setupDPR(){
  const dpr=Math.min(window.devicePixelRatio||1,2);
  canvas.width=Math.round(W*dpr); canvas.height=Math.round(H*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
  uiCanvas.width=Math.round(W*dpr); uiCanvas.height=Math.round(H*dpr); uictx.setTransform(dpr,0,0,dpr,0,0);
}
setupDPR();

const IS_MOBILE=window.matchMedia('(pointer: coarse)').matches;
const SUPPORTS_VIB=IS_MOBILE&&'vibrate' in navigator;

const laneColors=['#b266ff','#66ccff','#66ff66','#ff6666']; // å·¦ä¸‹ä¸Šå³
const laneDirs=['left','down','up','right'];
const HITKEY_BASE=90, NOTE_BASE=48; // â†‘ NOTE_BASE åŠ å¤§ï¼ˆåŸ 44ï¼‰
let uiScale=1;

let phase='menu',running=false,paused=false,loopId=null,prevT=0;
let selectedSongFile=null;
let score=0,combo=0,lastJudgementText='-'; let missCount=0,gameOver=false;
let stats={sick:0,good:0,bad:0,shit:0,miss:0};
let chart=[],__remainNotes=0;
let receptorPulse=[0,0,0,0];
let currentSongTitle='-',currentDifficulty='normal',currentDirection='down',currentJudgeMode='old';
const dtHistory=[];const DT_HIST_MAX=240;

let cachedRectH=canvas.getBoundingClientRect().height;
let cachedScaleY=cachedRectH/H;
let cachedJudgeCss=(HITKEY_BASE*uiScale/2);
let cachedJudgeInternal=cachedJudgeCss/cachedScaleY;
function recomputeLayout(){
  const rect=canvas.getBoundingClientRect();
  cachedRectH=rect.height; cachedScaleY=cachedRectH/H;
  cachedJudgeCss=(currentDirection==='up')?(HITKEY_BASE*uiScale/2):(cachedRectH-HITKEY_BASE*uiScale/2);
  cachedJudgeInternal=cachedJudgeCss/cachedScaleY;
}
function applyDesktopScale(){
  const coarse=window.matchMedia('(pointer: coarse)').matches;
  const wide=window.matchMedia('(min-width:1024px)').matches;
  const wider=window.matchMedia('(min-width:1440px)').matches;
  let u=1; if(!coarse&&(wide||wider))u=wider?1.8:1.5;
  uiScale=u; document.getElementById('stage').style.setProperty('--u',String(u));
  document.getElementById('stage').style.maxWidth=`${Math.round(420*u)}px`;
  recomputeLayout();
}
function getJudgeLineYInternal(){return cachedJudgeInternal;}
function laneCenterX(index){
  const laneWidth=W/4;
  let x=index*laneWidth + laneWidth/2;
  if(index===1) x+=CENTER_TUCK_PX;
  if(index===2) x-=CENTER_TUCK_PX;
  return x;
}

/* ========= å°å·¥å…· ========= */
function dirToAngle(dir){switch(dir){case 'up':return -Math.PI/2;case 'down':return Math.PI/2;case 'left':return Math.PI;case 'right':return 0;}return 0}
function laneFromKey(k){switch(k){case'd':case'arrowleft':return 0;case'f':case'arrowdown':return 1;case'j':case'arrowup':return 2;case'k':case'arrowright':return 3;default:return null}}
function laneFromPointer(xCss){const rect=canvas.getBoundingClientRect();const x=xCss/rect.width*W;let best=0,bestd=1e9;for(let i=0;i<4;i++){const d=Math.abs(x-laneCenterX(i));if(d<bestd){bestd=d;best=i}}return best;}
function recordDt(d){dtHistory.push(d);if(dtHistory.length>DT_HIST_MAX)dtHistory.shift();}
function getDtStats(){if(!dtHistory.length)return{avg:0,std:0};const n=dtHistory.length;const avg=dtHistory.reduce((a,c)=>a+c,0)/n;const va=dtHistory.reduce((a,c)=>a+(c-avg)*(c-avg),0)/n;return{avg,std:Math.sqrt(va)};}
function banner(msg){const b=document.getElementById('warnBanner'); b.textContent=msg; b.style.display='block'; setTimeout(()=>b.style.display='none',3000);}
function setDebug(mode, err){debugEl.textContent=`mode: ${mode} | err: ${err||'-'}`}

/* ========= Cyberpunk ç®­é ­ ========= */
function lighten(c,a){const p=parseInt(c.slice(1),16);let r=(p>>16)&255,g=(p>>8)&255,b=p&255;r=Math.min(255,Math.round(r+(255-r)*a));g=Math.min(255,Math.round(g+(255-g)*a));b=Math.min(255,Math.round(b+(255-b)*a));return`rgb(${r},${g},${b})`}
function drawBlueStreakArrow({x,y,size,dir,baseColor,isReceptor,pulse,t}){
  const ang=dirToAngle(dir);
  const L=size*2.05, Hh=size*0.95, inner=0.62, cut=Hh*0.32;
  const tip=L*0.52, tail=-L*TAIL_FACTOR;

  ctx.save(); ctx.translate(x,y); ctx.rotate(ang);

  // èƒŒæ™¯å‹•æ…‹è»Œè·¡
  const trailLen=L*0.92, bands=7;
  for(let i=0;i<bands;i++){
    const pp=i/(bands-1), w=(1-pp)*trailLen;
    const a=(0.14*(1-pp))*(isReceptor?.55:1)*GLITCH_AMPLIFY;
    ctx.save(); ctx.globalAlpha=a*(0.85+0.25*Math.sin(t*7+i));
    ctx.fillStyle = (i%2)? lighten(baseColor,.18):lighten(baseColor,.38);
    ctx.beginPath();
    ctx.moveTo(tail-w*0.95,-Hh*0.34*(1-pp*0.25));
    ctx.lineTo(tip-w*0.1,-Hh*0.16*(1-pp*0.25));
    ctx.lineTo(tip-w*0.1, Hh*0.16*(1-pp*0.25));
    ctx.lineTo(tail-w*0.95, Hh*0.34*(1-pp*0.25));
    ctx.closePath(); ctx.fill();
    ctx.restore();
  }

  const drawChevron=(hh,lw,strokeStyle)=>{
    ctx.beginPath();
    ctx.moveTo(tail, -hh*0.52);
    ctx.lineTo(0,   -hh*0.52);
    ctx.lineTo(tip,  0);
    ctx.lineTo(0,    hh*0.52);
    ctx.lineTo(tail,  hh*0.52);
    ctx.lineTo(tail+cut*(hh/Hh), 0);
    ctx.closePath();
    ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.lineWidth=lw; ctx.strokeStyle=strokeStyle; ctx.stroke();
  };

  // Receptorï¼šé»‘åº•ï¼‹ç´°ç™½æé‚Šï¼›å‘½ä¸­æ™‚æ•´é«”æ³›å…‰
  if(isReceptor){
    ctx.fillStyle='#050607';
    ctx.beginPath();
    ctx.moveTo(tail,-Hh*0.55);ctx.lineTo(0,-Hh*0.55);ctx.lineTo(tip,0);ctx.lineTo(0,Hh*0.55);ctx.lineTo(tail,Hh*0.55);ctx.lineTo(tail+cut,0);ctx.closePath();ctx.fill();
    ctx.lineWidth=6;ctx.strokeStyle='#000';ctx.stroke();
    ctx.lineWidth=2.1;ctx.strokeStyle='rgba(255,255,255,.95)';ctx.stroke();
    if(pulse>0){
      ctx.save();ctx.globalAlpha=(0.40+0.50*pulse)*GLITCH_AMPLIFY;ctx.fillStyle=lighten(baseColor,.28);
      ctx.beginPath();ctx.moveTo(tail,-Hh*0.55);ctx.lineTo(0,-Hh*0.55);ctx.lineTo(tip,0);ctx.lineTo(0,Hh*0.55);ctx.lineTo(tail,Hh*0.55);ctx.lineTo(tail+cut,0);ctx.closePath();ctx.fill();ctx.restore();
    }
  }else{
    // Noteï¼šä¿ç•™å½©è‰²é‚Šç·šï¼ˆå…§å¤–é›™å±¤ï¼‰
    drawChevron(Hh,       5.0, lighten(baseColor,.48));
    drawChevron(Hh*inner, 3.0, '#ffffff');
  }

  // æ•…éšœé‚Šç·š
  const gAmp=(isReceptor? size*0.06 : size*0.10)*GLITCH_AMPLIFY;
  for(let k=0;k<4;k++){
    const ox=Math.sin(t*20 + k*1.9)*gAmp;
    const oy=Math.cos(t*26 + k*2.1)*gAmp*0.45;
    ctx.save(); ctx.translate(ox,oy);
    ctx.globalAlpha=isReceptor?0.28:0.40; ctx.globalCompositeOperation='lighter';
    drawChevron(Hh*(0.98-k*0.06), 1.6, (k%2)?'rgba(0,255,255,.9)':'rgba(255,0,160,.9)');
    ctx.restore();
  }
  // æ©«å‘åˆ‡ç‰‡é–ƒçˆ
  const slices=5;
  for(let s=0;s<slices;s++){
    const yy=((s/(slices-1))-0.5)*Hh*1.0;
    const jitter=(Math.sin(t*30+s*2.3)*gAmp*0.6);
    ctx.save(); ctx.beginPath(); ctx.rect(tail,yy-2,L*1.05,4); ctx.clip(); ctx.translate(jitter,0);
    drawChevron(Hh*0.96, 1.2, 'rgba(255,255,255,0.25)'); ctx.restore();
  }
  // ç´°æƒæç·š
  ctx.globalAlpha=0.12; ctx.fillStyle='#fff';
  const stripeH=Math.max(1,Math.round(size*0.10)), shift=((t*140)%stripeH);
  for(let sy=-Hh; sy<=Hh; sy+=stripeH*3){ ctx.fillRect(tail, sy+shift, L*1.05, 1); }

  ctx.restore();
}

/* ========= èƒŒæ™¯ ========= */
function drawPlayfieldBackground(t){
  ctx.save(); ctx.fillStyle='#0f1727'; ctx.fillRect(0,0,W,H);
  ctx.globalAlpha=0.24; ctx.strokeStyle='rgba(120,213,255,0.35)'; ctx.lineWidth=1;
  const step=22,ox=(t*26)%step,oy=(t*18)%step;
  for(let x=-ox;x<=W;x+=step){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=-oy;y<=H;y+=step){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  ctx.globalAlpha=0.26; const g=ctx.createLinearGradient(0,0,W,0);
  g.addColorStop(0,'rgba(0,255,255,0.32)');g.addColorStop(0.5,'rgba(255,0,160,0.26)');g.addColorStop(1,'rgba(255,255,0,0.20)');ctx.fillStyle=g;
  const diagH=20,drift=(t*64)%80; ctx.save();ctx.translate(-drift,0);ctx.rotate(-Math.PI/12);
  for(let y=-H;y<H*2;y+=diagH*4){ctx.fillRect(-W,y,W*3,diagH);} ctx.restore();
  // éœ“è™¹é›œè¨Š
  for(let i=0;i<18;i++){const ww=30+Math.random()*120,hh=2+Math.random()*4,xx=Math.random()*(W-ww),yy=Math.random()*H;ctx.globalAlpha=0.16+Math.random()*0.18;ctx.fillStyle=(i%3===0)?'rgba(0,255,255,0.6)':(i%3===1)?'rgba(255,0,160,0.5)':'rgba(255,255,0,0.45)';ctx.fillRect(xx,yy,ww,hh);}
  ctx.restore();
}

/* ========= éŸ³è¨Šå¼•æ“ï¼šä¸‰è»Œï¼ˆWebAudio â†’ HTML5 â†’ Silentï¼‰ ========= */
let INPUT_OFFSET_MS=+(localStorage.getItem('dfjk.offsetMs')||0);
const bgmEl=document.getElementById('bgm');
let audioCtx=null,gainNode=null,buffer=null,srcNode=null,mode='-';
let startAtCtx=0,startAtSong=0,softBaseSong=0,softStartPerf=0;
let durationSec=120,songEnded=false,lastAudioErr=null;

async function ensureAudio(){ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});} if(!gainNode){ gainNode=audioCtx.createGain();gainNode.connect(audioCtx.destination);} }

async function loadViaWebAudio(url){
  await ensureAudio();
  const res=await fetch(url,{mode:'cors'}); if(!res.ok) throw new Error(`fetch ${res.status}`);
  const arr=await res.arrayBuffer();
  buffer=await audioCtx.decodeAudioData(arr);
  durationSec=buffer.duration||120;
  mode='webaudio'; setDebug(mode);
}
function playWebAudio(offsetSec){
  if(!buffer) return;
  try{ if(srcNode){srcNode.onended=null; srcNode.stop(0);} }catch{}
  srcNode=audioCtx.createBufferSource();
  srcNode.buffer=buffer; srcNode.connect(gainNode);
  const when=Math.max(0,audioCtx.currentTime+0.03);
  startAtCtx=when; startAtSong=Math.max(0,Math.min(durationSec-0.001,offsetSec||0));
  softBaseSong=startAtSong; softStartPerf=performance.now()/1000;
  srcNode.onended=()=>{songEnded=true};
  try{ srcNode.start(when,startAtSong);}catch(e){}
}
async function loadViaHTML5(url){
  return new Promise((resolve,reject)=>{
    bgmEl.src=url; bgmEl.crossOrigin='anonymous';
    const onCan=()=>{ durationSec=isFinite(bgmEl.duration)?bgmEl.duration:120; bgmEl.removeEventListener('canplaythrough',onCan); mode='html5'; setDebug(mode); resolve(); };
    const onErr=(e)=>{ bgmEl.removeEventListener('error',onErr); reject(new Error('html5 error')); };
    bgmEl.addEventListener('canplaythrough',onCan,{once:true});
    bgmEl.addEventListener('error',onErr,{once:true});
    bgmEl.load();
    setTimeout(()=>{ if(mode!=='html5' && !isFinite(bgmEl.duration)){ reject(new Error('html5 timeout')); } }, 2500);
  });
}
function playHTML5(offsetSec){
  try{ bgmEl.currentTime=Math.max(0,Math.min((durationSec||120)-0.001,offsetSec||0)); }catch{}
  bgmEl.play().catch(()=>{});
  songEnded=false; bgmEl.onended=()=>{songEnded=true};
  softBaseSong=bgmEl.currentTime||0; softStartPerf=performance.now()/1000;
}
function loadSilent(){ mode='silent'; durationSec=120; setDebug(mode,'no audio available'); }
function playSilent(offsetSec){ softBaseSong=Math.max(0,offsetSec||0); softStartPerf=performance.now()/1000; songEnded=false; }
function stopAllAudio(){ try{ if(srcNode){srcNode.onended=null; srcNode.stop(0);} }catch{} try{ bgmEl.pause(); }catch{} srcNode=null; songEnded=false; }
function getClockSec(){
  if(mode==='webaudio' && audioCtx && buffer && srcNode){
    return Math.max(0,Math.min(durationSec,(audioCtx.currentTime-startAtCtx)+startAtSong));
  }
  if(mode==='html5'){
    const t = (bgmEl && !isNaN(bgmEl.currentTime)) ? bgmEl.currentTime : (performance.now()/1000-softStartPerf)+softBaseSong;
    return Math.max(0,Math.min(durationSec,t));
  }
  return Math.max(0,Math.min(durationSec,(performance.now()/1000-softStartPerf)+softBaseSong));
}
function getJudgeClockSec(){return getClockSec()+(INPUT_OFFSET_MS/1000)}
function setVolumes(percent){
  const v=Math.max(0,Math.min(100,percent))/100;
  if(gainNode) gainNode.gain.value=v;
  if(bgmEl)    bgmEl.volume=v;
}

/* ========= SFX ========= */
const hitSound=document.getElementById('hitSound');const SFX_GAIN=1.6;
class TapSoundPool{constructor(src,size=10){this.pool=[];this.idx=0;for(let i=0;i<size;i++){const a=new Audio(src);a.preload='auto';a.volume=1.0;this.pool.push(a)}}setVolume(v){const vol=Math.max(0,Math.min(1,v));for(const a of this.pool)a.volume=vol}play(){const a=this.pool[this.idx];this.idx=(this.idx+1)%this.pool.length;try{a.currentTime=0;a.play().catch(()=>{})}catch{}}}
let tapPool=null;function setSfxFromMaster(percent){const v=Math.max(0,Math.min(100,percent))/100;if(!tapPool)tapPool=new TapSoundPool(hitSound.src,12);tapPool.setVolume(Math.min(1,v*SFX_GAIN));hitSound.volume=Math.min(1,v*SFX_GAIN);}
function playTapSound(){if(!tapPool)tapPool=new TapSoundPool(hitSound.src,12);tapPool.play()}

/* ========= åˆ¤å®š ========= */
const WINDOWS={sick:80,good:130,bad:150,shit:170}, SCORES={sick:350,good:200,bad:100,shit:-50,miss:-300,ghost:-150};
let baseNoteSpeed=550, noteSpeed=baseNoteSpeed;
function judge(dtMs,lane){
  const adt=Math.abs(dtMs); let rating='',base=0,incCombo=true;
  if(adt<=WINDOWS.sick){rating='SICK!';base=SCORES.sick;stats.sick++;}
  else if(adt<=WINDOWS.good){rating='GOOD';base=SCORES.good;stats.good++;}
  else if(adt<=WINDOWS.bad){rating='BAD';base=SCORES.bad;stats.bad++;}
  else if(adt<=WINDOWS.shit){rating='SHIT';base=SCORES.shit;stats.shit++;incCombo=false;}
  else {lastJudgementText='MISS';combo=0;missCount++;stats.miss++;score=Math.max(0,score+SCORES.miss);updateHUD();return;}
  const p=Math.min(1,adt/WINDOWS.shit),centrality=Math.pow(1-p,1.25);
  score=Math.max(0,Math.round(score+base*centrality));
  if(incCombo)combo++;else combo=Math.max(0,combo-1);
  lastJudgementText=rating; recordDt(dtMs); receptorPulse[lane]=1;
  if(SUPPORTS_VIB) try{navigator.vibrate(8)}catch{}
  updateHUD();
}

/* ========= è­œç”Ÿæˆ & æ›´æ–° ========= */
const FIRST_NOTE_LEAD=1.6;
function generateChart(dur){
  chart=[]; const d=currentDifficulty;
  // æ”¾é¬†é–“è·ï¼ˆä½ èªªä¹‹å‰å¤ªç·Šï¼‰
  let doubleChance=0.35, tmin=0.24, tmax=0.52;
  if(d==='beginner'){doubleChance=0.15;tmin=0.34;tmax=0.64;}
  else if(d==='easy'){doubleChance=0.20;tmin=0.28;tmax=0.54;}
  else if(d==='hard'){doubleChance=0.55;tmin=0.18;tmax=0.40;}
  if(!(d==='ex'||d==='hell')){
    let t=FIRST_NOTE_LEAD;
    while(t<dur){
      const used=new Set();const arr=[];const cnt=Math.random()<doubleChance?2:1;
      while(arr.length<cnt){const ln=Math.floor(Math.random()*4);if(!used.has(ln)){used.add(ln);arr.push({t, lane:ln, hit:false, y:-50});}}
      chart.push(...arr);
      t+=Math.random()*(tmax-tmin)+tmin;
    }
  }else{
    const beat=0.5;let t=FIRST_NOTE_LEAD,cur=0;
    const n=()=>{cur=(cur+1)%4;return cur;},push=(tt,ln)=>chart.push({t:tt,lane:ln,hit:false,y:-50}),rnd=()=>Math.floor(Math.random()*4);
    while(t<dur){
      if(d==='ex'){
        push(t,n()); if(Math.random()<0.60)push(t,(cur+2)%4);
        if(Math.random()<0.35)push(t+beat/2,(cur+1)%4);
        if(Math.random()<0.18){push(t+beat/3,rnd());push(t+2*beat/3,rnd());}
        t+=Math.random()<0.5?beat/2:beat;
      }else{
        push(t,n()); if(Math.random()<0.85)push(t,(cur+2)%4);
        push(t+beat/2,(cur+1)%4);
        if(Math.random()<0.4){push(t+beat/4,rnd());push(t+3*beat/4,rnd());}
        t+=beat/2;
      }
    }
  }
  __remainNotes=chart.length;
}
function noteYAtTimeFor(thit,tnow){const j=getJudgeLineYInternal();return (currentDirection==='down')?(j-(thit-tnow)*noteSpeed):(j+(thit-tnow)*noteSpeed)}
function update(songT,dt){
  for(let i=0;i<chart.length;i++){const n=chart[i];n.y=noteYAtTimeFor(n.t,songT);}
  for(let i=0;i<chart.length;i++){
    const n=chart[i]; if(n.hit)continue;
    const lateMs=(songT-n.t)*1000;
    if(lateMs>WINDOWS.shit+160){
      n.hit=true; __remainNotes--;
      lastJudgementText='MISS'; combo=0; missCount++; stats.miss++; score=Math.max(0,score+SCORES.miss); updateHUD();
    }
  }
  for(let i=0;i<4;i++){receptorPulse[i]=Math.max(0,receptorPulse[i]-dt*3.2);}
}

/* ========= ç¹ªåœ– ========= */
function updateHUD(){
  document.getElementById('score').textContent=score;
  document.getElementById('combo').textContent=combo;
  document.getElementById('judgement').textContent=lastJudgementText;
  document.getElementById('missCount').textContent=missCount;
  document.getElementById('songTitle').textContent=currentSongTitle;
  document.getElementById('diffLabel').textContent=currentDifficulty.toUpperCase();
  document.getElementById('dirLabel').textContent=(currentDirection==='up'?'ä¸Šå‡':'ä¸‹è½');
  document.getElementById('judgeLabel').textContent=(currentJudgeMode==='old'?'Old':'New');
  document.getElementById('offsetActive').textContent=`${INPUT_OFFSET_MS} ms`;
}
function render(){
  const t=performance.now()/1000, judge=getJudgeLineYInternal();
  ctx.clearRect(0,0,W,H); drawPlayfieldBackground(t);

  // receptorï¼ˆæ•´é«”æœƒåœ¨å‘½ä¸­æ™‚ç™¼å…‰ï¼‰
  for(let i=0;i<4;i++){
    const x=laneCenterX(i);
    drawBlueStreakArrow({x,y:judge,size:NOTE_BASE,dir:laneDirs[i],baseColor:laneColors[i],isReceptor:true,pulse:receptorPulse[i],t});
  }
  // notes
  const top=-140,bottom=H+140;
  for(let i=0;i<chart.length;i++){
    const n=chart[i]; if(n.hit)continue; if(n.y<top||n.y>bottom)continue;
    const x=laneCenterX(n.lane);
    drawBlueStreakArrow({x,y:n.y,size:NOTE_BASE,dir:laneDirs[n.lane],baseColor:laneColors[n.lane],isReceptor:false,pulse:0,t:t+i*0.02});
  }
  // åˆ¤å®šå­—
  if(lastJudgementText!=='-'){ctx.fillStyle='#fff';ctx.font='bold 32px sans-serif';ctx.textAlign='center';const off=(currentDirection==='up')?120:-40;ctx.fillText(lastJudgementText,W/2,judge+off);}
}

/* ========= UIï¼šç†±åœ– + å·¦ä¸Šå¾½ç« ï¼ˆé–å®šä½ç½®ï¼‰ ========= */
function drawCornerBadge(){
  const x=14,y=14;
  uictx.save(); uictx.translate(x,y);
  uictx.fillStyle='rgba(0,0,0,.55)'; uictx.fillRect(0,0,92,28);
  const grad=uictx.createLinearGradient(0,0,92,0);
  grad.addColorStop(0,'#00ffff'); grad.addColorStop(0.5,'#ff00a0'); grad.addColorStop(1,'#ffff00');
  uictx.strokeStyle=grad; uictx.lineWidth=2;
  uictx.strokeRect(1,1,90,26);
  uictx.fillStyle='#fff'; uictx.font='12px sans-serif'; uictx.fillText('DFJK Cyber',8,18);
  uictx.restore();
}
function renderUI(){
  uictx.clearRect(0,0,W,H);
  drawCornerBadge(); // å·¦ä¸Šè§’é–æ­»ä¸è·‘ä½

  // åç§»ç†±åœ–
  const bins=36,min=-300,max=300,step=(max-min)/bins,hist=new Array(bins).fill(0);
  for(const v of dtHistory){const i=Math.floor((v-min)/step);if(i>=0&&i<bins)hist[i]++}
  const w=230,h=74,bw=w/bins;
  const x0=14;
  // ä¸Šå‡æ¨¡å¼æ”¾æœ€åº•ä¸‹ï¼Œé¿å…èˆ‡ receptor é‡ç–Š
  const y0=(currentDirection==='up')?(H-h-24):(24+(IS_MOBILE?6:0));
  uictx.save();uictx.globalAlpha=.98;uictx.fillStyle='rgba(0,0,0,.58)';uictx.fillRect(x0-8,y0-10,w+16,h+46);
  uictx.fillStyle='#fff';uictx.font='12px sans-serif';uictx.fillText('Hit åç§»ç†±åœ– (ms)',x0,y0-12);
  const maxc=Math.max(1,...hist);
  for(let i=0;i<bins;i++){const v=hist[i],bh=(v/maxc)*h,xx=Math.floor(x0+i*bw);uictx.fillStyle='#78d5ff';uictx.fillRect(xx,y0+(h-bh),Math.ceil(bw-1),bh);}
  const {avg,std}=getDtStats();uictx.fillStyle='#fff';uictx.fillText(`avg: ${avg.toFixed(1)} ms  Ïƒ: ${std.toFixed(1)} ms  åç§»: ${INPUT_OFFSET_MS} ms`,x0,y0+h+16);
  uictx.strokeStyle='#ffd966';uictx.beginPath();const midx=x0+(-min)/step*bw;uictx.moveTo(midx,y0);uictx.lineTo(midx,y0+h);uictx.stroke();uictx.restore();
}

/* ========= è¼¸å…¥ ========= */
function onLanePress(lane){
  if(!running)return;
  playTapSound();
  const tNow=getJudgeClockSec();
  let bestIdx=-1, bestAbs=Infinity;
  for(let i=0;i<chart.length;i++){
    const n=chart[i]; if(n.hit||n.lane!==lane)continue;
    const dtMs=(tNow-n.t)*1000, adt=Math.abs(dtMs);
    if(adt<=WINDOWS.shit && adt<bestAbs){bestAbs=adt; bestIdx=i;}
  }
  if(bestIdx>=0){
    const n=chart[bestIdx]; n.hit=true; __remainNotes--; judge((tNow-n.t)*1000, lane);
  }else if(currentJudgeMode==='old'){
    lastJudgementText='MISS'; combo=0; score=Math.max(0,score+SCORES.ghost); updateHUD();
  }
}

/* ========= å€’æ•¸ï¼ˆRAFï¼‰ ========= */
let isCountingDown=false, countdownRAF=null;
function showCountdown(startCallback){
  cancelCountdown(); isCountingDown=true;
  const el=document.getElementById('countdownText'); el.style.display='block';
  const t0=performance.now();
  const seg=[800,800,800,800,900], labels=['Ready','3','2','1','Go!']; // æ”¾æ…¢ä¸€é»
  const total=seg.reduce((a,b)=>a+b,0);
  function step(now){
    if(!isCountingDown)return;
    const elapsed=now-t0;
    let acc=0,idx=seg.length-1;
    for(let i=0;i<seg.length;i++){acc+=seg[i]; if(elapsed<acc){idx=i; break;}}
    el.textContent=labels[idx];
    el.style.animation='none'; void el.offsetWidth; el.style.animation='popScale .55s ease-out';
    render(); renderUI();
    if(elapsed>=total || elapsed>=COUNTDOWN_MS){
      el.style.display='none'; isCountingDown=false; startCallback(); return;
    }
    countdownRAF=requestAnimationFrame(step);
  }
  countdownRAF=requestAnimationFrame(step);
}
function cancelCountdown(){ if(!isCountingDown && !countdownRAF) return; isCountingDown=false; try{cancelAnimationFrame(countdownRAF)}catch{} countdownRAF=null; const el=document.getElementById('countdownText'); el.style.animation='none'; el.style.display='none'; }

/* ========= UI åˆ‡æ› ========= */
function showOnly(id){['menuScreen','musicScreen','optionsScreen','gameScreen','pauseScreen','endScreen'].forEach(x=>document.getElementById(x).style.display=(x===id?'block':'none')); if(id!=='gameScreen')document.getElementById('gameScreen').classList.remove('blur');}
function goToMenu(){cancelCountdown();stopGameLoop();stopAllAudio();showOnly('menuScreen');phase='menu';document.getElementById('menuChosenSong').textContent=selectedSongFile?selectedSongFile.replace(/\.mp3$/i,''):'å°šæœªé¸æ“‡';}
function showOptions(){showOnly('optionsScreen')}
function showMusic(){showOnly('musicScreen')}

/* ========= éŸ³é‡/æ ¡æ­£/æ›²åº« ========= */
function initVolumeUI(){
  const s=document.getElementById('volumeSlider');
  const l=document.getElementById('volumeLabel');
  const saved=+localStorage.getItem('dfjk.volume')||80;
  s.value=String(saved); l.textContent=`${saved}%`; setVolumes(saved); setSfxFromMaster(saved);
  s.addEventListener('input',()=>{const v=+s.value; l.textContent=`${v}%`; setVolumes(v); setSfxFromMaster(v); localStorage.setItem('dfjk.volume',String(v));});
}
function setGlobalOffset(ms){const v=Math.max(-600,Math.min(600,(ms|0)));INPUT_OFFSET_MS=v;localStorage.setItem('dfjk.offsetMs',String(v));document.getElementById('offsetLabel').textContent=`${v} ms`;document.getElementById('offsetActive').textContent=`${v} ms`}
function initOffsetUI(){
  const s=document.getElementById('offsetSlider'),lab=document.getElementById('offsetLabel');
  const saved=+(localStorage.getItem('dfjk.offsetMs')||0);
  s.value=String(saved); lab.textContent=`${saved} ms`; setGlobalOffset(saved);
  document.getElementById('offsetCalibBtn').addEventListener('click',()=>alert('å¿«é€Ÿæ ¡æ­£ä¿ç•™ï¼›è¦å…¨è‡ªå‹•æˆ‘å†å‡ç´šã€‚'));
}

/* æ›²åº«ï¼ˆå®Œæ•´ï¼‰ */
const SONGS = [
  "Charlie Puth - Light Switch [Official Music Video] - Charlie Puth.mp3",
  "Creepy Nuts â€Mirageâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Opening Theme Song - Creepy Nuts.mp3",
  "Creepy Nuts â€Nemureâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Ending Theme Song - Creepy Nuts (1).mp3",
  "Creepy Nutsï½¢Bling-Bang-Bang-Bornï½£ Ã— TV Animeï½¢ãƒãƒƒã‚·ãƒ¥ãƒ«-MASHLE-ï½£ Collaboration Music Video #BBBBãƒ€ãƒ³ã‚¹ - Creepy Nuts.mp3",
  "KANA-BOON - Silhouette - KANABOONVEVO.mp3",
  "Wiz Khalifa - See You Again ft. Charlie Puth [Official Video] Furious 7 Soundtrack - Wiz Khalifa Music (youtube).mp3",
  "Maroon 5 - Memories (Official Video) - Maroon5VEVO (youtube).mp3",
  "Chainsaw Man â€“ The Movie Reze Arc - Theme Song FULL IRIS OUT by Kenshi Yonezu (Lyrics) - Jamong (youtube).mp3",
  "ãƒ’ã‚°ãƒã‚¢ã‚¤ _ ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ã€Official Videoã€‘ Ai Higuchi â€Itterasshai(See you later)â€ - ãƒ’ã‚°ãƒã‚¢ã‚¤ (youtube).mp3",
  "Chainsaw Man â€“ The Movie Reze Arc - Ending FULL JANE DOE by Kenshi Yonezu, Hikaru Utada (Lyrics) - Jamong (youtube).mp3",
  "PokÃ©mon partners of different generations dancing POKÃ‰DANCE Animation Music Video - PokÃ©mon Asia ENG (youtube).mp3",
  "Lost Sky, Sara Skinner - Dreams pt. II (feat. Sara Skinner) [NCS Release].mp3",
  "OneRepublic - Nobody (from Kaiju No. 8) [Official Music Video] - OneRepublicVEVO.mp3",
  "YOASOBIã€ŒWatch me!ã€Official Music Video - Ayase _ YOASOBI.mp3",
  "yung kai - blue (official music video) - yung kai.mp3",
  "ã€AKASAKIã€‘Bunny Girl _ ãƒãƒ‹ãƒ¼ã‚¬ãƒ¼ãƒ«ï¼ˆLyric Videoï¼‰ - AKASAKI (19).mp3",
  "ã€MVã€‘éš™_ã‚†ãƒ¼ã‚Šã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã€‘ - ã‚†ãƒ¼ã‚ŠğŸğŸ¥ã€”24ã€•ãƒ»yuri (1).mp3",
  "ã€imaseã€‘NIGHT DANCERï¼ˆMVï¼‰ - imase.mp3",
  "ãªã¨ã‚Š - Overdose - ãªã¨ã‚Š _ natori.mp3",
  "å¥½ãã ã‹ã‚‰ã€‚_ ã€ãƒ¦ã‚¤ã‚«ã€ã€MVã€‘ - ã€ãƒ¦ã‚¤ã‚«ã€.mp3",
  "å»»å»»å¥‡è­š - Eve MV - Eve.mp3",
  "é’ã®ã™ã¿ã‹ _ ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ - Where Our Blue Is _ Tatsuya Kitani - ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ _ Tatsuya Kitani.mp3",
  "Toge Toge Sadistic - Enormita (youtube).mp3",
  "My dream girls - NACHERRY (youtube).mp3",
  "PEACEKEEPER - STEREO DIVE FOUNDATION (youtube).mp3",
  "YOASOBI - Idolã€Œã‚¢ã‚¤ãƒ‰ãƒ«ã€Lyrics Video [Kan_Rom_Eng] Oshi no Ko (æ¨ã—ã®å­) OP - mimanimi (youtube).mp3",
  "YOASOBI â€“ 'æ€ªç‰© (Monster)' Lyrics - Kei Takahashi (youtube).mp3",
  "YOASOBI - Racing Into The Night Lyrics (JPN_ROM_ENG) - rin rin (youtube).mp3",
  "ã€Hanserã€‘å®¤å†…ç³»çš„TrackMaker _ ã‚¤ãƒ³ãƒˆã‚™ã‚¢ç³»ãªã‚‰ãƒˆãƒ©ãƒƒã‚¯ãƒ¡ã‚¤ã‚«ãƒ¼ ã€ä¸­æ–‡ç¿»å”± _ coverã€‘ - OtakuLAB (youtube).mp3",
  "Aimer - Brave Shine - AimerOfficialVEVO (youtube).mp3",
  "ROSA WALTON x HALLIE COGGINS - I REALLY WANT TO STAY AT YOUR HOUSE (LYRIC) AMV CYBERPUNK EDGERUNNERS - Eternity Music (youtube).mp3"
];
function fillSongList(){
  const sel=document.getElementById('songSelect'); if(sel.dataset.filled)return;
  sel.innerHTML='';
  const ph=document.createElement('option'); ph.value=''; ph.textContent='â€” è«‹é¸æ“‡æ›²ç›® â€”'; ph.disabled=true; ph.selected=!selectedSongFile; sel.appendChild(ph);
  SONGS.forEach(f=>{const opt=document.createElement('option');opt.value=f;opt.textContent=f.replace(/\.mp3$/i,'');if(selectedSongFile===f)opt.selected=true;sel.appendChild(opt);});
  sel.addEventListener('change',()=>{document.getElementById('chosenSongLabel').textContent=sel.value?sel.options[sel.selectedIndex].textContent:'å°šæœªé¸æ“‡';});
  sel.dataset.filled='1';
}
function confirmSong(){const sel=document.getElementById('songSelect');if(!sel.value){alert('è«‹å…ˆé¸æ“‡éŸ³æ¨‚');return;}selectedSongFile=sel.value;document.getElementById('chosenSongLabel').textContent=sel.options[sel.selectedIndex].textContent;document.getElementById('menuChosenSong').textContent=sel.options[sel.selectedIndex].textContent;goToMenu();}

/* ========= æµç¨‹ ========= */
async function startGame(){
  try{
    try{ await ensureAudio(); await audioCtx.resume(); }catch{}
    if(!selectedSongFile){ showMusic(); alert('è«‹å…ˆé¸æ“‡éŸ³æ¨‚'); return; }

    const diff=document.getElementById('difficultySelect').value,
          sp=document.getElementById('speedMultiplier'),
          dir=document.getElementById('noteDirection').value,
          jmode=document.getElementById('judgeMode').value;
    currentDifficulty=diff; currentDirection=dir; currentJudgeMode=jmode;

    let mul=parseFloat(sp.value); if(diff==='beginner')mul=0.8; else if(diff==='easy')mul=0.9; else if(diff==='ex')mul=1.8;
    noteSpeed=baseNoteSpeed*mul;

    score=0;combo=0;lastJudgementText='-';missCount=0;gameOver=false;stats={sick:0,good:0,bad:0,shit:0,miss:0};
    chart=[];__remainNotes=0;dtHistory.length=0;receptorPulse=[0,0,0,0]; updateHUD();

    currentSongTitle=selectedSongFile.replace(/\.mp3$/i,'');
    const url = MUSIC_DIR + encodeURIComponent(selectedSongFile);

    showOnly('gameScreen');phase='countdown';setupDPR();applyDesktopScale();recomputeLayout();render();renderUI();

    // éŸ³è¨Šè¼‰å…¥ï¼šWebAudio â†’ HTML5 â†’ Silent
    lastAudioErr=null;
    try{
      await loadViaWebAudio(url);
    }catch(e1){
      lastAudioErr=e1.message||String(e1);
      try{
        await loadViaHTML5(url);
      }catch(e2){
        lastAudioErr+='; '+(e2.message||String(e2));
        loadSilent();
      }
    }
    setDebug(mode,lastAudioErr);

    generateChart(durationSec||120);
    showCountdown(()=>{
      running=true; paused=false; prevT=getClockSec();
      if(mode==='webaudio'){ playWebAudio(0); }
      else if(mode==='html5'){ playHTML5(0); }
      else { playSilent(0); }
      loopId=requestAnimationFrame(gameLoop);
    });
  }catch(e){
    console.error(e);
    banner('âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥éŸ³æ¨‚è·¯å¾‘æˆ– Console');
    goToMenu();
  }
}
function pauseGame(){if(!running||paused)return;paused=true;showOnly('pauseScreen');document.getElementById('gameScreen').classList.add('blur');stopAllAudio();}
function resumeGame(){if(!paused)return;paused=false;showOnly('gameScreen');document.getElementById('gameScreen').classList.remove('blur');const at=getClockSec();if(mode==='webaudio'){playWebAudio(at)}else if(mode==='html5'){playHTML5(at)}else{playSilent(at)}prevT=getClockSec();loopId=requestAnimationFrame(gameLoop);}
function gameLoop(){if(paused)return;const t=getClockSec();const dt=Math.max(0,t-prevT);prevT=t;update(t,dt);render();renderUI();if(songEnded||__remainNotes<=0){running=false;stopGameLoop();stopAllAudio();document.getElementById('finalSong').textContent=currentSongTitle;document.getElementById('finalDiff').textContent=currentDifficulty.toUpperCase();document.getElementById('finalDir').textContent=(currentDirection==='up'?'ä¸Šå‡':'ä¸‹è½');document.getElementById('finalJudge').textContent=(currentJudgeMode==='old'?'Old':'New');document.getElementById('finalScore').textContent=score;document.getElementById('statSick').textContent=stats.sick;document.getElementById('statGood').textContent=stats.good;document.getElementById('statBad').textContent=stats.bad;document.getElementById('statShit').textContent=stats.shit;document.getElementById('statMiss').textContent=stats.miss;showOnly('endScreen');return;}loopId=requestAnimationFrame(gameLoop);}
function stopGameLoop(){try{cancelAnimationFrame(loopId)}catch{}loopId=null;}

/* ========= ç¶å…¨åŸŸ ========= */
window.startGame = startGame;
window.pauseGame  = pauseGame;
window.resumeGame = resumeGame;
window.showOptions= showOptions;
window.showMusic  = showMusic;
window.goToMenu   = goToMenu;
window.confirmSong= confirmSong;

/* ========= äº‹ä»¶ & åˆå§‹åŒ– ========= */
window.addEventListener('keydown',e=>{
  if(e.repeat)return;
  const lane=laneFromKey(e.key.toLowerCase());
  if(lane!==null){if(running&&!paused)onLanePress(lane);e.preventDefault();return;}
  if(e.key==='Escape'){
    if(phase==='countdown'){cancelCountdown();goToMenu();}
    else if(running&&!paused){pauseGame();}
    else if(paused){resumeGame();}
  }
});
canvas.addEventListener('pointerdown',e=>{
  if(!running||paused)return;
  const rect=canvas.getBoundingClientRect();
  const lane=laneFromPointer(e.clientX-rect.left);
  onLanePress(lane);
},{passive:true});

function init(){
  try{
    applyDesktopScale(); setupDPR(); recomputeLayout();
    initVolumeUI(); initOffsetUI(); fillSongList();
    setDebug('-', '-');
  }catch(err){
    console.error(err); banner('âš ï¸ åˆå§‹åŒ–å‡ºéŒ¯ï¼Œè«‹é‡æ•´ï¼ˆè©³è¦‹ Consoleï¼‰');
  }
  setTimeout(()=>{
    if(typeof window.startGame!=='function'){
      banner('âš ï¸ Start ç¶å®šå¤±æ•—ï¼Œå·²è‡ªå‹•ä¿®å¾©ï¼Œè«‹å†æŒ‰ä¸€æ¬¡');
      window.startGame = startGame;
    }
  }, 50);
}
window.addEventListener('resize',()=>{setupDPR();applyDesktopScale();recomputeLayout();render();renderUI();});
window.addEventListener('error',()=>banner('âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Console è¨Šæ¯'));
init();
</script>
</body>
</html>
