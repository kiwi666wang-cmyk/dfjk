<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DFJK é«˜ç²¾åº¦ Cyberpunk ç‰ˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  html,body{margin:0;touch-action:manipulation;overscroll-behavior:none}
  body{
    color:#fff;font-family:sans-serif;text-align:center;transition:background .5s ease;
    background: radial-gradient(1300px 900px at 50% 0%, #111a30 0%, #0b1426 55%, #07101d 100%);
    overflow-x:hidden;
  }
  body::before,body::after{content:"";position:fixed;inset:0;pointer-events:none;z-index:0}
  body::before{
    background:
      repeating-linear-gradient(to bottom, rgba(255,255,255,.07) 0 1px, rgba(0,0,0,0) 3px),
      linear-gradient(120deg, rgba(0,255,255,.18), rgba(255,0,160,.15) 60%, rgba(255,255,0,.10));
    mix-blend-mode:screen;animation:scanY 5.6s linear infinite;opacity:.28;
  }
  body::after{
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="2" stitchTiles="stitch"/></filter><rect width="140" height="140" filter="url(%23n)" opacity="0.09"/></svg>');
    background-size:240px 240px;animation:noiseShift 7.5s steps(28) infinite;opacity:.22;mix-blend-mode:overlay;
  }
  @keyframes scanY{from{background-position:0 0,0 0}to{background-position:0 360px,0 0}}
  @keyframes noiseShift{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(0,-70px,0)}}

  #stage{position:relative;width:95%;max-width:420px;margin:20px auto;--u:1;z-index:1}
  canvas{display:block;background:#0f1727;width:100%;height:auto}
  #gameCanvas{touch-action:none}
  canvas.ui{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;background:transparent;border:none;z-index:5}

  #edgeFade{position:absolute;inset:0;pointer-events:none;opacity:1;border-radius:10px;z-index:6;
    background:
      linear-gradient(to right, rgba(255,255,255,.16), rgba(255,255,255,0) 40%) left/16px 100% no-repeat,
      linear-gradient(to left,  rgba(255,255,255,.16), rgba(255,255,255,0) 40%) right/16px 100% no-repeat,
      linear-gradient(to bottom,rgba(255,255,255,.16), rgba(255,255,255,0) 40%) top/100% 16px no-repeat,
      linear-gradient(to top,   rgba(255,255,255,.16), rgba(255,255,255,0) 40%) bottom/100% 16px no-repeat;
  }

  .hitbar{position:absolute;left:0;width:100%;display:flex;justify-content:space-between;align-items:center;height:calc(90px * var(--u));z-index:2;opacity:0;pointer-events:none}

  .hud{font-size:18px;margin-top:10px;line-height:1.6}
  .songline{font-size:14px;opacity:.9}
  button{margin:10px;padding:10px 20px;font-size:18px;background:#78d5ff;border:none;border-radius:8px;cursor:pointer}
  #menuScreen,#musicScreen,#endScreen,#optionsScreen,#pauseScreen{padding-top:120px}
  .blur{filter:blur(6px);pointer-events:none;user-select:none}
  #pauseButton{position:absolute;top:10px;right:10px;z-index:3}

  #countdownText{
    position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);
    font-family:'Fredoka One',sans-serif;font-size:72px;color:#fff;text-shadow:2px 2px 8px #000;z-index:9;pointer-events:none;display:none}
  @keyframes popScale{0%{transform:translate(-50%,-50%) scale(.85)}50%{transform:translate(-50%,-50%) scale(1.12)}100%{transform:translate(-50%,-50%) scale(1)}}

  #warnBanner{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:rgba(255,80,80,.95);padding:10px 14px;border-radius:8px;font-size:14px;display:none;z-index:20}
  #debug{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.55);padding:6px 10px;border-radius:6px;font:12px/1.4 monospace;z-index:25}

  /* æ ¡æ­£è¦†è“‹å±¤ */
  #calibOverlay{position:fixed;inset:0;display:none;z-index:50;background:rgba(3,7,15,.86);backdrop-filter:blur(2px)}
  #calibWrap{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(520px,92vw);padding:18px 16px;border-radius:12px;background:rgba(10,16,30,.9);box-shadow:0 10px 40px rgba(0,0,0,.4);border:1px solid rgba(120,213,255,.3)}
  #calibTitle{font-size:22px;margin:6px 0 4px}
  #calibInfo{opacity:.85;font-size:14px;margin-bottom:8px}
  #calibBeatDot{width:26px;height:26px;border-radius:50%;margin:12px auto;background:#78d5ff;box-shadow:0 0 28px rgba(120,213,255,.95)}
  #calibBig{font:700 44px/1.2 'Fredoka One',sans-serif;margin:8px 0 2px}
  #calibStat{font:14px/1.4 monospace;opacity:.95;margin:2px 0 10px}
  .calibBtns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .calibBtn{flex:1 1 140px;padding:14px 12px;font-size:18px;border-radius:10px;border:none;cursor:pointer}
  .calibBtn.primary{background:#78d5ff}.calibBtn.warn{background:#ffc857}.calibBtn.cancel{background:#ff6b6b}
</style>
</head>
<body>
  <!-- ä¸»é¸å–® -->
  <div id="menuScreen">
    <h1>ğŸµ DFJK é«˜ç²¾åº¦ Cyberpunk ç‰ˆ</h1>
    <div class="row">
      <button onclick="window.startGame()">é–‹å§‹éŠæˆ²</button>
      <button onclick="window.showMusic()">éŸ³æ¨‚</button>
      <button onclick="window.showOptions()">é¸é …</button>
    </div>
    <div class="row">å·²é¸æ›²ç›®ï¼š<span id="menuChosenSong">å°šæœªé¸æ“‡</span></div>
  </div>

  <!-- éŸ³æ¨‚é¸å–® -->
  <div id="musicScreen" style="display:none;">
    <h2>ğŸ¼ é¸æ“‡æœ¬å±€æ›²ç›®</h2>
    <div class="row">
      <select id="songSelect" size="12"></select>
      <div class="hint">å¿…é ˆé¸æ“‡æ›²ç›®æ‰å¯é–‹å§‹ã€‚</div>
    </div>
    <div class="row">
      <button onclick="window.confirmSong()">ç¢ºå®š</button>
      <button onclick="window.goToMenu()">å›ä¸»é¸å–®</button>
    </div>
    <div class="row">å·²é¸ï¼š<span id="chosenSongLabel">å°šæœªé¸æ“‡</span></div>
  </div>

  <!-- é¸é … -->
  <div id="optionsScreen" style="display:none;">
    <h2>âš™ï¸ éŠæˆ²é¸é …</h2>
    <div class="row">
      <label for="difficultySelect">é›£åº¦ï¼š</label>
      <select id="difficultySelect">
        <option value="ex">EXï¼ˆæ¥µé™ï¼‰</option>
        <option value="hell">åœ°ç„</option>
        <option value="hard">å›°é›£</option>
        <option value="normal" selected>æ™®é€š</option>
        <option value="easy">ç°¡å–®</option>
        <option value="beginner">åˆå­¸è€…</option>
      </select>
    </div>
    <div class="row">
      <label for="speedMultiplier">é€Ÿåº¦å€ç‡ï¼š</label>
      <select id="speedMultiplier">
        <option value="1">1.0xï¼ˆæ¨™æº–ï¼‰</option>
        <option value="1.1">1.1x</option>
        <option value="1.2">1.2x</option>
        <option value="1.3">1.3x</option>
        <option value="1.6">1.6x</option>
        <option value="2.0">2.0x</option>
      </select>
    </div>
    <div class="row">
      <label for="noteDirection">éŸ³ç¬¦æ–¹å‘ï¼š</label>
      <select id="noteDirection">
        <option value="down" selected>ä¸‹è½æ‰“æ“Šï¼ˆæ‰“æ“Šç·šåœ¨åº•ï¼‰</option>
        <option value="up">ä¸Šå‡æ‰“æ“Šï¼ˆæ‰“æ“Šç·šåœ¨é ‚ï¼‰</option>
      </select>
    </div>
    <div class="row">
      <label for="judgeMode">åˆ¤å®šæ¨¡å¼ï¼š</label>
      <select id="judgeMode">
        <option value="old" selected>Old Inputï¼ˆå« Ghost æ‡²ç½°ï¼‰</option>
        <option value="new">New Inputï¼ˆç§»é™¤ WRONGï¼‰</option>
      </select>
    </div>

    <!-- ä¸»éŸ³é‡ï¼æ•²æ“ŠéŸ³é‡ -->
    <div class="row">
      <label for="volumeSlider">ä¸»éŸ³é‡ï¼ˆBGMï¼‰ï¼š</label>
      <input id="volumeSlider" type="range" min="0" max="100" value="80" />
      <span id="volumeLabel">80%</span>
    </div>
    <div class="row">
      <label for="sfxSlider">æ•²æ“Šè²éŸ³é‡ï¼š</label>
      <input id="sfxSlider" type="range" min="0" max="100" value="70" />
      <span id="sfxLabel">70%</span>
    </div>

    <div class="row"><hr style="opacity:.2"></div>
    <h3>ğŸ¯ å‘½ä¸­å»¶é²æ ¡æ­£</h3>
    <div class="row">
      <label for="offsetSlider">å…¨åŸŸåç§» (ms)ï¼š</label>
      <input id="offsetSlider" type="range" min="-600" max="600" value="0" />
      <span id="offsetLabel">0 ms</span>
      <button id="offsetCalibBtn" type="button">å¿«é€Ÿæ ¡æ­£</button>
    </div>
    <div class="row"><button onclick="window.goToMenu()">å›ä¸»é¸å–®</button></div>
  </div>

  <!-- éŠæˆ²ç•«é¢ -->
  <div id="gameScreen" style="display:none; position:relative;">
    <button id="pauseButton" onclick="window.pauseGame()">â¸ï¸</button>
    <div id="stage">
      <canvas id="gameCanvas" width="420" height="640"></canvas>
      <canvas id="uiCanvas" class="ui" width="420" height="640"></canvas>
      <div id="edgeFade" aria-hidden="true"></div>
      <div class="hitbar"><div class="hitkey"></div><div class="hitkey"></div><div class="hitkey"></div><div class="hitkey"></div></div>
      <div id="countdownText">Ready</div>
    </div>
    <div class="hud">
      åˆ†æ•¸ï¼š<span id="score">0</span>ã€€é€£æ“Šï¼š<span id="combo">0</span>ã€€åˆ¤å®šï¼š<span id="judgement">-</span>ã€€MISSï¼š<span id="missCount">0</span>
      <div class="songline">
        æ›²ç›®ï¼š<span id="songTitle">-</span> ï½œ é›£åº¦ï¼š<span id="diffLabel">-</span> ï½œ æ–¹å‘ï¼š<span id="dirLabel">-</span> ï½œ åˆ¤å®šï¼š<span id="judgeLabel">-</span> ï½œ åç§»ï¼š<span id="offsetActive">0 ms</span>
      </div>
    </div>
  </div>

  <!-- æš«åœ -->
  <div id="pauseScreen" style="display:none;">
    <h2>â¸ï¸ éŠæˆ²æš«åœ</h2>
    <button onclick="window.resumeGame()">â–¶ï¸ ç¹¼çºŒ</button>
    <button onclick="window.goToMenu()">å›ä¸»é¸å–®</button>
  </div>

  <!-- çµç®— -->
  <div id="endScreen" style="display:none;">
    <h2>ğŸ® éŠæˆ²çµæŸï¼</h2>
    <p>æ›²ç›®ï¼š<span id="finalSong">-</span></p>
    <p>é›£åº¦ï¼š<span id="finalDiff">-</span></p>
    <p>æ–¹å‘ï¼š<span id="finalDir">-</span></p>
    <p>åˆ¤å®šï¼š<span id="finalJudge">-</span></p>
    <p>åˆ†æ•¸ï¼š<span id="finalScore">0</span></p>
    <p>SICKï¼š<span id="statSick">0</span></p>
    <p>GOODï¼š<span id="statGood">0</span></p>
    <p>BADï¼š<span id="statBad">0</span></p>
    <p>SHITï¼š<span id="statShit">0</span></p>
    <p>MISSï¼š<span id="statMiss">0</span></p>
    <button onclick="window.startGame()">å†ç©ä¸€æ¬¡</button>
    <button onclick="window.goToMenu()">å›ä¸»é¸å–®</button>
  </div>

  <!-- æ ¡æ­£è¦†è“‹å±¤ -->
  <div id="calibOverlay">
    <div id="calibWrap">
      <div id="calibTitle">ğŸ¯ å¿«é€Ÿæ ¡æ­£</div>
      <div id="calibInfo">è·Ÿè‘—ç¯€æ‹ï¼ˆæ¯æ‹ 1000msï¼‰æŒ‰ DFJK æˆ–é»æ“Šç•«é¢ï¼Œè‡³å°‘ 10 æ¬¡å¾Œå¯å®Œæˆã€‚æ¡ä¸­ä½æ•¸ + MAD å»æ¥µå€¼ã€‚</div>
      <div id="calibBeatDot"></div>
      <div id="calibBig">å¾…æ©Ÿ</div>
      <div id="calibStat">0/10ã€€å»ºè­°åç§»ï¼šâ€”</div>
      <div class="calibBtns">
        <button id="calibStart" class="calibBtn primary">é–‹å§‹</button>
        <button id="calibFinish" class="calibBtn warn" disabled>å®Œæˆ</button>
        <button id="calibCancel" class="calibBtn cancel">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <audio id="hitSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_6e3e3b6f3f.mp3?filename=click-124467.mp3" preload="auto"></audio>
  <audio id="bgm" preload="auto"></audio>

  <div id="warnBanner">âš ï¸ æç¤º</div>
  <div id="debug">mode: - | err: -</div>

<script>
/* ====== åƒè€ƒï¼šä¸»è¦çµæ§‹èˆ‡ä¸Šä¸€ç‰ˆä¸€è‡´ï¼Œåƒ…é‡é»æ”¹ã€Œé›»æµå››é¢å…«æ–¹ã€èˆ‡ã€Œå¡«è‰²å›å¾©ã€ ====== */

/* å°ºå¯¸ / DPR */
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
const uiCanvas=document.getElementById('uiCanvas');
const uictx=uiCanvas.getContext('2d',{alpha:true});
let W=420,H=640;
function setupDPR(){
  const dpr=Math.min(window.devicePixelRatio||1,2);
  canvas.width=Math.round(W*dpr); canvas.height=Math.round(H*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
  uiCanvas.width=Math.round(W*dpr); uiCanvas.height=Math.round(H*dpr); uictx.setTransform(dpr,0,0,dpr,0,0);
}
setupDPR();

const IS_MOBILE=window.matchMedia('(pointer: coarse)').matches;
const SUPPORTS_VIB=IS_MOBILE&&'vibrate' in navigator;

/* ç‹€æ…‹ */
const laneColors=['#b266ff','#66ccff','#66ff66','#ff6666']; // å·¦ä¸‹ä¸Šå³
const laneDirs=['left','down','up','right'];
const HITKEY_BASE=90, NOTE_BASE=46;
let uiScale=1;

let phase='menu',running=false,paused=false,loopId=null,prevT=0;
let selectedSongFile=null;
let score=0,combo=0,lastJudgementText='-'; let missCount=0,gameOver=false;
let stats={sick:0,good:0,bad:0,shit:0,miss:0};
let chart=[],__remainNotes=0;
let receptorPulse=[0,0,0,0];

let currentSongTitle='-',currentDifficulty='normal',currentDirection='down',currentJudgeMode='old';
const dtHistory=[];const DT_HIST_MAX=240;

const hitFx=[];
function addHitFx(lane){hitFx.push({lane,t0:performance.now()/1000,life:0.25});}

/* é€£æ“Šæç¤º */
let comboFlashText='', comboFlashT0=0;
function triggerComboFlash(){comboFlashText=`COMBO x${combo}!!`; comboFlashT0=performance.now()/1000;}

/* ç‰ˆé¢ */
let cachedRectH=canvas.getBoundingClientRect().height;
let cachedScaleY=cachedRectH/H;
let cachedJudgeCss=(HITKEY_BASE*uiScale/2);
let cachedJudgeInternal=cachedJudgeCss/cachedScaleY;
function recomputeLayout(){
  const rect=canvas.getBoundingClientRect();
  cachedRectH=rect.height; cachedScaleY=cachedRectH/H;
  cachedJudgeCss=(currentDirection==='up')?(HITKEY_BASE*uiScale/2):(cachedRectH-HITKEY_BASE*uiScale/2);
  cachedJudgeInternal=cachedJudgeCss/cachedScaleY;
}
function applyDesktopScale(){
  const coarse=window.matchMedia('(pointer: coarse)').matches;
  const wide=window.matchMedia('(min-width:1024px)').matches;
  const wider=window.matchMedia('(min-width:1440px)').matches;
  let u=1; if(!coarse&&(wide||wider))u=wider?1.8:1.5;
  uiScale=u; document.getElementById('stage').style.setProperty('--u',String(u));
  document.getElementById('stage').style.maxWidth=`${Math.round(420*u)}px`;
  recomputeLayout();
}
function getJudgeLineYInternal(){return cachedJudgeInternal;}
function laneCenterX(index){
  const laneWidth=W/4;
  let x=index*laneWidth + laneWidth/2;
  if(index===1) x+=10; // è®“ä¸­é–“å…©å€‹é è¿‘ä¸€äº›
  if(index===2) x-=10;
  return x;
}

/* å·¥å…· */
function laneFromKey(k){switch(k){case'd':case'arrowleft':return 0;case'f':case'arrowdown':return 1;case'j':case'arrowup':return 2;case'k':case'arrowright':return 3;default:return null}}
function laneFromPointer(xCss){const rect=canvas.getBoundingClientRect();const x=xCss/rect.width*W;let best=0,bestd=1e9;for(let i=0;i<4;i++){const d=Math.abs(x-laneCenterX(i));if(d<bestd){bestd=d;best=i}}return best;}
function recordDt(d){dtHistory.push(d);if(dtHistory.length>DT_HIST_MAX)dtHistory.shift();}
function getDtStats(){if(!dtHistory.length)return{avg:0,std:0};const n=dtHistory.length;const avg=dtHistory.reduce((a,c)=>a+c,0)/n;const va=dtHistory.reduce((a,c)=>a+(c-avg)*(c-avg),0)/n;return{avg,std:Math.sqrt(va)};}
function banner(msg){const b=document.getElementById('warnBanner'); b.textContent=msg; b.style.display='block'; setTimeout(()=>b.style.display='none',3000);}

/* è¦–è¦ºï¼šå·¥å…· */
const EFFECT_INTENSITY=1.0;
function lighten(c,a){const p=parseInt(c.slice(1),16);let r=(p>>16)&255,g=(p>>8)&255,b=p&255;r=Math.min(255,Math.round(r+(255-r)*a));g=Math.min(255,Math.round(g+(255-g)*a));b=Math.min(255,Math.round(b+(255-b)*a));return`rgb(${r},${g},${b})`}

/* æ”¾å°„å…‰æšˆï¼ˆä¿ç•™ï¼‰ */
function glitchAura(x,y,r,t,intensity=1){
  if(intensity<=0) return;
  ctx.save();
  ctx.globalCompositeOperation='lighter';
  const n=Math.floor(16*intensity);
  for(let i=0;i<n;i++){
    const ang=(i/n)*Math.PI*2 + Math.sin(t*3+i)*0.35;
    const rr=r*(0.6+0.55*Math.sin(t*5+i))*intensity;
    const px=x+Math.cos(ang)*rr, py=y+Math.sin(ang)*rr;
    ctx.globalAlpha=0.10+0.18*Math.random();
    ctx.fillStyle=(i%2)?'rgba(0,255,255,.95)':'rgba(255,0,160,.95)';
    ctx.fillRect(px-1.6,py-1.6,3.2,3.2);
  }
  ctx.globalAlpha=0.20*intensity;
  ctx.strokeStyle='rgba(255,255,255,.7)';
  ctx.beginPath(); ctx.arc(x,y,r*0.98,0,Math.PI*2); ctx.stroke();
  ctx.restore();
}

/* âœ… å››é¢å…«æ–¹é›·æ“Šï¼ˆé‡å¯«ï¼‰ */
function radialElectric(x,y,r,t,intensity=1){
  ctx.save();
  ctx.globalCompositeOperation='lighter';
  const bolts = Math.floor(14*intensity);
  for(let i=0;i<bolts;i++){
    const ang = Math.random()*Math.PI*2;
    const len = r*(0.35+0.75*Math.random());
    const sx = x + Math.cos(ang)*(r*0.15);
    const sy = y + Math.sin(ang)*(r*0.15);
    const ex = sx + Math.cos(ang)*len;
    const ey = sy + Math.sin(ang)*len;

    // å¤šæ®µæŠ–å‹•ï¼ˆåƒçœŸé–ƒé›»ï¼‰
    const k=5; ctx.beginPath();
    for(let j=0;j<=k;j++){
      const p=j/k;
      // æ²¿è·¯å¾‘æ³•ç·šæ–¹å‘æŠ–å‹•
      const nx = sx+(ex-sx)*p + (Math.sin(t*40 + i*2 + j*1.3)*3.0) + (Math.random()*2-1)*1.2;
      const ny = sy+(ey-sy)*p + (Math.cos(t*36 + i*2 + j*1.1)*3.0) + (Math.random()*2-1)*1.2;
      j?ctx.lineTo(nx,ny):ctx.moveTo(nx,ny);
    }
    ctx.lineWidth=1.6;
    ctx.strokeStyle=(i%3===0)?'#ffffff':((i%2)?'rgba(0,255,255,.9)':'rgba(255,0,160,.9)');
    ctx.stroke();

    // åˆ†å²”
    if(Math.random()<0.45){
      const ba = ang + (Math.random()*0.8-0.4);
      const bl = len*(0.35+0.35*Math.random());
      ctx.beginPath();
      const mx = sx + (ex-sx)* (0.45+0.35*Math.random());
      const my = sy + (ey-sy)* (0.45+0.35*Math.random());
      const bx = mx + Math.cos(ba)*bl, by = my + Math.sin(ba)*bl;
      ctx.moveTo(mx,my); ctx.lineTo(bx,by);
      ctx.lineWidth=1.2; ctx.strokeStyle=(i%2)?'rgba(0,255,255,.8)':'rgba(255,0,160,.8)'; ctx.stroke();
    }
  }
  // ç«èŠ±
  const sparks=Math.floor(22*intensity);
  for(let s=0;s<sparks;s++){
    const a=Math.random()*Math.PI*2;
    const rr=r*(0.2+0.7*Math.random());
    const sx=x+Math.cos(a)*rr, sy=y+Math.sin(a)*rr;
    const ex=sx+(Math.random()*2-1)*4, ey=sy+(Math.random()*2-1)*4;
    ctx.globalAlpha=0.7;
    ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(ex,ey);
    ctx.lineWidth=1; ctx.strokeStyle=(s%4===0)?'#fff':'rgba(0,255,255,.85)'; ctx.stroke();
  }
  ctx.restore();
}

/* ç®­é ­ä¸»é«”ï¼ˆå«å¡«è‰²é‚è¼¯ï¼‰ */
const TAIL_FACTOR=0.30; // å°¾ç¿¼çŸ­ä¸€é»
function dirToAngle(dir){switch(dir){case'up':return -Math.PI/2;case'down':return Math.PI/2;case'left':return Math.PI;case'right':return 0;}return 0}

function drawArrowPath(tail,tip,Hh,cut){
  ctx.beginPath();
  ctx.moveTo(tail, -Hh*0.55);
  ctx.lineTo(0,   -Hh*0.55);
  ctx.lineTo(tip,  0);
  ctx.lineTo(0,    Hh*0.55);
  ctx.lineTo(tail,  Hh*0.55);
  ctx.lineTo(tail+cut,0);
  ctx.closePath();
}

function drawBlueStreakArrow({x,y,size,dir,baseColor,isReceptor,pulse=0,t=0}){
  const p = Math.max(0, Math.min(1, pulse||0));
  const ang=dirToAngle(dir);
  const L=size*2.05, Hh=size*0.95, inner=0.62, cut=Hh*0.32;
  const tip=L*0.52, tail=-L*TAIL_FACTOR;

  ctx.save(); ctx.translate(x,y); ctx.rotate(ang);

  if(isReceptor){
    // åº•ï¼šé»‘ + ç™½é‚Š
    ctx.fillStyle='#050607';
    drawArrowPath(tail,tip,Hh,cut); ctx.fill();
    ctx.lineWidth=2.1; ctx.strokeStyle='rgba(255,255,255,.95)'; ctx.stroke();

    // âœ… æŒ‰ä¸‹æ™‚æ•´å¡Šå¡«è‰²ï¼ˆé¡è‰²å¼·åº¦ç”± pulse æ±ºå®šï¼‰
    if(p>0){
      const grad=ctx.createLinearGradient(tail,-Hh, tip,Hh);
      grad.addColorStop(0, lighten(baseColor, .15));
      grad.addColorStop(1, baseColor);
      ctx.globalAlpha = 0.25 + 0.75*p;
      ctx.fillStyle = grad;
      drawArrowPath(tail,tip,Hh,cut); ctx.fill();
      ctx.globalAlpha = 1;
    }

  }else{
    // âœ… éŸ³ç¬¦ï¼šæ°¸é å¯¦å¿ƒæ¼¸å±¤å¡«æ»¿ + å…§ç™½ç·šï¼ˆæ›´æœ‰æœªä¾†æ„Ÿï¼‰
    const grad=ctx.createLinearGradient(tail,-Hh, tip,Hh);
    grad.addColorStop(0, '#ffffff');
    grad.addColorStop(0.25, lighten(baseColor, .25));
    grad.addColorStop(1, baseColor);
    ctx.fillStyle=grad;
    drawArrowPath(tail,tip,Hh,cut); ctx.fill();

    // å…§éƒ¨ç™½è‰²ç´° chevron
    ctx.beginPath();
    ctx.moveTo(tail, -Hh*0.52);
    ctx.lineTo(0,   -Hh*0.52);
    ctx.lineTo(tip,  0);
    ctx.lineTo(0,    Hh*0.52);
    ctx.lineTo(tail,  Hh*0.52);
    ctx.lineTo(tail+cut*(inner),0);
    ctx.closePath();
    ctx.lineWidth=3.0; ctx.strokeStyle='#ffffff'; ctx.stroke();
  }

  // æ©«å‘æƒæè£‚ç´‹ï¼ˆç¸®åˆ° ~0.81 é¢ç©ï¼‰
  const gAmp=(isReceptor? size*0.05 : size*0.10)*((isReceptor)? (0.3+0.7*p):1);
  const slices=4*((isReceptor)? (0.4+0.6*p):1);
  for(let s=0;s<slices;s++){
    const yy=((s/Math.max(1,(slices-1)))-0.5)*Hh*0.9;
    const jitter=(Math.sin(t*30+s*2.3)*gAmp*0.6);
    ctx.save(); ctx.beginPath(); ctx.rect(tail,yy-2,L*1.05,4); ctx.clip(); ctx.translate(jitter,0);
    ctx.globalAlpha=(isReceptor?(0.10+0.15*p):0.25);
    ctx.beginPath(); ctx.moveTo(tail,yy); ctx.lineTo(tip,yy); ctx.lineWidth=1.2; ctx.strokeStyle='rgba(255,255,255,1)'; ctx.stroke();
    ctx.restore();
  }

  ctx.restore();

  // å¤–åœå…‰æšˆ + âœ… å››é¢å…«æ–¹é›·æ“Šï¼ˆæŒ‰ä¸‹æ™‚æ›´å¼·ï¼‰
  const R = isReceptor ? size*1.02 : size*0.88;
  const now = performance.now()/1000;
  const boost = isReceptor ? (0.45 + 0.9*p) : 0.9;
  glitchAura(x,y,R,now,EFFECT_INTENSITY*boost);
  radialElectric(x,y,R,now,EFFECT_INTENSITY*boost);
}

/* èƒŒæ™¯ */
function drawPlayfieldBackground(t){
  ctx.save();
  ctx.fillStyle='#0f1727'; ctx.fillRect(0,0,W,H);
  ctx.globalAlpha=0.24; ctx.strokeStyle='rgba(120,213,255,0.35)'; ctx.lineWidth=1;
  const step=22,ox=(t*26)%step,oy=(t*18)%step;
  for(let x=-ox;x<=W;x+=step){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=-oy;y<=H;y+=step){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  ctx.globalAlpha=0.26;
  const g=ctx.createLinearGradient(0,0,W,0);
  g.addColorStop(0,'rgba(0,255,255,0.32)');g.addColorStop(0.5,'rgba(255,0,160,0.26)');g.addColorStop(1,'rgba(255,255,0,0.20)');
  ctx.fillStyle=g;
  const diagH=20,drift=(t*64)%80;
  ctx.save();ctx.translate(-drift,0);ctx.rotate(-Math.PI/12);
  for(let y=-H;y<H*2;y+=diagH*4){ctx.fillRect(-W,y,W*3,diagH);}
  ctx.restore();
  ctx.restore();
}

/* éŸ³è¨Šï¼ˆBGMï¼‰â€”â€” çœç•¥ä¸è®Šçš„å¤šæ•¸é‚è¼¯ï¼Œä»ä¿ç•™ WebAudio/HTML5 é›™è·¯å¾‘èˆ‡é‡‘å±¬æ•²æ“Šè²æ±  */
let INPUT_OFFSET_MS=+(localStorage.getItem('dfjk.offsetMs')||0);
const bgmEl=document.getElementById('bgm');
let audioCtx=null,gainNode=null,buffer=null,srcNode=null,mode='silent';
let startAtCtx=0,startAtSong=0,softBaseSong=0,softStartPerf=0;
let durationSec=120,songEnded=false;
let waReady=false, htmlReady=false, canStartMusic=false;

let MASTER_VOL=0.8, SFX_VOL=0.7, sfxGain=null;
async function ensureAudio(){ if(!audioCtx){audioCtx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});} if(!gainNode){gainNode=audioCtx.createGain();gainNode.connect(audioCtx.destination);} if(!sfxGain){sfxGain=audioCtx.createGain();sfxGain.gain.value=SFX_VOL;sfxGain.connect(gainNode);} }
function applyAllVolumes(){ if(gainNode)gainNode.gain.value=MASTER_VOL; if(bgmEl)bgmEl.volume=MASTER_VOL; if(sfxGain)sfxGain.gain.value=SFX_VOL; if(!tapPool)tapPool=new TapSoundPool(hitSound.src,12); const poolVol=Math.min(1,MASTER_VOL*SFX_VOL*SFX_GAIN); tapPool.setVolume(poolVol); hitSound.volume=poolVol; }
async function loadViaWebAudio(url){ try{await ensureAudio(); const res=await fetch(url,{mode:'cors'}); if(!res.ok) throw new Error(`fetch ${res.status}`); const arr=await res.arrayBuffer(); buffer=await audioCtx.decodeAudioData(arr); durationSec=buffer.duration||120; waReady=true; if(canStartMusic){ if(mode==='html5'){try{bgmEl.pause();}catch{} startWebAudio(getClockSec()); } else if(mode==='silent'){ startWebAudio(getClockSec()); } } }catch(e){} }
function startWebAudio(offsetSec){ if(!buffer)return; try{ if(srcNode){srcNode.onended=null; srcNode.stop(0);} }catch{} srcNode=audioCtx.createBufferSource(); srcNode.buffer=buffer; srcNode.connect(gainNode); const when=Math.max(0,audioCtx.currentTime+0.03); startAtCtx=when; startAtSong=Math.max(0,Math.min(durationSec-0.001,offsetSec||0)); softBaseSong=startAtSong; softStartPerf=performance.now()/1000; srcNode.onended=()=>{songEnded=true}; try{ srcNode.start(when,startAtSong);}catch(e){} mode='webaudio'; }
function loadViaHTML5(url){ return new Promise((resolve,reject)=>{ bgmEl.src=url; bgmEl.preload='auto'; const ok=()=>{cleanup(); durationSec=isFinite(bgmEl.duration)?bgmEl.duration:durationSec; htmlReady=true; if(canStartMusic && mode==='silent'){ startHTML5(getClockSec()); } resolve(); }; const err=()=>{cleanup(); reject(new Error('html5 error'));}; const cleanup=()=>{ bgmEl.removeEventListener('canplay',ok); bgmEl.removeEventListener('error',err); }; bgmEl.addEventListener('canplay',ok,{once:true}); bgmEl.addEventListener('error',err,{once:true}); try{ bgmEl.load(); }catch{} }); }
function startHTML5(offsetSec){ try{ bgmEl.currentTime=Math.max(0,Math.min((durationSec||120)-0.001,offsetSec||0)); }catch{} bgmEl.play().catch(()=>{}); songEnded=false; bgmEl.onended=()=>{songEnded=true}; softBaseSong=bgmEl.currentTime||0; softStartPerf=performance.now()/1000; mode='html5'; }
function playSilent(offsetSec){ softBaseSong=Math.max(0,offsetSec||0); softStartPerf=performance.now()/1000; songEnded=false; mode='silent'; }
function stopAllAudio(){ try{ if(srcNode){srcNode.onended=null; srcNode.stop(0);} }catch{} try{ bgmEl.pause(); }catch{} srcNode=null; songEnded=false; }
function getClockSec(){ if(mode==='webaudio'&&audioCtx&&buffer&&srcNode){ return Math.max(0,Math.min(durationSec,(audioCtx.currentTime-startAtCtx)+startAtSong)); } if(mode==='html5'){ const t=(bgmEl && !isNaN(bgmEl.currentTime))?bgmEl.currentTime:(performance.now()/1000-softStartPerf)+softBaseSong; return Math.max(0,Math.min(durationSec,t)); } return Math.max(0,Math.min(durationSec,(performance.now()/1000-softStartPerf)+softBaseSong)); }
function getJudgeClockSec(){return getClockSec()+(INPUT_OFFSET_MS/1000)}

/* æ•²æ“Šè²æ± ï¼ˆåŒå‰ç‰ˆï¼‰ */
const hitSound=document.getElementById('hitSound');const SFX_GAIN=1.6;
class TapSoundPool{constructor(src,size=10){this.pool=[];this.idx=0;for(let i=0;i<size;i++){const a=new Audio(src);a.preload='auto';a.volume=1.0;this.pool.push(a)}}setVolume(v){const vol=Math.max(0,Math.min(1,v));for(const a of this.pool)a.volume=vol}play(){const a=this.pool[this.idx];this.idx=(this.idx+1)%this.pool.length;try{a.currentTime=0;a.play().catch(()=>{})}catch{}}}
let tapPool=null;
async function playMetalPing(){ try{await ensureAudio(); if(!audioCtx) throw 0; const t0=audioCtx.currentTime+0.001, dur=0.09; const mix=audioCtx.createGain(); mix.connect(sfxGain||gainNode);
  const o1=audioCtx.createOscillator(); o1.type='triangle'; o1.frequency.setValueAtTime(2600,t0); o1.frequency.exponentialRampToValueAtTime(1800,t0+dur); const g1=audioCtx.createGain(); g1.gain.setValueAtTime(0.0001,t0); g1.gain.exponentialRampToValueAtTime(0.50,t0+0.004); g1.gain.exponentialRampToValueAtTime(0.0001,t0+dur); o1.connect(g1); g1.connect(mix);
  const o2=audioCtx.createOscillator(); o2.type='square'; o2.frequency.setValueAtTime(5200,t0); o2.frequency.exponentialRampToValueAtTime(2600,t0+0.07); const g2=audioCtx.createGain(); g2.gain.setValueAtTime(0.16,t0); g2.gain.exponentialRampToValueAtTime(0.0001,t0+0.07); o2.connect(g2); g2.connect(mix);
  const nb=audioCtx.createBuffer(1,256,audioCtx.sampleRate), data=nb.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1; const n=audioCtx.createBufferSource(); n.buffer=nb;
  const bp=audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=9000; bp.Q.value=6; const hp=audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1800; hp.Q.value=0.7;
  const ng=audioCtx.createGain(); ng.gain.setValueAtTime(0.14,t0); ng.gain.exponentialRampToValueAtTime(0.0001,t0+0.05); n.connect(bp); bp.connect(hp); hp.connect(ng); ng.connect(mix);
  o1.start(t0);o1.stop(t0+dur+0.03); o2.start(t0);o2.stop(t0+0.08); n.start(t0); n.stop(t0+0.06);
}catch{ if(!tapPool) tapPool=new TapSoundPool(hitSound.src,12); tapPool.play(); } }
async function playTapSound(){ try{await ensureAudio(); if(audioCtx){ await playMetalPing(); return; } }catch{} if(!tapPool) tapPool=new TapSoundPool(hitSound.src,12); tapPool.play(); }

/* åˆ¤å®š */
const WINDOWS={sick:80,good:130,bad:150,shit:170}, SCORES={sick:350,good:200,bad:100,shit:-50,miss:-300,ghost:-150};
let baseNoteSpeed=550, noteSpeed=baseNoteSpeed;
function judge(dtMs,lane){
  const adt=Math.abs(dtMs); let rating='',base=0,incCombo=true;
  if(adt<=WINDOWS.sick){rating='SICK!';base=SCORES.sick;stats.sick++;}
  else if(adt<=WINDOWS.good){rating='GOOD';base=SCORES.good;stats.good++;}
  else if(adt<=WINDOWS.bad){rating='BAD';base=SCORES.bad;stats.bad++;}
  else if(adt<=WINDOWS.shit){rating='SHIT';base=SCORES.shit;stats.shit++;incCombo=false;}
  else {lastJudgementText='MISS';combo=0;missCount++;stats.miss++;score=Math.max(0,score+SCORES.miss);updateHUD();return;}
  const p=Math.min(1,adt/WINDOWS.shit),centrality=Math.pow(1-p,1.25);
  score=Math.max(0,Math.round(score+base*centrality));
  if(incCombo)combo++;else combo=Math.max(0,combo-1);
  if(incCombo && combo>0 && combo%10===0) triggerComboFlash();
  lastJudgementText=rating; recordDt(dtMs); receptorPulse[lane]=1; addHitFx(lane);
  if(SUPPORTS_VIB) try{navigator.vibrate(8)}catch{}
  updateHUD();
}

/* è­œ / æ›´æ–° */
const FIRST_NOTE_LEAD=1.6;
function generateChart(dur){
  chart=[]; const d=currentDifficulty;
  let doubleChance=0.35, tmin=0.24, tmax=0.52;
  if(d==='beginner'){doubleChance=0.15;tmin=0.34;tmax=0.64;}
  else if(d==='easy'){doubleChance=0.20;tmin=0.28;tmax=0.54;}
  else if(d==='hard'){doubleChance=0.55;tmin=0.18;tmax=0.40;}
  if(!(d==='ex'||d==='hell')){
    let t=FIRST_NOTE_LEAD;
    while(t<dur){
      const used=new Set();const arr=[];const cnt=Math.random()<doubleChance?2:1;
      while(arr.length<cnt){const ln=Math.floor(Math.random()*4);if(!used.has(ln)){used.add(ln);arr.push({t, lane:ln, hit:false, y:-50});}}
      chart.push(...arr);
      t+=Math.random()*(tmax-tmin)+tmin;
    }
  }else{
    const beat=0.5;let t=FIRST_NOTE_LEAD,cur=0;
    const n=()=>{cur=(cur+1)%4;return cur;},push=(tt,ln)=>chart.push({t:tt,lane:ln,hit:false,y:-50}),rnd=()=>Math.floor(Math.random()*4);
    while(t<dur){
      if(d==='ex'){
        push(t,n()); if(Math.random()<0.60)push(t,(cur+2)%4);
        if(Math.random()<0.35)push(t+beat/2,(cur+1)%4);
        if(Math.random()<0.18){push(t+beat/3,rnd());push(t+2*beat/3,rnd());}
        t+=Math.random()<0.5?beat/2:beat;
      }else{
        push(t,n()); if(Math.random()<0.85)push(t,(cur+2)%4);
        push(t+beat/2,(cur+1)%4);
        if(Math.random()<0.4){push(t+beat/4,rnd());push(t+3*beat/4,rnd());}
        t+=beat/2;
      }
    }
  }
  __remainNotes=chart.length;
}
function noteYAtTimeFor(thit,tnow){const j=getJudgeLineYInternal();return (currentDirection==='down')?(j-(thit-tnow)*noteSpeed):(j+(thit-tnow)*noteSpeed)}
function update(songT,dt){
  for(let i=0;i<chart.length;i++){const n=chart[i];n.y=noteYAtTimeFor(n.t,songT);}
  for(let i=0;i<chart.length;i++){
    const n=chart[i]; if(n.hit)continue;
    const lateMs=(songT-n.t)*1000;
    if(lateMs>WINDOWS.shit+160){
      n.hit=true; __remainNotes--;
      lastJudgementText='MISS'; combo=0; missCount++; stats.miss++; score=Math.max(0,score+SCORES.miss); updateHUD();
    }
  }
  for(let i=0;i<4;i++){receptorPulse[i]=Math.max(0,receptorPulse[i]-dt*3.2);}
  for(let i=hitFx.length-1;i>=0;i--){ if((performance.now()/1000 - hitFx[i].t0)>hitFx[i].life){ hitFx.splice(i,1);} }
}

/* ç¹ªåœ– */
function updateHUD(){
  document.getElementById('score').textContent=score;
  document.getElementById('combo').textContent=combo;
  document.getElementById('judgement').textContent=lastJudgementText;
  document.getElementById('missCount').textContent=missCount;
  document.getElementById('songTitle').textContent=currentSongTitle;
  document.getElementById('diffLabel').textContent=currentDifficulty.toUpperCase();
  document.getElementById('dirLabel').textContent=(currentDirection==='up'?'ä¸Šå‡':'ä¸‹è½');
  document.getElementById('judgeLabel').textContent=(currentJudgeMode==='old'?'Old':'New');
  document.getElementById('offsetActive').textContent=`${INPUT_OFFSET_MS} ms`;
}
function drawRing(x,y,r,alpha,color='#ffffff'){ctx.save(); ctx.globalAlpha=alpha; ctx.strokeStyle=color; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.stroke(); ctx.restore();}
function render(opts={skipNotes:false}){
  const t=performance.now()/1000, judge=getJudgeLineYInternal();
  ctx.clearRect(0,0,W,H);

  drawPlayfieldBackground(t);

  for(let i=0;i<4;i++){
    const x=laneCenterX(i);
    drawBlueStreakArrow({x,y:judge,size:NOTE_BASE,dir:laneDirs[i],baseColor:laneColors[i],isReceptor:true,pulse=receptorPulse[i],t});
  }
  for(const fx of hitFx){
    const p=Math.min(1,(performance.now()/1000 - fx.t0)/fx.life);
    const x=laneCenterX(fx.lane);
    drawRing(x,judge,18+80*p,1-p,'#ffffff');
  }
  if(!opts.skipNotes){
    const top=-140,bottom=H+140;
    for(let i=0;i<chart.length;i++){
      const n=chart[i]; if(n.hit)continue; if(n.y<top||n.y>bottom)continue;
      const x=laneCenterX(n.lane);
      drawBlueStreakArrow({x,y:n.y,size:NOTE_BASE,dir:laneDirs[n.lane],baseColor:laneColors[n.lane],isReceptor:false,pulse:0,t:t+i*0.02});
    }
  }
  if(lastJudgementText!=='-'){ctx.fillStyle='#fff';ctx.font='bold 32px sans-serif';ctx.textAlign='center';const off=(currentDirection==='up')?120:-40;ctx.fillText(lastJudgementText,W/2,judge+off);}
  if(comboFlashText){
    const life=0.9; const age=(performance.now()/1000 - comboFlashT0);
    if(age<life){
      const s=1+0.18*Math.sin(age*9);
      ctx.save(); ctx.translate(W/2, H*0.22); ctx.scale(s,s);
      ctx.fillStyle='rgba(255,255,255,.95)'; ctx.font='bold 36px sans-serif'; ctx.textAlign='center'; ctx.fillText(comboFlashText,0,0);
      ctx.restore();
    }else comboFlashText='';
  }
}
function renderPreviewAt(previewSongTimeSec){
  const t=performance.now()/1000, judge=getJudgeLineYInternal();
  ctx.clearRect(0,0,W,H);
  drawPlayfieldBackground(t);
  for(let i=0;i<4;i++){
    const x=laneCenterX(i);
    drawBlueStreakArrow({x,y:judge,size:NOTE_BASE,dir:laneDirs[i],baseColor:laneColors[i],isReceptor:true,pulse:receptorPulse[i],t});
  }
  const top=-140,bottom=H+140;
  for(let i=0;i<chart.length;i++){
    const n=chart[i]; if(n.hit)continue;
    const y=noteYAtTimeFor(n.t, previewSongTimeSec);
    if(y<top||y>bottom)continue;
    const x=laneCenterX(n.lane);
    drawBlueStreakArrow({x,y,size:NOTE_BASE,dir:laneDirs[n.lane],baseColor:laneColors[n.lane],isReceptor:false,pulse:0,t:t+i*0.02});
  }
}

/* è§’è½å¾½ç«  + ç†±åœ– */
function drawCornerBadge(){
  const x=14,y=14;
  uictx.save(); uictx.translate(x,y);
  uictx.fillStyle='rgba(0,0,0,.55)'; uictx.fillRect(0,0,92,28);
  const grad=uictx.createLinearGradient(0,0,92,0);
  grad.addColorStop(0,'#00ffff'); grad.addColorStop(0.5,'#ff00a0'); grad.addColorStop(1,'#ffff00');
  uictx.strokeStyle=grad; uictx.lineWidth=2; uictx.strokeRect(1,1,90,26);
  uictx.fillStyle='#fff'; uictx.font='12px sans-serif'; uictx.fillText('DFJK Cyber',8,18);
  uictx.restore();
}
function renderUI(){
  uictx.clearRect(0,0,W,H);
  drawCornerBadge();
  const bins=36,min=-300,max=300,step=(max-min)/bins,hist=new Array(bins).fill(0);
  for(const v of dtHistory){const i=Math.floor((v-min)/step);if(i>=0&&i<bins)hist[i]++}
  const w=230,h=74,bw=w/bins;
  const x0=14;
  const y0=(currentDirection==='up')?(H-h-24):(24+(IS_MOBILE?6:0));
  uictx.save();uictx.globalAlpha=.98;uictx.fillStyle='rgba(0,0,0,.58)';uictx.fillRect(x0-8,y0-10,w+16,h+46);
  uictx.fillStyle='#fff';uictx.font='12px sans-serif';uictx.fillText('Hit åç§»ç†±åœ– (ms)',x0,y0-12);
  const maxc=Math.max(1,...hist);
  for(let i=0;i<bins;i++){const v=hist[i],bh=(v/maxc)*h,xx=Math.floor(x0+i*bw);uictx.fillStyle='#78d5ff';uictx.fillRect(xx,y0+(h-bh),Math.ceil(bw-1),bh);}
  const {avg,std}=getDtStats();uictx.fillStyle='#fff';uictx.fillText(`avg: ${avg.toFixed(1)} ms  Ïƒ: ${std.toFixed(1)} ms  åç§»: ${INPUT_OFFSET_MS} ms`,x0,y0+h+16);
  uictx.strokeStyle='#ffd966';uictx.beginPath();const midx=x0+(-min)/step*bw;uictx.moveTo(midx,y0);uictx.lineTo(midx,y0+h);uictx.stroke();uictx.restore();
}

/* è¼¸å…¥ */
function onLanePress(lane){
  if(!running)return;
  playTapSound();
  const tNow=getJudgeClockSec();
  let bestIdx=-1, bestAbs=Infinity;
  for(let i=0;i<chart.length;i++){
    const n=chart[i]; if(n.hit||n.lane!==lane)continue;
    const dtMs=(tNow-n.t)*1000, adt=Math.abs(dtMs);
    if(adt<=WINDOWS.shit && adt<bestAbs){bestAbs=adt; bestIdx=i;}
  }
  if(bestIdx>=0){
    const n=chart[bestIdx]; n.hit=true; __remainNotes--; judge((tNow-n.t)*1000, lane);
  }else if(currentJudgeMode==='old'){
    lastJudgementText='MISS'; combo=0; score=Math.max(0,score+SCORES.ghost);
    receptorPulse[lane]=Math.max(receptorPulse[lane],0.7);
    addHitFx(lane);
    updateHUD();
  }
}

/* å€’æ•¸ */
let isCountingDown=false, countdownRAF=null;
function showCountdown(startCallback, opts={}){
  const showNotes=!!opts.showNotes;
  const previewTimeSec=(typeof opts.previewTime==='number')?opts.previewTime:0;
  cancelCountdown(); isCountingDown=true;
  const el=document.getElementById('countdownText'); el.style.display='block';
  const labels=['Ready','3','2','1','Go!']; const dur=[600,800,800,800,600];
  const t0=performance.now();
  function step(now){
    if(!isCountingDown)return;
    const elapsed=now-t0;
    let acc=0, idx=labels.length-1;
    for(let i=0;i<labels.length;i++){acc+=dur[i]; if(elapsed<acc){idx=i; break;}}
    el.textContent=(idx<labels.length?labels[idx]:'Go!');
    el.style.animation='none'; void el.offsetWidth; el.style.animation='popScale .55s ease-out';
    if(showNotes){ renderPreviewAt(previewTimeSec); } else { render({skipNotes:true}); }
    renderUI();
    if(elapsed>=dur.reduce((a,b)=>a+b,0)){
      el.style.display='none'; isCountingDown=false; startCallback(); return;
    }
    countdownRAF=requestAnimationFrame(step);
  }
  countdownRAF=requestAnimationFrame(step);
}
function cancelCountdown(){ if(!isCountingDown && !countdownRAF) return; isCountingDown=false; try{cancelAnimationFrame(countdownRAF)}catch{} countdownRAF=null; const el=document.getElementById('countdownText'); el.style.animation='none'; el.style.display='none'; }

/* UI åˆ‡æ› */
function showOnly(id){['menuScreen','musicScreen','optionsScreen','gameScreen','pauseScreen','endScreen'].forEach(x=>document.getElementById(x).style.display=(x===id?'block':'none')); if(id!=='gameScreen')document.getElementById('gameScreen').classList.remove('blur');}
function goToMenu(){cancelCountdown();stopGameLoop();stopAllAudio();phase='menu';running=false;paused=false;showOnly('menuScreen');document.getElementById('menuChosenSong').textContent=selectedSongFile?selectedSongFile.replace(/\.mp3$/i,''):'å°šæœªé¸æ“‡';}
function showOptions(){showOnly('optionsScreen')}
function showMusic(){showOnly('musicScreen')}

/* éŸ³é‡/æ ¡æ­£/æ›²åº« */
function setGlobalOffset(ms){ const v=Math.max(-600,Math.min(600,(ms|0))); INPUT_OFFSET_MS=v; localStorage.setItem('dfjk.offsetMs',String(v)); document.getElementById('offsetLabel').textContent=`${v} ms`; document.getElementById('offsetActive').textContent=`${v} ms`; }
function initVolumeUI(){
  const mS=document.getElementById('volumeSlider'), mL=document.getElementById('volumeLabel');
  const sS=document.getElementById('sfxSlider'),    sL=document.getElementById('sfxLabel');
  const savedMaster=+localStorage.getItem('dfjk.volume')||80;
  const savedSfx=+localStorage.getItem('dfjk.sfxVol')||70;
  MASTER_VOL=Math.max(0,Math.min(100,savedMaster))/100;
  SFX_VOL=Math.max(0,Math.min(100,savedSfx))/100;
  mS.value=String(Math.round(MASTER_VOL*100)); mL.textContent=`${Math.round(MASTER_VOL*100)}%`;
  sS.value=String(Math.round(SFX_VOL*100));    sL.textContent=`${Math.round(SFX_VOL*100)}%`;
  applyAllVolumes();
  mS.addEventListener('input',()=>{const v=+mS.value; MASTER_VOL=v/100; mL.textContent=`${v}%`; localStorage.setItem('dfjk.volume', String(v)); applyAllVolumes();});
  sS.addEventListener('input',()=>{const v=+sS.value; SFX_VOL=v/100; sL.textContent=`${v}%`; localStorage.setItem('dfjk.sfxVol', String(v)); applyAllVolumes();});
}
function initOffsetUI(){
  const s=document.getElementById('offsetSlider'), lab=document.getElementById('offsetLabel');
  const saved=+(localStorage.getItem('dfjk.offsetMs')||0);
  s.value=String(saved); lab.textContent=`${saved} ms`; setGlobalOffset(saved);
  s.addEventListener('input', ()=> setGlobalOffset(+s.value));
  s.addEventListener('change',()=> setGlobalOffset(+s.value));
  document.getElementById('offsetCalibBtn').addEventListener('click',openCalibrator);
  calibStartBtn.addEventListener('click',()=>{ if(!isCalibrating){ startCalib(); }});
  calibFinishBtn.addEventListener('click',finishCalib);
  calibCancelBtn.addEventListener('click',closeCalibrator);
}

/* æ›²åº«ï¼ˆå®Œæ•´æ¸…å–®ï¼‰ */
const SONGS=[ "Charlie Puth - Light Switch [Official Music Video] - Charlie Puth.mp3","Creepy Nuts â€Mirageâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Opening Theme Song - Creepy Nuts.mp3","Creepy Nuts â€Nemureâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Ending Theme Song - Creepy Nuts (1).mp3","Creepy Nutsï½¢Bling-Bang-Bang-Bornï½£ Ã— TV Animeï½¢ãƒãƒƒã‚·ãƒ¥ãƒ«-MASHLE-ï½£ Collaboration Music Video #BBBBãƒ€ãƒ³ã‚¹ - Creepy Nuts.mp3","KANA-BOON - Silhouette - KANABOONVEVO.mp3","Wiz Khalifa - See You Again ft. Charlie Puth [Official Video] Furious 7 Soundtrack - Wiz Khalifa Music (youtube).mp3","Maroon 5 - Memories (Official Video) - Maroon5VEVO (youtube).mp3","Chainsaw Man â€“ The Movie Reze Arc - Theme Song FULL IRIS OUT by Kenshi Yonezu (Lyrics) - Jamong (youtube).mp3","ãƒ’ã‚°ãƒã‚¢ã‚¤ _ ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ã€Official Videoã€‘ Ai Higuchi â€Itterasshai(See you later)â€ - ãƒ’ã‚°ãƒã‚¢ã‚¤ (youtube).mp3","Chainsaw Man â€“ The Movie Reze Arc - Ending FULL JANE DOE by Kenshi Yonezu, Hikaru Utada (Lyrics) - Jamong (youtube).mp3","PokÃ©mon partners of different generations dancing POKÃ‰DANCE Animation Music Video - PokÃ©mon Asia ENG (youtube).mp3","Lost Sky, Sara Skinner - Dreams pt. II (feat. Sara Skinner) [NCS Release].mp3","OneRepublic - Nobody (from Kaiju No. 8) [Official Music Video] - OneRepublicVEVO.mp3","YOASOBIã€ŒWatch me!ã€Official Music Video - Ayase _ YOASOBI.mp3","yung kai - blue (official music video) - yung kai.mp3","ã€AKASAKIã€‘Bunny Girl _ ãƒãƒ‹ãƒ¼ã‚¬ãƒ¼ãƒ«ï¼ˆLyric Videoï¼‰ - AKASAKI (19).mp3","ã€MVã€‘éš™_ã‚†ãƒ¼ã‚Šã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã€‘ - ã‚†ãƒ¼ã‚ŠğŸğŸ¥ã€”24ã€•ãƒ»yuri (1).mp3","ã€imaseã€‘NIGHT DANCERï¼ˆMVï¼‰ - imase.mp3","ãªã¨ã‚Š - Overdose - ãªã¨ã‚Š _ natori.mp3","å¥½ãã ã‹ã‚‰ã€‚_ ã€ãƒ¦ã‚¤ã‚«ã€ã€MVã€‘ - ã€ãƒ¦ã‚¤ã‚«ã€.mp3","å»»å»»å¥‡è­š - Eve MV - Eve.mp3","é’ã®ã™ã¿ã‹ _ ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ - Where Our Blue Is _ Tatsuya Kitani - ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ _ Tatsuya Kitani.mp3","Toge Toge Sadistic - Enormita (youtube).mp3","My dream girls - NACHERRY (youtube).mp3","PEACEKEEPER - STEREO DIVE FOUNDATION (youtube).mp3","YOASOBI - Idolã€Œã‚¢ã‚¤ãƒ‰ãƒ«ã€Lyrics Video [Kan_Rom_Eng] Oshi no Ko (æ¨ã—ã®å­) OP - mimanimi (youtube).mp3","YOASOBI â€“ 'æ€ªç‰© (Monster)' Lyrics - Kei Takahashi (youtube).mp3","YOASOBI - Racing Into The Night Lyrics (JPN_ROM_ENG) - rin rin (youtube).mp3","ã€Hanserã€‘å®¤å†…ç³»çš„TrackMaker _ ã‚¤ãƒ³ãƒˆã‚™ã‚¢ç³»ãªã‚‰ãƒˆãƒ©ãƒƒã‚¯ãƒ¡ã‚¤ã‚«ãƒ¼ ã€ä¸­æ–‡ç¿»å”± _ coverã€‘ - OtakuLAB (youtube).mp3","Aimer - Brave Shine - AimerOfficialVEVO (youtube).mp3","ROSA WALTON x HALLIE COGGINS - I REALLY WANT TO STAY AT YOUR HOUSE (LYRIC) AMV CYBERPUNK EDGERUNNERS - Eternity Music (youtube).mp3" ];
function fillSongList(){const sel=document.getElementById('songSelect'); if(sel.dataset.filled)return; sel.innerHTML=''; const ph=document.createElement('option'); ph.value=''; ph.textContent='â€” è«‹é¸æ“‡æ›²ç›® â€”'; ph.disabled=true; ph.selected=!selectedSongFile; sel.appendChild(ph); SONGS.forEach(f=>{const opt=document.createElement('option');opt.value=f;opt.textContent=f.replace(/\.mp3$/i,'');if(selectedSongFile===f)opt.selected=true;sel.appendChild(opt);}); sel.addEventListener('change',()=>{document.getElementById('chosenSongLabel').textContent=sel.value?sel.options[sel.selectedIndex].textContent:'å°šæœªé¸æ“‡';}); sel.dataset.filled='1'; }
function confirmSong(){const sel=document.getElementById('songSelect');if(!sel.value){alert('è«‹å…ˆé¸æ“‡éŸ³æ¨‚');return;}selectedSongFile=sel.value;document.getElementById('chosenSongLabel').textContent=sel.options[sel.selectedIndex].textContent;document.getElementById('menuChosenSong').textContent=sel.options[sel.selectedIndex].textContent;goToMenu();}

/* æµç¨‹ */
let pausedAt=0;
async function startGame(){
  if(!selectedSongFile){ showMusic(); alert('è«‹å…ˆé¸æ“‡éŸ³æ¨‚'); return; }
  const diff=document.getElementById('difficultySelect').value,
        sp=document.getElementById('speedMultiplier'),
        dir=document.getElementById('noteDirection').value,
        jmode=document.getElementById('judgeMode').value;
  currentDifficulty=diff; currentDirection=dir; currentJudgeMode=jmode;

  let mul=parseFloat(sp.value); if(diff==='beginner')mul=0.8; else if(diff==='easy')mul=0.9; else if(diff==='ex')mul=1.8;
  noteSpeed=baseNoteSpeed*mul;

  score=0;combo=0;lastJudgementText='-';missCount=0;gameOver=false;stats={sick:0,good:0,bad:0,shit:0,miss:0};
  chart=[];__remainNotes=0;dtHistory.length=0;receptorPulse=[0,0,0,0]; hitFx.length=0; comboFlashText=''; updateHUD();

  currentSongTitle=selectedSongFile.replace(/\.mp3$/i,'');
  const url = 'music/' + encodeURIComponent(selectedSongFile);

  try{ await ensureAudio(); await audioCtx.resume(); }catch{}
  showOnly('gameScreen');phase='countdown';setupDPR();applyDesktopScale();recomputeLayout();
  render({skipNotes:true});renderUI();

  generateChart(durationSec || 120);

  waReady=htmlReady=false; canStartMusic=false; stopAllAudio(); mode='silent';
  loadViaWebAudio(url); loadViaHTML5(url).catch(()=>{});

  showCountdown(()=>{
    canStartMusic=true;
    phase='playing';
    running=true; paused=false; prevT=0;
    playSilent(0);
    if(waReady)      startWebAudio(getClockSec());
    else if(htmlReady) startHTML5(getClockSec());
    loopId=requestAnimationFrame(gameLoop);
  }, { showNotes:false });
}
function pauseGame(){
  if(!running||paused)return;
  paused=true; phase='paused';
  document.getElementById('gameScreen').classList.add('blur');
  showOnly('pauseScreen');
  pausedAt=getClockSec();
  stopGameLoop(); stopAllAudio();
}
function resumeGame(){
  if(!paused)return;
  paused=false; phase='countdown';
  showOnly('gameScreen'); document.getElementById('gameScreen').classList.remove('blur');

  canStartMusic=false;
  showCountdown(()=>{
    canStartMusic=true;
    phase='playing';
    running=true; prevT=pausedAt;
    playSilent(pausedAt);
    if(waReady)      startWebAudio(getClockSec());
    else if(htmlReady) startHTML5(getClockSec());
    loopId=requestAnimationFrame(gameLoop);
  }, { showNotes:true, previewTime: pausedAt });
}
function gameLoop(){
  if(paused)return;
  const t=getClockSec(); const dt=Math.max(0,t-prevT); prevT=t;
  update(t,dt); render(); renderUI();
  if(songEnded||__remainNotes<=0){
    running=false; stopGameLoop(); stopAllAudio();
    document.getElementById('finalSong').textContent=currentSongTitle;
    document.getElementById('finalDiff').textContent=currentDifficulty.toUpperCase();
    document.getElementById('finalDir').textContent=(currentDirection==='up'?'ä¸Šå‡':'ä¸‹è½');
    document.getElementById('finalJudge').textContent=(currentJudgeMode==='old'?'Old':'New');
    document.getElementById('finalScore').textContent=score;
    document.getElementById('statSick').textContent=stats.sick;
    document.getElementById('statGood').textContent=stats.good;
    document.getElementById('statBad').textContent=stats.bad;
    document.getElementById('statShit').textContent=stats.shit;
    document.getElementById('statMiss').textContent=stats.miss;
    showOnly('endScreen'); phase='menu';
    return;
  }
  loopId=requestAnimationFrame(gameLoop);
}
function stopGameLoop(){try{cancelAnimationFrame(loopId)}catch{}loopId=null;}

/* æ ¡æ­£ï¼ˆåŒå‰ç‰ˆï¼Œç•¥ï¼‰ */
const calibPanel=document.getElementById('calibOverlay');
const calibStartBtn=document.getElementById('calibStart');
const calibFinishBtn=document.getElementById('calibFinish');
const calibCancelBtn=document.getElementById('calibCancel');
const calibBig=document.getElementById('calibBig');
const calibDot=document.getElementById('calibBeatDot');
const calibStat=document.getElementById('calibStat');

let isCalibrating=false;
let calibInt=1.0, calibBeats=16;
let tapSamples=[]; let calibTimers=[]; let tapHandler=null;
let t0Ctx=0, syncPerf0=0, syncCtx0=0;
function schedule(fn,ms){const id=setTimeout(fn,Math.max(0,ms));calibTimers.push(id);}
function clearCalibTimers(){calibTimers.forEach(id=>clearTimeout(id));calibTimers=[];}
function robustRecommend(arrMs){ if(arrMs.length===0)return 0; const s=[...arrMs].sort((a,b)=>a-b); const m=s[Math.floor(s.length/2)]; const dev=s.map(v=>Math.abs(v-m)).sort((a,b)=>a-b); const MAD=dev[Math.floor(dev.length/2)]||1; const keep=arrMs.filter(v=>Math.abs(v-m)<=Math.max(3*MAD,120)); const t=keep.sort((a,b)=>a-b); const lo=Math.floor(t.length*0.2),hi=Math.ceil(t.length*0.8); const core=t.slice(lo,hi); const mean=core.reduce((a,c)=>a+c,0)/Math.max(1,core.length); return Math.max(-600,Math.min(600,Math.round(mean))); }
function openCalibrator(){ if(phase==='playing'||phase==='countdown'){ banner('è«‹å…ˆé€€å‡ºéŠæˆ²å†æ ¡æ­£'); return; } calibPanel.style.display='block'; calibBig.textContent='å¾…æ©Ÿ'; calibStat.textContent='0/10ã€€å»ºè­°åç§»ï¼šâ€”'; tapSamples=[]; calibFinishBtn.disabled=true; }
function closeCalibrator(){calibPanel.style.display='none';clearCalibTimers();isCalibrating=false; if(tapHandler){window.removeEventListener('keydown',tapHandler); calibPanel.removeEventListener('pointerdown',tapHandler); tapHandler=null;}}
function startCalib(){
  clearCalibTimers(); tapSamples=[]; calibFinishBtn.disabled=true; isCalibrating=true;
  ensureAudio().then(()=>audioCtx.resume()).catch(()=>{});
  syncPerf0=performance.now()/1000; syncCtx0=audioCtx.currentTime;
  const lead=0.70; t0Ctx=audioCtx.currentTime+lead;
  for(let i=0;i<calibBeats;i++){
    const t=t0Ctx+i*calibInt;
    const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
    osc.type='sine'; osc.frequency.value=880; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.45,t+0.005); g.gain.exponentialRampToValueAtTime(0.0001,t+0.08);
    osc.connect(g); g.connect(sfxGain||gainNode); osc.start(t); osc.stop(t+0.09);
    const delayMs=(t-audioCtx.currentTime)*1000; schedule(()=>{calibDot.style.transform='scale(1.28)'; calibDot.style.boxShadow='0 0 30px rgba(120,213,255,1)'; setTimeout(()=>{calibDot.style.transform='scale(1)';calibDot.style.boxShadow='0 0 26px rgba(120,213,255,.9)';},120);},delayMs);
  }
  tapHandler=(e)=>{
    if(e.type==='keydown'){const k=e.key.toLowerCase(); if(k!=='d'&&k!=='f'&&k!=='j'&&k!=='k')return; e.preventDefault();}
    const tPerf=performance.now()/1000; const tapCtx=syncCtx0+(tPerf-syncPerf0); if(tapCtx<t0Ctx-0.15)return;
    const k=Math.round((tapCtx-t0Ctx)/calibInt); const tBeat=t0Ctx+k*calibInt; const deltaMs=(tapCtx-tBeat)*1000; if(Math.abs(deltaMs)<=450) tapSamples.push(deltaMs);
    const need=10, nowN=Math.min(tapSamples.length,need); let advise='â€”'; if(nowN>=4){const rec=robustRecommend(tapSamples); advise=(rec>0?'+':'')+rec+' ms';}
    calibBig.textContent=nowN+'/'+need; calibStat.textContent=`${nowN}/${need}ã€€å»ºè­°åç§»ï¼š${advise}`; if(nowN>=need)calibFinishBtn.disabled=false;
  };
  window.addEventListener('keydown',tapHandler); calibPanel.addEventListener('pointerdown',tapHandler);
}
function finishCalib(){ if(tapSamples.length===0){closeCalibrator();return;} const rec=robustRecommend(tapSamples); setGlobalOffset(rec); banner(`å·²å¥—ç”¨åç§»ï¼š${rec} ms`); closeCalibrator(); }

/* å…¨åŸŸç¶å®šèˆ‡äº‹ä»¶ */
window.startGame=startGame; window.pauseGame=pauseGame; window.resumeGame=resumeGame; window.showOptions=showOptions; window.showMusic=showMusic; window.goToMenu=goToMenu; window.confirmSong=confirmSong;

window.addEventListener('keydown',e=>{
  if(e.repeat)return;
  const key=e.key.toLowerCase();
  const lane=laneFromKey(key);
  if(lane!==null){ if(running&&!paused) onLanePress(lane); e.preventDefault(); return; }
  if(key==='escape'){
    if(phase==='playing'){ pauseGame(); }
    else if(phase==='paused'){ resumeGame(); }
    e.preventDefault();
  }
});
canvas.addEventListener('pointerdown',e=>{
  if(!running||paused)return; e.preventDefault();
  const rect=canvas.getBoundingClientRect();
  const lane=laneFromPointer(e.clientX-rect.left);
  onLanePress(lane);
},{passive:false});
canvas.addEventListener('touchstart',e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); },{passive:false});
canvas.addEventListener('touchmove',e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); },{passive:false});
window.addEventListener('dblclick',e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); },{passive:false});
window.addEventListener('gesturestart',e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); },{passive:false});

/* åˆå§‹åŒ– */
function init(){ applyDesktopScale(); setupDPR(); recomputeLayout(); initVolumeUI(); initOffsetUI(); fillSongList(); }
window.addEventListener('resize',()=>{setupDPR();applyDesktopScale();recomputeLayout(); if(phase==='countdown'){ render({skipNotes:true}); renderUI(); }});
init();
</script>
</body>
</html>
