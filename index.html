<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport"
  content="width=device-width,initial-scale=1.0,
  maximum-scale=1.0,user-scalable=no"/>
<title>DFJK å¤šéµ+è¡€æ¢+RGB+Offset</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet"/>
<style>
html,body{margin:0;touch-action:manipulation;}
body{background:#0b1226;color:#fff;font-family:sans-serif;
  text-align:center;transition:background .35s ease;}
body.ex-mode{background:linear-gradient(#ff3300,#990000,#000);}
#stage{position:relative;width:95%;max-width:420px;margin:20px auto;}
canvas{display:block;width:100%;height:auto;background:#0c1322;}
button{margin:10px;padding:10px 20px;font-size:18px;
  background:#78d5ff;border:none;border-radius:8px;cursor:pointer;}
select,input[type=range]{padding:6px 10px;border-radius:6px;
  border:1px solid #445;background:#12152a;color:#fff;}
label{margin-right:6px}
.row{margin:8px 0}
#menuScreen,#musicScreen,#optionsScreen,#gameScreen,
#pauseScreen,#endScreen{padding-top:120px;}
.hud{font-size:18px;margin-top:10px;line-height:1.6;}
.songline{font-size:14px;opacity:.9;}
#warnBanner{position:fixed;left:50%;bottom:20px;
  transform:translateX(-50%);background:rgba(255,80,80,.95);
  padding:10px 14px;border-radius:8px;font-size:14px;
  display:none;z-index:30;}
.topbar{position:absolute;top:10px;left:0;right:0;z-index:8;
  display:flex;align-items:center;gap:8px;padding:0 10px;}
.topbar button{padding:6px 10px;font-size:14px;border:none;
  border-radius:8px;background:#78d5ff;cursor:pointer;}
#heatButton{background:#ffd54a;color:#000;}
#hpBar{position:relative;flex:1;height:18px;margin:0 2px;
  background:rgba(255,255,255,.14);border-radius:999px;display:none;}
#hpFill{position:absolute;inset:0 auto 0 0;width:100%;
  background:#ff3b3b;border-radius:999px;}
#hpText{position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);color:#000;font-weight:800;
  font-size:12px;}
#countdownText{position:absolute;top:40%;left:50%;
  transform:translate(-50%,-50%);font-family:'Fredoka One',sans-serif;
  font-size:72px;color:#fff;text-shadow:2px 2px 8px #000;z-index:9;
  display:none;pointer-events:none;}
@keyframes pop{0%{transform:translate(-50%,-50%) scale(.85)}
50%{transform:translate(-50%,-50%) scale(1.12)}
100%{transform:translate(-50%,-50%) scale(1)}}
#songSelect{width:90%;max-width:420px;height:280px;}
#uiCanvas{position:absolute;inset:0;width:100%;height:100%;
  pointer-events:none;background:transparent;border:none;z-index:6;}
.blur{filter:blur(6px);pointer-events:none;user-select:none;}
</style>
</head>
<body>

<!-- ä¸»é¸å–® -->
<div id="menuScreen">
  <h1>ğŸµ DFJK</h1>
  <div class="row">
    <button id="btnStart" data-action="start">é–‹å§‹éŠæˆ²</button>
    <button id="btnMusic" data-action="music">éŸ³æ¨‚</button>
    <button id="btnOptions" data-action="options">é¸é …</button>
  </div>
  <div class="row">
    å·²é¸æ›²ç›®ï¼š<span id="menuChosenSong">å°šæœªé¸æ“‡</span>
  </div>
</div>

<!-- éŸ³æ¨‚é¸å–® -->
<div id="musicScreen" style="display:none;">
  <h2>ğŸ¼ é¸æ“‡æœ¬å±€æ›²ç›®</h2>
  <div class="row">
    <select id="songSelect" size="12"></select>
  </div>
  <div class="row">
    <button id="btnSongConfirm" data-action="song-ok">ç¢ºå®š</button>
    <button class="btnBackMenu" data-action="menu">å›ä¸»é¸å–®</button>
  </div>
  <div class="row">
    å·²é¸ï¼š<span id="chosenSongLabel">å°šæœªé¸æ“‡</span>
  </div>
</div>

<!-- é¸é … -->
<div id="optionsScreen" style="display:none;">
  <h2>âš™ï¸ éŠæˆ²é¸é …</h2>

  <div class="row">
    <label for="keyModeSelect">éµæ•¸ï¼š</label>
    <select id="keyModeSelect">
      <option value="4" selected>4 éµ</option>
      <option value="6">6 éµ</option>
      <option value="8">8 éµ</option>
    </select>
  </div>

  <div class="row">
    <label for="difficultySelect">é›£åº¦ï¼š</label>
    <select id="difficultySelect">
      <option value="ex">EXï¼ˆæ¥µé™ï¼‰</option>
      <option value="hell">åœ°ç„</option>
      <option value="hard">å›°é›£</option>
      <option value="normal" selected>æ™®é€š</option>
      <option value="easy">ç°¡å–®</option>
      <option value="beginner">åˆå­¸è€…</option>
    </select>
  </div>

  <div class="row">
    <label for="speedMultiplier">é€Ÿåº¦å€ç‡ï¼š</label>
    <select id="speedMultiplier">
      <option value="1">1.0x</option>
      <option value="1.1">1.1x</option>
      <option value="1.2">1.2x</option>
      <option value="1.3">1.3x</option>
      <option value="1.6">1.6x</option>
      <option value="2.0">2.0x</option>
      <option value="2.2">2.2x</option>
      <option value="2.4">2.4x</option>
      <option value="2.6">2.6x</option>
      <option value="2.8">2.8x</option>
      <option value="3.0">3.0x</option>
    </select>
  </div>

  <div class="row">
    <label for="noteDirection">éŸ³ç¬¦æ–¹å‘ï¼š</label>
    <select id="noteDirection">
      <option value="down" selected>ä¸‹è½æ‰“æ“Š</option>
      <option value="up">ä¸Šå‡æ‰“æ“Š</option>
    </select>
  </div>

  <div class="row">
    <label for="judgeMode">åˆ¤å®šæ¨¡å¼ï¼š</label>
    <select id="judgeMode">
      <option value="old" selected>Old Input</option>
      <option value="new">New Input</option>
    </select>
  </div>

  <div class="row">
    <label for="rgbToggle">RGB å¾ªç’°ï¼š</label>
    <input id="rgbToggle" type="checkbox"/>
  </div>

  <div class="row">
    <label for="hpToggle">è¡€æ¢æ¨¡å¼ï¼š</label>
    <input id="hpToggle" type="checkbox"/>
  </div>

  <div class="row">
    <label for="offsetSlider">å…¨åŸŸæ ¡æ­£(ms)ï¼š</label>
    <input id="offsetSlider" type="range" min="-200" max="200" value="0"/>
    <span id="offsetLabel">0ms</span>
  </div>

  <div class="row">
    <label for="volumeSlider">ä¸»éŸ³é‡ï¼ˆBGMï¼‰ï¼š</label>
    <input id="volumeSlider" type="range" min="0" max="100" value="80"/>
    <span id="volumeLabel">80%</span>
  </div>

  <div class="row">
    <label for="sfxSlider">æ•²æ“Šè²éŸ³é‡ï¼š</label>
    <input id="sfxSlider" type="range" min="0" max="100" value="70"/>
    <span id="sfxLabel">70%</span>
  </div>

  <div class="row">
    <button class="btnBackMenu" data-action="menu">å›ä¸»é¸å–®</button>
  </div>
</div>

<!-- éŠæˆ²ç•«é¢ -->
<div id="gameScreen" style="display:none;position:relative;">
  <div class="topbar">
    <button id="heatButton" data-action="heat">HEAT</button>
    <div id="hpBar">
      <div id="hpFill"></div>
      <div id="hpText">100/100</div>
    </div>
    <button id="pauseButton" data-action="pause">â¸ï¸</button>
  </div>

  <div id="stage">
    <canvas id="gameCanvas" width="420" height="640"></canvas>
    <canvas id="uiCanvas" width="420" height="640"></canvas>
    <div id="countdownText">Ready</div>
  </div>

  <div class="hud">
    åˆ†æ•¸ï¼š<span id="score">0</span>ã€€
    é€£æ“Šï¼š<span id="combo">0</span>ã€€
    åˆ¤å®šï¼š<span id="judgement">-</span>ã€€
    MISSï¼š<span id="missCount">0</span>
    <div class="songline">
      æ›²ç›®ï¼š<span id="songTitle">-</span> ï½œ
      é›£åº¦ï¼š<span id="diffLabel">-</span> ï½œ
      æ–¹å‘ï¼š<span id="dirLabel">-</span> ï½œ
      åˆ¤å®šï¼š<span id="judgeLabel">-</span> ï½œ
      éµæ•¸ï¼š<span id="laneLabel">4</span>
    </div>
  </div>
</div>

<!-- æš«åœ -->
<div id="pauseScreen" style="display:none;">
  <h2>â¸ï¸ éŠæˆ²æš«åœ</h2>
  <button id="btnResume" data-action="resume">â–¶ï¸ ç¹¼çºŒ</button>
  <button class="btnBackMenu" data-action="menu">å›ä¸»é¸å–®</button>
</div>

<!-- çµç®— -->
<div id="endScreen" style="display:none;">
  <h2>ğŸ® éŠæˆ²çµæŸï¼</h2>
  <p>æ›²ç›®ï¼š<span id="finalSong">-</span></p>
  <p>é›£åº¦ï¼š<span id="finalDiff">-</span></p>
  <p>æ–¹å‘ï¼š<span id="finalDir">-</span></p>
  <p>åˆ¤å®šï¼š<span id="finalJudge">-</span></p>
  <p>åˆ†æ•¸ï¼š<span id="finalScore">0</span></p>
  <p>SICKï¼š<span id="statSick">0</span></p>
  <p>GOODï¼š<span id="statGood">0</span></p>
  <p>BADï¼š<span id="statBad">0</span></p>
  <p>SHITï¼š<span id="statShit">0</span></p>
  <p>MISSï¼š<span id="statMiss">0</span></p>
  <button id="btnRestart" data-action="restart">å†ç©ä¸€æ¬¡</button>
  <button class="btnBackMenu" data-action="menu">å›ä¸»é¸å–®</button>
</div>

<audio id="bgm" preload="auto"></audio>
<div id="warnBanner">âš ï¸ æç¤º</div>

<script>
/* ===== å¿«æ· ===== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const tip=(m)=>{const b=$("#warnBanner");
  b.textContent=m; b.style.display="block";
  setTimeout(()=>b.style.display="none",1600);};
window.addEventListener("error",e=>{
  tip("JSéŒ¯èª¤ï¼š"+(e.message||"æœªçŸ¥"));});

/* ===== ç•«å¸ƒ ===== */
const W=420,H=640;
const c=$("#gameCanvas");
const ctx=c.getContext("2d",{alpha:false,desynchronized:true});
const uc=$("#uiCanvas");
const uix=uc.getContext("2d",{alpha:true});
const IS_MOBILE=matchMedia("(pointer:coarse)").matches;
function fit(){
  const d=IS_MOBILE?Math.min(devicePixelRatio||1,1.35)
                   :Math.min(devicePixelRatio||1,2);
  c.width=W*d; c.height=H*d; ctx.setTransform(d,0,0,d,0,0);
  uc.width=W*d; uc.height=H*d; uix.setTransform(d,0,0,d,0,0);
}
fit();

/* ===== ç‹€æ…‹ ===== */
let phase="menu";
let running=false, paused=false, loopId=null;
let dir="down", diff="normal", jmode="old";
let LANE=4;
let baseSpd=550, spd=baseSpd;
let score=0, combo=0, missCount=0;
let lastJudge='-';
let stats={sick:0,good:0,bad:0,shit:0,miss:0};
let wrongCount=0;
let chart=[], remain=0;
let currentSong="-";
let uiScale=1, HIT=90, judgeCss=HIT/2, judgeY=HIT/2;
let receptorPulse=[], recShock=[];
let comboFlash='';
let heatOn=true;
let rgbOn=false;
let offsetMs=0;

/* ===== è¡€æ¢ ===== */
let hpOn=true;
let hp=100, hpMax=100;
const hpBar=$("#hpBar"), hpFill=$("#hpFill"), hpText=$("#hpText");
function hpShow(v){ hpBar.style.display=v?"block":"none"; }
function hpClamp(){ hp=Math.max(0,Math.min(hp,hpMax)); }
function hpSet(v){ hp=v; hpClamp(); hpUI(); }
function hpUI(){
  const w=Math.max(0,Math.min(100,hp))/100*100;
  hpFill.style.width=`${w}%`;
  hpText.textContent=`${Math.round(hp)}/${hpMax}`;
}
function hpChange(d){ if(!hpOn) return;
  hp+=d; hpClamp(); hpUI();
  if(hp<=0){ fail("è¡€é‡æ­¸é›¶"); }}

/* ===== ç‰ˆé¢ + èˆå°å¯¬åº¦ï¼ˆä¾éµæ•¸æ”¾å¤§ï¼‰ ===== */
function layout(){
  const r=c.getBoundingClientRect();
  const h=r.height, sc=h/H;
  judgeCss=(dir==='up')?(HIT*uiScale/2):(h-HIT*uiScale/2);
  judgeY=judgeCss/sc;
}
function desktop(){
  const coarse=IS_MOBILE;
  const wide=matchMedia("(min-width:1024px)").matches;
  const wider=matchMedia("(min-width:1440px)").matches;
  let u=1; if(!coarse&&(wide||wider)) u=wider?1.8:1.5;
  const laneBoost = (LANE===4)?1 : (LANE===6? (coarse?1.10:1.22) : (coarse?1.18:1.38));
  uiScale=u*laneBoost;
  const st=$("#stage");
  st.style.setProperty("--u",String(uiScale));
  st.style.maxWidth=`${Math.round(420*uiScale)}px`;
  layout();
}
desktop();

/* ===== HUD ===== */
function hud(){
  $("#score").textContent=score;
  $("#combo").textContent=combo;
  $("#judgement").textContent=lastJudge;
  $("#missCount").textContent=missCount;
  $("#songTitle").textContent=currentSong;
  $("#diffLabel").textContent=diff.toUpperCase();
  $("#dirLabel").textContent=(dir==='up'?'ä¸Šå‡':'ä¸‹è½');
  $("#judgeLabel").textContent=(jmode==='old'?'Old':'New');
  $("#laneLabel").textContent=String(LANE);
}

/* ===== é¡è‰²/æ–¹å‘ ===== */
const COL4=["#b266ff","#66ccff","#66ff66","#ff6666"];
const DIR4=["left","down","up","right"];
const COL6=["#ff3b3b","#ff8a00","#ffd400","#26d77d","#2aa0ff","#4b57ff"];
const DIR6=["left","up","right","left","down","right"];
const COL8=["#ffffff","#ff3b3b","#ff8a00","#ffd400",
            "#26d77d","#2aa0ff","#4b57ff","#9aa0a6"];
const DIR8=["left","down","up","right","left","down","up","right"];
function laneX(i){const lw=W/Math.max(1,LANE);return i*lw+lw/2;}
function d2a(d){if(d==="up")return -Math.PI/2;
  if(d==="down")return Math.PI/2;
  if(d==="left")return Math.PI;return 0;}
function hsv2rgb(h,s,v){
  let f=(n,k=(n+h/60)%6)=>v-v*s*Math.max(Math.min(k,4-k,1),0);
  const r=Math.round(f(5)*255), g=Math.round(f(3)*255),
        b=Math.round(f(1)*255);
  return `rgb(${r},${g},${b})`;
}
function rgbCycle(t, lane){
  const h=( (t*120)+(lane*30) )%360; return hsv2rgb(h,1,.95);
}
function meta(){ let cols=COL4,dirs=DIR4;
  if(LANE===6){cols=COL6;dirs=DIR6;}
  if(LANE===8){cols=COL8;dirs=DIR8;}
  return {cols,dirs};
}
function noteColor(t,l){ return rgbOn? rgbCycle(t*1000,l)
  : meta().cols[l%LANE]; }
function noteSize(){ return (LANE===4?50:(LANE===6?44:38)); }

/* ===== ç®­é ­ï¼ˆè³½åšé€ å‹ / è„ˆè¡ï¼‰ ===== */
function arrowPath(xc,s){
  const L=s*2.0, Hh=s*0.9, cut=Hh*0.28;
  const tip=L*0.52, tail=-L*0.22;
  xc.beginPath();
  xc.moveTo(tail,-Hh*0.55);
  xc.lineTo(0,-Hh*0.55);
  xc.lineTo(tip,0);
  xc.lineTo(0,Hh*0.55);
  xc.lineTo(tail,Hh*0.55);
  xc.lineTo(tail+cut,0);
  xc.closePath();
}
function drawArrow(o){
  const {x,y,size,dir,isRec,base="#18c",pulse=0}=o;
  ctx.save(); ctx.translate(x,y); ctx.rotate(d2a(dir));
  const scl = isRec ? (1+0.18*pulse) : 1;
  ctx.scale(scl,scl);

  arrowPath(ctx,size);

  const fillOn = isRec && pulse>0;
  ctx.fillStyle = fillOn ? base : "#0f1b2f";
  ctx.fill();

  ctx.lineWidth=2.2;
  ctx.strokeStyle="rgba(255,255,255,.95)";
  ctx.stroke();

  ctx.save(); ctx.clip();
  const k=6, glow = fillOn ? 0.28 : 0.18;
  for(let i=0;i<k;i++){
    const u=i/(k-1)-.5, yy=u*size*.95;
    ctx.globalAlpha=glow;
    ctx.strokeStyle=base; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(-size,yy);
    ctx.lineTo(size*1.1,yy); ctx.stroke();
  }
  ctx.restore();

  if(!isRec){
    ctx.globalAlpha=.22;
    ctx.beginPath(); ctx.arc(0,0,size*.36,0,Math.PI*2); ctx.stroke();
  }
  ctx.restore();
}
function drawTrail(o){
  const {x,y,size,dir,col="#fff"}=o;
  const step=3,gap=10,a=d2a(dir);
  for(let i=1;i<=step;i++){
    const off=i*gap, ax=x-Math.cos(a)*off, ay=y-Math.sin(a)*off;
    ctx.save(); ctx.globalAlpha=.12*(1-i/(step+1));
    drawArrow({x:ax,y:ay,size,dir,isRec:false,base:col,pulse:0});
    ctx.restore();
  }
}

/* ===== èƒŒæ™¯ï¼‹ç†±åœ– ===== */
function bg(time){
  ctx.save();
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"#0c1322"); g.addColorStop(1,"#0a0f1b");
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ctx.globalAlpha=.10; ctx.strokeStyle="rgba(120,213,255,.30)";
  const st=26,ox=(time*30)%st,oy=(time*18)%st;
  for(let x=-ox;x<=W;x+=st){ctx.beginPath();
    ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=-oy;y<=H;y+=st){ctx.beginPath();
    ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  ctx.restore();

  if(!heatOn) return;
  const lw=W/Math.max(1,LANE);
  const y0=(dir==='up')? (H*0.65) : (H*0.35);
  const h=(dir==='up')? (H-y0-10) : (y0-10);
  for(let i=0;i<LANE;i++){
    const x=i*lw, mid=x+lw/2;
    ctx.save(); ctx.globalAlpha=.10;
    ctx.fillStyle="rgba(255,255,255,.12)";
    ctx.fillRect(x+2, (dir==='up'?y0:10), lw-4, Math.abs(h));
    ctx.globalAlpha=.22;
    ctx.beginPath(); ctx.moveTo(mid,10); ctx.lineTo(mid,H-10);
    ctx.strokeStyle="rgba(120,213,255,.35)"; ctx.stroke();
    ctx.restore();
  }
}

/* ===== å‘½ä¸­å…‰åœˆ FX ===== */
let fxRings=[];
function fxHit(l){ fxRings.push({lane:l,t:performance.now(),life:260}); }
function drawFX(){
  const now=performance.now();
  for(let i=fxRings.length-1;i>=0;i--){
    const f=fxRings[i], p=(now-f.t)/f.life;
    if(p>=1){ fxRings.splice(i,1); continue; }
    const x=laneX(f.lane), j=judgeY;
    ctx.save(); ctx.globalAlpha=1-p;
    ctx.lineWidth=3;
    ctx.strokeStyle=noteColor(clk(),f.lane);
    ctx.beginPath(); ctx.arc(x,j,18+82*p,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  }
}

/* ===== åˆ¤å®š/ä½ç½® ===== */
const WIN={sick:85,good:135,bad:155,shit:175};
function yAt(th,tn){
  const j=judgeY;
  return (dir==='down')? j-(th-tn)*spd : j+(th-tn)*spd;
}

/* ===== æ•²æ“Šè² ===== */
let AC=null; let SFX_GAIN=.7;
function initAC(){ if(!AC){
  try{ AC=new (window.AudioContext||window.webkitAudioContext)(); }
  catch{} } }
function ping(){
  if(!AC) return;
  const o=AC.createOscillator();
  const g=AC.createGain();
  o.type="triangle";
  o.frequency.setValueAtTime(2300,AC.currentTime);
  o.frequency.exponentialRampToValueAtTime(3500,AC.currentTime+.05);
  g.gain.setValueAtTime(.001,AC.currentTime);
  g.gain.linearRampToValueAtTime(.22*SFX_GAIN,AC.currentTime+.005);
  g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+.08);
  o.connect(g).connect(AC.destination);
  o.start(); o.stop(AC.currentTime+.09);
}

/* ===== å€’æ•¸ ===== */
let counting=false,cRAF=null, previewTime=null;
function countdown(cb, showPreview=false){
  counting=true; previewTime=showPreview?clk():null;
  const el=$("#countdownText");
  const lab=['Ready','3','2','1','Go!'];
  const dur=[600,800,800,800,600];
  el.style.display='block';
  const t0=performance.now();
  const step=(now)=>{
    if(!counting) return;
    const e=now-t0; let acc=0, idx=lab.length-1;
    for(let i=0;i<lab.length;i++){
      acc+=dur[i]; if(e<acc){ idx=i; break; }
    }
    el.textContent=lab[idx]||'Go!';
    el.style.animation='none'; void el.offsetWidth;
    el.style.animation='pop .55s ease-out';
    if(previewTime!=null) drawAt(previewTime);
    else draw({skip:true});
    const total=dur.reduce((a,b)=>a+b,0);
    if(e>=total){ el.style.display='none';
      counting=false; previewTime=null; cb(); return; }
    cRAF=requestAnimationFrame(step);
  };
  cRAF=requestAnimationFrame(step);
}
function cancelCountdown(){
  if(!counting&&!cRAF) return;
  counting=false; previewTime=null;
  try{ cancelAnimationFrame(cRAF); }catch{}
  cRAF=null; const el=$("#countdownText");
  el.style.animation='none'; el.style.display='none';
}

/* ===== æ›²åº« ===== */
const SONGS=[
 "Charlie Puth - Light Switch [Official Music Video] - Charlie Puth.mp3",
 "Creepy Nuts â€Mirageâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Opening Theme Song - Creepy Nuts.mp3",
 "Creepy Nuts â€Nemureâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Ending Theme Song - Creepy Nuts (1).mp3",
 "Creepy Nutsï½¢Bling-Bang-Bang-Bornï½£ Ã— TV Animeï½¢ãƒãƒƒã‚·ãƒ¥ãƒ«-MASHLE-ï½£ Collaboration Music Video #BBBBãƒ€ãƒ³ã‚¹ - Creepy Nuts.mp3",
 "KANA-BOON - Silhouette - KANABOONVEVO.mp3",
 "Wiz Khalifa - See You Again ft. Charlie Puth [Official Video] Furious 7 Soundtrack - Wiz Khalifa Music (youtube).mp3",
 "Maroon 5 - Memories (Official Video) - Maroon5VEVO (youtube).mp3",
 "Chainsaw Man â€“ The Movie Reze Arc - Theme Song FULL IRIS OUT by Kenshi Yonezu (Lyrics) - Jamong (youtube).mp3",
 "ãƒ’ã‚°ãƒã‚¢ã‚¤ _ ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ã€Official Videoã€‘ Ai Higuchi â€Itterasshai(See you later)â€ - ãƒ’ã‚°ãƒã‚¢ã‚¤ (youtube).mp3",
 "Chainsaw Man â€“ The Movie Reze Arc - Ending FULL JANE DOE by Kenshi Yonezu, Hikaru Utada (Lyrics) - Jamong (youtube).mp3",
 "PokÃ©mon partners of different generations dancing POKÃ‰DANCE Animation Music Video - PokÃ©mon Asia ENG (youtube).mp3",
 "Lost Sky, Sara Skinner - Dreams pt. II (feat. Sara Skinner) [NCS Release].mp3",
 "OneRepublic - Nobody (from Kaiju No. 8) [Official Music Video] - OneRepublicVEVO.mp3",
 "YOASOBIã€ŒWatch me!ã€Official Music Video - Ayase _ YOASOBI.mp3",
 "yung kai - blue (official music video) - yung kai.mp3",
 "ã€AKASAKIã€‘Bunny Girl _ ãƒãƒ‹ãƒ¼ã‚¬ãƒ¼ãƒ«ï¼ˆLyric Videoï¼‰ - AKASAKI (19).mp3",
 "ã€MVã€‘éš™_ã‚†ãƒ¼ã‚Šã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã€‘ - ã‚†ãƒ¼ã‚ŠğŸğŸ¥ã€”24ã€•ãƒ»yuri (1).mp3",
 "ã€imaseã€‘NIGHT DANCERï¼ˆMVï¼‰ - imase.mp3",
 "ãªã¨ã‚Š - Overdose - ãªã¨ã‚Š _ natori.mp3",
 "å¥½ãã ã‹ã‚‰ã€‚_ ã€ãƒ¦ã‚¤ã‚«ã€ã€MVã€‘ - ã€ãƒ¦ã‚¤ã‚«ã€.mp3",
 "å»»å»»å¥‡è­š - Eve MV - Eve.mp3",
 "é’ã®ã™ã¿ã‹ _ ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ - Where Our Blue Is _ Tatsuya Kitani - ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ _ Tatsuya Kitani.mp3",
 "Toge Toge Sadistic - Enormita (youtube).mp3",
 "My dream girls - NACHERRY (youtube).mp3",
 "PEACEKEEPER - STEREO DIVE FOUNDATION (youtube).mp3",
 "YOASOBI - Idolã€Œã‚¢ã‚¤ãƒ‰ãƒ«ã€Lyrics Video [Kan_Rom_Eng] Oshi no Ko (æ¨ã—ã®å­) OP - mimanimi (youtube).mp3",
 "YOASOBI â€“ 'æ€ªç‰© (Monster)' Lyrics - Kei Takahashi (youtube).mp3",
 "YOASOBI - Racing Into The Night Lyrics (JPN_ROM_ENG) - rin rin (youtube).mp3",
 "ã€Hanserã€‘å®¤å†…ç³»çš„TrackMaker _ ã‚¤ãƒ³ãƒˆã‚™ã‚¢ç³»ãªã‚‰ãƒˆãƒ©ãƒƒã‚¯ãƒ¡ã‚¤ã‚«ãƒ¼ ã€ä¸­æ–‡ç¿»å”± _ coverã€‘ - OtakuLAB (youtube).mp3",
 "Aimer - Brave Shine - AimerOfficialVEVO (youtube).mp3",
 "ROSA WALTON x HALLIE COGGINS - I REALLY WANT TO STAY AT YOUR HOUSE (LYRIC) AMV CYBERPUNK EDGERUNNERS - Eternity Music (youtube).mp3"
];
let selectedSongFile=null;
function fillSongs(){
  const sel=$("#songSelect");
  if(sel.dataset.filled) return;
  sel.innerHTML="";
  const ph=document.createElement('option');
  ph.value=""; ph.textContent="â€” è«‹é¸æ“‡æ›²ç›® â€”";
  ph.disabled=true; ph.selected=!selectedSongFile;
  sel.appendChild(ph);
  SONGS.forEach(f=>{
    const o=document.createElement('option');
    o.value=f; o.textContent=f.replace(/\.mp3$/i,'');
    if(selectedSongFile===f) o.selected=true;
    sel.appendChild(o);
  });
  sel.addEventListener('change',()=>{
    $("#chosenSongLabel").textContent=sel.value
      ? sel.options[sel.selectedIndex].textContent
      : "å°šæœªé¸æ“‡";
  });
  sel.dataset.filled="1";
}
function confirmSong(){
  const sel=$("#songSelect");
  if(!sel.value){ alert("è«‹å…ˆé¸æ“‡éŸ³æ¨‚"); return; }
  selectedSongFile=sel.value;
  $("#chosenSongLabel").textContent=sel.options[sel.selectedIndex].textContent;
  $("#menuChosenSong").textContent=sel.options[sel.selectedIndex].textContent;
  toMenu();
}

/* ===== ç”Ÿè­œï¼ˆå« 6/8 ä¸‰éµï¼‰ ===== */
const LEAD=1.2;
function genChart(dur){
  chart=[];
  let dbl=.35,tmin=.24,tmax=.52,tpl=.20;
  if(diff==='beginner'){ dbl=.15;tpl=.05;tmin=.34;tmax=.64; }
  else if(diff==='easy'){ dbl=.20;tpl=.10;tmin=.28;tmax=.54; }
  else if(diff==='hard'){ dbl=.55;tpl=.28;tmin=.18;tmax=.40; }
  else if(diff==='ex'){ dbl=.60;tpl=.35;tmin=.16;tmax=.36; }
  let t=LEAD;
  while(t<dur){
    const used=new Set(), notes=[];
    let cnt=(Math.random()<dbl)?2:1;
    if(LANE>=6 && Math.random()<tpl) cnt=3;
    while(notes.length<cnt){
      const ln=Math.floor(Math.random()*LANE);
      if(!used.has(ln)){
        used.add(ln);
        notes.push({t,lane:ln,hit:false,y:-50});
      }
    }
    chart.push(...notes);
    t+=Math.random()*(tmax-tmin)+tmin;
  }
  remain=chart.length;
}

/* ===== éŸ³æ¨‚æ™‚é˜ ===== */
const bgm=$("#bgm");
let durSec=120, ended=false;
function clk(){ return isFinite(bgm.currentTime)?bgm.currentTime:0; }

/* ===== æ›´æ–°/ç¹ªåœ– ===== */
function update(t,dt){
  for(const n of chart){ n.y=yAt(n.t,t); }
  for(const n of chart){
    if(n.hit) continue;
    const late=(t-n.t)*1000;
    if(late>WIN.shit+160){
      n.hit=true; remain--;
      lastJudge='MISS'; combo=0; missCount++;
      stats.miss++; hud();
      if(diff==='ex' && missCount>15) fail("EXï¼šMISS>15");
      if(diff==='ex') hpChange(-25);
      else if(diff==='hard') hpChange(-10);
      else if(diff==='easy'||diff==='beginner') hpChange(-5);
      else hpChange(-8);
    }
  }
  for(let i=0;i<LANE;i++){
    receptorPulse[i]=Math.max(0,(receptorPulse[i]||0)-dt*3.4);
    recShock[i]=Math.max(0,(recShock[i]||0)-dt*5.2);
  }
}
function drawBase(t){
  ctx.clearRect(0,0,W,H);
  bg(performance.now()/1000);
  const j=judgeY, {dirs}=meta();
  const nsz=noteSize();
  for(let i=0;i<LANE;i++){
    const x=laneX(i);
    const col=noteColor(t,i);
    const pul=receptorPulse[i]||0;
    drawArrow({x,y:j,size:nsz,dir:dirs[i],
      isRec:true,base:col,pulse:pul});
  }
}
function drawNotes(t){
  const {dirs}=meta();
  const top=-160,bot=H+160;
  const nsz=noteSize();
  for(const n of chart){
    if(n.hit) continue;
    if(n.y<top||n.y>bot) continue;
    const x=laneX(n.lane);
    const col=noteColor(t,n.lane);
    drawTrail({x,y:n.y,size:nsz,dir:dirs[n.lane],col});
    ctx.save(); ctx.globalCompositeOperation="lighter";
    drawArrow({x,y:n.y,size:nsz,dir:dirs[n.lane],
      isRec:false,base:col,pulse:0});
    ctx.restore();
  }
}
function drawJudge(){
  if(lastJudge==='-') return;
  const j=judgeY;
  ctx.fillStyle='#fff';
  ctx.font='bold 30px sans-serif';
  ctx.textAlign='center';
  const off=(dir==='up')?120:-40;
  ctx.fillText(lastJudge,W/2,j+off);
}
function drawCombo(){
  if(!comboFlash) return;
  ctx.fillStyle='#ff78b5';
  ctx.font='bold 30px sans-serif';
  ctx.textAlign='center';
  ctx.fillText(comboFlash,W/2,80);
}
function draw(opt={}){
  const t=clk();
  drawBase(t);
  if(!opt.skip){ drawNotes(t); }
  drawFX();
  drawJudge();
  drawCombo();
}
function drawAt(t){
  ctx.clearRect(0,0,W,H);
  bg(performance.now()/1000);
  const j=judgeY, {dirs}=meta();
  const nsz=noteSize();
  for(let i=0;i<LANE;i++){
    const x=laneX(i);
    const col=noteColor(t,i);
    drawArrow({x,y:j,size:nsz,dir:dirs[i],
      isRec:true,base:col,pulse:0});
  }
  const top=-160,bot=H+160;
  for(const n of chart){
    if(n.hit) continue;
    const y=yAt(n.t,t);
    if(y<top||y>bot) continue;
    const x=laneX(n.lane);
    const col=noteColor(t,n.lane);
    drawTrail({x,y,size:nsz,dir:dirs[n.lane],col});
    ctx.save(); ctx.globalCompositeOperation="lighter";
    drawArrow({x,y,size:nsz,dir:dirs[n.lane],
      isRec:false,base:col,pulse:0});
    ctx.restore();
  }
}

/* ===== è¿´åœˆï¼ˆé– 60fpsï¼‰ ===== */
const FPS=60, SPF=1000/FPS; let _last=0;
function loop(ts){
  if(paused) return;
  if(_last && ts-_last<SPF-0.5){
    loopId=requestAnimationFrame(loop); return;
  }
  const dt=_last? (ts-_last)/1000 : 1/FPS;
  _last=ts;
  const t=clk(); update(t,dt); draw();
  if(ended||remain<=0){ finishGame(); return; }
  loopId=requestAnimationFrame(loop);
}
function stopLoop(){
  try{ cancelAnimationFrame(loopId); }catch{}
  loopId=null;
}

/* ===== è¼¸å…¥ ===== */
function keyLane(k){
  const kk=k.toLowerCase();
  if(LANE===4){
    if(kk==='d'||kk==='arrowleft')return 0;
    if(kk==='f'||kk==='arrowdown')return 1;
    if(kk==='j'||kk==='arrowup')return 2;
    if(kk==='k'||kk==='arrowright')return 3;
    return null;
  }
  if(LANE===6){
    if(kk==='s')return 0; if(kk==='d')return 1; if(kk==='f')return 2;
    if(kk==='j')return 3; if(kk==='k')return 4; if(kk==='l')return 5;
    if(kk.startsWith('arrow'))return null; return null;
  }
  if(LANE===8){
    if(kk==='a')return 0; if(kk==='s')return 1; if(kk==='d')return 2;
    if(kk==='f')return 3; if(kk==='j')return 4; if(kk==='k')return 5;
    if(kk==='l')return 6; if(kk===';')return 7;
    if(kk.startsWith('arrow'))return null; return null;
  }
  return null;
}
window.addEventListener("keydown",e=>{
  if(e.repeat) return;
  const k=e.key.toLowerCase();
  if(k==='r'){ heatOn=!heatOn; tip(heatOn?"HEAT é–‹":"HEAT é—œ"); }
  if(k==='escape'){
    if(phase==='playing') pauseGame();
    else if(phase==='paused') resumeGame();
    else if(phase==='countdown'){ cancelCountdown(); pauseGame(); }
    e.preventDefault(); return;
  }
  const l=keyLane(k);
  if(l!==null){
    if(running && !paused){ onPress(l); }
    e.preventDefault(); return;
  }
});
c.addEventListener("pointerdown",e=>{
  if(!(running && !paused)) return;
  const r=c.getBoundingClientRect();
  const x=e.clientX-r.left;
  const lw=r.width/Math.max(1,LANE);
  const lane=Math.min(LANE-1,Math.max(0,Math.floor(x/lw)));
  onPress(lane); e.preventDefault();
},{passive:false});
document.addEventListener("dblclick",e=>{
  if(phase==='playing'||phase==='countdown') e.preventDefault();
},{passive:false});
document.addEventListener("gesturestart",e=>{
  if(phase==='playing'||phase==='countdown') e.preventDefault();
},{passive:false});
document.addEventListener("contextmenu",e=>{
  if(phase==='playing'||phase==='countdown') e.preventDefault();
});

/* ===== åˆ¤å®šé‚è¼¯ï¼ˆå«å…¨åŸŸæ ¡æ­£ + HP è¦å‰‡ + FXï¼‰ ===== */
function onPress(l){
  if(!running) return;
  initAC(); ping();
  receptorPulse[l]=1; recShock[l]=1;
  const t=clk(); let bi=-1,ba=1e9;
  for(let i=0;i<chart.length;i++){
    const n=chart[i];
    if(n.hit||n.lane!==l) continue;
    const dt=((t-n.t)*1000) - offsetMs;
    const ad=Math.abs(dt);
    if(ad<=WIN.shit && ad<ba){ ba=ad; bi=i; }
  }
  if(bi>=0){
    const n=chart[bi]; n.hit=true; remain--;
    const dt=((t-n.t)*1000) - offsetMs;
    const ad=Math.abs(dt);
    if(ad<=WIN.sick){
      lastJudge='SICK!'; combo++; stats.sick++; score+=350; hpChange(+15);
    }else if(ad<=WIN.good){
      lastJudge='GOOD'; combo++; stats.good++; score+=200; hpChange(+12);
    }else if(ad<=WIN.bad){
      lastJudge='BAD'; stats.bad++; score+=100; hpChange(+6);
    }else{
      lastJudge='SHIT'; combo=Math.max(0,combo-1); stats.shit++; score-=50;
      if(diff==='ex') hpChange(-20);
      else if(diff==='hard') hpChange(-8);
      else if(diff==='easy'||diff==='beginner') hpChange(-3);
      else hpChange(-6);
    }
    score=Math.max(0,score);
    fxHit(l);
    if(combo>0 && combo%10===0){
      comboFlash=`COMBO x${combo}!!`;
      setTimeout(()=>comboFlash='',900);
    }
    hud();
  }else{
    if(jmode==='old'){
      lastJudge='WRONG'; wrongCount++; hpChange(-2);
      fxHit(l);
    }else lastJudge='-';
    hud();
  }
}

/* ===== æµç¨‹ ===== */
function toMenu(){
  cancelCountdown(); stopLoop();
  try{ bgm.pause(); }catch{}
  document.body.classList.remove('ex-mode');
  phase='menu'; running=false; paused=false;
  showOnly('menuScreen');
  const n= selectedSongFile
    ? selectedSongFile.replace(/\.mp3$/i,'')
    : 'å°šæœªé¸æ“‡';
  $("#menuChosenSong").textContent=n;
}
function toMusic(){ showOnly('musicScreen'); }
function toOpt(){ showOnly('optionsScreen'); }
function pauseGame(){
  if(phase==='countdown'){ cancelCountdown(); }
  if(!running) return;
  paused=true; phase='paused';
  $("#gameScreen").classList.add('blur');
  showOnly('pauseScreen');
  try{ bgm.pause(); }catch{}
}
function resumeGame(){
  if(!paused) return;
  paused=false; showOnly('gameScreen');
  $("#gameScreen").classList.remove('blur');
  countdown(()=>{
    phase='playing';
    try{ bgm.play().catch(()=>{});}catch{}
  }, true);
}
function fail(msg){ tip(msg||"å¤±æ•—"); finishGame(); }

/* ===== Start / End ===== */
function startGame(){
  if(!selectedSongFile){ toMusic(); alert("è«‹å…ˆé¸æ“‡éŸ³æ¨‚"); return; }
  LANE=+$("#keyModeSelect").value||4;
  receptorPulse=new Array(LANE).fill(0);
  recShock=new Array(LANE).fill(0);
  diff=$("#difficultySelect").value||"normal";
  dir=$("#noteDirection").value||"down";
  jmode=$("#judgeMode").value||"old";
  rgbOn=$("#rgbToggle").checked||false;

  hpOn=$("#hpToggle").checked;
  hpShow(hpOn); hpSet(100);

  let mul=parseFloat($("#speedMultiplier").value||"1");
  if(diff==='beginner') mul=.8; else if(diff==='easy') mul=.9;
  spd=baseSpd*mul;

  document.body.classList.toggle('ex-mode',diff==='ex');

  score=0; combo=0; missCount=0; wrongCount=0; lastJudge='-';
  stats={sick:0,good:0,bad:0,shit:0,miss:0};
  chart=[]; remain=0; comboFlash=''; fxRings.length=0;

  currentSong=selectedSongFile.replace(/\.mp3$/i,''); hud();

  showOnly("gameScreen"); phase="countdown";
  desktop(); fit(); layout(); draw({skip:true});

  try{ bgm.pause(); }catch{}
  const url='music/'+encodeURIComponent(selectedSongFile);
  try{ bgm.src=url; bgm.load(); }catch{}
  durSec=isFinite(bgm.duration)?bgm.duration:120;
  genChart(durSec||120);

  countdown(()=>{
    phase='playing'; running=true;
    try{ bgm.currentTime=0; bgm.play().catch(()=>{});}catch{}
    loopId=requestAnimationFrame(loop);
  }, false);
}
function finishGame(){
  running=false; lastJudge='END'; hud();
  $("#finalSong").textContent=currentSong;
  $("#finalDiff").textContent=diff.toUpperCase();
  $("#finalDir").textContent=(dir==='up'?'ä¸Šå‡':'ä¸‹è½');
  $("#finalJudge").textContent=(jmode==='old'?'Old':'New');
  $("#finalScore").textContent=score;
  $("#statSick").textContent=stats.sick;
  $("#statGood").textContent=stats.good;
  $("#statBad").textContent=stats.bad;
  $("#statShit").textContent=stats.shit;
  $("#statMiss").textContent=missCount;
  showOnly("endScreen"); phase="menu";
}

/* ===== ç¶å®šï¼ˆé›™ä¿éšªï¼‰ + è¨­å®šä¿å­˜ ===== */
function bind(){
  $("#btnStart")?.addEventListener("click",startGame);
  $("#btnMusic")?.addEventListener("click",toMusic);
  $("#btnOptions")?.addEventListener("click",toOpt);
  $("#btnSongConfirm")?.addEventListener("click",confirmSong);
  $("#btnResume")?.addEventListener("click",resumeGame);
  $("#btnRestart")?.addEventListener("click",startGame);
  $$(".btnBackMenu").forEach(b=>b.addEventListener("click",toMenu));
  $("#heatButton")?.addEventListener("click",()=>{
    heatOn=!heatOn; tip(heatOn?"HEAT é–‹":"HEAT é—œ");
  });
  document.addEventListener("click",(e)=>{
    const a=e.target.closest("[data-action]"); if(!a) return;
    const act=a.getAttribute("data-action");
    if(act==="start") startGame();
    else if(act==="music") toMusic();
    else if(act==="options") toOpt();
    else if(act==="song-ok") confirmSong();
    else if(act==="menu") toMenu();
    else if(act==="pause") pauseGame();
    else if(act==="resume") resumeGame();
    else if(act==="restart") startGame();
    else if(act==="heat"){ heatOn=!heatOn; }
  });

  /* éŸ³é‡æ»‘æ¡¿ */
  const mv=+(localStorage.getItem("dfjk.volume")||80);
  $("#volumeSlider").value=String(mv);
  $("#volumeLabel").textContent=`${mv}%`;
  bgm.volume=mv/100;
  $("#volumeSlider").addEventListener("input",e=>{
    const v=+e.target.value;
    $("#volumeLabel").textContent=`${v}%`;
    bgm.volume=v/100;
    localStorage.setItem("dfjk.volume",String(v));
  });

  const sv=+(localStorage.getItem("dfjk.sfxVol")||70);
  $("#sfxSlider").value=String(sv);
  $("#sfxLabel").textContent=`${sv}%`;
  SFX_GAIN=sv/100;
  $("#sfxSlider").addEventListener("input",e=>{
    const v=+e.target.value;
    $("#sfxLabel").textContent=`${v}%`;
    SFX_GAIN=v/100;
    localStorage.setItem("dfjk.sfxVol",String(v));
  });

  /* å…¨åŸŸåç§» */
  offsetMs=+(localStorage.getItem("dfjk.offset")||0);
  $("#offsetSlider").value=String(offsetMs);
  $("#offsetLabel").textContent=`${offsetMs}ms`;
  $("#offsetSlider").addEventListener("input",e=>{
    offsetMs=+e.target.value;
    $("#offsetLabel").textContent=`${offsetMs}ms`;
    localStorage.setItem("dfjk.offset",String(offsetMs));
  });

  /* RGB / HP é è¨­è¨˜æ†¶ */
  const rgb = localStorage.getItem("dfjk.rgbOn");
  if(rgb!==null){ $("#rgbToggle").checked = rgb==="1"; }
  $("#rgbToggle").addEventListener("change",e=>{
    localStorage.setItem("dfjk.rgbOn", e.target.checked?"1":"0");
  });
  const hps = localStorage.getItem("dfjk.hpOn");
  if(hps!==null){ $("#hpToggle").checked = hps==="1"; }
  else { $("#hpToggle").checked = true; } /* é è¨­é–‹å•Ÿ */
  $("#hpToggle").addEventListener("change",e=>{
    localStorage.setItem("dfjk.hpOn", e.target.checked?"1":"0");
  });

  /* é¦–æ¬¡äº’å‹•å•Ÿå‹• AudioContext */
  const wake=()=>{
    initAC(); document.removeEventListener("pointerdown",wake);
    document.removeEventListener("keydown",wake);
  };
  document.addEventListener("pointerdown",wake,{passive:true});
  document.addEventListener("keydown",wake);
}

/* ===== åˆå§‹åŒ– ===== */
function showOnly(id){
  const ids=["menuScreen","musicScreen","optionsScreen",
    "gameScreen","pauseScreen","endScreen"];
  ids.forEach(x=>{
    const el=$("#"+x);
    if(el) el.style.display=(x===id?"block":"none");
  });
  if(id!=="gameScreen"){
    $("#gameScreen")?.classList.remove("blur");
    document.body.classList.remove('ex-mode'); /* å›ä¸»å–®ä¿®æ­£ç´…åº• */
  }
}
function init(){
  desktop(); fit(); layout(); bind(); fillSongs(); hud();
  const hps = localStorage.getItem("dfjk.hpOn");
  hpOn = hps ? (hps==="1") : true;
  hpShow(hpOn); hpSet(100);
  const rgb = localStorage.getItem("dfjk.rgbOn");
  rgbOn = rgb ? (rgb==="1") : false;
  $("#rgbToggle").checked = rgbOn;
  $("#hpToggle").checked = hpOn;
  showOnly("menuScreen");
}
window.addEventListener("resize",()=>{
  fit(); desktop(); layout();
  if(phase==='countdown') draw({skip:true});
});
document.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>
