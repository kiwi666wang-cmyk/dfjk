<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DFJK é«˜ç²¾åº¦ Cyberpunk ç‰ˆï¼ˆå‹•æ…‹ç®­é ­ + èƒŒæ™¯ç‰¹æ•ˆï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  html, body { touch-action: manipulation; }
  body{
    margin:0; color:#fff; font-family:sans-serif; text-align:center; transition: background .5s ease;
    background: radial-gradient(1200px 800px at 50% 0%, #101a2c 0%, #0c1524 60%, #0a111d 100%);
    overflow-x:hidden;
  }
  /* å…¨é  Cyberpunk æ•ˆæœå±¤ï¼ˆæƒæç·š + è‰²å½©é›œè¨Šï¼Œæ¥µè¼•é‡ï¼‰ */
  body::before, body::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
  }
  /* æƒæç·š */
  body::before{
    background:
      repeating-linear-gradient(to bottom, rgba(255,255,255,.035) 0px, rgba(255,255,255,.035) 1px, rgba(0,0,0,0) 2px),
      linear-gradient(120deg, rgba(0,255,255,.06), rgba(255,0,160,.05) 60%, rgba(255,255,0,.03));
    mix-blend-mode: screen;
    animation: scanY 6s linear infinite;
    opacity:.22;
  }
  /* ç´°å¾®é›œè¨Š */
  body::after{
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity="0.05"/></svg>');
    background-size: 220px 220px;
    animation: noiseShift 9s steps(30) infinite;
    opacity:.18;
    mix-blend-mode: overlay;
  }
  @keyframes scanY{ from { background-position: 0 0, 0 0; } to { background-position: 0 300px, 0 0; } }
  @keyframes noiseShift{ 0%{ transform:translate3d(0,0,0);} 100%{ transform:translate3d(0,-60px,0);} }

  body.ex-mode{ background: linear-gradient(to bottom, #ff3300, #990000, #000000); }

  #stage{ position:relative; width:95%; max-width:420px; margin:20px auto; --u:1; z-index:1; }
  canvas{ display:block; background:#121a2a; border:2px solid #fff; width:100%; height:auto; touch-action:manipulation; }
  /* éŠç©æ™‚ç§»é™¤ç¡¬é‚Šï¼Œç”¨å½é‚Šç•Œ + å…‰æšˆ */
  #stage.immersive canvas.game{ border:none; }
  #edgeFade{
    position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .25s ease;
    background:
      linear-gradient(to right, rgba(255,255,255,.10), rgba(255,255,255,0) 40%) left/14px 100% no-repeat,
      linear-gradient(to left,  rgba(255,255,255,.10), rgba(255,255,255,0) 40%) right/14px 100% no-repeat,
      linear-gradient(to bottom,rgba(255,255,255,.10), rgba(255,255,255,0) 40%) top/100% 14px no-repeat,
      linear-gradient(to top,   rgba(255,255,255,.10), rgba(255,255,255,0) 40%) bottom/100% 14px no-repeat;
    border-radius:10px;
  }
  #stage.immersive #edgeFade{ opacity:1; }
  #stage.immersive::after{
    content:""; position:absolute; inset:-6px; pointer-events:none; border-radius:14px;
    box-shadow: 0 0 28px 12px rgba(0, 255, 255, .07), 0 0 36px 16px rgba(255, 0, 160, .05);
  }
  /* UI å å±¤ï¼šå°ˆç•«å·¦ä¸Šè§’ç†±åœ–ç­‰å›ºå®š HUDï¼Œä¸æœƒæ¼‚ç§»æˆ–è£åˆ‡ */
  canvas.ui{
    position:absolute; inset:0; width:100%; height:100%; pointer-events:none; background:transparent; border:none; z-index:5;
  }

  .hitbar{ position:absolute; left:0; width:100%; display:flex; justify-content:space-between; align-items:center; height:calc(90px * var(--u)); z-index:2; opacity:0; pointer-events:none; }
  .hitkey{ flex:1; margin:0 5px; height:calc(90px * var(--u)); }

  .hud{ font-size:18px; margin-top:10px; line-height:1.6; }
  .songline{ font-size:14px; opacity:.9; }
  button{ margin:10px; padding:10px 20px; font-size:18px; background:#78d5ff; border:none; border-radius:8px; cursor:pointer; }

  #menuScreen, #musicScreen, #endScreen, #optionsScreen, #pauseScreen{ padding-top:120px; }
  .blur{ filter:blur(6px); pointer-events:none; user-select:none; }
  #pauseButton{ position:absolute; top:10px; right:10px; z-index:3; }
  .pause-bottom{ top:auto !important; bottom:10px !important; }

  /* å€’æ•¸å­—æ¨£ */
  #countdownText{
    position:absolute; top:40%; left:50%; transform:translate(-50%,-50%);
    font-family:'Fredoka One', sans-serif; font-size:72px; color:#fff; text-shadow:2px 2px 8px #000;
    z-index:9; pointer-events:none; opacity:1; will-change:transform; display:none;
  }
  @keyframes popScale{ 0%{ transform:translate(-50%,-50%) scale(.85);} 50%{ transform:translate(-50%,-50%) scale(1.12);} 100%{ transform:translate(-50%,-50%) scale(1);} }

  .row{ margin:10px 0; } label{ margin-right:6px; }
  select{ padding:6px 10px; border-radius:6px; border:1px solid #445; background:#12152a; color:#fff; }

  #songSelect{ width:90%; max-width:420px; height:280px; }
  #musicScreen .hint{ opacity:.8; font-size:14px; margin-top:6px; }

  #warnBanner{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:rgba(255,80,80,.95); padding:10px 14px; border-radius:8px; font-size:14px; display:none; z-index:20; }

  .options-footer{ position:sticky; bottom:0; z-index:5; padding:10px 0 16px; background:linear-gradient(to top, rgba(15,18,32,.95), rgba(15,18,32,0)); }
</style>
</head>
<body>
  <!-- ä¸»é¸å–® -->
  <div id="menuScreen">
    <h1>ğŸµ DFJK é«˜ç²¾åº¦ Cyberpunk ç‰ˆï¼ˆå‹•æ…‹ç®­é ­ + èƒŒæ™¯ç‰¹æ•ˆï¼‰</h1>
    <div class="row">
      <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
      <button onclick="showMusic()">éŸ³æ¨‚</button>
      <button onclick="showOptions()">é¸é …</button>
    </div>
    <div class="row">å·²é¸æ›²ç›®ï¼š<span id="menuChosenSong">å°šæœªé¸æ“‡</span></div>
  </div>

  <!-- éŸ³æ¨‚é¸å–® -->
  <div id="musicScreen" style="display:none;">
    <h2>ğŸ¼ é¸æ“‡æœ¬å±€æ›²ç›®</h2>
    <div class="row">
      <select id="songSelect" size="12"></select>
      <div class="hint">å¿…é ˆé¸æ“‡æ›²ç›®æ‰å¯é–‹å§‹ã€‚</div>
    </div>
    <div class="row">
      <button onclick="confirmSong()">ç¢ºå®š</button>
      <button onclick="goToMenu()">å›ä¸»é¸å–®</button>
    </div>
    <div class="row">å·²é¸ï¼š<span id="chosenSongLabel">å°šæœªé¸æ“‡</span></div>
  </div>

  <!-- é¸é … -->
  <div id="optionsScreen" style="display:none;">
    <h2>âš™ï¸ éŠæˆ²é¸é …</h2>

    <div class="row">
      <label for="difficultySelect">é›£åº¦ï¼š</label>
      <select id="difficultySelect">
        <option value="ex">EXï¼ˆæ¥µé™ï¼‰</option>
        <option value="hell">åœ°ç„</option>
        <option value="hard">å›°é›£</option>
        <option value="normal" selected>æ™®é€š</option>
        <option value="easy">ç°¡å–®</option>
        <option value="beginner">åˆå­¸è€…</option>
      </select>
    </div>

    <div class="row">
      <label for="speedMultiplier">é€Ÿåº¦å€ç‡ï¼š</label>
      <select id="speedMultiplier">
        <option value="1">1.0xï¼ˆæ¨™æº–ï¼‰</option>
        <option value="1.1">1.1x</option>
        <option value="1.2">1.2x</option>
        <option value="1.3">1.3x</option>
        <option value="1.6">1.6x</option>
        <option value="2.0">2.0x</option>
      </select>
    </div>

    <div class="row">
      <label for="noteDirection">éŸ³ç¬¦æ–¹å‘ï¼š</label>
      <select id="noteDirection">
        <option value="down" selected>ä¸‹è½æ‰“æ“Šï¼ˆæ‰“æ“Šç·šåœ¨åº•ï¼‰</option>
        <option value="up">ä¸Šå‡æ‰“æ“Šï¼ˆæ‰“æ“Šç·šåœ¨é ‚ï¼‰</option>
      </select>
    </div>

    <div class="row">
      <label for="judgeMode">åˆ¤å®šæ¨¡å¼ï¼š</label>
      <select id="judgeMode">
        <option value="old" selected>Old Inputï¼ˆå« Ghost æ‡²ç½°ï¼‰</option>
        <option value="new">New Inputï¼ˆç§»é™¤ WRONGï¼‰</option>
      </select>
    </div>

    <div class="row">
      <label for="volumeSlider">éŸ³é‡ï¼š</label>
      <input id="volumeSlider" type="range" min="0" max="100" value="80" />
      <span id="volumeLabel">80%</span>
    </div>

    <div class="row"><hr style="opacity:.2"></div>
    <h3>ğŸ¯ å‘½ä¸­å»¶é²æ ¡æ­£</h3>
    <div class="row">
      <label for="offsetSlider">å…¨åŸŸåç§» (ms)ï¼š</label>
      <input id="offsetSlider" type="range" min="-600" max="600" value="0" />
      <span id="offsetLabel">0 ms</span>
      <button id="offsetCalibBtn">å¿«é€Ÿæ ¡æ­£</button>
    </div>

    <div class="options-footer">
      <button onclick="goToMenu()">å›ä¸»é¸å–®</button>
    </div>
  </div>

  <!-- éŠæˆ²ç•«é¢ -->
  <div id="gameScreen" style="display:none; position:relative;">
    <button id="pauseButton" onclick="pauseGame()">â¸ï¸</button>
    <div id="stage">
      <canvas id="gameCanvas" class="game" width="420" height="640"></canvas>
      <canvas id="uiCanvas" class="ui" width="420" height="640"></canvas>
      <div id="edgeFade" aria-hidden="true"></div>
      <div class="hitbar">
        <div class="hitkey" id="key-d"></div>
        <div class="hitkey" id="key-f"></div>
        <div class="hitkey" id="key-j"></div>
        <div class="hitkey" id="key-k"></div>
      </div>
      <div id="countdownText">Ready</div>
    </div>

    <div class="hud">
      åˆ†æ•¸ï¼š<span id="score">0</span>ã€€
      é€£æ“Šï¼š<span id="combo">0</span>ã€€
      åˆ¤å®šï¼š<span id="judgement">-</span>ã€€
      MISSï¼š<span id="missCount">0</span>
      <div class="songline">
        æ›²ç›®ï¼š<span id="songTitle">-</span> ï½œ é›£åº¦ï¼š<span id="diffLabel">-</span> ï½œ æ–¹å‘ï¼š<span id="dirLabel">-</span> ï½œ åˆ¤å®šï¼š<span id="judgeLabel">-</span> ï½œ åç§»ï¼š<span id="offsetActive">0 ms</span>
      </div>
    </div>
  </div>

  <!-- æš«åœ -->
  <div id="pauseScreen" style="display:none;">
    <h2>â¸ï¸ éŠæˆ²æš«åœ</h2>
    <button onclick="resumeGame()">â–¶ï¸ ç¹¼çºŒ</button>
    <button onclick="goToMenu()">å›ä¸»é¸å–®</button>
  </div>

  <!-- çµç®— -->
  <div id="endScreen" style="display:none;">
    <h2>ğŸ® éŠæˆ²çµæŸï¼</h2>
    <p>æ›²ç›®ï¼š<span id="finalSong">-</span></p>
    <p>é›£åº¦ï¼š<span id="finalDiff">-</span></p>
    <p>æ–¹å‘ï¼š<span id="finalDir">-</span></p>
    <p>åˆ¤å®šï¼š<span id="finalJudge">-</span></p>
    <p>åˆ†æ•¸ï¼š<span id="finalScore">0</span></p>
    <p>SICKï¼š<span id="statSick">0</span></p>
    <p>GOODï¼š<span id="statGood">0</span></p>
    <p>BADï¼š<span id="statBad">0</span></p>
    <p>SHITï¼š<span id="statShit">0</span></p>
    <p>MISSï¼š<span id="statMiss">0</span></p>
    <button onclick="startGame()">å†ç©ä¸€æ¬¡</button>
    <button onclick="goToMenu()">å›ä¸»é¸å–®</button>
  </div>

  <div id="warnBanner">âš ï¸ éŸ³æ¨‚ç„¡æ³•è¼‰å…¥æˆ–æ’­æ”¾</div>

  <audio id="hitSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_6e3e3b6f3f.mp3?filename=click-124467.mp3" preload="auto"></audio>

<script>
/* =========================================================
 * DFJK é«˜ç²¾åº¦ Cyberpunk ç‰ˆï¼ˆå‹•æ…‹ç®­é ­ + èƒŒæ™¯ç‰¹æ•ˆ + ç†±åœ–ä¸‹ç§»ï¼‰
 * ========================================================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
const uiCanvas = document.getElementById('uiCanvas');
const uictx = uiCanvas.getContext('2d', { alpha: true });

let W = 420, H = 640;
function setupCanvasDPR(){
  const dpr = Math.min(window.devicePixelRatio||1, 2);
  canvas.width = Math.round(W * dpr);
  canvas.height= Math.round(H * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  uiCanvas.width = Math.round(W * dpr);
  uiCanvas.height= Math.round(H * dpr);
  uictx.setTransform(dpr,0,0,dpr,0,0);
}
setupCanvasDPR();

const FLICKER_SCALE = 0.9; // <<< 100 é¢ç© â†’ 81 é¢ç©ï¼ˆåŠå¾‘/ä½ç§»*0.9ï¼‰

const laneWidth = W/4;
const hitbar = document.querySelector('.hitbar');
const HITKEY_BASE=90, NOTE_BASE=60;
let uiScale=1;

let phase='menu';
let isCountingDown=false; let countdownTimers=[], countdownRAF=null;

const IS_MOBILE = window.matchMedia('(pointer: coarse)').matches;
const SUPPORTS_VIB = IS_MOBILE && 'vibrate' in navigator;
let __fpsMode = IS_MOBILE ? 'stable60' : 'unlocked';
let __lastRenderTs=0; const __TARGET_INTERVAL=1000/60;

function applyDesktopScale(){
  const isCoarse = window.matchMedia('(pointer: coarse)').matches;
  const wide = window.matchMedia('(min-width: 1024px)').matches;
  const wider = window.matchMedia('(min-width: 1440px)').matches;
  let u=1; if(!isCoarse && (wide||wider)) u = wider ? 1.8 : 1.5;
  uiScale=u;
  const stage=document.getElementById('stage');
  stage.style.setProperty('--u', String(u));
  stage.style.maxWidth = `${Math.round(420*u)}px`;
  recomputeLayout();
}

let cachedRectHeight = canvas.getBoundingClientRect().height;
let cachedScaleY = cachedRectHeight / H;
let cachedJudgeLineCss = (HITKEY_BASE * uiScale / 2);
let cachedJudgeLineInternal = cachedJudgeLineCss / cachedScaleY;
let __layoutFrozen=false, __frozenRectHeight=null, __frozenScaleY=null, __frozenJudgeCss=null;
function freezeLayout(){
  const rect = canvas.getBoundingClientRect();
  __frozenRectHeight=rect.height; __frozenScaleY=__frozenRectHeight/H;
  __frozenJudgeCss=(currentDirection==='up')?(HITKEY_BASE*uiScale/2):(__frozenRectHeight-HITKEY_BASE*uiScale/2);
  __layoutFrozen=true; updateHitbarPosition();
}
function unfreezeLayout(){ __layoutFrozen=false; recomputeLayout(); }
function recomputeLayout(){
  if(__layoutFrozen) return;
  const rect=canvas.getBoundingClientRect();
  cachedRectHeight=rect.height; cachedScaleY=cachedRectHeight/H;
  cachedJudgeLineCss=(currentDirection==='up')?(HITKEY_BASE*uiScale/2):(cachedRectHeight - HITKEY_BASE*uiScale/2);
  cachedJudgeLineInternal=cachedJudgeLineCss/cachedScaleY;
  updateHitbarPosition(); positionPauseButton();
}
function getJudgeLineYCss(){ return __layoutFrozen? __frozenJudgeCss : cachedJudgeLineCss; }
function getJudgeLineYInternal(){ return getJudgeLineYCss() / (__layoutFrozen? __frozenScaleY : cachedScaleY); }

const keys=['d','f','j','k']; const laneDirs=['left','down','up','right'];
function laneFromKey(k){ switch(k){ case 'd':case 'arrowleft':return 0; case 'f':case 'arrowdown':return 1; case 'j':case 'arrowup':return 2; case 'k':case 'arrowright':return 3; default:return null; } }

let score=0, combo=0, lastJudgementText='-';
let running=false, paused=false, loopId=null;
let chart=[], comboFlash='';
let prevSongT=0, pausedAtSong=0;

const hitSound=document.getElementById('hitSound'); let tapPool=null; const SFX_GAIN=1.6;
let baseNoteSpeed=550, noteSpeed=baseNoteSpeed;

const BASE_WINDOWS = { sick:80, good:130, bad:150, shit:170 };
const FNF_SCORES  = { sick:350, good:200, bad:100, shit:-50, miss:-300, ghost:-150 };
const LATE_MISS_GRACE_MS = 160; function currentWindows(){ return BASE_WINDOWS; }

let missCount=0, gameOver=false; let stats={sick:0,good:0,bad:0,shit:0,miss:0};
let currentSongTitle='-'; let currentDifficulty='normal'; let currentDirection='down'; let currentJudgeMode='old';
let selectedSongFile=null;

/* æ›²ç›®æ¸…å–®ï¼ˆå®Œæ•´ï¼‰ */
const SONGS = [
  "Charlie Puth - Light Switch [Official Music Video] - Charlie Puth.mp3",
  "Creepy Nuts â€Mirageâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Opening Theme Song - Creepy Nuts.mp3",
  "Creepy Nuts â€Nemureâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Ending Theme Song - Creepy Nuts (1).mp3",
  "Creepy Nutsï½¢Bling-Bang-Bang-Bornï½£ Ã— TV Animeï½¢ãƒãƒƒã‚·ãƒ¥ãƒ«-MASHLE-ï½£ Collaboration Music Video #BBBBãƒ€ãƒ³ã‚¹ - Creepy Nuts.mp3",
  "KANA-BOON - Silhouette - KANABOONVEVO.mp3",
  "Wiz Khalifa - See You Again ft. Charlie Puth [Official Video] Furious 7 Soundtrack - Wiz Khalifa Music (youtube).mp3",
  "Maroon 5 - Memories (Official Video) - Maroon5VEVO (youtube).mp3",
  "Chainsaw Man â€“ The Movie Reze Arc - Theme Song FULL IRIS OUT by Kenshi Yonezu (Lyrics) - Jamong (youtube).mp3",
  "ãƒ’ã‚°ãƒã‚¢ã‚¤ _ ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ã€Official Videoã€‘ Ai Higuchi â€Itterasshai(See you later)â€ - ãƒ’ã‚°ãƒã‚¢ã‚¤ (youtube).mp3",
  "Chainsaw Man â€“ The Movie Reze Arc - Ending FULL JANE DOE by Kenshi Yonezu, Hikaru Utada (Lyrics) - Jamong (youtube).mp3",
  "PokÃ©mon partners of different generations dancing POKÃ‰DANCE Animation Music Video - PokÃ©mon Asia ENG (youtube).mp3",
  "Lost Sky, Sara Skinner - Dreams pt. II (feat. Sara Skinner) [NCS Release].mp3",
  "OneRepublic - Nobody (from Kaiju No. 8) [Official Music Video] - OneRepublicVEVO.mp3",
  "YOASOBIã€ŒWatch me!ã€Official Music Video - Ayase _ YOASOBI.mp3",
  "yung kai - blue (official music video) - yung kai.mp3",
  "ã€AKASAKIã€‘Bunny Girl _ ãƒãƒ‹ãƒ¼ã‚¬ãƒ¼ãƒ«ï¼ˆLyric Videoï¼‰ - AKASAKI (19).mp3",
  "ã€MVã€‘éš™_ã‚†ãƒ¼ã‚Šã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã€‘ - ã‚†ãƒ¼ã‚ŠğŸğŸ¥ã€”24ã€•ãƒ»yuri (1).mp3",
  "ã€imaseã€‘NIGHT DANCERï¼ˆMVï¼‰ - imase.mp3",
  "ãªã¨ã‚Š - Overdose - ãªã¨ã‚Š _ natori.mp3",
  "å¥½ãã ã‹ã‚‰ã€‚_ ã€ãƒ¦ã‚¤ã‚«ã€ã€MVã€‘ - ã€ãƒ¦ã‚¤ã‚«ã€.mp3",
  "å»»å»»å¥‡è­š - Eve MV - Eve.mp3",
  "é’ã®ã™ã¿ã‹ _ ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ - Where Our Blue Is _ Tatsuya Kitani - ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ _ Tatsuya Kitani.mp3",
  "Toge Toge Sadistic - Enormita (youtube).mp3",
  "My dream girls - NACHERRY (youtube).mp3",
  "PEACEKEEPER - STEREO DIVE FOUNDATION (youtube).mp3",
  "YOASOBI - Idolã€Œã‚¢ã‚¤ãƒ‰ãƒ«ã€Lyrics Video [Kan_Rom_Eng] Oshi no Ko (æ¨ã—ã®å­) OP - mimanimi (youtube).mp3",
  "YOASOBI â€“ 'æ€ªç‰© (Monster)' Lyrics - Kei Takahashi (youtube).mp3",
  "YOASOBI - Racing Into The Night Lyrics (JPN_ROM_ENG) - rin rin (youtube).mp3",
  "ã€Hanserã€‘å®¤å†…ç³»çš„TrackMaker _ ã‚¤ãƒ³ãƒˆã‚™ã‚¢ç³»ãªã‚‰ãƒˆãƒ©ãƒƒã‚¯ãƒ¡ã‚¤ã‚«ãƒ¼ ã€ä¸­æ–‡ç¿»å”± _ coverã€‘ - OtakuLAB (youtube).mp3",
  "Aimer - Brave Shine - AimerOfficialVEVO (youtube).mp3",
  "ROSA WALTON x HALLIE COGGINS - I REALLY WANT TO STAY AT YOUR HOUSE (LYRIC) AMV CYBERPUNK EDGERUNNERS - Eternity Music (youtube).mp3"
];

/* SFX æ±  */
class TapSoundPool{ constructor(src,size=10){ this.pool=[]; this.idx=0; for(let i=0;i<size;i++){ const a=new Audio(src); a.preload='auto'; a.volume=1.0; this.pool.push(a);} } setVolume(v){ const vol=Math.max(0,Math.min(1,v)); for(const a of this.pool) a.volume=vol; } play(){ const a=this.pool[this.idx]; this.idx=(this.idx+1)%this.pool.length; try{ a.currentTime=0; a.play().catch(()=>{});}catch{} } }

/* ç•«é¢åˆ‡æ› */
function showOnly(id){ ['menuScreen','musicScreen','optionsScreen','gameScreen','pauseScreen','endScreen'].forEach(x=>document.getElementById(x).style.display=(x===id?'block':'none')); if(id!=='gameScreen') document.getElementById('gameScreen').classList.remove('blur'); }
function goToMenu(){ cancelCountdown(); stopGameLoop(); stopAndResetAudio(); setImmersive(false); unfreezeLayout(); showOnly('menuScreen'); phase='menu'; document.body.classList.remove('ex-mode'); document.getElementById('menuChosenSong').textContent = selectedSongFile? selectedSongFile.replace(/\.mp3$/i,'') : 'å°šæœªé¸æ“‡'; }
function showOptions(){ setImmersive(false); showOnly('optionsScreen'); }
function showMusic(){ setImmersive(false); showOnly('musicScreen'); }
function setImmersive(on){ const stage=document.getElementById('stage'); if(stage) stage.classList.toggle('immersive', !!on); }

/* æ›²åº« UI */
function fillSongList(){
  const sel=document.getElementById('songSelect'); if(sel.dataset.filled) return;
  sel.innerHTML=''; const ph=document.createElement('option'); ph.value=''; ph.textContent='â€” è«‹é¸æ“‡æ›²ç›® â€”'; ph.disabled=true; ph.selected=!selectedSongFile; sel.appendChild(ph);
  SONGS.forEach(f=>{ const opt=document.createElement('option'); opt.value=f; opt.textContent=f.replace(/\.mp3$/i,''); if(selectedSongFile===f) opt.selected=true; sel.appendChild(opt); });
  sel.addEventListener('change',()=>{ document.getElementById('chosenSongLabel').textContent = sel.value? sel.options[sel.selectedIndex].textContent : 'å°šæœªé¸æ“‡'; });
  sel.dataset.filled='1';
}
function confirmSong(){ const sel=document.getElementById('songSelect'); if(!sel.value){ alert('è«‹å…ˆé¸æ“‡éŸ³æ¨‚'); return; } selectedSongFile=sel.value; document.getElementById('chosenSongLabel').textContent=sel.options[sel.selectedIndex].textContent; document.getElementById('menuChosenSong').textContent=sel.options[sel.selectedIndex].textContent; goToMenu(); }

/* HUD */
function updateHUD(){
  document.getElementById('score').textContent=score;
  document.getElementById('combo').textContent=combo;
  document.getElementById('judgement').textContent=lastJudgementText;
  document.getElementById('missCount').textContent=missCount;
  document.getElementById('songTitle').textContent=currentSongTitle;
  document.getElementById('diffLabel').textContent=currentDifficulty.toUpperCase();
  document.getElementById('dirLabel').textContent=(currentDirection==='up'?'ä¸Šå‡':'ä¸‹è½');
  document.getElementById('judgeLabel').textContent=(currentJudgeMode==='old'?'Old':'New');
  const off=document.getElementById('offsetActive'); if(off) off.textContent=`${INPUT_OFFSET_MS} ms`;
}

/* è‰²å½©èˆ‡å·¥å…· */
const laneColors=['#b266ff','#66ccff','#66ff66','#ff6666'];
const receptorPulse=[0,0,0,0]; const hitFx=[];
function dirToAngle(dir){ switch(dir){ case 'up':return 0; case 'down':return Math.PI; case 'left':return -Math.PI/2; case 'right':return Math.PI/2; } return 0; }
function hexToRgb(hex){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if(!m) return {r:255,g:255,b:255}; return {r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16)}; }
function rgbToHsl(r,g,b){ r/=255; g/=255; b/=255; const max=Math.max(r,g,b), min=Math.min(r,g,b); let h,s,l=(max+min)/2; if(max===min){ h=s=0; } else { const d=max-min; s=l>0.5? d/(2-max-min): d/(max+min); switch(max){ case r:h=(g-b)/d+(g<b?6:0);break; case g:h=(b-r)/d+2;break; case b:h=(r-g)/d+4;break;} h/=6; } return {h:h*360,s,l}; }
function hslToHex(h,s,l){ h/=360; const f=(n)=>{ const k=(n+h)%1; const a=s*Math.min(l,1-l); const c=l - a*Math.max(-1, Math.min(k*6-3, Math.min(4-k*6,1))); return Math.round(255*c); }; const r=f(0), g=f(1/3), b=f(2/3); return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`; }
function accentColors(baseHex){ const {r,g,b}=hexToRgb(baseHex); const {h,s,l}=rgbToHsl(r,g,b); const c1=baseHex; const c2=hslToHex((h+155)%360, Math.min(1, s*0.9), Math.min(0.7, l*1.05)); return {c1,c2}; }

/* å¹¾ä½•ç®­ç¾½ path */
function chevronPath(g, Wd, Hh){
  const headH=Hh*0.55;
  g.beginPath();
  g.moveTo(0,-Hh/2);
  g.lineTo(Wd/2,-Hh/2+headH);
  g.lineTo(Wd*0.22,-Hh/2+headH);
  g.lineTo(Wd*0.22,Hh/2);
  g.lineTo(-Wd*0.22,Hh/2);
  g.lineTo(-Wd*0.22,-Hh/2+headH);
  g.lineTo(-Wd/2,-Hh/2+headH);
  g.closePath();
}

/* ä»¥æ™‚é–“ t åšå‹•æ…‹å‹•ç•«ï¼ˆæƒæç·š/é›»è·¯/å½©åˆ†é›¢/ç¢ç‰‡æŠ–å‹•ï¼‰ */
function drawDynamicChevron({x,y,size,dir,baseColor,isReceptor,pulse,t}){
  const Hh=size*1.20, Wd=size*1.06;
  const {c1,c2}=accentColors(baseColor);
  const ang=dirToAngle(dir);
  ctx.save(); ctx.translate(x,y); ctx.rotate(ang);

  // 1) åŸºåº•ï¼šé»‘åº• + ç²—é»‘é‚Š + ç´°ç™½é‚Šï¼ˆReceptorï¼‰ / å½©è‰²æœ¬é«”ï¼ˆNoteï¼‰
  if(isReceptor){
    let g=ctx.createLinearGradient(0,-Hh/2,0,Hh/2);
    g.addColorStop(0,'#1a1c22'); g.addColorStop(0.35,'#0f1116'); g.addColorStop(1,'#000');
    ctx.fillStyle=g; chevronPath(ctx,Wd,Hh); ctx.fill();

    ctx.lineWidth=6; ctx.strokeStyle='#000'; chevronPath(ctx,Wd,Hh); ctx.stroke(); // ç²—é»‘é‚Š
    ctx.lineWidth=2; ctx.strokeStyle='rgba(255,255,255,.98)'; chevronPath(ctx,Wd,Hh); ctx.stroke(); // ç´°ç™½é‚Š
  }else{
    const pulseC = 0.1*FLICKER_SCALE + 0.1*FLICKER_SCALE*Math.sin(t*4 + x*0.01);
    let g=ctx.createLinearGradient(0,-Hh/2,0,Hh/2);
    g.addColorStop(0, '#ffffff');
    g.addColorStop(0.22, baseColor);
    g.addColorStop(1, baseColor);
    ctx.globalAlpha = 0.95 + 0.05*FLICKER_SCALE*Math.sin(t*5);
    ctx.shadowColor = baseColor;
    ctx.shadowBlur  = (10 + 14*pulseC)*FLICKER_SCALE;
    ctx.fillStyle=g; chevronPath(ctx,Wd,Hh); ctx.fill();
    ctx.shadowBlur=0; ctx.globalAlpha = 1;

    ctx.lineWidth=6; ctx.strokeStyle='#000'; chevronPath(ctx,Wd,Hh); ctx.stroke();
    ctx.lineWidth=2; ctx.strokeStyle='rgba(255,255,255,.95)'; chevronPath(ctx,Wd,Hh); ctx.stroke();
  }

  // 2) å…§å±¤å¹¾ä½•ç·šï¼ˆè™›ç·šæµå‹•ï¼‰
  const layerCount = __useLowQuality ? 1 : 3;
  for(let i=1;i<=layerCount;i++){
    const k = 1 - i*0.15*FLICKER_SCALE;
    ctx.save(); ctx.scale(k,k);
    ctx.lineWidth = Math.max(1, 2.4*(1-k));
    ctx.setLineDash([6, 6]); ctx.lineDashOffset = - (t*60*FLICKER_SCALE) * (0.4 + i*0.15);
    ctx.strokeStyle = 'rgba(255,255,255,0.22)';
    chevronPath(ctx,Wd,Hh); ctx.stroke();
    ctx.restore();
  }
  ctx.setLineDash([]);

  // 3) é›»è·¯ç·šï¼ˆæœƒæ»¾å‹•ï¼‰
  ctx.save();
  ctx.globalAlpha= isReceptor ? 0.55 : 0.35;
  ctx.lineWidth = 1.3;
  ctx.strokeStyle = isReceptor ? 'rgba(120,213,255,.55)' : 'rgba(255,255,255,.28)';
  const scroll = (t*40*FLICKER_SCALE)%20;
  const lanes=[-Hh*0.18*FLICKER_SCALE, 0, Hh*0.18*FLICKER_SCALE];
  lanes.forEach(y0=>{
    ctx.beginPath();
    ctx.moveTo(-Wd*0.26 + ((scroll)%10), y0);
    ctx.lineTo( Wd*0.26 + ((scroll)%10), y0);
    ctx.stroke();
  });
  ctx.restore();

  // 4) å½©åˆ†é›¢æé‚Šï¼ˆå·¦å³è¼•å¾®æŒ¯ç›ªï¼‰
  const wob = ((Math.sin(t*8)+Math.sin(t*3+1.2))*0.8 + (isReceptor?0:0.4)) * FLICKER_SCALE;
  ctx.save(); ctx.globalCompositeOperation='lighter';
  ctx.lineWidth=2; ctx.strokeStyle=c1; ctx.translate(1.0+wob,0); chevronPath(ctx,Wd,Hh); ctx.stroke();
  ctx.strokeStyle=c2; ctx.translate(-2.0-wob*1.1,0); chevronPath(ctx,Wd,Hh); ctx.stroke();
  ctx.restore();

  // 5) æƒæäº®å¸¶ï¼ˆä¸Šä¸‹å¾€è¿”ï¼‰
  const bandY = -Hh*0.35*FLICKER_SCALE + ( (Math.sin(t*2)+1)/2 ) * (Hh*0.7*FLICKER_SCALE);
  ctx.save(); ctx.globalCompositeOperation='lighter';
  const sh = ctx.createLinearGradient(-Wd/2, bandY-12*FLICKER_SCALE, Wd/2, bandY+12*FLICKER_SCALE);
  sh.addColorStop(0,'rgba(255,255,255,0)');
  sh.addColorStop(0.5, isReceptor ? 'rgba(180,255,255,0.12)' : 'rgba(255,255,255,0.10)');
  sh.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle=sh; ctx.fillRect(-Wd/2, bandY-12*FLICKER_SCALE, Wd, 24*FLICKER_SCALE);
  ctx.restore();

  // 6) ç¢ç‰‡ glitchï¼ˆä½ç§»/é•·åº¦ç¸®å°ï¼‰
  if(!__useLowQuality){
    const frameSeed = Math.floor(t*30 + x*0.07 + y*0.03);
    function rand(s){ const x=Math.sin(s*9999.13)*43758.5453; return x - Math.floor(x); }
    ctx.save(); ctx.globalCompositeOperation='lighter';
    const density = isReceptor? (10 + Math.floor(pulse*12)) : 9;
    for(let i=0;i<density;i++){
      const side = rand(frameSeed+i) < .5 ? -1 : 1;
      const yy = -Hh/2 + rand(frameSeed+i*3.1)*Hh*FLICKER_SCALE;
      const len = (8 + rand(frameSeed+i*5.7)*32) * FLICKER_SCALE;
      const thick = (1 + rand(frameSeed+i*2.3)*3) * FLICKER_SCALE;
      const xx = (Wd/2 + 2 + rand(frameSeed+i*7.7)*14*FLICKER_SCALE) * side;
      ctx.save();
      ctx.translate(xx, yy);
      ctx.rotate((rand(frameSeed+i*1.9)-.5)*0.6*FLICKER_SCALE);
      ctx.globalAlpha = (0.18 + rand(frameSeed+i*11.11)*0.25) * FLICKER_SCALE;
      ctx.fillStyle = (i%2? c1 : c2);
      ctx.fillRect(-len/2, -thick/2, len, thick);
      ctx.restore();
    }
    ctx.restore();
  }

  // 7) å‘½ä¸­æ™‚ï¼Œæ•´é¡†ä»¥ lane è‰²äº®èµ·ï¼ˆReceptorï¼‰
  if(isReceptor && pulse>0){
    ctx.save();
    ctx.globalAlpha = (0.45 + 0.5*pulse) * FLICKER_SCALE;
    let g=ctx.createLinearGradient(0,-Hh/2,0,Hh/2);
    g.addColorStop(0,'#ffffff'); g.addColorStop(0.22, baseColor); g.addColorStop(1, baseColor);
    ctx.fillStyle=g; chevronPath(ctx,Wd,Hh); ctx.fill();
    ctx.restore();
  }

  ctx.restore();
}

/* é¡å¤–å‘½ä¸­ç‰¹æ•ˆ */
function drawGlitchBurst(x,y,colorA,colorB,intensity){
  const n=Math.floor(4+intensity*5);
  ctx.save(); ctx.globalCompositeOperation='lighter';
  for(let i=0;i<n;i++){
    const w=(18+Math.random()*40)*FLICKER_SCALE, h=(2+Math.random()*3)*FLICKER_SCALE;
    const xx=x + (Math.random()<0.5?-1:1)*(8+Math.random()*20)*FLICKER_SCALE;
    const yy=y + (Math.random()*2-1)*16*FLICKER_SCALE;
    ctx.globalAlpha=(0.26+Math.random()*0.28)*FLICKER_SCALE;
    ctx.fillStyle=(i%2)?colorA:colorB;
    ctx.fillRect(xx-w/2, yy-h/2, w, h);
  }
  ctx.restore();
}
function drawGlow(x,y,r,color,alpha){
  r*=FLICKER_SCALE;
  ctx.save(); ctx.globalAlpha=alpha; const g=ctx.createRadialGradient(x,y,0,x,y,r);
  g.addColorStop(0,color); g.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.restore();
}

/* FPS ç­‰ */
let __fpsMA=60, __fpsFrames=0, __fpsLastTs=0, __useLowQuality=false, __remainNotes=0;
function trackFPS(ts){ __fpsFrames++; if(!__fpsLastTs){ __fpsLastTs=ts; return;} const span=ts-__fpsLastTs; if(span>=300){ const inst=__fpsFrames*1000/span; __fpsMA=__fpsMA*0.8+inst*0.2; __fpsFrames=0; __fpsLastTs=ts; if(__fpsMA<54) __useLowQuality=true; else if(__fpsMA>58) __useLowQuality=false; } }

/* ===== WebAudio + è»Ÿæ™‚é˜ fallback ===== */
let INPUT_OFFSET_MS = +(localStorage.getItem('dfjk.offsetMs')||0);
let audioCtx=null, songBuffer=null, gainNode=null, srcNode=null;
let startAtCtx=0, startAtSong=0; let songEnded=false;
let softBaseSong=0, softStartPerf=0;

async function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'}); if(!gainNode){ gainNode=audioCtx.createGain(); gainNode.connect(audioCtx.destination);} }
async function loadSongBuffer(url){ await ensureAudio(); const res=await fetch(url); if(!res.ok) throw new Error('fetch failed'); const arr=await res.arrayBuffer(); const buf=await audioCtx.decodeAudioData(arr); songBuffer=buf; }
function stopAndResetAudio(){ try{ if(srcNode){ srcNode.onended=null; srcNode.stop(0);} }catch{} srcNode=null; startAtCtx=0; startAtSong=0; songEnded=false; }
function playFrom(offsetSec){
  if(!audioCtx||!songBuffer) return;
  stopAndResetAudio();
  srcNode=audioCtx.createBufferSource(); srcNode.buffer=songBuffer; srcNode.connect(gainNode);
  const when=Math.max(0, audioCtx.currentTime + 0.03);
  startAtCtx=when; startAtSong=Math.max(0, Math.min(songBuffer.duration-0.001, offsetSec||0));
  softBaseSong=startAtSong; softStartPerf=performance.now()/1000;
  try{ srcNode.start(when, startAtSong); }catch(e){}
  srcNode.onended=()=>{ songEnded=true; };
}
function getSongClockSecAudio(){
  if(!audioCtx||!songBuffer||!srcNode) return null;
  return Math.max(0, Math.min(songBuffer.duration, (audioCtx.currentTime - startAtCtx) + startAtSong));
}
function getClockSec(){ const ta = getSongClockSecAudio(); if(ta!==null && audioCtx.state==='running') return ta; const t = softBaseSong + (performance.now()/1000 - softStartPerf); return Math.max(0, songBuffer? Math.min(songBuffer.duration, t) : t); }
function getJudgeClockSec(){ return getClockSec() + (INPUT_OFFSET_MS/1000); }
function setGlobalOffset(ms){ const clamp = Math.max(-600, Math.min(600, (ms|0))); INPUT_OFFSET_MS=clamp; localStorage.setItem('dfjk.offsetMs', String(INPUT_OFFSET_MS)); const lab=document.getElementById('offsetLabel'); if(lab) lab.textContent=`${INPUT_OFFSET_MS} ms`; const hud=document.getElementById('offsetActive'); if(hud) hud.textContent=`${INPUT_OFFSET_MS} ms`; }

/* æ ¡æ­£ UIï¼ˆç•¥åŒå‰ç‰ˆï¼‰ */
function initOffsetUI(){
  const s=document.getElementById('offsetSlider'); const lab=document.getElementById('offsetLabel');
  const saved=+(localStorage.getItem('dfjk.offsetMs')||0);
  s.value=String(saved); lab.textContent=`${saved} ms`; setGlobalOffset(saved);
  s.addEventListener('input',()=>{ const v=+s.value; lab.textContent=`${v} ms`; setGlobalOffset(v); });
  document.getElementById('offsetCalibBtn').addEventListener('click', openOffsetCalibrator);
}

/* â€”â€”ï¼ˆæ ¡æ­£é¢æ¿å®Œæ•´å¯¦ä½œï¼Œç‚ºç¯€çœç¯‡å¹…ä¿ç•™åŸæ¨£ï¼‰â€”â€” */
function openOffsetCalibrator(){
  (async()=>{ try{ await ensureAudio(); if(audioCtx.state==='suspended') await audioCtx.resume(); }catch{} })();
  const overlay=document.createElement('div');
  overlay.id='offset-overlay';
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;color:#fff;padding:24px;';
  const BIG='font-size:28px;font-weight:700;', MID='font-size:18px;opacity:.9;', BTN='padding:10px 18px;font-size:18px;border:none;border-radius:10px;margin:8px;cursor:pointer;background:#78d5ff;color:#001;';
  overlay.innerHTML=`
    <div style="${BIG}margin-bottom:12px;">å»¶é²æ ¡æ­£</div>
    <div style="${MID}margin-bottom:10px;display:flex;gap:10px;align-items:center;">
      <label>ç¯€æ‹ (BPM)ï¼š
        <select id="bpmSel" style="padding:6px 10px;border-radius:8px;border:1px solid #445;background:#12152a;color:#fff;">
          <option value="60">60</option>
          <option value="75">75</option>
          <option value="90" selected>90</option>
          <option value="120">120</option>
        </select>
      </label>
      <span id="rangeHint" style="opacity:.85;"></span>
    </div>
    <div style="${MID}margin-bottom:10px;">è·Ÿè‘—ç¯€æ‹<b>é»æ“Šè¢å¹•æˆ–æŒ‰ç©ºç™½éµ</b>ï¼Œè‡³å°‘ 12 æ¬¡ï¼ˆå»ºè­° 16ï½20 æ¬¡ï¼‰ã€‚</div>
    <div id="pulseWrap" style="width:220px;height:220px;border-radius:50%;position:relative;margin:8px 0 16px 0;">
      <div id="pulseDot" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:56px;height:56px;border-radius:50%;background:#fff;box-shadow:0 0 30px rgba(255,255,255,.95);"></div>
      <div id="pulseRing" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:190px;height:190px;border-radius:50%;border:6px solid rgba(255,255,255,.35);"></div>
    </div>
    <div id="progress" style="${MID}margin-bottom:8px;">æœ‰æ•ˆæ¨£æœ¬ï¼š0 æ¬¡ï¼ˆç›®æ¨™ â‰¥ 16ï¼‰</div>
    <div id="readout" style="${MID}margin-bottom:18px;">åç§»é ä¼°ï¼šâ€”</div>
    <div>
      <button id="ok" style="${BTN}background:#34d399;">å®Œæˆ</button>
      <button id="cancel" style="${BTN}background:#ff9aa2;">å–æ¶ˆ</button>
    </div>`;
  document.body.appendChild(overlay);

  let BPM=90, T=60/BPM; const rangeHint=overlay.querySelector('#rangeHint'); const setRangeText=()=>rangeHint.textContent=`æ¸¬é‡ç¯„åœï¼šÂ±${Math.round((T/2)*1000)} ms`; setRangeText();
  const ring=overlay.querySelector('#pulseRing'); const dot=overlay.querySelector('#pulseDot');
  function flash(){ dot.style.transform='translate(-50%,-50%) scale(1.12)'; ring.style.transition='none'; ring.style.transform='translate(-50%,-50%) scale(0.90)'; requestAnimationFrame(()=>{ ring.style.transition='transform .32s ease-out, opacity .32s ease-out'; dot.style.transform='translate(-50%,-50%) scale(1)'; ring.style.transform='translate(-50%,-50%) scale(1.06)'; ring.style.opacity='.78'; setTimeout(()=>{ ring.style.opacity='.35'; }, 280); }); }

  let schedTimer=null, t0=null, nextBeat=null;
  function scheduleTick(t){ try{ const osc=audioCtx.createOscillator(); const env=audioCtx.createGain(); osc.frequency.value=1200; env.gain.value=0; osc.connect(env); env.connect(gainNode||audioCtx.destination); env.gain.setValueAtTime(0,t); env.gain.linearRampToValueAtTime(0.8,t+0.005); env.gain.exponentialRampToValueAtTime(0.0001,t+0.06); osc.start(t); osc.stop(t+0.08);}catch{} }
  function scheduler(){ const now=audioCtx.currentTime; while(nextBeat < now + 0.25){ scheduleTick(nextBeat); setTimeout(flash, Math.max(0,(nextBeat-now)*1000)); nextBeat+=T; } schedTimer=setTimeout(scheduler,50); }
  function startMetronome(delay=0.9){ t0=audioCtx.currentTime+delay; nextBeat=t0; scheduler(); }
  function restart(bpm){ BPM=bpm; T=60/BPM; setRangeText(); taps.length=0; updateUI(); clearTimeout(schedTimer); startMetronome(0.7); }

  const taps=[]; const progress=overlay.querySelector('#progress'); const readout=overlay.querySelector('#readout'); const N_MIN=12, N_TARGET=16;
  function phaseToMs(t){ let x=t - t0; x -= Math.round(x/T)*T; if (x> T/2) x-=T; if (x<-T/2) x+=T; return x*1000; }
  function robustEstimate(arr){ if(!arr.length) return 0; const sorted=[...arr].sort((a,b)=>a-b); const med=sorted[Math.floor(sorted.length/2)]; const devs=arr.map(x=>Math.abs(x-med)); const ds=[...devs].sort((a,b)=>a-b); const MAD=ds[Math.floor(ds.length/2)]||1; const thr=Math.max(25, 2.5*MAD); const filtered=arr.filter(x=>Math.abs(x-med)<=thr); const mean=filtered.reduce((a,c)=>a+c,0)/Math.max(1,filtered.length); return Math.round(mean); }
  function updateUI(){ const ms=robustEstimate(taps.map(t=>phaseToMs(t))); const n=taps.length; progress.textContent=`æœ‰æ•ˆæ¨£æœ¬ï¼š${n} æ¬¡ï¼ˆç›®æ¨™ â‰¥ ${N_TARGET}ï¼‰`; readout.textContent = n? `åç§»é ä¼°ï¼š${ms} msã€€å»ºè­°å¥—ç”¨ï¼š${-ms} ms` : 'åç§»é ä¼°ï¼šâ€”'; okBtn.disabled = n < N_MIN; }
  function registerTap(){ taps.push(audioCtx.currentTime); updateUI(); if(SUPPORTS_VIB) navigator.vibrate(6); }
  function keyHandler(e){ if(e.repeat) return; if(e.code==='Space'){ e.preventDefault(); registerTap(); } if(e.code==='Escape'){ e.preventDefault(); cleanup(); } }
  function pointerHandler(e){ if(e.target.closest('button')) return; registerTap(); }
  window.addEventListener('keydown', keyHandler, true); overlay.addEventListener('pointerdown', pointerHandler, {passive:true});
  const okBtn=overlay.querySelector('#ok'), cancelBtn=overlay.querySelector('#cancel'), bpmSel=overlay.querySelector('#bpmSel'); okBtn.disabled=true;
  bpmSel.addEventListener('change', ()=>{ const val=parseInt(bpmSel.value,10)||90; restart(val); });
  function applyAndClose(){ const ms=robustEstimate(taps.map(t=>phaseToMs(t))); setGlobalOffset(-ms); cleanup(); }
  function cleanup(){ clearTimeout(schedTimer); window.removeEventListener('keydown', keyHandler, true); overlay.removeEventListener('pointerdown', pointerHandler); overlay.remove(); }
  okBtn.addEventListener('click', applyAndClose); okBtn.addEventListener('pointerdown', e=>{ e.preventDefault(); applyAndClose(); });
  cancelBtn.addEventListener('click', cleanup); cancelBtn.addEventListener('pointerdown', e=>{ e.preventDefault(); cleanup(); });
  startMetronome(0.8);
}

/* çµ±è¨ˆ/éœ‡å‹• */
const dtHistory=[]; const DT_HIST_MAX=240;
function recordDt(dtMs){ dtHistory.push(dtMs); if(dtHistory.length>DT_HIST_MAX) dtHistory.shift(); }
function getDtStats(){ if(!dtHistory.length) return {avg:0,std:0}; const n=dtHistory.length; const avg=dtHistory.reduce((a,c)=>a+c,0)/n; const va=dtHistory.reduce((a,c)=>a+(c-avg)*(c-avg),0)/n; return {avg, std:Math.sqrt(va)}; }
function hapticForRating(r){ if(!SUPPORTS_VIB) return; const map={'SICK!':12,'GOOD':8,'BAD':5,'SHIT':3}; navigator.vibrate(map[r]||6); }

/* åˆ¤å®š */
function judge(dtMs, lane){
  const WN=currentWindows(); const adt=Math.abs(dtMs);
  let rating='', base=0, incCombo=true;
  if(adt<=WN.sick){ rating='SICK!'; base=FNF_SCORES.sick; stats.sick++; }
  else if(adt<=WN.good){ rating='GOOD'; base=FNF_SCORES.good; stats.good++; }
  else if(adt<=WN.bad){ rating='BAD'; base=FNF_SCORES.bad; stats.bad++; }
  else if(adt<=WN.shit){ rating='SHIT'; base=FNF_SCORES.shit; stats.shit++; incCombo=false; }
  else { miss(); return; }
  const p=Math.min(1, adt/WN.shit); const centrality=Math.pow(1-p,1.25);
  score=Math.max(0, Math.round(score + base * centrality));
  if(incCombo) combo++; else combo=Math.max(0, combo-1);
  lastJudgementText=rating; receptorPulse[lane]=1;
  hitFx.push({lane, t0:getClockSec(), life:0.25});
  recordDt(dtMs); hapticForRating(rating); updateHUD();
  if(combo>0 && combo%10===0){ comboFlash=`COMBO x${combo}!!`; setTimeout(()=>comboFlash='',800); }
}
function miss(){ lastJudgementText='MISS'; combo=0; missCount++; stats.miss++; score=Math.max(0, score+FNF_SCORES.miss); updateHUD(); if(currentDifficulty==='ex' && missCount>15) triggerFailOnce('ä½ è¼¸äº†ï¼EX æ¨¡å¼ MISS è¶…é 15 æ¬¡'); }
function ghostTap(lane){ lastJudgementText='MISS'; combo=0; score=Math.max(0, score+FNF_SCORES.ghost); receptorPulse[lane]=0.5; if(SUPPORTS_VIB) navigator.vibrate(2); updateHUD(); }
function triggerFailOnce(msg){ if(gameOver) return; gameOver=true; running=false; stopGameLoop(); stopAndResetAudio(); setTimeout(()=>{ alert(msg); goToMenu(); },0); }

/* è­œé¢ */
function generateChart(durationSec){
  chart=[]; const d=currentDifficulty;
  let doubleNoteChance=0.35, tmin=0.20, tmax=0.45;
  if(d==='beginner'){ doubleNoteChance=0.15; tmin=0.30; tmax=0.60; }
  else if(d==='easy'){ doubleNoteChance=0.20; tmin=0.25; tmax=0.50; }
  else if(d==='normal'){ doubleNoteChance=0.35; tmin=0.20; tmax=0.45; }
  else if(d==='hard'){ doubleNoteChance=0.55; tmin=0.15; tmax=0.35; }
  if(!(d==='ex'||d==='hell')){
    let t=1; while(t<durationSec){
      const used=new Set(); const arr=[]; const cnt=Math.random()<doubleNoteChance?2:1;
      while(arr.length<cnt){ const lane=Math.floor(Math.random()*4); if(!used.has(lane)){ used.add(lane); arr.push({t,lane,type:'tap',hit:false,y:-50}); } }
      chart.push(...arr); t += Math.random()*(tmax-tmin)+tmin;
    }
    __remainNotes=chart.length; rebuildLaneCursors(); return;
  }
  const beat=0.5; let t=1; let cur=0; const next=()=>{ cur=(cur+1)%4; return cur; }; const push=(tt,ln)=>chart.push({t:tt,lane:ln,type:'tap',hit:false,y:-50}); const rnd=()=>Math.floor(Math.random()*4);
  while(t<durationSec){
    if(d==='ex'){ push(t,next()); if(Math.random()<0.60) push(t,(cur+2)%4); if(Math.random()<0.35) push(t+beat/2,(cur+1)%4); if(Math.random()<0.18){ push(t+beat/3,rnd()); push(t+2*beat/3,rnd()); } t += Math.random()<0.5 ? beat/2 : beat; }
    else { push(t,next()); if(Math.random()<0.85) push(t,(cur+2)%4); push(t+beat/2,(cur+1)%4); if(Math.random()<0.4){ push(t+beat/4,rnd()); push(t+3*beat/4,rnd()); } t += beat/2; }
  }
  __remainNotes=chart.length; rebuildLaneCursors();
}
function noteYAtTimeFor(tHit, tNow){ const judge=getJudgeLineYInternal(); return (currentDirection==='down')? (judge - (tHit - tNow)*noteSpeed) : (judge + (tHit - tNow)*noteSpeed); }

/* Lane Cursor */
const nextIdxByLane=[0,0,0,0];
function rebuildLaneCursors(){ nextIdxByLane.fill(0); chart.sort((a,b)=>a.t-b.t); }

/* æ›´æ–°/ç¹ªåœ– */
function updateHitbarPosition(){ if(!hitbar || document.getElementById('gameScreen').style.display==='none') return; const topPx=getJudgeLineYCss() - (HITKEY_BASE*uiScale/2); hitbar.style.top=`${topPx}px`; }
function positionPauseButton(){ const btn=document.getElementById('pauseButton'); if(!btn) return; btn.classList.remove('pause-bottom'); const isCoarse=window.matchMedia('(pointer: coarse)').matches; if(isCoarse && currentDirection==='up') btn.classList.add('pause-bottom'); }

/* === Playfield èƒŒæ™¯ï¼šé›»å­ç·šè·¯ + æ•…éšœæƒæ === */
function drawPlayfieldBackground(t){
  // æ·±è‰²åŸºåº•æ ¼ç·š
  ctx.save();
  ctx.globalAlpha=0.18;
  ctx.fillStyle='#0e1522';
  ctx.fillRect(0,0,W,H);
  // ç´°ç·šæ ¼
  ctx.globalAlpha=0.10;
  ctx.strokeStyle='rgba(120,213,255,0.25)';
  ctx.lineWidth=1;
  const step=28;
  const ox=(t*20)%step;
  for(let x=-ox; x<=W; x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  for(let y=-ox; y<=H; y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
  // æ»¾å‹•é›»è·¯æ¢ç´‹
  ctx.globalAlpha=0.16;
  const bandH=18;
  const by=((t*40)% (bandH*4));
  const grd=ctx.createLinearGradient(0,0, W,0);
  grd.addColorStop(0,'rgba(0,255,255,0.12)');
  grd.addColorStop(0.5,'rgba(255,0,160,0.10)');
  grd.addColorStop(1,'rgba(255,255,0,0.06)');
  ctx.fillStyle=grd;
  for(let y=-bandH*2+by; y<H; y+=bandH*4){ ctx.fillRect(0,y,W,bandH); }
  // å½é‚Šç•Œå…‰æšˆï¼ˆæ›´æŸ”å’Œï¼‰
  ctx.globalAlpha=0.22;
  const g=ctx.createRadialGradient(W/2, H/2, Math.min(W,H)*0.2, W/2,H/2, Math.max(W,H)*0.8);
  g.addColorStop(0,'rgba(0,0,0,0)');
  g.addColorStop(1,'rgba(0,0,0,0.45)');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ctx.restore();
}

function update(songT, dt){
  for(let i=0;i<chart.length;i++){ const n=chart[i]; n.y=noteYAtTimeFor(n.t, songT); }
  for(let i=0;i<chart.length;i++){
    const n=chart[i];
    if(!n.hit && ((songT - n.t)*1000) > (currentWindows().shit + LATE_MISS_GRACE_MS)){
      n.hit=true; __remainNotes--; miss(); if (i>=nextIdxByLane[n.lane]) nextIdxByLane[n.lane]=i+1;
    }
  }
  for(let i=0;i<4;i++) receptorPulse[i]=Math.max(0, receptorPulse[i]-dt*3.2);
  for(let i=hitFx.length-1;i>=0;i--) if(songT - hitFx[i].t0 > hitFx[i].life) hitFx.splice(i,1);
}

function render({skipNotes=false}={}){
  const judge=getJudgeLineYInternal();
  ctx.clearRect(0,0,W,H);
  const tAnim = performance.now()/1000;

  // Playfield èƒŒæ™¯ï¼ˆå…ˆç•«ï¼‰
  drawPlayfieldBackground(tAnim);

  // Receptorï¼ˆé»‘åº• + å‹•æ…‹æ•ˆæœï¼›å‘½ä¸­æ•´é¡†å½©è‰²ï¼‰
  for(let lane=0; lane<4; lane++){
    const x=lane*laneWidth+laneWidth/2; const pulse=receptorPulse[lane];
    const s=1 + 0.18*FLICKER_SCALE*pulse;
    drawDynamicChevron({x, y:judge, size:NOTE_BASE*s, dir:laneDirs[lane], baseColor:laneColors[lane], isReceptor:true,  pulse, t:tAnim});
    if (pulse>0){
      const {c1,c2}=accentColors(laneColors[lane]);
      drawGlitchBurst(x, judge, c1, c2, pulse);
      drawGlow(x, judge, 48 + 26*pulse, laneColors[lane], (0.30 + 0.34*pulse)*FLICKER_SCALE);
    } else {
      drawGlow(x, judge, 32, 'rgba(0,255,255,0.20)', 0.06*FLICKER_SCALE);
    }
  }

  // Notesï¼ˆå‹•æ…‹ï¼‰
  if(!skipNotes){
    const top=-120, bottom=H+120;
    for(let i=0;i<chart.length;i++){
      const n=chart[i]; if(n.hit) continue; if(n.y<top||n.y>bottom) continue;
      const x=n.lane*laneWidth+laneWidth/2;
      drawDynamicChevron({x, y:n.y, size:NOTE_BASE, dir:laneDirs[n.lane], baseColor:laneColors[n.lane], isReceptor:false, pulse:0, t:tAnim + i*0.03});
    }
  }

  // å‘½ä¸­ç’°
  for(let i=0;i<hitFx.length;i++){
    const fx=hitFx[i]; const p=Math.min(1,(getClockSec()-fx.t0)/fx.life);
    const x=fx.lane*laneWidth+laneWidth/2;
    ctx.save(); ctx.globalAlpha=(1-p)*FLICKER_SCALE; ctx.strokeStyle=laneColors[fx.lane]; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(x, judge, (18+80*p)*FLICKER_SCALE, 0, Math.PI*2); ctx.stroke(); ctx.restore();
  }

  if(lastJudgementText!=='-'){
    ctx.fillStyle='#fff'; ctx.font='bold 32px sans-serif'; ctx.textAlign='center';
    const offset=(currentDirection==='up')? 120 : -40;
    ctx.fillText(lastJudgementText, W/2, judge+offset);
  }
  if(comboFlash){
    ctx.fillStyle='#ff78d5'; ctx.font='bold 36px sans-serif'; ctx.textAlign='center'; ctx.fillText(comboFlash, W/2, H/2 - 100);
  }

  renderUI(); // å›ºå®š HUDï¼ˆå«ç†±åœ–ï¼‰
}

/* å·¦ä¸Šè§’ HUDï¼šç†±åœ–åœ¨ã€Œä¸Šå‡æ‰“æ“Šã€æ™‚è‡ªå‹•ä¸‹ç§»åˆ°åˆ¤å®šç·šä¸‹æ–¹ */
function renderUI(){
  const bins=36, min=-300, max=300, step=(max-min)/bins; const hist=new Array(bins).fill(0);
  for(const v of dtHistory){ const i=Math.floor((v-min)/step); if(i>=0&&i<bins) hist[i]++; }
  uictx.clearRect(0,0,W,H);

  // å®‰å…¨é‚Šè·
  const safeLeft= 14;
  const SCALE=0.96; const w=Math.round(240*SCALE), h=Math.round(74*SCALE); const bw=w/bins;

  // y ä½ç½®ï¼šdown æ¨¡å¼æ”¾ä¸Šæ–¹ï¼›up æ¨¡å¼ â†’ åˆ¤å®šç·šä¸‹ç§» 40pxï¼ˆä¸”ä¸è¶…å‡ºåº•éƒ¨ï¼‰
  const judgeY = getJudgeLineYInternal();
  const topDefault = 24 + (IS_MOBILE ? 6 : 0);
  const y0 = (currentDirection==='up')
    ? Math.min(H - h - 24, judgeY + 40)   // <<< é€™è£¡å¹³ç§»åˆ°ä¸‹æ–¹
    : topDefault;

  const x0=safeLeft;

  uictx.save();
  uictx.globalAlpha=0.98;
  uictx.fillStyle='rgba(0,0,0,0.55)'; uictx.fillRect(x0-8,y0-10,w+16,h+46);
  uictx.fillStyle='#fff'; uictx.font='12px sans-serif'; uictx.fillText('Hit åç§»ç†±åœ– (ms)', x0, y0-12);
  const maxc=Math.max(1,...hist);
  for(let i=0;i<bins;i++){ const v=hist[i]; const bh=(v/maxc)*h; const xx=Math.floor(x0 + i*bw); uictx.fillStyle='#78d5ff'; uictx.fillRect(xx, y0+(h-bh), Math.ceil(bw-1), bh); }
  const {avg,std}=getDtStats(); uictx.fillStyle='#fff'; uictx.fillText(`avg: ${avg.toFixed(1)} ms  Ïƒ: ${std.toFixed(1)} ms  åç§»: ${INPUT_OFFSET_MS} ms`, x0, y0+h+16);
  uictx.strokeStyle='#ffd966'; uictx.beginPath(); const midx=x0 + (-min)/step*bw; uictx.moveTo(midx,y0); uictx.lineTo(midx,y0+h); uictx.stroke();
  uictx.restore();
}

function renderPreviewAt(t){
  const judge=getJudgeLineYInternal();
  ctx.clearRect(0,0,W,H);
  const tt = performance.now()/1000;

  drawPlayfieldBackground(tt);

  for(let lane=0; lane<4; lane++){
    const x=lane*laneWidth+laneWidth/2;
    drawDynamicChevron({x, y:judge, size:NOTE_BASE, dir:laneDirs[lane], baseColor:laneColors[lane], isReceptor:true, pulse:0, t:tt});
  }
  const top=-120, bottom=H+120;
  for(let i=0;i<chart.length;i++){
    const n=chart[i]; if(n.hit) continue; const y=noteYAtTimeFor(n.t,t); if(y<top||y>bottom) continue;
    const x=n.lane*laneWidth+laneWidth/2;
    drawDynamicChevron({x, y, size:NOTE_BASE, dir:laneDirs[n.lane], baseColor:laneColors[n.lane], isReceptor:false, pulse:0, t:tt + i*0.03});
  }
  renderUI();
}

function endGameAndShowResult(){
  running=false; lastJudgementText='END'; updateHUD();
  document.getElementById('finalSong').textContent=currentSongTitle;
  document.getElementById('finalDiff').textContent=currentDifficulty.toUpperCase();
  document.getElementById('finalDir').textContent=(currentDirection==='up'?'ä¸Šå‡':'ä¸‹è½');
  document.getElementById('finalJudge').textContent=(currentJudgeMode==='old'?'Old':'New');
  document.getElementById('finalScore').textContent=score;
  document.getElementById('statSick').textContent=stats.sick;
  document.getElementById('statGood').textContent=stats.good;
  document.getElementById('statBad').textContent=stats.bad;
  document.getElementById('statShit').textContent=stats.shit;
  document.getElementById('statMiss').textContent=stats.miss;
  showOnly('endScreen'); setImmersive(false); phase='menu';
}

/* è¿´åœˆ */
function loop(ts){
  if(paused) return;
  const songT=getClockSec(); const dt=Math.max(0, songT - prevSongT); prevSongT=songT;
  update(songT, dt); trackFPS(ts);
  let doRender=true;
  if(__fpsMode==='stable60' && IS_MOBILE){
    if(ts-__lastRenderTs < __TARGET_INTERVAL-0.5) doRender=false;
    else { const steps=Math.max(1, Math.floor((ts-__lastRenderTs)/__TARGET_INTERVAL)); __lastRenderTs += steps*__TARGET_INTERVAL; }
  }
  if(doRender) render();
  if(songEnded || __remainNotes<=0){ endGameAndShowResult(); return; }
  loopId=requestAnimationFrame(loop);
}
function stopGameLoop(){ try{ cancelAnimationFrame(loopId);}catch{} loopId=null; }

/* å€’æ•¸ï¼ˆé¦–å¹€é æ¸²æŸ“ï¼‰ */
function showCountdown(startCallback, opts){
  cancelCountdown(); isCountingDown=true; phase='countdown';
  const previewTime=opts&&typeof opts.previewTime==='number'? opts.previewTime : null;
  const showNotes=!!(opts && opts.showNotes && previewTime!==null);
  if(showNotes) renderPreviewAt(previewTime); else render({skipNotes:true});

  const el=document.getElementById('countdownText'); el.style.display='block'; el.textContent='Ready';
  const steps=['Ready','3','2','1','Go!']; const stepDur=700;

  const countdownLoop=()=>{ if(!isCountingDown) return; if(showNotes) renderPreviewAt(previewTime); else render({skipNotes:true}); countdownRAF=requestAnimationFrame(countdownLoop); }; countdownLoop();
  const playStep=i=>{ if(!isCountingDown) return; el.textContent=steps[i]; el.style.animation='none'; void el.offsetWidth; el.style.animation='popScale .55s ease-out'; };

  for(let i=0;i<steps.length;i++){ countdownTimers.push(setTimeout(()=>playStep(i), i*stepDur)); }
  countdownTimers.push(setTimeout(()=>{ if(!isCountingDown) return; el.style.display='none'; isCountingDown=false; try{ cancelAnimationFrame(countdownRAF);}catch{}; startCallback(); }, steps.length*stepDur));
}
function cancelCountdown(){ if(!isCountingDown && countdownTimers.length===0 && !countdownRAF) return; isCountingDown=false; countdownTimers.forEach(id=>clearTimeout(id)); countdownTimers=[]; try{ cancelAnimationFrame(countdownRAF);}catch{} countdownRAF=null; const el=document.getElementById('countdownText'); el.style.animation='none'; el.style.display='none'; }

/* æç¤º */
const warnBanner=document.getElementById('warnBanner'); let audioWarned=false;
function showPlayWarning(msg){ if(audioWarned) return; audioWarned=true; warnBanner.textContent=msg||'âš ï¸ éŸ³æ¨‚ç„¡æ³•æ’­æ”¾ï¼šè«‹ç¢ºèªæª”å/è·¯å¾‘ï¼Œæˆ–é»ä¸€ä¸‹ç•«é¢å†æŒ‰é–‹å§‹ã€‚'; warnBanner.style.display='block'; setTimeout(()=>{ warnBanner.style.display='none'; audioWarned=false; },3000); }

/* è¼¸å…¥ */
window.addEventListener('keydown', e=>{
  if(e.repeat) return;
  const k=e.key.toLowerCase(); const lane=laneFromKey(k);
  if(lane!==null){ if(phase==='playing') onLanePress(lane); e.preventDefault(); return; }
  if(e.key==='Escape'){
    if(phase==='countdown'){ cancelCountdown(); goToMenu(); return; }
    if(phase==='playing'){ paused? resumeGame() : pauseGame(); return; }
    if(phase==='paused'){ resumeGame(); return; }
  }
});
canvas.addEventListener('pointerdown', e=>{
  if(phase!=='playing') return; e.preventDefault();
  const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left; const cssLaneWidth=rect.width/4;
  const lane=Math.min(3, Math.max(0, Math.floor(x/cssLaneWidth))); onLanePress(lane);
}, {passive:false});

function onLanePress(lane){
  if(!running) return;
  playTapSound();
  const tNow=getJudgeClockSec(); const win=currentWindows().shit;
  let best=-1, bestAbs=Infinity;
  for(let i=nextIdxByLane[lane]; i<chart.length; i++){
    const n=chart[i]; if(n.hit || n.lane!==lane) continue;
    const dtMs=(tNow - n.t)*1000; const adt=Math.abs(dtMs);
    if(adt<=win){ if(adt<bestAbs){ bestAbs=adt; best=i; } }
    else if (dtMs>win){ nextIdxByLane[lane]=i+1; }
    else { break; }
  }
  if(best>=0){
    const n=chart[best]; judge((tNow - n.t)*1000, lane); n.hit=true; __remainNotes--; receptorPulse[lane]=1;
    if(best>=nextIdxByLane[lane]) nextIdxByLane[lane]=best+1;
  } else {
    if(currentJudgeMode==='old') ghostTap(lane);
    receptorPulse[lane]=1;
  }
}

/* éŸ³é‡ & é˜è² */
function setVolumes(percent){ const v=Math.max(0,Math.min(100,percent))/100; if(gainNode) gainNode.gain.value=v; if(!tapPool) tapPool=new TapSoundPool(hitSound.src,12); const sfxVol=Math.min(1, v*SFX_GAIN); tapPool.setVolume(sfxVol); hitSound.volume=sfxVol; }
function initVolumeUI(){ const slider=document.getElementById('volumeSlider'); const label=document.getElementById('volumeLabel'); const saved=+localStorage.getItem('dfjk.volume')||80; slider.value=String(saved); label.textContent=`${saved}%`; setVolumes(saved); slider.addEventListener('input', ()=>{ const val=+slider.value; label.textContent=`${val}%`; setVolumes(val); localStorage.setItem('dfjk.volume', String(val)); }); }
function playTapSound(){ if(!tapPool) tapPool=new TapSoundPool(hitSound.src,12); tapPool.play(); }

/* æµç¨‹ */
function startGame(){
  if(!selectedSongFile){ alert('è«‹å…ˆé¸æ“‡éŸ³æ¨‚'); showMusic(); return; }
  const diff=document.getElementById('difficultySelect').value;
  const spSel=document.getElementById('speedMultiplier');
  const dir=document.getElementById('noteDirection').value;
  const jmode=document.getElementById('judgeMode').value;
  currentDifficulty=diff; currentDirection=dir; currentJudgeMode=jmode;
  let mul=parseFloat(spSel.value); if(diff==='beginner') mul=0.8; else if(diff==='easy') mul=0.9; else if(diff==='ex') mul=1.8;
  noteSpeed=baseNoteSpeed*mul; document.body.classList.toggle('ex-mode', diff==='ex');

  stopGameLoop(); score=0; combo=0; lastJudgementText='-'; comboFlash=''; chart=[]; paused=false; running=true; missCount=0; gameOver=false;
  stats={sick:0,good:0,bad:0,shit:0,miss:0}; prevSongT=0; pausedAtSong=0;
  for(let i=0;i<4;i++) receptorPulse[i]=0; hitFx.length=0; dtHistory.length=0; updateHUD();

  currentSongTitle=selectedSongFile.replace(/\.mp3$/i,''); const url='music/'+encodeURIComponent(selectedSongFile);
  showOnly('gameScreen'); setImmersive(true); phase='countdown';
  setupCanvasDPR(); applyDesktopScale(); recomputeLayout(); updateHUD(); __lastRenderTs=0;

  render({skipNotes:true}); // é¿å…é»‘ç•«é¢

  loadSongBuffer(url).then(()=>{
    const durationSec = songBuffer && isFinite(songBuffer.duration) ? songBuffer.duration : 120;
    generateChart(durationSec);
    showCountdown(()=>{
      if(phase!=='countdown') return;
      phase='playing'; freezeLayout(); __lastRenderTs=0; prevSongT=0;
      (async()=>{ await ensureAudio(); try{ if(audioCtx.state==='suspended') await audioCtx.resume(); }catch{}; playFrom(0); })();
      loopId=requestAnimationFrame(loop);
    });
  }).catch(e=>{ console.warn(e); showPlayWarning('âš ï¸ è¼‰å…¥éŸ³æ¨‚å¤±æ•—'); goToMenu(); });
}

function pauseGame(){
  if(phase==='countdown'){ cancelCountdown(); goToMenu(); return; }
  if(!running||paused) return;
  pausedAtSong = getClockSec();
  paused=true; phase='paused'; stopGameLoop(); unfreezeLayout();
  document.getElementById('gameScreen').classList.add('blur'); showOnly('pauseScreen');
  try{ if(srcNode){ srcNode.onended=null; srcNode.stop(0);} }catch{} srcNode=null;
}

function resumeGame(){
  if(!paused) return; paused=false;
  showOnly('gameScreen'); document.getElementById('gameScreen').classList.remove('blur');
  setupCanvasDPR(); applyDesktopScale(); recomputeLayout();
  phase='countdown';
  const resumeAt = Math.max(0, Math.min(songBuffer? songBuffer.duration : 0, pausedAtSong));
  renderPreviewAt(resumeAt);
  showCountdown(()=>{
    phase='playing'; freezeLayout();
    (async()=>{ await ensureAudio(); try{ if(audioCtx.state==='suspended') await audioCtx.resume(); }catch{}; playFrom(resumeAt); })();
    prevSongT=resumeAt; __lastRenderTs=0; loopId=requestAnimationFrame(loop);
  }, { showNotes:true, previewTime: resumeAt });
}

/* åˆå§‹åŒ– */
function onViewportChanged(){ if(__layoutFrozen) return; if(phase==='playing'||phase==='countdown'){ setupCanvasDPR(); applyDesktopScale(); recomputeLayout(); renderUI(); } }
function initOffsetAndVolume(){ initOffsetUI(); initVolumeUI(); }

applyDesktopScale();
initOffsetAndVolume();
fillSongList();

window.addEventListener('resize', ()=>{ setupCanvasDPR(); onViewportChanged(); }, {passive:true});
window.addEventListener('scroll', ()=>{ if(!__layoutFrozen && (phase==='playing'||phase==='countdown')) recomputeLayout(); }, {passive:true});
if(window.visualViewport){ ['resize','scroll'].forEach(ev=>{ window.visualViewport.addEventListener(ev, ()=>{ setupCanvasDPR(); onViewportChanged(); }, {passive:true}); }); }
window.addEventListener('orientationchange', ()=>{ setupCanvasDPR(); unfreezeLayout(); applyDesktopScale(); recomputeLayout(); if(phase==='playing'||phase==='countdown') freezeLayout(); }, {passive:true});

document.addEventListener('contextmenu', e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); });
document.addEventListener('gesturestart', e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); });
document.addEventListener('dblclick', e=>{ if(phase==='playing'||phase==='countdown') e.preventDefault(); });

goToMenu();

/* ç¶å®š */
Object.assign(window, { startGame, showMusic, showOptions, goToMenu, pauseGame, resumeGame, confirmSong });
</script>
</body>
</html>
